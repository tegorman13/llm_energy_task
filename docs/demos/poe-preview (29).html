<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Use Perception Experiment</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: "#5D5CDE",
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom styling */
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5D5CDE;
            cursor: pointer;
        }
        
        .range-slider::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #5D5CDE;
            cursor: pointer;
        }
        
        /* Dark mode support */
        .dark body {
            background-color: #181818;
            color: #f3f4f6;
        }
        
        .transition-opacity {
            transition: opacity 0.3s ease;
        }
    </style>
</head>
<body class="bg-white dark:bg-gray-900 text-gray-800 dark:text-gray-100 min-h-screen flex flex-col">
    <!-- Dark mode detection -->
    <script>
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
    </script>

    <header class="bg-primary text-white p-4 shadow">
        <div class="container mx-auto">
            <h1 class="text-xl md:text-2xl font-bold">Energy Use Perception Study</h1>
            <p class="text-sm md:text-base">Based on Marghetis, Attari, &amp; Landy (2019)</p>
        </div>
    </header>

    <main class="container mx-auto p-4 flex-grow flex flex-col">
        <div id="appContent" class="flex-grow flex flex-col">
            <!-- Introduction section -->
            <section id="introduction" class="flex-grow flex flex-col">
                <div class="max-w-3xl mx-auto w-full bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Welcome to the Energy Use Perception Study</h2>
                    <p class="mb-4">
                        This web application simulates the experimental procedure used in a 2019 study by Marghetis, Attari, and Landy published in Nature Energy.
                    </p>
                    <p class="mb-4">
                        The original study investigated how people estimate the energy used by home appliances and tested interventions to improve these estimations.
                    </p>
                    <p class="mb-4">
                        In this simulation, you'll be randomly assigned to one of four experimental conditions, just like the original study participants:
                    </p>
                    <ol class="list-decimal ml-6 mb-4">
                        <li>Control - basic information only</li>
                        <li>Scale-Use Information - additional numerical anchors</li>
                        <li>Explicit Heuristic - a helpful energy estimation rule</li>
                        <li>Both Interventions - combining scale-use and heuristic</li>
                    </ol>
                    <p class="mb-4">
                        You'll then estimate the energy used by common household appliances and make decisions about energy-conserving behaviors.
                    </p>
                    <p class="mb-6">
                        This simulation is for educational purposes and your responses will not be recorded.
                    </p>
                    <button id="startButton" class="w-full bg-primary hover:bg-opacity-90 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline transition">
                        Begin Study Simulation
                    </button>
                </div>
            </section>

            <!-- Condition information section -->
            <section id="conditionInfo" class="hidden flex-grow flex flex-col">
                <div class="max-w-3xl mx-auto w-full bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Study Information</h2>
                    <div class="p-4 mb-4 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <p id="conditionText" class="font-medium"></p>
                    </div>
                    <p class="mb-4">
                        On the next screens, you'll be estimating how much electricity (in watt-hours) is used by various household appliances running for one hour.
                    </p>
                    <p class="mb-6">
                        Please read the information above carefully as it will help guide your estimations.
                    </p>
                    <button id="startEstimationButton" class="w-full bg-primary hover:bg-opacity-90 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline transition">
                        Continue to Energy Estimation Task
                    </button>
                </div>
            </section>
            
            <!-- Energy estimation task section -->
            <section id="estimationTask" class="hidden flex-grow flex flex-col">
                <div class="max-w-3xl mx-auto w-full bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Energy Estimation Task</h2>
                        <p class="text-sm bg-primary bg-opacity-10 text-primary dark:bg-opacity-20 py-1 px-3 rounded-full">
                            Appliance <span id="currentApplianceNum">1</span> of <span id="totalAppliances">36</span>
                        </p>
                    </div>
                    
                    <div class="p-4 mb-6 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <p id="conditionTextEstimation" class="font-medium"></p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">How much electricity does this appliance use in one hour?</h3>
                        <div id="applianceName" class="text-2xl font-bold mb-4 text-center py-6 bg-gray-100 dark:bg-gray-700 rounded-lg"></div>
                        
                        <div class="mb-4">
                            <label for="estimateSlider" class="block text-sm font-medium mb-2">Estimate (watt-hours):</label>
                            <div class="flex items-center space-x-4">
                                <input type="range" id="estimateSlider" class="range-slider flex-grow h-2 bg-gray-300 dark:bg-gray-600 rounded-lg appearance-none cursor-pointer" min="1" max="12000" value="100">
                                <input type="number" id="estimateValue" class="w-24 py-2 px-3 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 rounded-md text-base" min="1" max="12000" value="100">
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <span>1 Wh</span>
                                <span>12,000 Wh</span>
                            </div>
                            <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400 mt-1">
                                <span>(Example: LED bulb)</span>
                                <span>(Example: Electric car charging)</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="flex justify-between">
                        <button id="prevApplianceButton" class="hidden bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition">
                            Previous
                        </button>
                        <div class="flex-grow"></div>
                        <button id="nextApplianceButton" class="bg-primary hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition">
                            Next
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Behavioral choice task section -->
            <section id="behavioralTask" class="hidden flex-grow flex flex-col">
                <div class="max-w-3xl mx-auto w-full bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">Behavioral Choice Task</h2>
                        <p class="text-sm bg-primary bg-opacity-10 text-primary dark:bg-opacity-20 py-1 px-3 rounded-full">
                            Question <span id="currentChoiceNum">1</span> of <span id="totalChoices">20</span>
                        </p>
                    </div>
                    
                    <div class="p-4 mb-6 bg-blue-50 dark:bg-blue-900 rounded-lg">
                        <p id="conditionTextBehavioral" class="font-medium"></p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-4">For the following options, please choose the one that uses the LEAST amount of electricity:</h3>
                        <div id="choiceQuestion" class="mb-6 text-center"></div>
                        
                        <div class="space-y-4">
                            <button id="choiceA" class="choice-btn w-full text-left bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                                Option A
                            </button>
                            <button id="choiceB" class="choice-btn w-full text-left bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-lg p-4 hover:bg-gray-50 dark:hover:bg-gray-600 transition">
                                Option B
                            </button>
                        </div>
                    </div>
                    
                    <div id="feedbackArea" class="hidden mb-6 p-4 rounded-lg"></div>
                    
                    <div class="flex justify-between">
                        <button id="prevChoiceButton" class="hidden bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 text-gray-800 dark:text-gray-200 font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition">
                            Previous
                        </button>
                        <div class="flex-grow"></div>
                        <button id="nextChoiceButton" class="hidden bg-primary hover:bg-opacity-90 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline transition">
                            Next
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- Results section -->
            <section id="resultsSection" class="hidden flex-grow flex flex-col">
                <div class="max-w-3xl mx-auto w-full bg-white dark:bg-gray-800 rounded-lg shadow p-6 mb-6">
                    <h2 class="text-xl font-bold mb-4">Your Results</h2>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Your Experimental Condition</h3>
                        <p id="resultCondition" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg"></p>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Energy Estimation Accuracy</h3>
                        <div id="estimationAccuracy" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <div class="mb-2">
                                <span class="font-medium">Average Error:</span>
                                <span id="avgErrorValue"></span>
                            </div>
                            <div>
                                <span class="font-medium">Correlation with True Values:</span>
                                <span id="correlationValue"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Behavioral Choice Task Performance</h3>
                        <div id="behavioralPerformance" class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <div>
                                <span class="font-medium">Correct Choices:</span>
                                <span id="correctChoicesValue"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold mb-2">Key Findings from the Original Study</h3>
                        <div class="p-4 bg-gray-100 dark:bg-gray-700 rounded-lg">
                            <ul class="list-disc ml-5 space-y-2">
                                <li>People typically underestimate the energy used by large appliances and overestimate the energy used by small appliances.</li>
                                <li>The scale-use intervention dramatically improved energy estimations but had little effect on behavioral choices.</li>
                                <li>The explicit heuristic intervention had a more modest effect on energy estimations but significantly improved behavioral choices.</li>
                                <li>Understanding relative energy use was associated with self-reported energy conservation behaviors and environmental attitudes.</li>
                            </ul>
                        </div>
                    </div>
                    
                    <button id="restartButton" class="w-full bg-primary hover:bg-opacity-90 text-white font-bold py-3 px-4 rounded focus:outline-none focus:shadow-outline transition">
                        Restart Simulation
                    </button>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-200 dark:bg-gray-800 p-4 text-center text-sm">
        <p>Based on: Marghetis, T., Attari, S. Z., &amp; Landy, D. (2019). Simple interventions can correct misperceptions of home energy use. Nature Energy, 4(10), 874–881.</p>
    </footer>

    <script>
        // Define the appliances and their actual energy use in watt-hours
        const appliances = [
            { name: "Compact Fluorescent Light (CFL) bulb", actual: 23 },
            { name: "Desktop computer", actual: 138 },
            { name: "Laptop computer", actual: 32 },
            { name: "Stereo", actual: 33 },
            { name: "Window air conditioner", actual: 1157 },
            { name: "Central air conditioner", actual: 3797 },
            { name: "Clothes dryer", actual: 3938 },
            { name: "Dishwasher", actual: 1201 },
            { name: "Charging a Tesla Model-S electric car", actual: 11520 },
            { name: "Dehumidifier", actual: 734 },
            { name: "Humidifier", actual: 185 },
            { name: "Vacuum", actual: 809 },
            { name: "100-watt Incandescent light bulb", actual: 100 },
            { name: "Slow cooker (crock-pot)", actual: 318 },
            { name: "Electric oven", actual: 3050 },
            { name: "Portable heater", actual: 1290 },
            { name: "Charging a smartphone", actual: 3.42 },
            { name: "40\" flat screen television", actual: 68 },
            { name: "Ceiling fan", actual: 69 },
            { name: "Water heater", actual: 4284 },
            { name: "Modem", actual: 12.1 },
            { name: "Television Cable box", actual: 33 },
            { name: "Alarm clock", actual: 2.8 },
            { name: "Iron", actual: 1198 },
            { name: "Projector", actual: 197 },
            { name: "Full size fridge", actual: 364 },
            { name: "Storage freezer", actual: 384 },
            { name: "Washing machine", actual: 478 },
            { name: "Video game console", actual: 111 },
            { name: "Electric blanket", actual: 197 },
            { name: "DVD player", actual: 9.13 },
            { name: "Microwave", actual: 1101 },
            { name: "Toaster", actual: 1213 },
            { name: "LED light bulb", actual: 15 },
            { name: "Electric kettle", actual: 1390 },
            { name: "Coffee maker", actual: 1134 }
        ];

        // Define behavioral choice questions
        const behavioralChoices = [
            {
                question: "Which option uses the least amount of electricity?",
                a: "Watching a movie on a laptop",
                b: "Watching a movie on a projector",
                correctAnswer: "a",
                explanation: "A laptop uses about 32 Wh, while a projector uses around 197 Wh - about 6 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Warming yourself with an electric blanket",
                b: "Warming yourself with a portable space heater",
                correctAnswer: "a",
                explanation: "An electric blanket uses about 197 Wh, while a portable heater uses around 1290 Wh - about 6.5 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "A desktop computer's tower",
                b: "A desktop computer's monitor",
                correctAnswer: "b",
                explanation: "A computer monitor uses about 34 Wh, while a tower uses around 92 Wh - about 2.7 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Cooking with an electric oven",
                b: "Cooking with a crock-pot",
                correctAnswer: "b",
                explanation: "A crock-pot uses about 318 Wh, while an electric oven uses around 3050 Wh - about 9.6 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Ironing your clothes",
                b: "Vacuuming your carpets",
                correctAnswer: "b",
                explanation: "A vacuum uses about 809 Wh, while an iron uses around 1198 Wh - about 1.5 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Cooling yourself with a window air conditioner",
                b: "Cooling yourself with a ceiling fan",
                correctAnswer: "b",
                explanation: "A ceiling fan uses about 68 Wh, while a window air conditioner uses around 1157 Wh - about 17 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Watching a movie on a 40\" flat screen television",
                b: "Watching a movie on a projector",
                correctAnswer: "a",
                explanation: "A flat screen TV uses about 68 Wh, while a projector uses around 197 Wh - about 2.9 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Watching your favorite shows on a 40\" flat screen television",
                b: "Watching your favorite shows on your laptop computer",
                correctAnswer: "b",
                explanation: "A laptop uses about 32 Wh, while a flat screen TV uses around 68 Wh - about 2.1 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Playing video games on your console (only consider the console)",
                b: "Watching cable television (only consider the cable box)",
                correctAnswer: "b",
                explanation: "A cable box uses about 33 Wh, while a game console uses around 111 Wh - about 3.4 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Charging a Tesla Model S electric vehicle for one hour",
                b: "Cooking a casserole in an electric oven for one hour",
                correctAnswer: "b",
                explanation: "An electric oven uses about 3050 Wh, while charging a Tesla uses around 11520 Wh - about 3.8 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "A water heater running at full capacity for one hour",
                b: "Vacuuming your carpets for one hour",
                correctAnswer: "b",
                explanation: "A vacuum uses about 809 Wh, while a water heater uses around 4284 Wh - about 5.3 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "A central air conditioning unit running at full capacity for 8 hours throughout one day",
                b: "25 Compact Fluorescent Light (CFL) bulbs left on for 8 hours in one day",
                correctAnswer: "b",
                explanation: "25 CFL bulbs for 8 hours use about 4600 Wh, while a central AC for 8 hours uses around 30376 Wh - about 6.6 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Warming a room with a portable space heater",
                b: "Washing clothes in a washing machine",
                correctAnswer: "b",
                explanation: "A washing machine uses about 478 Wh, while a portable heater uses around 1290 Wh - about 2.7 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Vacuuming carpets",
                b: "A refrigerator",
                correctAnswer: "b",
                explanation: "A refrigerator uses about 364 Wh, while a vacuum uses around 809 Wh - about 2.2 times more energy."
            },
            {
                question: "Which option uses the least amount of electricity?",
                a: "Drying a load of laundry in a clothes dryer once a week",
                b: "20 Light Emitting Diode (LED) bulbs left on for 60 hours each week",
                correctAnswer: "a",
                explanation: "A clothes dryer uses about 3938 Wh, while 20 LED bulbs for 60 hours use around 18000 Wh - about 4.6 times more energy."
            },
            {
                question: "Which action would allow you to save the most electricity?",
                a: "Purchasing a space heater that is 20% more efficient",
                b: "Purchasing a television that is 20% more efficient",
                correctAnswer: "a",
                explanation: "A 20% improvement for a heater (1290 Wh) saves much more than a 20% improvement for a TV (68 Wh)."
            },
            {
                question: "Which action would allow you to save the most electricity?",
                a: "Replacing 20 of your Compact Fluorescent Light (CFL) bulbs for LED bulbs, left on for 8 hours each day for one week",
                b: "Hand washing your dishes with cold water rather than using the dishwasher",
                correctAnswer: "a",
                explanation: "Replacing CFLs with LEDs saves about 8960 Wh per week, while handwashing instead of using a dishwasher saves about 1201 Wh."
            },
            {
                question: "Which action would allow you to save the most electricity?",
                a: "Line drying your clothes rather than using an electric clothes dryer (once a week)",
                b: "Reading a book rather than watching television (20 hours a week)",
                correctAnswer: "a",
                explanation: "Line drying saves about 3938 Wh, while reading instead of watching TV for 20 hours saves about 1360 Wh."
            },
            {
                question: "Which action would allow you to save the most electricity?",
                a: "Turning off your cable box when not in use",
                b: "Turning off an idle laptop when not in use",
                correctAnswer: "a",
                explanation: "An idle cable box uses about 17.8 Wh, while an idle laptop uses about 8.9 Wh."
            },
            {
                question: "Which action would allow you to save the most electricity?",
                a: "Replacing your morning coffee (coffee maker runs at full capacity for 10 minutes) with a glass of water",
                b: "Unwinding with a book at the end of the day rather than watching television for one hour",
                correctAnswer: "a",
                explanation: "A coffee maker for 10 minutes uses about 189 Wh, while watching TV for an hour uses about 68 Wh."
            }
        ];

        // Global state
        let state = {
            condition: null, // 0: control, 1: scale-use, 2: heuristic, 3: both
            currentApplianceIndex: 0,
            currentChoiceIndex: 0,
            estimates: [], // User's estimates for each appliance
            choices: [], // User's choices for behavioral task
            shuffledAppliances: [],
            shuffledChoices: []
        };

        // Get condition texts
        function getConditionText(condition) {
            const baseText = "A 100-watt incandescent light bulb uses 100 units of energy in one hour.";
            const scaleText = "A 5-watt phone charger uses 5 units of energy to charge a smartphone in one hour. Similarly, a 100-watt incandescent light bulb uses 100 units of energy in one hour, and a typical clothes dryer uses about 4,000 units of energy in one hour.";
            const heuristicText = "A 100-watt incandescent light bulb uses 100 units of energy in one hour. Note that LARGE appliances that primarily HEAT or COOL things use a lot more energy than people think.";
            const bothText = "A 5-watt phone charger uses 5 units of energy to charge a smartphone in one hour. Similarly, a 100-watt incandescent light bulb uses 100 units of energy in one hour, and a typical clothes dryer uses about 4,000 units of energy in one hour. Note that LARGE appliances that primarily HEAT or COOL things use a lot more energy than people think.";
            
            switch(condition) {
                case 0: return baseText; // Control
                case 1: return scaleText; // Scale-use
                case 2: return heuristicText; // Heuristic
                case 3: return bothText; // Both
                default: return baseText;
            }
        }

        function getConditionName(condition) {
            switch(condition) {
                case 0: return "Control Condition (Basic Information)";
                case 1: return "Scale-Use Information Condition";
                case 2: return "Explicit Heuristic Condition";
                case 3: return "Both Interventions Condition";
                default: return "Unknown Condition";
            }
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Initialize the experiment
        function initializeExperiment() {
            // Randomly assign condition (0-3)
            state.condition = Math.floor(Math.random() * 4);
            
            // Shuffle appliances and behavioral choices
            state.shuffledAppliances = shuffleArray(appliances);
            state.shuffledChoices = shuffleArray(behavioralChoices);
            
            // Initialize arrays to hold user responses
            state.estimates = Array(appliances.length).fill(100);
            state.choices = Array(behavioralChoices.length).fill(null);
            
            // Reset indices
            state.currentApplianceIndex = 0;
            state.currentChoiceIndex = 0;
            
            // Set condition text
            document.getElementById('conditionText').textContent = getConditionText(state.condition);
            document.getElementById('conditionTextEstimation').textContent = getConditionText(state.condition);
            document.getElementById('conditionTextBehavioral').textContent = getConditionText(state.condition);
            
            // Update UI for first appliance
            updateApplianceUI();
            
            // Set total counts
            document.getElementById('totalAppliances').textContent = appliances.length;
            document.getElementById('totalChoices').textContent = behavioralChoices.length;
        }

        // Update the appliance UI based on current index
        function updateApplianceUI() {
            const currentAppliance = state.shuffledAppliances[state.currentApplianceIndex];
            document.getElementById('applianceName').textContent = currentAppliance.name;
            document.getElementById('currentApplianceNum').textContent = state.currentApplianceIndex + 1;
            
            // Update slider and number input with current estimate
            const estimateValue = state.estimates[state.currentApplianceIndex];
            document.getElementById('estimateSlider').value = estimateValue;
            document.getElementById('estimateValue').value = estimateValue;
            
            // Show/hide previous button
            document.getElementById('prevApplianceButton').classList.toggle('hidden', state.currentApplianceIndex === 0);
            
            // Update next button text for last appliance
            const nextButton = document.getElementById('nextApplianceButton');
            if (state.currentApplianceIndex === appliances.length - 1) {
                nextButton.textContent = 'Finish & Continue';
            } else {
                nextButton.textContent = 'Next';
            }
        }

        // Update the behavioral choice UI based on current index
        function updateChoiceUI() {
            const currentChoice = state.shuffledChoices[state.currentChoiceIndex];
            document.getElementById('choiceQuestion').textContent = currentChoice.question;
            document.getElementById('choiceA').textContent = currentChoice.a;
            document.getElementById('choiceB').textContent = currentChoice.b;
            document.getElementById('currentChoiceNum').textContent = state.currentChoiceIndex + 1;
            
            // Reset button styles
            document.querySelectorAll('.choice-btn').forEach(btn => {
                btn.classList.remove('bg-green-100', 'dark:bg-green-900', 'bg-red-100', 'dark:bg-red-900', 'border-green-500', 'border-red-500');
                btn.classList.add('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600');
            });
            
            // Hide feedback
            document.getElementById('feedbackArea').classList.add('hidden');
            
            // Show/hide previous button
            document.getElementById('prevChoiceButton').classList.toggle('hidden', state.currentChoiceIndex === 0);
            
            // Hide next button until choice is made
            document.getElementById('nextChoiceButton').classList.add('hidden');
        }

        // Calculate results
        function calculateResults() {
            // Calculate average error
            let totalError = 0;
            for (let i = 0; i < appliances.length; i++) {
                const actual = state.shuffledAppliances[i].actual;
                const estimate = state.estimates[i];
                const relativeError = Math.abs(estimate - actual) / actual;
                totalError += relativeError;
            }
            const avgError = totalError / appliances.length;
            
            // Calculate correlation (simplified version)
            const logActuals = state.shuffledAppliances.map(a => Math.log10(a.actual));
            const logEstimates = state.estimates.map(e => Math.log10(e));
            
            const meanLogActual = logActuals.reduce((sum, val) => sum + val, 0) / logActuals.length;
            const meanLogEstimate = logEstimates.reduce((sum, val) => sum + val, 0) / logEstimates.length;
            
            let numerator = 0;
            let denominatorActual = 0;
            let denominatorEstimate = 0;
            
            for (let i = 0; i < logActuals.length; i++) {
                const diffActual = logActuals[i] - meanLogActual;
                const diffEstimate = logEstimates[i] - meanLogEstimate;
                numerator += diffActual * diffEstimate;
                denominatorActual += diffActual * diffActual;
                denominatorEstimate += diffEstimate * diffEstimate;
            }
            
            const correlation = numerator / (Math.sqrt(denominatorActual) * Math.sqrt(denominatorEstimate));
            
            // Count correct choices
            const correctChoices = state.choices.filter(choice => choice === true).length;
            
            // Update results UI
            document.getElementById('resultCondition').textContent = getConditionName(state.condition);
            document.getElementById('avgErrorValue').textContent = ` ${(avgError * 100).toFixed(1)}%`;
            document.getElementById('correlationValue').textContent = ` ${correlation.toFixed(2)}`;
            document.getElementById('correctChoicesValue').textContent = ` ${correctChoices}/${behavioralChoices.length} (${(correctChoices / behavioralChoices.length * 100).toFixed(0)}%)`;
        }

        // Event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Start button click
            document.getElementById('startButton').addEventListener('click', function() {
                document.getElementById('introduction').classList.add('hidden');
                document.getElementById('conditionInfo').classList.remove('hidden');
                initializeExperiment();
            });
            
            // Start estimation button click
            document.getElementById('startEstimationButton').addEventListener('click', function() {
                document.getElementById('conditionInfo').classList.add('hidden');
                document.getElementById('estimationTask').classList.remove('hidden');
            });
            
            // Estimate slider and input sync
            document.getElementById('estimateSlider').addEventListener('input', function() {
                document.getElementById('estimateValue').value = this.value;
                state.estimates[state.currentApplianceIndex] = parseInt(this.value);
            });
            
            document.getElementById('estimateValue').addEventListener('input', function() {
                const value = parseInt(this.value) || 1;
                if (value < 1) this.value = 1;
                if (value > 12000) this.value = 12000;
                document.getElementById('estimateSlider').value = this.value;
                state.estimates[state.currentApplianceIndex] = parseInt(this.value);
            });
            
            // Navigation buttons for appliance estimation
            document.getElementById('prevApplianceButton').addEventListener('click', function() {
                if (state.currentApplianceIndex > 0) {
                    state.currentApplianceIndex--;
                    updateApplianceUI();
                }
            });
            
            document.getElementById('nextApplianceButton').addEventListener('click', function() {
                // Save current estimate
                state.estimates[state.currentApplianceIndex] = parseInt(document.getElementById('estimateValue').value);
                
                if (state.currentApplianceIndex < appliances.length - 1) {
                    // Go to next appliance
                    state.currentApplianceIndex++;
                    updateApplianceUI();
                } else {
                    // Finished with estimation task, move to behavioral task
                    document.getElementById('estimationTask').classList.add('hidden');
                    document.getElementById('behavioralTask').classList.remove('hidden');
                    updateChoiceUI();
                }
            });
            
            // Choice buttons
            document.getElementById('choiceA').addEventListener('click', function() {
                handleChoice('a');
            });
            
            document.getElementById('choiceB').addEventListener('click', function() {
                handleChoice('b');
            });
            
            // Navigation buttons for behavioral choices
            document.getElementById('prevChoiceButton').addEventListener('click', function() {
                if (state.currentChoiceIndex > 0) {
                    state.currentChoiceIndex--;
                    updateChoiceUI();
                }
            });
            
            document.getElementById('nextChoiceButton').addEventListener('click', function() {
                if (state.currentChoiceIndex < behavioralChoices.length - 1) {
                    // Go to next choice
                    state.currentChoiceIndex++;
                    updateChoiceUI();
                } else {
                    // Finished with behavioral task, show results
                    document.getElementById('behavioralTask').classList.add('hidden');
                    document.getElementById('resultsSection').classList.remove('hidden');
                    calculateResults();
                }
            });
            
            // Restart button
            document.getElementById('restartButton').addEventListener('click', function() {
                document.getElementById('resultsSection').classList.add('hidden');
                document.getElementById('introduction').classList.remove('hidden');
            });
        });

        // Handle user choice in behavioral task
        function handleChoice(choice) {
            const currentChoice = state.shuffledChoices[state.currentChoiceIndex];
            const correct = choice === currentChoice.correctAnswer;
            
            // Record result
            state.choices[state.currentChoiceIndex] = correct;
            
            // Highlight buttons
            const choiceABtn = document.getElementById('choiceA');
            const choiceBBtn = document.getElementById('choiceB');
            
            if (choice === 'a') {
                choiceABtn.classList.remove('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600');
                choiceABtn.classList.add(correct ? 'bg-green-100' : 'bg-red-100', correct ? 'dark:bg-green-900' : 'dark:bg-red-900', correct ? 'border-green-500' : 'border-red-500');
                if (!correct) {
                    choiceBBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600');
                    choiceBBtn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-500');
                }
            } else {
                choiceBBtn.classList.remove('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600');
                choiceBBtn.classList.add(correct ? 'bg-green-100' : 'bg-red-100', correct ? 'dark:bg-green-900' : 'dark:bg-red-900', correct ? 'border-green-500' : 'border-red-500');
                if (!correct) {
                    choiceABtn.classList.remove('bg-white', 'dark:bg-gray-700', 'border-gray-300', 'dark:border-gray-600');
                    choiceABtn.classList.add('bg-green-100', 'dark:bg-green-900', 'border-green-500');
                }
            }
            
            // Show feedback
            const feedbackArea = document.getElementById('feedbackArea');
            feedbackArea.classList.remove('hidden', 'bg-green-100', 'bg-red-100', 'dark:bg-green-900', 'dark:bg-red-900');
            feedbackArea.classList.add(correct ? 'bg-green-100' : 'bg-red-100', correct ? 'dark:bg-green-900' : 'dark:bg-red-900');
            feedbackArea.innerHTML = `
                <div class="font-bold mb-1">${correct ? '✓ Correct!' : '✗ Incorrect'}</div>
                <p>${currentChoice.explanation}</p>
            `;
            
            // Show next button
            document.getElementById('nextChoiceButton').classList.remove('hidden');
        }
    </script>


</body></html>