
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Reduction Planning Tasks</title>
    <style>
        :root {
            --primary-color: #2c73d2; /* Blue */
            --secondary-color: #2a9d8f; /* Teal */
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #212529;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
            --disabled-color: #6c757d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7f9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        header p {
            opacity: 0.8;
            font-size: 16px;
        }
        
        /* Tab navigation */
        .tabs {
            display: flex;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
            scrollbar-width: thin; /* For Firefox */
            scrollbar-color: var(--primary-color) var(--light-bg); /* For Firefox */
        }
        /* For Webkit browsers like Chrome, Safari */
        .tabs::-webkit-scrollbar {
            height: 6px;
        }
        .tabs::-webkit-scrollbar-track {
            background: var(--light-bg);
        }
        .tabs::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 3px;
            border: 1px solid var(--light-bg);
        }
        
        .tab-button {
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Dashboard components */
        .card {
            background-color: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .task-description {
            background-color: var(--light-bg);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col {
            flex: 1;
            padding: 0 10px;
            min-width: 300px;
            margin-bottom: 10px;
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 115, 210, 0.2);
        }
        
        .form-control.input-error {
            border-color: var(--error-color);
        }

        /* Buttons */
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
            margin-right: 5px;
            margin-bottom: 5px; /* Add margin for wrapping */
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2055a5;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #228276;
        }

        .btn-danger {
            background-color: var(--error-color);
            color: white;
        }

        .btn-danger:hover {
            background-color: #c82333;
        }

        .btn:disabled {
            background-color: var(--disabled-color);
            border-color: var(--disabled-color);
            cursor: not-allowed;
        }
        
        /* Profile card */
        .profile-card {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .profile-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .profile-card.selected {
            border-color: var(--primary-color);
            border-width: 2px;
            background-color: rgba(44, 115, 210, 0.05);
        }
        
        .profile-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        /* Action item */
        .action-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-item:hover {
            border-color: var(--primary-color);
            background-color: rgba(44, 115, 210, 0.05);
        }

        .action-item.added {
            opacity: 0.6;
            cursor: not-allowed;
            background-color: #f8f9fa;
        }
        
        .action-item h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .action-tag {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 12px;
            margin-right: 8px;
            margin-bottom: 5px; /* Add margin for wrapping */
            background-color: rgba(44, 115, 210, 0.1);
            color: var(--primary-color);
        }

        .action-tag-cost { background-color: rgba(255, 193, 7, 0.2); color: #856404; } /* Warning */
        .action-tag-effort { background-color: rgba(40, 167, 69, 0.1); color: #155724; } /* Success */
        .action-tag-savings { background-color: rgba(44, 115, 210, 0.1); color: var(--primary-color); }
        
        /* Plan display */
        .plan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .plan-item-content {
            flex-grow: 1;
            margin-right: 10px;
        }
        
        .plan-item-savings {
            white-space: nowrap;
            font-weight: 500;
            color: var(--secondary-color);
        }
        
        /* Seed Plan Editable Item */
        .seed-plan-item {
            display: flex;
            align-items: center;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }

        .seed-plan-item span {
            flex-grow: 1;
            margin-right: 10px;
        }

        .seed-plan-item input {
            width: 100px;
            text-align: right;
        }

        .seed-plan-item .remove-btn {
            margin-left: 10px;
        }

        /* Implementation Intention Item */
        .implementation-item {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            background-color: #f9f9f9;
        }

        .implementation-item strong {
            color: var(--primary-color);
        }

        .implementation-item .remove-btn {
            float: right;
        }

        /* Comparative Plan Items */
        .compare-plan-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .compare-plan-item:last-child {
            border-bottom: none;
        }
        .compare-plan-item input[type="checkbox"] {
            margin-right: 10px;
        }


        /* Progress container */
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 14px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            left: 100%;
            top: 0;
            bottom: 0;
            width: 2px;
            background-color: var(--error-color);
            transform: translateX(-1px);
        }

        .progress-fill.over-target {
            background-color: var(--warning-color);
        }
        
        /* AI feedback panel */
        .feedback-panel {
            background-color: #f0f7ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .feedback-panel p {
            margin-bottom: 10px;
        }
        .feedback-panel ul {
            padding-left: 20px;
            margin-bottom: 10px;
        }
        
        /* Background tabs */
        .info-section {
            margin-bottom: 25px;
        }
        
        .info-section h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .info-section p, .info-section ul {
            margin-bottom: 10px;
        }

        .info-section ul {
            padding-left: 20px;
        }

        .info-section strong {
            color: var(--secondary-color);
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .d-none { display: none; }
        .d-block { display: block; }
        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }

        
        /* Responsive design */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            .col {
                min-width: 100%;
                margin-bottom: 15px;
            }
            
            .tab-button {
                padding: 10px 12px;
                font-size: 14px;
            }

            header h1 { font-size: 20px; }
            header p { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <header>
                <h1>Energy Reduction Planning Tasks Dashboard</h1>
                <p>An interactive demo of experimental paradigms for human-AI collaboration in energy conservation</p>
            </header>
            
            <div class="tabs" id="dashboard-tabs">
                <button class="tab-button active" data-target="intro">Introduction</button>
                <button class="tab-button" data-target="estimate-plan">Estimate-then-Plan</button>
                <button class="tab-button" data-target="critique-revision">Critique & Revision</button>
                <button class="tab-button" data-target="seed-plan">Seed Plan Anchoring</button>
                <button class="tab-button" data-target="implementation">Implementation Intentions</button>
                <button class="tab-button" data-target="compare">Comparative Planning</button>
                <button class="tab-button" data-target="background">Background & Hypotheses</button>
            </div>
            
            <div class="tab-content">
                <!-- Introduction Tab -->
                <div id="intro" class="tab-pane active">
                    <h2>Energy Reduction Planning Experiments</h2>
                    <div class="task-description">
                        <p>This dashboard demonstrates various experimental tasks designed to study how people create energy reduction plans from abstract goals, with assistance from AI systems. Each task tests different cognitive aspects of planning and decision-making in energy conservation. These are demo versions using pre-generated AI responses.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Research Objectives</div>
                                <p>This research examines how people translate high-level energy reduction goals (e.g., "reduce energy by 10%") into concrete, appliance-specific actions. We explore how different forms of AI assistance affect:</p>
                                <ul class="mt-2" style="padding-left: 20px;">
                                    <li>Planning accuracy and efficiency</li>
                                    <li>Cognitive load during the planning process</li>
                                    <li>Correction of common energy misconceptions (Attari et al., 2010)</li>
                                    <li>Perceived agency and implementation intentions</li>
                                    <li>Trust in AI recommendations</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Try Different Task Paradigms</div>
                                <p>Each tab represents a different experimental paradigm:</p>
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="switchTab('estimate-plan')">Estimate-then-Plan</button>
                                    <button class="btn btn-primary" onclick="switchTab('critique-revision')">Critique & Revision</button>
                                    <button class="btn btn-primary" onclick="switchTab('seed-plan')">Seed Plan Anchoring</button>
                                    <button class="btn btn-primary" onclick="switchTab('implementation')">Implementation Intentions</button>
                                    <button class="btn btn-primary" onclick="switchTab('compare')">Comparative Planning</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Key Literature and Data Sources</div>
                        <p>This research builds on established findings in energy perception and conservation:</p>
                        <ul class="mt-2" style="padding-left: 20px;">
                            <li><strong>Attari et al. (2010)</strong> - Found that people systematically underestimate high-impact energy actions (heating, cooling, water heating) while overestimating low-impact, visible ones (lighting, electronics). This task demo incorporates this by providing feedback that corrects these biases.</li>
                            <li><strong>Marghetis et al. (2019)</strong> - Demonstrated that simple interventions (like heuristics or benchmarks) can improve relative energy judgments. Some AI feedback mimics these interventions.</li>
                            <li><strong>EIA Residential Energy Consumption Survey (RECS)</strong> - Source for realistic household profiles (usage levels, breakdowns).</li>
                            <li><strong>ENERGY STAR, DOE, NREL, Technical Reference Manuals (TRMs)</strong> - Sources for plausible, standardized energy savings estimates for specific actions.</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Estimate-then-Plan Tab -->
                <div id="estimate-plan" class="tab-pane">
                    <h2>Task 1: Estimate-then-Plan with Causal Explanations</h2>
                    <div class="task-description">
                        <p><strong>Phase 1:</strong> Estimate the percentage of total energy used by different household categories, based on the selected profile. Receive AI feedback (either basic numbers or detailed causal explanations). <br><strong>Phase 2:</strong> Create an energy reduction plan to meet the target using the calibrated knowledge.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                             <div class="card">
                                <div class="card-title">Step 1: Select Profile & Settings</div>
                                <div class="form-group">
                                    <label>Household Profile:</label>
                                    <div id="estimate-profiles">
                                        <!-- Profiles populated by JS -->
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="estimate-target">Reduction Target:</label>
                                    <select id="estimate-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15" selected>15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="estimate-format">Goal Display Format:</label>
                                    <select id="estimate-format" class="form-control">
                                        <option value="kwh" selected>kWh/year</option>
                                        <option value="dollars">$/year</option>
                                        <option value="percent">%</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label for="estimate-feedback-type">Feedback Type:</label>
                                    <select id="estimate-feedback-type" class="form-control">
                                        <option value="explanation" selected>With Explanations</option>
                                        <option value="basic">Basic (Numbers Only)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                             <div id="estimation-phase" class="card">
                                <div class="card-title">Step 2: Estimate Energy Use (%)</div>
                                <p>Estimate the % of total energy for each category. Total must be 100%.</p>
                                
                                <div class="form-group mt-3">
                                    <label for="estimate-heating">Heating:</label>
                                    <input type="number" id="estimate-heating" class="form-control" min="0" max="100" placeholder="%">
                                </div>
                                <div class="form-group">
                                    <label for="estimate-cooling">Cooling:</label>
                                    <input type="number" id="estimate-cooling" class="form-control" min="0" max="100" placeholder="%">
                                </div>
                                <div class="form-group">
                                    <label for="estimate-water">Water Heating:</label>
                                    <input type="number" id="estimate-water" class="form-control" min="0" max="100" placeholder="%">
                                </div>
                                <div class="form-group">
                                    <label for="estimate-appliances">Appliances (Fridge, Dryer, etc.):</label>
                                    <input type="number" id="estimate-appliances" class="form-control" min="0" max="100" placeholder="%">
                                </div>
                                <div class="form-group">
                                    <label for="estimate-lighting">Lighting:</label>
                                    <input type="number" id="estimate-lighting" class="form-control" min="0" max="100" placeholder="%">
                                </div>
                                <div class="form-group">
                                    <label for="estimate-electronics">Electronics (TV, Computer, etc.):</label>
                                    <input type="number" id="estimate-electronics" class="form-control" min="0" max="100" placeholder="%">
                                </div>
                                <p><strong>Total Estimated: <span id="estimate-total">0</span>%</strong></p>
                                <button id="submit-estimates" class="btn btn-primary">Submit Estimates & Get Feedback</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="estimate-feedback-panel" class="feedback-panel d-none">
                        <div class="feedback-title">Step 3: AI Feedback on Your Estimates</div>
                        <div id="estimate-feedback-content"></div>
                        <button id="continue-to-planning" class="btn btn-secondary mt-2">Continue to Planning Phase</button>
                    </div>
                    
                    <div id="planning-phase" class="d-none">
                        <h3>Step 4: Energy Reduction Planning</h3>
                        <p>Use the feedback and available actions to create a plan to meet your target: <strong id="planning-goal-display"></strong>.</p>
                        
                        <div class="row mt-3">
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Available Actions</div>
                                    <input type="text" id="estimate-action-search" class="form-control mb-3" placeholder="Search actions...">
                                    <div id="estimate-available-actions" style="max-height: 500px; overflow-y: auto;">
                                        <!-- Actions populated by JS -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Your Energy Reduction Plan</div>
                                    
                                    <div id="estimate-selected-plan" style="min-height: 200px;">
                                        <p id="estimate-empty-plan-message">Select actions from the left to add them here.</p>
                                    </div>
                                    
                                    <div class="progress-container">
                                        <div class="progress-label">
                                            <span>Target: <span id="estimate-reduction-target">0</span></span>
                                            <span>Current Plan: <span id="estimate-current-savings">0</span></span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="estimate-progress-fill" class="progress-fill" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                    
                                    <button id="submit-estimate-plan" class="btn btn-primary">Submit Final Plan</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="estimate-plan-feedback" class="feedback-panel d-none">
                            <div class="feedback-title">Final Plan Analysis</div>
                            <div id="estimate-plan-feedback-content"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Critique & Revision Tab -->
                <div id="critique-revision" class="tab-pane">
                     <h2>Task 2: LLM Critique-and-Revision Loop</h2>
                    <div class="task-description">
                        <p><strong>Phase 1:</strong> Draft an initial energy-saving plan to meet the target. <br><strong>Phase 2:</strong> Request an AI critique (basic or detailed) of your plan's accuracy and balance. <br><strong>Phase 3:</strong> Revise your plan based on the critique. You can request critique again.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Step 1: Select Profile & Settings</div>
                                <div class="form-group">
                                    <label for="critique-household">Household Profile:</label>
                                    <select id="critique-household" class="form-control">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="critique-target">Reduction Target:</label>
                                    <select id="critique-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15" selected>15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="critique-detail">Feedback Detail:</label>
                                    <select id="critique-detail" class="form-control">
                                        <option value="detailed" selected>Detailed Feedback</option>
                                        <option value="basic">Basic Feedback</option>
                                    </select>
                                </div>
                                <button id="start-critique-task" class="btn btn-primary">Start Drafting Plan</button>
                            </div>
                            
                            <div id="critique-actions-card" class="card d-none">
                                <div class="card-title">Available Actions</div>
                                <input type="text" id="critique-search" class="form-control mb-3" placeholder="Search actions...">
                                <div id="critique-actions" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Actions populated by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div id="critique-plan-card" class="card d-none">
                                <div class="card-title">Step 2: Your Plan <span id="revision-cycle">(Initial Draft)</span></div>
                                <p>Target: <strong id="critique-goal-display"></strong></p>

                                <div id="critique-plan" style="min-height: 200px;">
                                    <p id="empty-critique-plan">Select actions from the left panel to add to your plan.</p>
                                </div>
                                
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Target: <span id="critique-target-value">0</span></span>
                                        <span>Current Plan: <span id="critique-current-savings">0</span></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="critique-progress" class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                </div>
                                
                                <div class="mt-3">
                                    <button id="request-critique" class="btn btn-secondary" disabled>Request AI Critique</button>
                                    <button id="submit-critique-plan" class="btn btn-primary" disabled>Submit Final Plan</button>
                                </div>
                            </div>
                            
                            <div id="critique-feedback-panel" class="feedback-panel d-none">
                                <div class="feedback-title">Step 3: AI Critique</div>
                                <div id="critique-feedback-content"></div>
                                <p class="mt-2">You can now revise your plan and request critique again, or submit.</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seed Plan Anchoring Tab -->
                <div id="seed-plan" class="tab-pane">
                    <h2>Task 3: Seed Plan Anchoring</h2>
                    <div class="task-description">
                        <p><strong>Step 1:</strong> Receive an AI-generated initial plan (seed) which may be accurate or biased (e.g., overemphasizing lighting/electronics, reflecting common misperceptions). <br><strong>Step 2:</strong> Edit the savings values (kWh) for each action in the seed plan until the total exactly matches the target goal. You cannot add or remove actions, only change the numbers. This tests anchoring bias.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Step 1: Select Profile & Settings</div>
                                <div class="form-group">
                                    <label for="seed-household">Household Profile:</label>
                                    <select id="seed-household" class="form-control">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="seed-target">Reduction Target:</label>
                                    <select id="seed-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15" selected>15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="seed-format">Goal Format (for display only - editing is in kWh):</label>
                                    <select id="seed-format" class="form-control">
                                        <option value="kwh" selected>kWh/year</option>
                                        <option value="percent">%</option>
                                        <option value="dollars">$/year</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="seed-quality">Seed Plan Quality:</label>
                                    <select id="seed-quality" class="form-control">
                                        <option value="accurate" selected>Accurate Seed Plan</option>
                                        <option value="biased">Biased Seed Plan (Lighting/Electronics Heavy)</option>
                                    </select>
                                </div>
                                <button id="generate-seed" class="btn btn-primary">Generate AI Seed Plan</button>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div id="seed-plan-card" class="card d-none">
                                <div class="card-title">Step 2: Edit AI Seed Plan</div>
                                <p>Adjust the kWh savings for each action until the total matches the target: <strong id="seed-goal-display"></strong>.</p>
                                <div class="mb-2" style="font-size: 14px; color: var(--disabled-color);">
                                    Edits made: <span id="edit-count">0</span> | Initial total: <span id="seed-initial-total">0</span> kWh
                                </div>
                                
                                <div id="seed-plan-display" style="min-height: 200px;">
                                    <!-- Seed plan populated by JS -->
                                </div>
                                
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Target: <span id="seed-target-value">0</span> kWh</span>
                                        <span>Current Plan: <span id="seed-current-savings">0</span> kWh</span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="seed-progress" class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                    <p id="seed-match-message" class="text-center mt-2" style="color: var(--success-color); display: none;">Target matched!</p>
                                </div>
                                
                                <button id="submit-seed-plan" class="btn btn-primary" disabled>Submit Final Plan</button>
                            </div>
                            
                            <div id="seed-feedback" class="feedback-panel d-none">
                                <div class="feedback-title">Final Plan Analysis</div>
                                <div id="seed-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Implementation Intentions Tab -->
                <div id="implementation" class="tab-pane">
                    <h2>Task 4: Implementation-Intention Wizard</h2>
                    <div class="task-description">
                        <p><strong>Step 1:</strong> Select high-impact actions relevant to the household. <br><strong>Step 2:</strong> For each selected action, create a specific "if-then" implementation intention. An optional AI wizard can provide suggestions for effective cues and actions. This focuses on bridging the intention-action gap.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                             <div class="card">
                                <div class="card-title">Step 1: Select Profile & Settings</div>
                                <div class="form-group">
                                    <label for="implementation-household">Household Profile:</label>
                                    <select id="implementation-household" class="form-control">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="implementation-assistance">AI Wizard Assistance:</label>
                                    <select id="implementation-assistance" class="form-control">
                                        <option value="enabled" selected>AI Wizard Enabled</option>
                                        <option value="disabled">No Assistance</option>
                                    </select>
                                </div>
                                <button id="start-implementation-task" class="btn btn-primary">Load Recommended Actions</button>
                            </div>

                            <div id="implementation-actions-card" class="card d-none">
                                <div class="card-title">Step 2: Select Actions</div>
                                <p>Choose actions to create implementation intentions for:</p>
                                <div id="implementation-actions" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                                    <!-- Actions populated by JS -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                             <div id="implementation-form" class="card d-none">
                                <div class="card-title">Step 3: Create Implementation Intention</div>
                                <div id="current-action-info" class="mb-3 p-2" style="background-color: #f8f9fa; border-radius: 4px;">
                                    <!-- Current action info populated by JS -->
                                </div>
                                
                                <div class="form-group">
                                    <label for="if-condition"><strong>IF</strong> (Situation/Cue):</label>
                                    <textarea id="if-condition" class="form-control" rows="2" placeholder="e.g., 'I leave a room...' or 'It's a sunny winter day...'"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label for="then-action"><strong>THEN</strong> I will (Specific Action):</label>
                                    <textarea id="then-action" class="form-control" rows="2" placeholder="e.g., 'turn off the lights' or 'open the south-facing curtains'"></textarea>
                                </div>
                                
                                <div id="wizard-suggestions" class="d-none" style="margin: 15px 0; padding: 15px; background-color: #e2f3ff; border-radius: 4px;">
                                    <h4 style="margin-top: 0; font-size: 16px;">AI Wizard Suggestions:</h4>
                                    <div id="wizard-content">
                                        <!-- Suggestions populated by JS -->
                                    </div>
                                </div>
                                
                                <div class="d-flex justify-content-between">
                                    <button id="cancel-implementation" class="btn btn-secondary">Cancel</button>
                                    <button id="save-implementation" class="btn btn-primary">Save Intention</button>
                                </div>
                            </div>
                            
                            <div id="implementation-plan-card" class="card d-none">
                                <div class="card-title">Your Implementation Plan</div>
                                <div id="implementation-plan" style="min-height: 150px;">
                                    <p id="empty-implementation-plan">Select actions from the left panel to add implementation intentions.</p>
                                </div>
                                <button id="submit-implementation" class="btn btn-primary mt-3">Submit Final Implementation Plan</button>
                            </div>
                            
                            <div id="implementation-feedback" class="feedback-panel d-none">
                                <div class="feedback-title">Implementation Plan Analysis</div>
                                <div id="implementation-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparative Planning Tab -->
                <div id="compare" class="tab-pane">
                    <h2>Task 5: Comparative Planning</h2>
                    <div class="task-description">
                        <p>Compare human-created and AI-generated energy reduction plans. Depending on the condition, you'll either: <br><strong>Human-First:</strong> Create your plan, then see and evaluate the AI's plan. <br><strong>AI-First:</strong> See the AI's plan, then create your own plan and evaluate. <br>Finally, choose to adopt the human plan, the AI plan, or create a hybrid.</p>
                    </div>
                    
                    <div class="card" id="compare-setup">
                        <div class="card-title">Step 1: Select Profile & Settings</div>
                        <div class="row">
                            <div class="col">
                                <div class="form-group">
                                    <label for="compare-household">Household Profile:</label>
                                    <select id="compare-household" class="form-control">
                                        <!-- Options populated by JS -->
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="compare-target">Reduction Target:</label>
                                    <select id="compare-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15" selected>15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="form-group">
                                    <label for="compare-order">Planning Order:</label>
                                    <select id="compare-order" class="form-control">
                                        <option value="human-first" selected>Human First, Then AI</option>
                                        <option value="ai-first">AI First, Then Human</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <button id="start-compare" class="btn btn-primary mt-2">Start Planning Process</button>
                    </div>
                    
                    <!-- Planning Area (Human or AI view) -->
                    <div id="compare-planning-area" class="d-none">
                        <div id="compare-phase-indicator" class="card mb-3">
                            <div class="card-title">Current Phase: <span id="compare-phase-name"></span></div>
                            <p id="compare-phase-description"></p>
                        </div>
                        
                        <div class="row">
                             <div class="col">
                                <div id="compare-actions-card" class="card">
                                    <div class="card-title">Available Actions</div>
                                    <input type="text" id="compare-search" class="form-control mb-3" placeholder="Search actions...">
                                    <div id="compare-actions" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Actions populated by JS -->
                                    </div>
                                </div>
                            </div>
                            <div class="col">
                                <div class="card">
                                    <div class="card-title" id="compare-current-plan-title">Your Plan</div>
                                    <p>Target: <strong id="compare-goal-display"></strong></p>
                                    
                                    <div id="compare-plan" style="min-height: 200px;">
                                        <p id="empty-compare-plan">Select actions from the left panel to add to the plan.</p>
                                    </div>
                                    
                                    <div class="progress-container">
                                        <div class="progress-label">
                                            <span>Target: <span id="compare-target-value">0</span></span>
                                            <span>Current Plan: <span id="compare-current-savings">0</span></span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="compare-progress" class="progress-fill" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                    
                                    <button id="compare-next-phase" class="btn btn-primary mt-3">Continue</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Comparison Phase -->
                    <div id="comparison-phase" class="d-none">
                        <h3>Step 3: Compare Plans and Choose</h3>
                        <p>Review the Human Plan and the AI Plan. Then choose your preferred approach below.</p>
                        
                        <div class="row">
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Human Plan (<span id="human-plan-total">0</span> kWh)</div>
                                    <div id="human-plan-display" style="min-height: 250px; max-height: 400px; overflow-y: auto;">
                                        <!-- Human plan populated by JS -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">AI Plan (<span id="ai-plan-total">0</span> kWh)</div>
                                    <div id="ai-plan-display" style="min-height: 250px; max-height: 400px; overflow-y: auto;">
                                        <!-- AI plan populated by JS -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <div class="card-title">Step 4: Your Final Choice</div>
                            
                            <div class="form-group">
                                <label>Select which plan to proceed with:</label>
                                <div class="mt-2 mb-2">
                                    <label class="d-block mb-2">
                                        <input type="radio" name="final-plan-choice" value="human" style="margin-right: 10px;"> Use Human Plan
                                    </label>
                                    <label class="d-block mb-2">
                                        <input type="radio" name="final-plan-choice" value="ai" style="margin-right: 10px;"> Use AI Plan
                                    </label>
                                    <label class="d-block">
                                        <input type="radio" name="final-plan-choice" value="hybrid" style="margin-right: 10px;"> Create Hybrid Plan
                                    </label>
                                </div>
                            </div>
                            
                            <div id="hybrid-editor" class="d-none">
                                <p>Select actions from both plans above using the checkboxes to create your hybrid plan.</p>
                                <div class="card mt-2">
                                    <div class="card-title">Your Hybrid Plan</div>
                                    <div id="hybrid-plan" style="min-height: 150px;">
                                        <p id="empty-hybrid-plan">No actions selected yet.</p>
                                    </div>
                                    <div class="progress-container">
                                        <div class="progress-label">
                                            <span>Target: <span id="hybrid-target-value">0</span></span>
                                            <span>Current Hybrid Plan: <span id="hybrid-current-savings">0</span></span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="hybrid-progress" class="progress-fill" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mt-3">
                                <label for="choice-justification">Why did you make this choice?</label>
                                <textarea id="choice-justification" class="form-control" rows="3" placeholder="Please explain your reasoning..."></textarea>
                            </div>
                            
                            <button id="submit-comparison" class="btn btn-primary" disabled>Submit Final Choice</button>
                        </div>
                        
                        <div id="comparison-feedback" class="feedback-panel d-none">
                            <div class="feedback-title">Comparative Analysis</div>
                            <div id="comparison-feedback-content"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Background & Hypotheses Tab -->
                <div id="background" class="tab-pane">
                    <h2>Background Information & Research Hypotheses</h2>
                    
                    <div class="info-section">
                        <h3>Theoretical Framework</h3>
                        <p>This research integrates several theoretical domains:</p>
                        <ul>
                            <li><strong>Mental Models & Heuristics:</strong> People often have systematic misconceptions about energy use, typically underestimating high-impact actions (heating, cooling, water heating) while overestimating visible, low-wattage activities (lighting). This bias (studied by <strong>Attari et al., 2010</strong>) leads to suboptimal planning. People rely on simple heuristics (e.g., visibility, frequency of use) rather than accurate energy knowledge.</li>
                            <li><strong>Cognitive Load Theory:</strong> Complex planning tasks impose cognitive load. AI assistance can potentially reduce extraneous load (e.g., calculations, information search) but might also reduce germane load (deep processing needed for learning) if it's too automated.</li>
                            <li><strong>Anchoring and Adjustment:</strong> Initial information (like an AI seed plan) can strongly influence subsequent judgments, leading to insufficient adjustment even if the anchor is biased.</li>
                            <li><strong>Implementation Intentions:</strong> Specific "if-then" plans (studied by <strong>Gollwitzer & Sheeran, 2006</strong>) significantly increase the likelihood of performing intended behaviors by linking situational cues to actions, overcoming the "intention-action gap".</li>
                            <li><strong>Human-AI Collaboration & Trust:</strong> How humans interact with AI (e.g., receiving critique, editing AI output, co-creating) affects outcomes, perceived agency, and trust calibration. Explanations can influence trust and appropriate reliance.</li>
                             <li><strong>Information Format Effects:</strong> How information is presented (e.g., kWh vs. % vs. $) impacts comprehension and decision accuracy (<strong>Schley & DeKay, 2015</strong> found kWh format often leads to better quantitative reasoning).</li>
                        </ul>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Task 1: Estimate-then-Plan Hypotheses</div>
                                <ul>
                                    <li><strong>H1 (Mental Model Correction):</strong> Explanatory feedback will lead to greater improvement in estimation accuracy (closer to ground truth) and better post-task knowledge compared to numeric-only feedback.</li>
                                    <li><strong>H2 (Planning):</strong> Participants receiving explanatory feedback will create plans that are more accurate (closer to the target) and feature a higher proportion of high-impact actions.</li>
                                    <li><strong>H3 (Format Interaction):</strong> The typical advantage of kWh format for accuracy might be reduced when rich explanatory feedback is available, as explanations could help bridge comprehension gaps for % or $ formats.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task 2: Critique-and-Revision Hypotheses</div>
                                <ul>
                                    <li><strong>H1 (Accuracy):</strong> Detailed critique will lead to larger improvements in plan accuracy (difference between initial and final plan) compared to basic critique.</li>
                                    <li><strong>H2 (Plan Balance):</strong> Detailed critique focusing on overlooked high-impact areas will lead to final plans with a greater proportion of savings from heating/cooling/water heating compared to basic critique.</li>
                                    <li><strong>H3 (Iteration):</strong> Allowing multiple critique-revision cycles will lead to more accurate final plans than a single cycle, especially with detailed feedback.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task 3: Seed Plan Anchoring Hypotheses</div>
                                <ul>
                                    <li><strong>H1 (Anchoring):</strong> Participants starting with Biased seed plans will produce final plans whose savings allocations deviate more significantly from ground truth values compared to those starting with Accurate seeds, even if the total savings match the target.</li>
                                    <li><strong>H2 (Adjustment):</strong> Edit distance (total kWh change from seed) will be smaller for the Biased seed condition, indicating insufficient adjustment from the flawed anchor.</li>
                                     <li><strong>H3 (Format Amplification):</strong> If format were also manipulated here, anchoring effects might be stronger with % or $ formats due to increased cognitive load for conversion, making people rely more on the initial numbers provided.</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Task 4: Implementation Intentions Hypotheses</div>
                                <ul>
                                    <li><strong>H1 (Quality):</strong> AI wizard assistance will lead to the creation of implementation intentions that are rated as more specific and actionable (clearer cues and actions).</li>
                                    <li><strong>H2 (Feasibility/Adoption):</strong> AI assistance might increase the perceived feasibility and likelihood of adopting intentions for complex or high-effort actions by providing concrete examples.</li>
                                    <li><strong>H3 (Agency vs. Quality):</strong> While AI assistance might improve II quality, self-generated intentions (No Assistance condition) might be associated with higher perceived ownership or personal commitment.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task 5: Comparative Planning Hypotheses</div>
                                <ul>
                                    <li><strong>H1 (Order Effect - Choice):</strong> Participants in the Human-First condition will be more likely to choose the human plan or a human-dominant hybrid compared to the AI-First condition.</li>
                                    <li><strong>H2 (Order Effect - Content):</strong> Participants in the AI-First condition may incorporate more novel or high-impact AI suggestions into their own subsequent plan or the final hybrid plan.</li>
                                    <li><strong>H3 (Hybrid Outcome):</strong> Hybrid plans created by actively selecting from both human and AI options may achieve higher accuracy or better feasibility scores than either plan alone, reflecting optimal integration.</li>
                                    <li><strong>H4 (Trust/Justification):</strong> Justifications for plan choice will reflect perceptions of AI competence (accuracy, high-impact suggestions) versus human relevance (feasibility, personal fit).</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Cross-Task Hypotheses</div>
                                <ul>
                                    <li><strong>H1 (Cognitive Load):</strong> Self-planning tasks (or initial phases) will report higher cognitive load (e.g., via NASA-TLX if measured) compared to tasks involving significant AI scaffolding (Critique, Seed Plan Editing, Implementation Wizard).</li>
                                    <li><strong>H2 (Agency):</strong> Tasks where the human primarily generates content (Estimate-then-Plan, initial Critique draft, Human-First Compare) will yield higher ratings of perceived agency/ownership compared to tasks involving reviewing/editing AI output (Seed Plan, AI-First Compare).</li>
                                    <li><strong>H3 (Accuracy vs. Assistance):</strong> Generally, AI-assisted tasks are expected to yield more accurate plans than unaided planning, but overly passive roles (like just accepting a seed plan) might not improve accuracy as much as active collaboration or feedback-driven revision.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>Key Literature References</h3>
                        <div>
                            <p><strong>Attari, S. Z., DeKay, M. L., Davidson, C. I., & Bruine de Bruin, W. (2010).</strong> Public perceptions of energy consumption and savings. <em>Proceedings of the National Academy of Sciences, 107</em>(37), 16054-16059.</p>
                            <p class="mt-1"><em>Key finding:</em> Systematic misperceptions - underestimation of high-impact savings (heating/cooling, water heating, dryer) and overestimation of low-impact savings (lighting, electronics).</p>
                        </div>
                        <div class="mt-3">
                            <p><strong>Marghetis, T., Attari, S. Z., & Landy, D. (2019).</strong> Simple interventions can correct misperceptions of home energy use. <em>Nature Energy, 4</em>(10), 874-881.</p>
                             <p class="mt-1"><em>Key finding:</em> Providing benchmark examples and simple heuristics (like "multiply watts by hours") significantly improved people's quantitative estimates of energy use.</p>
                        </div>
                        <div class="mt-3">
                            <p><strong>Gollwitzer, P. M., & Sheeran, P. (2006).</strong> Implementation intentions and goal achievement: A meta‐analysis of effects and processes. <em>Advances in Experimental Social Psychology, 38</em>, 69-119.</p>
                             <p class="mt-1"><em>Key finding:</em> Forming specific "if [cue], then I will [action]" plans dramatically increases the likelihood of goal attainment compared to general goal intentions.</p>
                        </div>
                         <div class="mt-3">
                            <p><strong>Schley, D. R., & DeKay, M. L. (2015).</strong> Improving energy decisions through better understanding of energy consumption. <em>Journal of Experimental Psychology: Applied, 21</em>(2), 190–207.</p>
                             <p class="mt-1"><em>Key finding:</em> Absolute energy units (like kWh) tend to facilitate more accurate quantitative reasoning and planning compared to relative units (%) or derived units ($).</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // --- Data Definitions ---
        const households = {
            suburban: {
                id: "suburban",
                name: "Suburban Family Home",
                description: "2,500 sq ft, 4 occupants, moderate climate",
                annualKwh: 12000,
                annualCost: 1440, // Assuming $0.12/kWh
                breakdown: { // Ground truth % for estimation task
                    heating: 35, cooling: 15, water: 20, appliances: 15, lighting: 8, electronics: 7
                }
            },
            apartment: {
                id: "apartment",
                name: "Urban Apartment",
                description: "900 sq ft, 2 occupants, mild climate",
                annualKwh: 7000,
                annualCost: 840,
                breakdown: {
                    heating: 25, cooling: 10, water: 25, appliances: 20, lighting: 10, electronics: 10
                }
            },
            rural: {
                id: "rural",
                name: "Rural Home (Electric Heat)",
                description: "1,800 sq ft, 3 occupants, cold climate",
                annualKwh: 15000,
                annualCost: 1800,
                breakdown: {
                    heating: 45, cooling: 8, water: 18, appliances: 14, lighting: 7, electronics: 8
                }
            }
        };

        // Standardized annual savings, assuming baseline ~10-12k kWh/yr. Cost @ $0.12/kWh
        // Added rough cost estimate ($) and effort (low/medium/high)
        const energyActions = [
             { id: "action1", category: "heating", name: "Lower thermostat by 2°F in winter (68°F -> 66°F)", savingsKwh: 550, cost: 0, effort: "low" },
            { id: "action2", category: "heating", name: "Install programmable thermostat", savingsKwh: 700, cost: 150, effort: "medium" },
            { id: "action3", category: "heating", name: "Upgrade to high-efficiency heat pump (from electric resistance)", savingsKwh: 3500, cost: 7000, effort: "high" },
            { id: "action4", category: "heating", name: "Add attic insulation (R-30 to R-60)", savingsKwh: 1100, cost: 1800, effort: "high" },
            { id: "action5", category: "cooling", name: "Raise thermostat by 2°F in summer (76°F -> 78°F)", savingsKwh: 225, cost: 0, effort: "low" },
            { id: "action6", category: "cooling", name: "Use ceiling fans to supplement AC", savingsKwh: 175, cost: 0, effort: "low" },
            { id: "action7", category: "cooling", name: "Replace AC older than 15 years with ENERGY STAR", savingsKwh: 500, cost: 3500, effort: "high" },
            { id: "action8", category: "waterHeating", name: "Lower water heater temp (140°F -> 120°F)", savingsKwh: 450, cost: 0, effort: "low" },
            { id: "action9", category: "waterHeating", name: "Install low-flow showerheads (2)", savingsKwh: 350, cost: 40, effort: "low" },
            { id: "action10", category: "waterHeating", name: "Wash clothes in cold water", savingsKwh: 225, cost: 0, effort: "low" },
            { id: "action11", category: "waterHeating", name: "Upgrade to heat pump water heater", savingsKwh: 1400, cost: 1600, effort: "high" },
            { id: "action12", category: "appliances", name: "Replace refrigerator (15+ yrs old) with ENERGY STAR", savingsKwh: 550, cost: 800, effort: "medium" },
            { id: "action13", category: "appliances", name: "Run dishwasher only when full", savingsKwh: 100, cost: 0, effort: "low" },
            { id: "action14", category: "appliances", name: "Air dry clothes instead of using electric dryer (5 loads/wk)", savingsKwh: 375, cost: 20, effort: "medium" },
            { id: "action15", category: "lighting", name: "Replace 10 incandescent bulbs with LEDs", savingsKwh: 150, cost: 30, effort: "low" },
            { id: "action16", category: "lighting", name: "Install dimmer switches (5 rooms)", savingsKwh: 60, cost: 125, effort: "medium" },
            { id: "action17", category: "lighting", name: "Use motion sensors for outdoor lighting", savingsKwh: 80, cost: 100, effort: "medium" },
            { id: "action18", category: "electronics", name: "Use advanced power strips (TV, computer)", savingsKwh: 125, cost: 35, effort: "low" },
            { id: "action19", category: "electronics", name: "Enable power management on computers", savingsKwh: 75, cost: 0, effort: "low" },
            { id: "action20", category: "electronics", name: "Unplug chargers when not in use", savingsKwh: 40, cost: 0, effort: "low" }
        ].map(a => ({ ...a, savingsDollars: Math.round(a.savingsKwh * 0.12) })); // Add dollar savings dynamically

        // AI Response Templates (Simplified examples)
        const aiResponses = {
            estimationFeedback: (estimate, actual, type) => {
                 const diff = estimate - actual;
                 let feedback = "";
                 if (Math.abs(diff) <= 5) {
                     feedback = `Your estimate of ${estimate}% is very close to the typical value of ${actual}%. `;
                     if (type === 'explanation') feedback += `This category represents a moderate part of energy use. `;
                 } else if (diff > 5 && diff <= 15) {
                     feedback = `Your estimate of ${estimate}% is slightly high compared to the typical ${actual}%. `;
                 } else if (diff > 15) {
                     feedback = `Your estimate of ${estimate}% is significantly higher than the typical ${actual}%. People often overestimate this category. `;
                 } else if (diff < -5 && diff >= -15) {
                     feedback = `Your estimate of ${estimate}% is slightly low compared to the typical ${actual}%. `;
                 } else { // diff < -15
                     feedback = `Your estimate of ${estimate}% is significantly lower than the typical ${actual}%. People often underestimate this category. `;
                 }
                 
                 if (type === 'explanation') {
                     if (category === 'heating' && diff < -10) feedback += "Heating large spaces requires substantial energy, especially in colder climates, making it a primary energy user. ";
                     if (category === 'water' && diff < -10) feedback += "Heating water is very energy-intensive due to water's high heat capacity and frequent daily use. ";
                     if (category === 'lighting' && diff > 10) feedback += "Modern lighting (especially LEDs) is very efficient; despite being visible, it's often a small fraction of total use. ";
                     if (category === 'electronics' && diff > 10) feedback += "While numerous, most modern electronics use relatively little power compared to heating/cooling appliances. ";
                 }
                 return feedback;
            },
            critique: (plan, targetKwh, type) => {
                const currentKwh = plan.reduce((sum, action) => sum + action.savingsKwh, 0);
                const gap = targetKwh - currentKwh;
                const highImpactCategories = ['heating', 'cooling', 'waterHeating'];
                const planHighImpactSavings = plan.filter(a => highImpactCategories.includes(a.category)).reduce((sum, a) => sum + a.savingsKwh, 0);
                const planLowImpactSavings = plan.filter(a => ['lighting', 'electronics'].includes(a.category)).reduce((sum, a) => sum + a.savingsKwh, 0);
                
                let feedback = "";

                // Accuracy feedback
                if (Math.abs(gap) < 0.05 * targetKwh) {
                    feedback += `<li>Your plan is very close to the target of ${targetKwh.toFixed(0)} kWh. Well done!</li>`;
                } else if (gap > 0) {
                    feedback += `<li>Your plan is short of the target by ${gap.toFixed(0)} kWh. Consider adding more actions.</li>`;
                } else {
                     feedback += `<li>Your plan exceeds the target by ${Math.abs(gap).toFixed(0)} kWh. You could remove less preferred actions if needed.</li>`;
                }

                // Balance feedback (Attari bias check)
                if (plan.length > 0 && planLowImpactSavings > planHighImpactSavings * 0.5 && planHighImpactSavings < 0.6 * targetKwh) {
                     feedback += `<li>Your plan seems to rely heavily on lower-impact actions (lighting, electronics).`;
                    if (type === 'detailed') {
                        feedback += ` Consider adding actions related to heating, cooling, or water heating, as these often provide much larger savings per action, reflecting common misperceptions identified by Attari et al. (2010).</li>`;
                    } else {
                        feedback += ` Consider adding higher-impact actions.</li>`;
                    }
                } else if (plan.length > 0 && planHighImpactSavings > 0.8 * currentKwh) {
                     feedback += `<li>Your plan effectively targets high-impact areas like heating/cooling/water heating.</li>`;
                } else {
                     feedback += `<li>Your plan includes a mix of action types.</li>`;
                }

                // Suggestions (for detailed feedback)
                if (type === 'detailed' && gap > 0) {
                    const potentialHighImpact = energyActions
                        .filter(action => highImpactCategories.includes(action.category) && !plan.some(p => p.id === action.id))
                        .sort((a, b) => b.savingsKwh - a.savingsKwh)
                        .slice(0, 2);
                    if (potentialHighImpact.length > 0) {
                         feedback += `<li>Suggestion: To reach your target, consider adding high-impact actions like '${potentialHighImpact[0].name}' (~${potentialHighImpact[0].savingsKwh} kWh) ${potentialHighImpact.length > 1 ? `or '${potentialHighImpact[1].name}' (~${potentialHighImpact[1].savingsKwh} kWh)` : ''}.</li>`;
                    }
                }
                
                return `<ul>${feedback}</ul>`;
            },
            implementationSuggestion: (category) => {
                const suggestions = {
                    heating: ["IF I feel cold in the evening, THEN I will put on a sweater first.", "WHEN I leave for work, THEN I will set the thermostat to the 'away' temperature.", "IF it's a sunny winter day, THEN I will open curtains on south-facing windows."],
                    cooling: ["WHEN the outside temperature drops in the evening, THEN I will open windows instead of using AC.", "IF I leave a room with a window AC unit, THEN I will turn it off.", "WHEN using the AC, THEN I will ensure all windows and doors are closed."],
                    waterHeating: ["WHEN I take a shower, THEN I will aim for 5 minutes or less.", "IF I wash clothes, THEN I will use the cold water setting.", "WHEN doing dishes by hand, THEN I will not let the hot water run continuously."],
                    appliances: ["WHEN loading the dishwasher, THEN I will wait until it's completely full.", "IF the weather is good, THEN I will hang clothes to dry.", "WHEN cooking, THEN I will match the pot size to the burner size."],
                    lighting: ["WHEN I leave a room, THEN I will turn off the lights.", "IF I need light in one spot, THEN I will use a task lamp instead of overhead lighting.", "WHEN a bulb burns out, THEN I will replace it with an LED."],
                    electronics: ["WHEN I go to bed, THEN I will turn off my computer monitor and TV completely.", "IF I buy new electronics, THEN I will check their ENERGY STAR rating.", "WHEN devices are fully charged, THEN I will unplug the chargers."]
                };
                const options = suggestions[category] || suggestions.electronics; // Default
                return options[Math.floor(Math.random() * options.length)];
            },
             seedPlanFeedback: (finalPlan, initialPlan, seedQuality, targetKwh) => {
                const finalTotal = finalPlan.reduce((sum, item) => sum + item.savingsKwh, 0);
                const initialTotal = initialPlan.reduce((sum, item) => sum + item.savingsKwh, 0);
                const groundTruthTotal = initialPlan.reduce((sum, item) => sum + (energyActions.find(a => a.id === item.id)?.savingsKwh || 0), 0); // Sum of *actual* savings for the seed actions
                const finalDeviationFromGround = finalPlan.reduce((sum, item) => {
                    const groundTruthAction = energyActions.find(a => a.id === item.id);
                    return sum + Math.abs(item.savingsKwh - (groundTruthAction ? groundTruthAction.savingsKwh : 0));
                }, 0);
                 const editDistance = initialPlan.reduce((sum, item, index) => {
                     return sum + Math.abs(item.savingsKwh - finalPlan[index].savingsKwh);
                 }, 0);

                 let feedback = `Your final plan total is ${finalTotal.toFixed(0)} kWh, matching the target of ${targetKwh.toFixed(0)} kWh. `;
                 feedback += `You made edits totaling ${editDistance.toFixed(0)} kWh from the initial seed plan (which started at ${initialTotal.toFixed(0)} kWh). `;

                 if (seedQuality === 'biased') {
                     feedback += `The initial seed plan was intentionally biased towards low-impact actions (lighting/electronics). `;
                     if (finalDeviationFromGround > editDistance * 0.5 && editDistance < targetKwh * 0.5) { // Heuristic for insufficient adjustment
                         feedback += `Your final plan still reflects some of this bias, suggesting an anchoring effect. You adjusted the total correctly, but the distribution of savings might still overestimate low-impact actions compared to their real potential. `;
                     } else {
                          feedback += `Your edits significantly adjusted the plan structure away from the initial bias. `;
                     }
                 } else {
                     feedback += `The initial seed plan was relatively accurate. Your edits refined the total to meet the exact target. `;
                 }
                 feedback += `The total deviation of your final plan's allocated savings from the ground truth savings for these actions is ${finalDeviationFromGround.toFixed(0)} kWh.`
                 return feedback;
            },
             implementationFeedback: (intentions) => {
                let feedback = `You created ${intentions.length} implementation intentions. `;
                const specificCount = intentions.filter(i => i.ifText.length > 15 && i.thenText.length > 15 && (i.ifText.includes('When') || i.ifText.includes('If'))).length;
                 if (intentions.length > 0) {
                     if (specificCount / intentions.length > 0.7) {
                         feedback += `Most of your intentions are specific and well-formed with clear cues ('If/When...') and actions ('Then I will...'). This increases the likelihood of follow-through.`;
                     } else if (specificCount / intentions.length > 0.4) {
                          feedback += `Some intentions are specific, while others could be clearer about the exact cue or action. Remember, the more precise the 'if-then' link, the better.`;
                     } else {
                          feedback += `Consider making your intentions more specific. Clearly define the situation (IF/WHEN) that triggers the action, and the exact behavior (THEN I WILL...).`;
                     }
                 }
                 return feedback;
            },
             comparisonFeedback: (choice, humanPlan, aiPlan, hybridPlan) => {
                 let feedback = `You chose to proceed with the ${choice === 'human' ? 'Human Plan' : choice === 'ai' ? 'AI Plan' : 'Hybrid Plan'}. `;
                 const humanTotal = humanPlan.reduce((sum, a) => sum + a.savingsKwh, 0);
                 const aiTotal = aiPlan.reduce((sum, a) => sum + a.savingsKwh, 0);

                 if (choice === 'human') {
                      feedback += `This suggests you valued the actions you selected, perhaps for their feasibility or personal relevance, even if the AI plan (${aiTotal.toFixed(0)} kWh) offered slightly different savings (${humanTotal.toFixed(0)} kWh).`;
                 } else if (choice === 'ai') {
                      feedback += `This indicates you found the AI's suggestions potentially more effective (${aiTotal.toFixed(0)} kWh) or efficient in reaching the goal compared to your initial plan (${humanTotal.toFixed(0)} kWh).`;
                 } else { // hybrid
                     const hybridTotal = hybridPlan.reduce((sum, a) => sum + a.savingsKwh, 0);
                      feedback += `This approach allows combining the strengths of both - potentially selecting feasible actions from your plan and high-impact suggestions from the AI. Your hybrid plan achieves ${hybridTotal.toFixed(0)} kWh savings.`;
                 }
                 // Could add analysis comparing high-impact actions in chosen vs. rejected plans
                 return feedback;
            }
        };
        
        // --- Global Utility Functions ---
        function formatSavings(value, unit, household) {
            if (!household) return `${value.toFixed(0)} kWh`; // Default if no household context
            switch (unit) {
                case 'percent':
                    return `${((value / household.annualKwh) * 100).toFixed(1)}%`;
                case 'dollars':
                    return `$${(value * (household.annualCost / household.annualKwh)).toFixed(0)}`;
                case 'kwh':
                default:
                    return `${value.toFixed(0)} kWh`;
            }
        }
        
        function calculateTargetKwh(household, percent) {
            return household.annualKwh * (percent / 100);
        }

        function renderActionItem(action, displayUnit = 'kwh', household = null) {
            const savingsDisplay = formatSavings(action.savingsKwh, displayUnit, household);
            return `
                <div class="action-item" data-action-id="${action.id}" onclick="handleActionClick(this, '${action.id}')">
                    <h4>${action.name}</h4>
                    <div>
                        <span class="action-tag action-tag-savings">~ ${savingsDisplay}/year</span>
                        <span class="action-tag action-tag-cost">Cost: $${action.cost}</span>
                        <span class="action-tag action-tag-effort">Effort: ${action.effort}</span>
                    </div>
                </div>
            `;
        }

        function renderPlanItem(action, displayUnit = 'kwh', household = null, removeCallbackName = null) {
             const savingsDisplay = formatSavings(action.savingsKwh, displayUnit, household);
             const removeButton = removeCallbackName 
                ? `<button class="btn btn-danger btn-sm" onclick="${removeCallbackName}('${action.id}')">Remove</button>` 
                : '';
             return `
                 <div class="plan-item" data-action-id="${action.id}">
                     <div class="plan-item-content">
                         ${action.name}
                     </div>
                     <div class="plan-item-savings mr-2">
                         ${savingsDisplay}
                     </div>
                     ${removeButton}
                 </div>
             `;
        }

        function updateProgressBar(current, target, progressFillId, currentSavingsId, overTargetClass = 'over-target') {
            const targetEl = document.getElementById(progressFillId.replace('fill', 'target'));
            const currentEl = document.getElementById(currentSavingsId);
            const fillEl = document.getElementById(progressFillId);
            
            if (!targetEl || !currentEl || !fillEl) return;

            const percent = target > 0 ? Math.min((current / target) * 100, 150) : 0; // Cap at 150% visually
            fillEl.style.width = `${percent}%`;

            if (current > target) {
                fillEl.classList.add(overTargetClass);
            } else {
                 fillEl.classList.remove(overTargetClass);
            }

            // Also update text display
             const formatUnit = targetEl.textContent.includes('%') ? '%' : targetEl.textContent.includes('$') ? '$' : 'kWh'; // Infer unit
            let currentFormatted, targetFormatted;

            if (formatUnit === '%') {
                const baseKwh = parseFloat(targetEl.dataset.baseKwh || '1'); // Need base kWh stored somewhere
                currentFormatted = `${((current / baseKwh) * 100).toFixed(1)}%`;
                targetFormatted = `${targetEl.dataset.targetPercent}%`;
            } else if (formatUnit === '$') {
                const costPerKwh = parseFloat(targetEl.dataset.costPerKwh || '0.12');
                currentFormatted = `$${(current * costPerKwh).toFixed(0)}`;
                targetFormatted = `$${(target * costPerKwh).toFixed(0)}`;
            } else { // kWh
                 currentFormatted = `${current.toFixed(0)} kWh`;
                 targetFormatted = `${target.toFixed(0)} kWh`;
            }
             
            currentEl.textContent = currentFormatted;
            // Target text is usually set once elsewhere
        }

        function filterActions(searchTerm, actionContainerId) {
            const term = searchTerm.toLowerCase();
            const container = document.getElementById(actionContainerId);
            container.querySelectorAll('.action-item').forEach(item => {
                const name = item.querySelector('h4').textContent.toLowerCase();
                const category = energyActions.find(a => a.id === item.dataset.actionId)?.category.toLowerCase() || '';
                 if (name.includes(term) || category.includes(term)) {
                    item.style.display = '';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        function showFeedback(panelId, contentId, content) {
            document.getElementById(contentId).innerHTML = content;
            document.getElementById(panelId).classList.remove('d-none');
        }

        // --- Tab Switching Logic ---
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    switchTab(targetId);
                });
            });
            
            // Initialize common elements first
            populateHouseholdDropdowns();

            // Initialize tasks
            initEstimateThenPlanTask();
            initCritiqueRevisionTask();
            initSeedPlanTask();
            initImplementationIntentionTask();
            initComparativePlanningTask();

            // Set initial state for dropdowns etc. if needed
            document.querySelector('#estimate-profiles .profile-card').click(); // Select first profile initially
        });
        
        function switchTab(tabId) {
            document.querySelectorAll('.tab-pane').forEach(pane => pane.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.tab-button[data-target="${tabId}"]`).classList.add('active');
        }

        function populateHouseholdDropdowns() {
             const selects = [
                 document.getElementById('critique-household'),
                 document.getElementById('seed-household'),
                 document.getElementById('implementation-household'),
                 document.getElementById('compare-household')
             ];
             selects.forEach(select => {
                 if (select) {
                     select.innerHTML = ''; // Clear existing options
                     Object.values(households).forEach(h => {
                         const option = document.createElement('option');
                         option.value = h.id;
                         option.textContent = `${h.name} (${h.annualKwh.toLocaleString()} kWh)`;
                         select.appendChild(option);
                     });
                 }
             });

             // Special handling for estimate profiles (radio-style)
             const estimateProfilesContainer = document.getElementById('estimate-profiles');
             if (estimateProfilesContainer) {
                 estimateProfilesContainer.innerHTML = '';
                 Object.values(households).forEach((h, index) => {
                     const div = document.createElement('div');
                     div.className = 'profile-card';
                     if (index === 0) div.classList.add('selected'); // Select first by default
                     div.dataset.profileId = h.id;
                     div.innerHTML = `<h3>${h.name}</h3><p>${h.description}</p><p><strong>Annual Usage:</strong> ${h.annualKwh.toLocaleString()} kWh</p>`;
                     estimateProfilesContainer.appendChild(div);
                 });
             }
        }

        // --- Task 1: Estimate-then-Plan ---
        let estimateState = {}; // Use object to hold state

        function initEstimateThenPlanTask() {
             estimateState = {
                household: households.suburban, // Default
                targetPercent: 15,
                targetUnit: 'kwh',
                feedbackType: 'explanation',
                estimations: {},
                selectedActions: [],
                phase: 'estimation', // 'estimation', 'planning', 'feedback'
                feedbackProvided: false,
                targetKwh: 0
            };
            
            // Profile selection
            const profileContainer = document.getElementById('estimate-profiles');
            profileContainer.addEventListener('click', function(e) {
                const card = e.target.closest('.profile-card');
                if (card) {
                    profileContainer.querySelectorAll('.profile-card').forEach(c => c.classList.remove('selected'));
                    card.classList.add('selected');
                    estimateState.household = households[card.dataset.profileId];
                    resetEstimateTaskView(); // Reset if profile changes
                }
            });

            // Settings listeners
            document.getElementById('estimate-target').addEventListener('change', (e) => { estimateState.targetPercent = parseInt(e.target.value); resetEstimateTaskView(false); });
            document.getElementById('estimate-format').addEventListener('change', (e) => { estimateState.targetUnit = e.target.value; resetEstimateTaskView(false); });
            document.getElementById('estimate-feedback-type').addEventListener('change', (e) => { estimateState.feedbackType = e.target.value; });

            // Estimation inputs listener for total
            const estimateInputs = ['heating', 'cooling', 'water', 'appliances', 'lighting', 'electronics'];
            estimateInputs.forEach(cat => {
                document.getElementById(`estimate-${cat}`).addEventListener('input', updateTotalEstimate);
            });

            // Buttons
            document.getElementById('submit-estimates').addEventListener('click', submitEstimates);
            document.getElementById('continue-to-planning').addEventListener('click', continueToPlanning);
            document.getElementById('submit-estimate-plan').addEventListener('click', submitEstimatePlan);

            // Search
            document.getElementById('estimate-action-search').addEventListener('input', (e) => filterActions(e.target.value, 'estimate-available-actions'));

            resetEstimateTaskView(); // Initial setup
        }

         function resetEstimateTaskView(resetSelections = true) {
             estimateState.estimations = {};
             estimateState.selectedActions = [];
             estimateState.phase = 'estimation';
             estimateState.feedbackProvided = false;
             estimateState.targetKwh = calculateTargetKwh(estimateState.household, estimateState.targetPercent);

             // Reset estimation inputs
             ['heating', 'cooling', 'water', 'appliances', 'lighting', 'electronics'].forEach(cat => {
                 const input = document.getElementById(`estimate-${cat}`);
                 input.value = '';
                 input.classList.remove('input-error');
             });
             document.getElementById('estimate-total').textContent = '0';

             // Hide feedback and planning phases
             document.getElementById('estimate-feedback-panel').classList.add('d-none');
             document.getElementById('planning-phase').classList.add('d-none');
             document.getElementById('estimate-plan-feedback').classList.add('d-none');

             // Re-enable estimate submission
             document.getElementById('submit-estimates').disabled = false;

             // Reset planning area
             document.getElementById('estimate-selected-plan').innerHTML = `<p id="estimate-empty-plan-message">Select actions from the left to add them here.</p>`;
             updateProgressBar(0, estimateState.targetKwh, 'estimate-progress-fill', 'estimate-current-savings');
              // Update goal display format immediately
             updateEstimateGoalDisplay();
         }

        function updateTotalEstimate() {
            let total = 0;
            const estimateInputs = ['heating', 'cooling', 'water', 'appliances', 'lighting', 'electronics'];
            estimateInputs.forEach(cat => {
                 const value = parseInt(document.getElementById(`estimate-${cat}`).value);
                 if (!isNaN(value)) {
                     total += value;
                 }
            });
            document.getElementById('estimate-total').textContent = total;
            // Basic validation (optional: highlight if not 100)
             document.getElementById('estimate-total').style.color = (total === 100) ? 'green' : 'red';
        }

        function submitEstimates() {
            let total = 0;
            let isValid = true;
            const categories = ['heating', 'cooling', 'water', 'appliances', 'lighting', 'electronics'];
            
            categories.forEach(category => {
                const input = document.getElementById(`estimate-${category}`);
                const value = parseInt(input.value);
                input.classList.remove('input-error');

                if (isNaN(value) || value < 0 || value > 100) {
                    input.classList.add('input-error');
                    isValid = false;
                } else {
                    estimateState.estimations[category] = value;
                    total += value;
                }
            });

            if (!isValid) {
                alert('Please enter valid percentages (0-100) for all categories.');
                return;
            }
            
            if (total !== 100) {
                alert('The percentages must add up to exactly 100%.');
                document.getElementById('estimate-total').style.color = 'red';
                return;
            }

            // Generate and show feedback
            let feedbackContent = "<ul>";
            const actualBreakdown = estimateState.household.breakdown;
            for (const category in estimateState.estimations) {
                // Use the correct key for water heating
                 const actualCategory = category === 'water' ? 'waterHeating' : category; 
                 const actualValue = actualBreakdown[actualCategory] || 0; // Handle potential mismatch
                 feedbackContent += `<li><strong>${category.charAt(0).toUpperCase() + category.slice(1)}:</strong> ${aiResponses.estimationFeedback(estimateState.estimations[category], actualValue, estimateState.feedbackType, category)}</li>`;
            }
            feedbackContent += "</ul>";
            
            showFeedback('estimate-feedback-panel', 'estimate-feedback-content', feedbackContent);
            estimateState.feedbackProvided = true;
             document.getElementById('submit-estimates').disabled = true; // Prevent re-submission
        }

        function continueToPlanning() {
            if (!estimateState.feedbackProvided) {
                 alert("Please submit your estimates and review the feedback first.");
                 return;
            }
            estimateState.phase = 'planning';
            document.getElementById('planning-phase').classList.remove('d-none');
            document.getElementById('estimate-feedback-panel').classList.add('d-none'); // Hide feedback panel
            populateEstimateActionList();
            updateEstimateGoalDisplay(); // Update display with correct format
            updateEstimatePlanView();
        }

        function populateEstimateActionList() {
            const container = document.getElementById('estimate-available-actions');
            container.innerHTML = '';
            energyActions.forEach(action => {
                 container.innerHTML += renderActionItem(action, estimateState.targetUnit, estimateState.household);
            });
        }

         function updateEstimateGoalDisplay() {
            estimateState.targetKwh = calculateTargetKwh(estimateState.household, estimateState.targetPercent);
            const targetDisplay = formatSavings(estimateState.targetKwh, estimateState.targetUnit, estimateState.household);
            document.getElementById('planning-goal-display').textContent = targetDisplay;
             document.getElementById('estimate-reduction-target').textContent = targetDisplay;
             // Store base values for progress bar updates if needed
             const targetEl = document.getElementById('estimate-reduction-target');
             targetEl.dataset.targetKwh = estimateState.targetKwh;
             targetEl.dataset.targetPercent = estimateState.targetPercent;
             targetEl.dataset.baseKwh = estimateState.household.annualKwh;
             targetEl.dataset.costPerKwh = (estimateState.household.annualCost / estimateState.household.annualKwh);

             updateEstimatePlanView(); // Refresh progress bar with new target
        }

        // Global handler for action clicks (used by multiple tasks)
        function handleActionClick(element, actionId) {
            const taskId = element.closest('.tab-pane').id;
            
            switch (taskId) {
                case 'estimate-plan':
                    toggleEstimateAction(actionId, element);
                    break;
                case 'critique-revision':
                    toggleCritiqueAction(actionId, element);
                    break;
                 case 'implementation':
                     startImplementationIntention(actionId);
                     break;
                 case 'compare':
                     toggleCompareAction(actionId, element);
                     break;
                 case 'seed-plan': // Adding actions to seed plan
                     addSeedAction(actionId, element);
                     break;
            }
        }

        function toggleEstimateAction(actionId, element) {
             if (element.classList.contains('added')) return; // Prevent adding twice

            const action = energyActions.find(a => a.id === actionId);
            if (!action) return;

            const index = estimateState.selectedActions.findIndex(a => a.id === actionId);
            if (index === -1) {
                estimateState.selectedActions.push(action);
                element.classList.add('added');
            } 
            // Removal is handled by button within the plan list now
            updateEstimatePlanView();
        }
         
        function removeEstimateAction(actionId) {
             const index = estimateState.selectedActions.findIndex(a => a.id === actionId);
             if (index > -1) {
                 estimateState.selectedActions.splice(index, 1);
                 // Unmark the action in the available list
                 const actionElement = document.querySelector(`#estimate-available-actions .action-item[data-action-id="${actionId}"]`);
                 if (actionElement) {
                     actionElement.classList.remove('added');
                 }
                 updateEstimatePlanView();
             }
         }


        function updateEstimatePlanView() {
            const container = document.getElementById('estimate-selected-plan');
            const emptyMessage = document.getElementById('estimate-empty-plan-message');
            container.innerHTML = ''; // Clear previous items
            
            if (estimateState.selectedActions.length === 0) {
                 container.innerHTML = `<p id="estimate-empty-plan-message">Select actions from the left to add them here.</p>`;
            } else {
                estimateState.selectedActions.forEach(action => {
                    container.innerHTML += renderPlanItem(action, estimateState.targetUnit, estimateState.household, 'removeEstimateAction');
                });
            }
            
            const currentKwh = estimateState.selectedActions.reduce((sum, action) => sum + action.savingsKwh, 0);
            updateProgressBar(currentKwh, estimateState.targetKwh, 'estimate-progress-fill', 'estimate-current-savings');
        }

        function submitEstimatePlan() {
             const currentKwh = estimateState.selectedActions.reduce((sum, action) => sum + action.savingsKwh, 0);
             const accuracy = Math.abs(currentKwh - estimateState.targetKwh);
             const accuracyPercent = estimateState.targetKwh > 0 ? (accuracy / estimateState.targetKwh) * 100 : 0;
             
             let feedback = `Your final plan achieves ${currentKwh.toFixed(0)} kWh savings, compared to a target of ${estimateState.targetKwh.toFixed(0)} kWh. `;
             if (accuracyPercent <= 5) {
                 feedback += `This is very accurate (within 5%)! `;
             } else if (accuracyPercent <= 15) {
                  feedback += `This is reasonably close to the target (within 15%). `;
             } else {
                   feedback += `This deviates significantly from the target (more than 15% difference). `;
             }
             // Could add analysis on high/low impact balance here too
             showFeedback('estimate-plan-feedback', 'estimate-plan-feedback-content', feedback);
             // Disable further changes maybe?
             document.getElementById('submit-estimate-plan').disabled = true;
        }

        // --- Task 2: Critique & Revision ---
         let critiqueState = {};

        function initCritiqueRevisionTask() {
             critiqueState = {
                household: households.suburban,
                targetPercent: 15,
                feedbackDetail: 'detailed',
                selectedActions: [],
                targetKwh: 0,
                revisionCount: 0,
                taskActive: false
            };

            // Settings listeners
            document.getElementById('critique-household').addEventListener('change', (e) => { critiqueState.household = households[e.target.value]; });
            document.getElementById('critique-target').addEventListener('change', (e) => { critiqueState.targetPercent = parseInt(e.target.value); });
            document.getElementById('critique-detail').addEventListener('change', (e) => { critiqueState.feedbackDetail = e.target.value; });
            document.getElementById('start-critique-task').addEventListener('click', startCritiqueTask);

            // Buttons
            document.getElementById('request-critique').addEventListener('click', requestCritique);
            document.getElementById('submit-critique-plan').addEventListener('click', submitCritiquePlan);

            // Search
            document.getElementById('critique-search').addEventListener('input', (e) => filterActions(e.target.value, 'critique-actions'));
        }
        
        function startCritiqueTask() {
             critiqueState.taskActive = true;
             critiqueState.selectedActions = [];
             critiqueState.revisionCount = 0;
             critiqueState.targetKwh = calculateTargetKwh(critiqueState.household, critiqueState.targetPercent);

             document.getElementById('critique-actions-card').classList.remove('d-none');
             document.getElementById('critique-plan-card').classList.remove('d-none');
             document.getElementById('critique-feedback-panel').classList.add('d-none'); // Hide previous feedback
             document.getElementById('revision-cycle').textContent = '(Initial Draft)';
             
             populateCritiqueActionList();
             updateCritiqueGoalDisplay();
             updateCritiquePlanView();

             document.getElementById('request-critique').disabled = false;
             document.getElementById('submit-critique-plan').disabled = false;
             document.getElementById('start-critique-task').textContent = 'Restart Task'; // Change button text
        }

        function populateCritiqueActionList() {
             const container = document.getElementById('critique-actions');
             container.innerHTML = '';
             // Display all actions, let user select
             energyActions.forEach(action => {
                 container.innerHTML += renderActionItem(action, 'kwh', critiqueState.household); // Always show kWh for planning
             });
             // Re-mark actions already in the plan if restarting
             critiqueState.selectedActions.forEach(sa => {
                 const el = container.querySelector(`.action-item[data-action-id="${sa.id}"]`);
                 if (el) el.classList.add('added');
             });
        }

         function updateCritiqueGoalDisplay() {
             const targetDisplay = formatSavings(critiqueState.targetKwh, 'kwh', critiqueState.household); // Use kWh internally
             document.getElementById('critique-goal-display').textContent = targetDisplay;
             document.getElementById('critique-target-value').textContent = targetDisplay;
             updateCritiquePlanView(); // Refresh progress bar
         }

        function toggleCritiqueAction(actionId, element) {
            if (!critiqueState.taskActive) return;
            if (element.classList.contains('added')) return; 

            const action = energyActions.find(a => a.id === actionId);
            if (!action) return;

             const index = critiqueState.selectedActions.findIndex(a => a.id === actionId);
             if (index === -1) {
                 critiqueState.selectedActions.push(action);
                 element.classList.add('added');
             }
             updateCritiquePlanView();
        }

         function removeCritiqueAction(actionId) {
             const index = critiqueState.selectedActions.findIndex(a => a.id === actionId);
             if (index > -1) {
                 critiqueState.selectedActions.splice(index, 1);
                 const actionElement = document.querySelector(`#critique-actions .action-item[data-action-id="${actionId}"]`);
                 if (actionElement) actionElement.classList.remove('added');
                 updateCritiquePlanView();
             }
         }

        function updateCritiquePlanView() {
            const container = document.getElementById('critique-plan');
            container.innerHTML = '';
            
            if (critiqueState.selectedActions.length === 0) {
                 container.innerHTML = `<p id="empty-critique-plan">Select actions from the left panel to add to your plan.</p>`;
            } else {
                critiqueState.selectedActions.forEach(action => {
                     container.innerHTML += renderPlanItem(action, 'kwh', critiqueState.household, 'removeCritiqueAction');
                 });
            }
            
            const currentKwh = critiqueState.selectedActions.reduce((sum, action) => sum + action.savingsKwh, 0);
            updateProgressBar(currentKwh, critiqueState.targetKwh, 'critique-progress', 'critique-current-savings');
             document.getElementById('critique-target-value').textContent = `${critiqueState.targetKwh.toFixed(0)} kWh`; // Ensure target display is correct unit
        }

        function requestCritique() {
            if (!critiqueState.taskActive || critiqueState.selectedActions.length === 0) {
                 alert("Please add some actions to your plan before requesting critique.");
                 return;
            }
            critiqueState.revisionCount++;
            document.getElementById('revision-cycle').textContent = `(Revision ${critiqueState.revisionCount})`;

             const feedbackContent = aiResponses.critique(critiqueState.selectedActions, critiqueState.targetKwh, critiqueState.feedbackDetail);
             showFeedback('critique-feedback-panel', 'critique-feedback-content', feedbackContent);
        }

        function submitCritiquePlan() {
             if (!critiqueState.taskActive) return;
             const currentKwh = critiqueState.selectedActions.reduce((sum, action) => sum + action.savingsKwh, 0);
             const accuracy = Math.abs(currentKwh - critiqueState.targetKwh);
             
             let feedback = `Your final submitted plan achieves ${currentKwh.toFixed(0)} kWh savings (Target: ${critiqueState.targetKwh.toFixed(0)} kWh). `;
             feedback += `You requested critique ${critiqueState.revisionCount} time(s). `;
             feedback += `The final accuracy is ${accuracy.toFixed(0)} kWh deviation from target.`;
             // Final analysis could compare initial vs final plan if stored

             // Show final feedback IN the critique panel for consistency
             showFeedback('critique-feedback-panel', 'critique-feedback-content', `<strong>Final Plan Submitted:</strong><br>${feedback}`);
             
             // Disable further actions
             document.getElementById('request-critique').disabled = true;
             document.getElementById('submit-critique-plan').disabled = true;
             document.getElementById('critique-actions-card').style.pointerEvents = 'none'; // Disable clicking actions
             document.getElementById('critique-plan').style.pointerEvents = 'none'; // Disable removing actions
             critiqueState.taskActive = false;
        }


        // --- Task 3: Seed Plan Anchoring ---
         let seedState = {};

        function initSeedPlanTask() {
             seedState = {
                household: households.suburban,
                targetPercent: 15,
                goalFormat: 'kwh',
                seedQuality: 'accurate',
                seedPlan: [], // { id, name, savingsKwh } - editable
                initialSeedPlan: [], // Store original for comparison
                targetKwh: 0,
                taskActive: false,
                 editCount: 0
            };

            // Settings listeners
            document.getElementById('seed-household').addEventListener('change', (e) => { seedState.household = households[e.target.value]; });
            document.getElementById('seed-target').addEventListener('change', (e) => { seedState.targetPercent = parseInt(e.target.value); });
            document.getElementById('seed-format').addEventListener('change', (e) => { seedState.goalFormat = e.target.value; updateSeedGoalDisplay(); }); // Update display only
            document.getElementById('seed-quality').addEventListener('change', (e) => { seedState.seedQuality = e.target.value; });
            document.getElementById('generate-seed').addEventListener('click', generateAndDisplaySeedPlan);
            document.getElementById('submit-seed-plan').addEventListener('click', submitSeedPlan);
        }

         function generateSeedPlanActions(targetKwh, quality) {
             const numActions = 10;
             let potentialActions = [...energyActions];
             let seedActions = [];

             // Prioritize based on quality
             if (quality === 'biased') {
                 // Prioritize lighting/electronics, then fill with others randomly
                 const lowImpact = potentialActions.filter(a => ['lighting', 'electronics'].includes(a.category));
                 const highImpact = potentialActions.filter(a => !['lighting', 'electronics'].includes(a.category));
                 potentialActions = [...lowImpact.sort(() => 0.5 - Math.random()), ...highImpact.sort(() => 0.5 - Math.random())];
             } else {
                 // Prioritize higher impact actions for accurate seed
                 potentialActions.sort((a, b) => b.savingsKwh - a.savingsKwh);
             }
             
             seedActions = potentialActions.slice(0, numActions);

             // Allocate savings to roughly match target (~110% initially)
             const totalTrueSavings = seedActions.reduce((sum, a) => sum + a.savingsKwh, 0);
             const scalingFactor = (targetKwh * 1.1) / totalTrueSavings; // Aim slightly over target

              let assignedSavings = seedActions.map(action => {
                 let savings = action.savingsKwh * scalingFactor;
                 // Apply bias for 'biased' quality
                 if (quality === 'biased') {
                     if (['lighting', 'electronics'].includes(action.category)) {
                         savings *= (1.5 + Math.random()); // Inflate low impact
                     } else {
                          savings *= (0.5 + Math.random() * 0.3); // Deflate high impact
                     }
                 }
                 return { id: action.id, name: action.name, savingsKwh: Math.max(10, Math.round(savings / 10) * 10) }; // Ensure minimum, round
             });

              // Fine-tune total to be closer to 110% target
              let currentTotal = assignedSavings.reduce((sum, a) => sum + a.savingsKwh, 0);
              let adjustmentFactor = (targetKwh * 1.1) / currentTotal;
              assignedSavings = assignedSavings.map(a => ({...a, savingsKwh: Math.max(10, Math.round(a.savingsKwh * adjustmentFactor / 10) * 10) }));

             return assignedSavings;
         }

        function generateAndDisplaySeedPlan() {
             seedState.taskActive = true;
             seedState.targetKwh = calculateTargetKwh(seedState.household, seedState.targetPercent);
             seedState.seedPlan = generateSeedPlanActions(seedState.targetKwh, seedState.seedQuality);
             seedState.initialSeedPlan = JSON.parse(JSON.stringify(seedState.seedPlan)); // Deep copy
             seedState.editCount = 0;
             document.getElementById('edit-count').textContent = seedState.editCount;

             document.getElementById('seed-plan-card').classList.remove('d-none');
             document.getElementById('seed-feedback').classList.add('d-none');
             document.getElementById('submit-seed-plan').disabled = true; // Enable only when target met
             
             updateSeedGoalDisplay();
             renderSeedPlan();
             updateSeedProgress(); // Initial progress bar update
        }

         function updateSeedGoalDisplay() {
             const targetDisplay = formatSavings(seedState.targetKwh, seedState.goalFormat, seedState.household);
             document.getElementById('seed-goal-display').textContent = targetDisplay;
             document.getElementById('seed-target-value').textContent = `${seedState.targetKwh.toFixed(0)}`; // Progress bar always uses kWh
         }

         function renderSeedPlan() {
             const container = document.getElementById('seed-plan-display');
             container.innerHTML = '';
             const initialTotal = seedState.initialSeedPlan.reduce((sum, a) => sum + a.savingsKwh, 0);
             document.getElementById('seed-initial-total').textContent = initialTotal.toFixed(0);

             seedState.seedPlan.forEach(item => {
                 const div = document.createElement('div');
                 div.className = 'seed-plan-item';
                 div.innerHTML = `
                     <span>${item.name}</span>
                     <input type="number" class="form-control seed-savings-input" data-action-id="${item.id}" value="${item.savingsKwh}" min="0" step="10">
                     <span>kWh</span>
                 `;
                 // Add input listener
                 const input = div.querySelector('input');
                 input.addEventListener('input', handleSeedInputChange);
                 input.addEventListener('change', handleSeedInputChange); // Ensure final value is captured
                 container.appendChild(div);
             });
         }

         function handleSeedInputChange(event) {
             if (!seedState.taskActive) return;
             const input = event.target;
             const actionId = input.dataset.actionId;
             let newValue = parseInt(input.value);

             if (isNaN(newValue) || newValue < 0) {
                 newValue = 0; // Ensure non-negative
                 input.value = 0;
             }
             
             const actionIndex = seedState.seedPlan.findIndex(a => a.id === actionId);
             if (actionIndex > -1) {
                  const oldValue = seedState.seedPlan[actionIndex].savingsKwh;
                   if (oldValue !== newValue) {
                        seedState.editCount++;
                        document.getElementById('edit-count').textContent = seedState.editCount;
                   }
                 seedState.seedPlan[actionIndex].savingsKwh = newValue;
                 updateSeedProgress();
             }
         }

        function updateSeedProgress() {
             const currentKwh = seedState.seedPlan.reduce((sum, item) => sum + item.savingsKwh, 0);
             updateProgressBar(currentKwh, seedState.targetKwh, 'seed-progress', 'seed-current-savings');
             document.getElementById('seed-current-savings').textContent = currentKwh.toFixed(0); // Update current savings text

             // Check if target is met
             const tolerance = 5; // Allow small tolerance (e.g., due to rounding)
             const targetMet = Math.abs(currentKwh - seedState.targetKwh) <= tolerance;
             document.getElementById('submit-seed-plan').disabled = !targetMet;
             document.getElementById('seed-match-message').style.display = targetMet ? 'block' : 'none';
        }

        function submitSeedPlan() {
             if (!seedState.taskActive) return;
             const feedbackContent = aiResponses.seedPlanFeedback(seedState.seedPlan, seedState.initialSeedPlan, seedState.seedQuality, seedState.targetKwh);
             showFeedback('seed-feedback', 'seed-feedback-content', feedbackContent);
             
             // Disable editing
             document.querySelectorAll('.seed-savings-input').forEach(input => input.disabled = true);
             document.getElementById('submit-seed-plan').disabled = true;
             seedState.taskActive = false;
        }


        // --- Task 4: Implementation Intentions ---
         let implementationState = {};

        function initImplementationIntentionTask() {
            implementationState = {
                household: households.suburban,
                assistance: 'enabled',
                recommendedActions: [],
                selectedAction: null, // Action currently being edited
                intentions: [], // { actionId, actionName, ifText, thenText }
                taskActive: false
            };

            // Settings listeners
            document.getElementById('implementation-household').addEventListener('change', (e) => { implementationState.household = households[e.target.value]; });
            document.getElementById('implementation-assistance').addEventListener('change', (e) => { implementationState.assistance = e.target.value; updateWizardVisibility(); });
            document.getElementById('start-implementation-task').addEventListener('click', startImplementationTask);

            // Form Buttons
            document.getElementById('cancel-implementation').addEventListener('click', cancelImplementationForm);
            document.getElementById('save-implementation').addEventListener('click', saveImplementationIntention);
            document.getElementById('submit-implementation').addEventListener('click', submitImplementationPlan);
        }

        function startImplementationTask() {
             implementationState.taskActive = true;
             implementationState.intentions = [];
             implementationState.selectedAction = null;

             // Filter high-impact, low-medium effort/cost actions relevant to profile
             const highImpactThreshold = 300; // kWh
             implementationState.recommendedActions = energyActions
                 .filter(a => a.savingsKwh >= highImpactThreshold && a.effort !== 'high' && a.cost < 500)
                 .sort((a, b) => b.savingsKwh - a.savingsKwh) // Sort by impact
                 .slice(0, 10); // Show top 10 relevant

             document.getElementById('implementation-actions-card').classList.remove('d-none');
             document.getElementById('implementation-plan-card').classList.remove('d-none');
             document.getElementById('implementation-form').classList.add('d-none'); // Hide form initially
             document.getElementById('implementation-feedback').classList.add('d-none');
             document.getElementById('submit-implementation').disabled = false; // Enable submission

             renderImplementationActions();
             renderImplementationPlan();
        }

        function renderImplementationActions() {
            const container = document.getElementById('implementation-actions');
            container.innerHTML = '';
            implementationState.recommendedActions.forEach(action => {
                 // Pass 'kwh' as unit since savings aren't the focus here, just action selection
                 container.innerHTML += renderActionItem(action, 'kwh', implementationState.household);
            });
        }

        function startImplementationIntention(actionId) {
            if (!implementationState.taskActive) return;
            // Check if already added
            if (implementationState.intentions.some(i => i.actionId === actionId)) {
                 alert("You have already created an intention for this action.");
                 return;
            }

            implementationState.selectedAction = energyActions.find(a => a.id === actionId);
            if (!implementationState.selectedAction) return;

            document.getElementById('current-action-info').innerHTML = `Creating intention for: <strong>${implementationState.selectedAction.name}</strong>`;
            document.getElementById('if-condition').value = '';
            document.getElementById('then-action').value = '';
            
            // Show/hide wizard suggestions
            updateWizardVisibility();
            if (implementationState.assistance === 'enabled') {
                populateWizardSuggestions(implementationState.selectedAction.category);
            }

            document.getElementById('implementation-form').classList.remove('d-none');
        }

         function updateWizardVisibility() {
            const wizardPanel = document.getElementById('wizard-suggestions');
            if (implementationState.selectedAction && implementationState.assistance === 'enabled') {
                wizardPanel.classList.remove('d-none');
            } else {
                wizardPanel.classList.add('d-none');
            }
        }

        function populateWizardSuggestions(category) {
            const suggestion = aiResponses.implementationSuggestion(category);
            document.getElementById('wizard-content').innerHTML = `<p>Example: <em>${suggestion}</em></p><button class="btn btn-secondary btn-sm" onclick="useWizardSuggestion('${suggestion}')">Use this example</button>`;
        }

        function useWizardSuggestion(suggestionText) {
             // Basic parsing of "IF ..., THEN I WILL ..."
            const parts = suggestionText.match(/IF (.*), THEN I WILL (.*)\.?/i);
            if (parts && parts.length === 3) {
                document.getElementById('if-condition').value = parts[1].trim();
                document.getElementById('then-action').value = parts[2].trim();
            } else { // Fallback if parsing fails
                 document.getElementById('if-condition').value = 'When [Situation]';
                 document.getElementById('then-action').value = suggestionText;
            }
        }

        function cancelImplementationForm() {
            implementationState.selectedAction = null;
            document.getElementById('implementation-form').classList.add('d-none');
        }

        function saveImplementationIntention() {
            const ifText = document.getElementById('if-condition').value.trim();
            const thenText = document.getElementById('then-action').value.trim();

            if (!implementationState.selectedAction || !ifText || !thenText) {
                alert("Please provide both an IF condition and a THEN action.");
                return;
            }

            implementationState.intentions.push({
                actionId: implementationState.selectedAction.id,
                actionName: implementationState.selectedAction.name,
                ifText: ifText,
                thenText: thenText
            });

            renderImplementationPlan();
            cancelImplementationForm(); // Hide form
            
            // Mark action as added in the list
             const actionElement = document.querySelector(`#implementation-actions .action-item[data-action-id="${implementationState.selectedAction.id}"]`);
             if (actionElement) {
                 actionElement.classList.add('added');
                 actionElement.onclick = null; // Prevent re-clicking
             }
        }

         function removeImplementationIntention(actionId) {
             const index = implementationState.intentions.findIndex(i => i.actionId === actionId);
             if (index > -1) {
                 implementationState.intentions.splice(index, 1);
                 // Unmark action in list
                 const actionElement = document.querySelector(`#implementation-actions .action-item[data-action-id="${actionId}"]`);
                 if (actionElement) {
                     actionElement.classList.remove('added');
                     actionElement.onclick = () => startImplementationIntention(actionId); // Re-enable click
                 }
                 renderImplementationPlan();
             }
         }

        function renderImplementationPlan() {
            const container = document.getElementById('implementation-plan');
            container.innerHTML = '';

            if (implementationState.intentions.length === 0) {
                 container.innerHTML = `<p id="empty-implementation-plan">Select actions from the left panel to add implementation intentions.</p>`;
            } else {
                 implementationState.intentions.forEach(intention => {
                     const div = document.createElement('div');
                     div.className = 'implementation-item';
                     div.innerHTML = `
                         <button class="btn btn-danger btn-sm remove-btn" onclick="removeImplementationIntention('${intention.actionId}')">X</button>
                         <strong>Action:</strong> ${intention.actionName}<br>
                         <strong>IF</strong> ${intention.ifText}, <br>
                         <strong>THEN I WILL</strong> ${intention.thenText}.
                     `;
                     container.appendChild(div);
                 });
            }
        }

        function submitImplementationPlan() {
             if (!implementationState.taskActive) return;
             const feedbackContent = aiResponses.implementationFeedback(implementationState.intentions);
             showFeedback('implementation-feedback', 'implementation-feedback-content', feedbackContent);
             
             // Disable further changes
             document.getElementById('submit-implementation').disabled = true;
             document.getElementById('implementation-actions-card').style.pointerEvents = 'none';
             document.getElementById('implementation-plan').style.pointerEvents = 'none';
             implementationState.taskActive = false;
        }

        // --- Task 5: Comparative Planning ---
         let compareState = {};

        function initComparativePlanningTask() {
             compareState = {
                household: households.suburban,
                targetPercent: 15,
                planningOrder: 'human-first', // 'human-first' or 'ai-first'
                targetKwh: 0,
                currentPhase: 'setup', // 'setup', 'planning1', 'planning2', 'comparison', 'finished'
                humanPlan: [],
                aiPlan: [],
                hybridPlan: [],
                finalChoice: null,
                taskActive: false
            };

            // Settings listeners
            document.getElementById('compare-household').addEventListener('change', (e) => { compareState.household = households[e.target.value]; });
            document.getElementById('compare-target').addEventListener('change', (e) => { compareState.targetPercent = parseInt(e.target.value); });
            document.getElementById('compare-order').addEventListener('change', (e) => { compareState.planningOrder = e.target.value; });
            document.getElementById('start-compare').addEventListener('click', startComparativePlanning);

             // Phase progression button
            document.getElementById('compare-next-phase').addEventListener('click', advanceComparePhase);
            
            // Final choice listeners
            document.querySelectorAll('input[name="final-plan-choice"]').forEach(radio => {
                radio.addEventListener('change', handleFinalChoiceChange);
            });
            document.getElementById('submit-comparison').addEventListener('click', submitComparison);

             // Search
            document.getElementById('compare-search').addEventListener('input', (e) => filterActions(e.target.value, 'compare-actions'));
        }

        function startComparativePlanning() {
            compareState.taskActive = true;
            compareState.targetKwh = calculateTargetKwh(compareState.household, compareState.targetPercent);
            compareState.humanPlan = [];
            compareState.aiPlan = [];
            compareState.hybridPlan = [];
            compareState.finalChoice = null;

            document.getElementById('compare-setup').classList.add('d-none');
            document.getElementById('compare-planning-area').classList.remove('d-none');
            document.getElementById('comparison-phase').classList.add('d-none');
            document.getElementById('comparison-feedback').classList.add('d-none');

            if (compareState.planningOrder === 'human-first') {
                setupComparePhase('planning1', 'Human Planning', 'Create your energy reduction plan.');
            } else { // ai-first
                generateAIPlan(); // Generate AI plan first
                 setupComparePhase('planning1', 'AI Plan Review', 'Review the plan generated by the AI. You will create your own plan next.');
                 displayAIPlanInEditor(); // Show AI plan (non-editable for now)
                 document.getElementById('compare-actions-card').classList.add('d-none'); // Hide actions during AI review
            }
            updateCompareGoalDisplay();
        }

         function setupComparePhase(phase, name, description) {
            compareState.currentPhase = phase;
            document.getElementById('compare-phase-name').textContent = name;
            document.getElementById('compare-phase-description').textContent = description;
            document.getElementById('compare-current-plan-title').textContent = name; // Set card title

             // Reset planning area for new phase if needed
             if (phase === 'planning1' && compareState.planningOrder === 'human-first') {
                compareState.humanPlan = [];
                populateCompareActionList();
                updateComparePlanView(compareState.humanPlan, 'compare-plan', 'empty-compare-plan', 'removeCompareAction');
                document.getElementById('compare-actions-card').classList.remove('d-none');
                document.getElementById('compare-next-phase').textContent = "Continue to AI Plan";
             } else if (phase === 'planning2' && compareState.planningOrder === 'human-first') { // Now show AI plan
                 generateAIPlan();
                 displayAIPlanInEditor();
                 document.getElementById('compare-actions-card').classList.add('d-none');
                 document.getElementById('compare-next-phase').textContent = "Continue to Comparison";
             } else if (phase === 'planning2' && compareState.planningOrder === 'ai-first') { // Now Human plans
                 compareState.humanPlan = [];
                 populateCompareActionList();
                 updateComparePlanView(compareState.humanPlan, 'compare-plan', 'empty-compare-plan', 'removeCompareAction');
                 document.getElementById('compare-actions-card').classList.remove('d-none');
                 document.getElementById('compare-next-phase').textContent = "Continue to Comparison";
             }
        }

        function advanceComparePhase() {
             if (compareState.currentPhase === 'planning1') {
                 if (compareState.planningOrder === 'human-first') {
                     // Human finished, now show AI plan
                     setupComparePhase('planning2', 'AI Plan Review', 'Review the AI-generated plan.');
                 } else { // AI-first
                      // AI review finished, now human plans
                      setupComparePhase('planning2', 'Human Planning', 'Now create your own energy reduction plan.');
                 }
             } else if (compareState.currentPhase === 'planning2') {
                 // Both plans created/reviewed, move to comparison
                 setupComparisonPhase();
             }
        }

         function generateAIPlan() {
             // Simple AI: greedily selects highest impact actions until target is met/exceeded
             let remainingTarget = compareState.targetKwh;
             compareState.aiPlan = [];
             const sortedActions = [...energyActions].sort((a, b) => b.savingsKwh - a.savingsKwh);
             
             for (const action of sortedActions) {
                 if (remainingTarget <= 0) break;
                 // Add action if it doesn't massively overshoot (e.g., > 150% of remaining target)
                 // Or always add if it's the first action needed
                 if (action.savingsKwh < remainingTarget * 1.5 || compareState.aiPlan.length === 0) {
                      compareState.aiPlan.push(action);
                      remainingTarget -= action.savingsKwh;
                 }
             }
             // Ensure target is reasonably met, maybe add one more small action if needed
             if (remainingTarget > compareState.targetKwh * 0.1 && compareState.aiPlan.length < energyActions.length) {
                 const smallActions = energyActions.filter(a => !compareState.aiPlan.some(p => p.id === a.id)).sort((a, b) => a.savingsKwh - b.savingsKwh);
                 if (smallActions.length > 0) compareState.aiPlan.push(smallActions[0]);
             }
         }

        function displayAIPlanInEditor() {
            // Show AI plan in the main planning view, but make it non-editable
             updateComparePlanView(compareState.aiPlan, 'compare-plan', 'empty-compare-plan', null); // No remove function
             document.getElementById('compare-plan').style.pointerEvents = 'none'; // Disable removing
        }

        function populateCompareActionList() {
             const container = document.getElementById('compare-actions');
             container.innerHTML = '';
             energyActions.forEach(action => {
                 container.innerHTML += renderActionItem(action, 'kwh', compareState.household);
             });
             // Re-mark actions if needed (e.g., if human is planning second)
             compareState.humanPlan.forEach(sa => {
                 const el = container.querySelector(`.action-item[data-action-id="${sa.id}"]`);
                 if (el) el.classList.add('added');
             });
        }

        function updateCompareGoalDisplay() {
             const targetDisplay = formatSavings(compareState.targetKwh, 'kwh', compareState.household);
             document.getElementById('compare-goal-display').textContent = targetDisplay;
             document.getElementById('compare-target-value').textContent = `${compareState.targetKwh.toFixed(0)} kWh`;
             updateComparePlanView(compareState.humanPlan, 'compare-plan', 'empty-compare-plan', 'removeCompareAction'); // Update progress bar
         }

        function toggleCompareAction(actionId, element) {
             // Only allow adding/removing during human planning phase
             if (!compareState.taskActive || !(compareState.currentPhase === 'planning1' && compareState.planningOrder === 'human-first') && !(compareState.currentPhase === 'planning2' && compareState.planningOrder === 'ai-first')) {
                 return;
             }
             if (element.classList.contains('added')) return;

             const action = energyActions.find(a => a.id === actionId);
             if (!action) return;

             const index = compareState.humanPlan.findIndex(a => a.id === actionId);
             if (index === -1) {
                 compareState.humanPlan.push(action);
                 element.classList.add('added');
             }
             updateComparePlanView(compareState.humanPlan, 'compare-plan', 'empty-compare-plan', 'removeCompareAction');
        }

         function removeCompareAction(actionId) {
              // Only allow removing during human planning phase
              if (!compareState.taskActive || !(compareState.currentPhase === 'planning1' && compareState.planningOrder === 'human-first') && !(compareState.currentPhase === 'planning2' && compareState.planningOrder === 'ai-first')) {
                  return;
              }
             const index = compareState.humanPlan.findIndex(a => a.id === actionId);
             if (index > -1) {
                 compareState.humanPlan.splice(index, 1);
                 const actionElement = document.querySelector(`#compare-actions .action-item[data-action-id="${actionId}"]`);
                 if (actionElement) actionElement.classList.remove('added');
                 updateComparePlanView(compareState.humanPlan, 'compare-plan', 'empty-compare-plan', 'removeCompareAction');
             }
         }

        function updateComparePlanView(plan, containerId, emptyMsgId, removeCallbackName) {
            const container = document.getElementById(containerId);
            container.innerHTML = ''; // Clear previous items
            
            if (plan.length === 0) {
                 container.innerHTML = `<p id="${emptyMsgId}">Plan is empty.</p>`;
            } else {
                 plan.forEach(action => {
                     container.innerHTML += renderPlanItem(action, 'kwh', compareState.household, removeCallbackName);
                 });
            }
            
            const currentKwh = plan.reduce((sum, action) => sum + action.savingsKwh, 0);
            // Update progress bar for the *active* planning area only
             if (containerId === 'compare-plan') {
                 updateProgressBar(currentKwh, compareState.targetKwh, 'compare-progress', 'compare-current-savings');
                 document.getElementById('compare-target-value').textContent = `${compareState.targetKwh.toFixed(0)} kWh`;
             } else if (containerId === 'hybrid-plan') {
                  updateProgressBar(currentKwh, compareState.targetKwh, 'hybrid-progress', 'hybrid-current-savings');
                  document.getElementById('hybrid-target-value').textContent = `${compareState.targetKwh.toFixed(0)} kWh`;
             }
        }

         // --- Comparison Phase Logic ---
        function setupComparisonPhase() {
            compareState.currentPhase = 'comparison';
            document.getElementById('compare-planning-area').classList.add('d-none');
            document.getElementById('comparison-phase').classList.remove('d-none');
            document.getElementById('hybrid-editor').classList.add('d-none'); // Hide hybrid initially
             document.getElementById('submit-comparison').disabled = true; // Disable submit until choice made

            // Populate human and AI plan displays with checkboxes for hybrid selection
            renderComparisonPlanDisplay('human-plan-display', compareState.humanPlan);
            renderComparisonPlanDisplay('ai-plan-display', compareState.aiPlan);

             // Update totals display
             document.getElementById('human-plan-total').textContent = compareState.humanPlan.reduce((s, a) => s + a.savingsKwh, 0).toFixed(0);
             document.getElementById('ai-plan-total').textContent = compareState.aiPlan.reduce((s, a) => s + a.savingsKwh, 0).toFixed(0);

              // Reset radio buttons and justification
             document.querySelectorAll('input[name="final-plan-choice"]').forEach(radio => radio.checked = false);
             document.getElementById('choice-justification').value = '';
        }

         function renderComparisonPlanDisplay(containerId, plan) {
             const container = document.getElementById(containerId);
             container.innerHTML = '';
             if (plan.length === 0) {
                 container.innerHTML = '<p>Plan is empty.</p>';
                 return;
             }
             plan.forEach(action => {
                 const div = document.createElement('div');
                 div.className = 'compare-plan-item';
                 div.innerHTML = `
                     <input type="checkbox" class="hybrid-checkbox" data-action-id="${action.id}" data-source-plan="${containerId.includes('human') ? 'human' : 'ai'}" onchange="updateHybridPlan()">
                     <span>${action.name} (~${action.savingsKwh.toFixed(0)} kWh)</span>
                 `;
                 container.appendChild(div);
             });
         }

         function handleFinalChoiceChange(event) {
             compareState.finalChoice = event.target.value;
             const hybridEditor = document.getElementById('hybrid-editor');
             if (compareState.finalChoice === 'hybrid') {
                 hybridEditor.classList.remove('d-none');
                 updateHybridPlan(); // Initial population
             } else {
                 hybridEditor.classList.add('d-none');
             }
             document.getElementById('submit-comparison').disabled = false; // Enable submit once a choice is made
         }

         function updateHybridPlan() {
            compareState.hybridPlan = [];
            const checkboxes = document.querySelectorAll('.hybrid-checkbox:checked');
             checkboxes.forEach(cb => {
                 const actionId = cb.dataset.actionId;
                 // Find action from original lists to avoid duplicates if action exists in both
                 let action = compareState.humanPlan.find(a => a.id === actionId) || compareState.aiPlan.find(a => a.id === actionId);
                 if (action && !compareState.hybridPlan.some(ha => ha.id === actionId)) { // Add only if not already added
                     compareState.hybridPlan.push(action);
                 }
             });
            
            updateComparePlanView(compareState.hybridPlan, 'hybrid-plan', 'empty-hybrid-plan', null); // No remove in hybrid view
         }

         function submitComparison() {
             if (!compareState.finalChoice) {
                 alert("Please select a final plan choice.");
                 return;
             }
             if (compareState.finalChoice === 'hybrid' && compareState.hybridPlan.length === 0) {
                 alert("Please select at least one action for your hybrid plan.");
                 return;
             }
            
             const feedbackContent = aiResponses.comparisonFeedback(compareState.finalChoice, compareState.humanPlan, compareState.aiPlan, compareState.hybridPlan);
             showFeedback('comparison-feedback', 'comparison-feedback-content', feedbackContent);

             // Disable further interaction
             document.getElementById('submit-comparison').disabled = true;
             document.querySelectorAll('input[name="final-plan-choice"], .hybrid-checkbox, #choice-justification').forEach(el => el.disabled = true);
             compareState.taskActive = false;
             compareState.currentPhase = 'finished';
         }


    </script>
</body>
</html>