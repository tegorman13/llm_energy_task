<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Planning Task Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Custom styles */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Style for active tab */
        .tab-button.active {
            border-color: #3b82f6; /* blue-500 */
            color: #3b82f6;
            font-weight: 600;
        }
        /* Simple progress bar */
        .progress-bar-fill {
            transition: width 0.3s ease-in-out;
        }
        /* Ensure text area doesn't overlap button */
        .chat-input-container {
            display: flex;
            align-items: flex-end; /* Align items to bottom */
            gap: 0.5rem; /* Add space between textarea and button */
        }
        .chat-input {
            flex-grow: 1; /* Allow textarea to grow */
            min-height: 40px; /* Minimum height */
            max-height: 120px; /* Maximum height before scrolling */
            overflow-y: auto; /* Add scroll if needed */
        }
        /* Style for LLM messages */
        .llm-message-content ul {
            list-style-type: disc;
            margin-left: 1.5rem; /* Indent list */
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .llm-message-content li {
            margin-bottom: 0.25rem;
        }
         /* Style for action list items */
        .action-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem 0.75rem; /* p-2 px-3 */
            margin-bottom: 0.5rem; /* mb-2 */
            background-color: #ffffff; /* bg-white */
            border: 1px solid #e5e7eb; /* border border-gray-200 */
            border-radius: 0.375rem; /* rounded-md */
        }
        .action-item-details {
            flex-grow: 1;
            margin-right: 0.5rem; /* mr-2 */
        }
        .action-item-name {
            font-weight: 500; /* font-medium */
        }
        .action-item-savings {
            font-size: 0.875rem; /* text-sm */
            color: #16a34a; /* text-green-600 */
        }
        .action-item-cost {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
        }
        .action-item-effort {
            font-size: 0.875rem; /* text-sm */
            color: #6b7280; /* text-gray-500 */
        }
         /* Responsive adjustments */
        @media (max-width: 640px) {
            .tab-button {
                padding: 0.5rem 0.75rem; /* Smaller padding on mobile */
                font-size: 0.875rem; /* Smaller font size */
            }
            .action-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .action-item button {
                margin-top: 0.5rem; /* Add space above button on mobile */
                align-self: flex-end; /* Align button to the right */
            }
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 lg:p-6">
        <h1 class="text-2xl sm:text-3xl font-bold mb-4 text-gray-800">Energy Planning Task Demo</h1>

        <div class="mb-4 border-b border-gray-300">
            <ul class="flex flex-wrap -mb-px text-sm font-medium text-center text-gray-500" id="tabs" role="tablist">
                </ul>
        </div>

        <div id="tab-content">
            </div>
    </div>

    <script>
        // --- DATA (Household Profiles, Actions, Goals, LLM Templates) ---
        const appData = {
            householdProfiles: [
              {
                id: "suburban_family",
                name: "Suburban Family Home",
                description: "A 4-bedroom, 2,500 sq ft single-family home in a suburban area with 4 occupants (2 adults, 2 children).",
                climate: "Mixed/Moderate",
                baseline: {
                  total: 10800, // Annual kWh usage
                  breakdown: {
                    heating: 3240,  // 30%
                    cooling: 1620,  // 15%
                    waterHeating: 1944, // 18%
                    refrigeration: 864,  // 8%
                    lighting: 972,   // 9%
                    cooking: 648,   // 6%
                    laundry: 540,   // 5%
                    electronics: 648,   // 6%
                    other: 324    // 3%
                  }
                },
                appliances: [
                  { name: "Central heating system", age: 8, details: "Gas furnace with electric blower" },
                  { name: "Central air conditioning", age: 8, details: "13 SEER efficiency" },
                  { name: "Water heater", age: 6, details: "50-gallon traditional tank" },
                  { name: "Refrigerator", age: 5, details: "Standard top-freezer, not ENERGY STAR" },
                  { name: "Washer & dryer", age: 7, details: "Standard efficiency" },
                  { name: "Lighting", age: "Mixed", details: "60% incandescent/halogen, 40% LED" },
                  { name: "Electronics", age: "Mixed", details: "2 TVs, 2 computers, various chargers and devices" }
                ]
              },
              {
                id: "urban_apartment",
                name: "Urban Apartment",
                description: "A 2-bedroom, 950 sq ft apartment in a mid-rise building with 2 occupants (young couple). Renter constraints apply (no major modifications).",
                climate: "Urban/Moderate",
                baseline: {
                  total: 6300, // Annual kWh usage
                  breakdown: {
                    heating: 1260,  // 20% (Often building controlled)
                    cooling: 945,   // 15% (Window ACs)
                    waterHeating: 1134, // 18% (Often building controlled)
                    refrigeration: 567,   // 9%
                    lighting: 693,   // 11%
                    cooking: 567,   // 9%
                    laundry: 378,   // 6% (Shared facilities may impact direct savings)
                    electronics: 693,   // 11%
                    other: 63     // 1%
                  }
                },
                appliances: [
                  { name: "Electric baseboard heating", age: 10, details: "Building-controlled in winter" },
                  { name: "Window air conditioners", age: 3, details: "2 units, 8,000 and 6,000 BTU" },
                  { name: "Water heater", age: "Unknown", details: "Building-provided hot water" },
                  { name: "Refrigerator", age: 12, details: "Older top-freezer model" },
                  { name: "Washer & dryer", age: "N/A", details: "Shared laundry facilities in building" },
                  { name: "Lighting", age: "Mixed", details: "30% incandescent, 70% LED" },
                  { name: "Electronics", age: "New", details: "1 TV, 2 laptops, various devices" }
                ]
              },
              {
                id: "rural_house",
                name: "Rural Single-Family Home",
                description: "A 3-bedroom, 1,800 sq ft detached home in a rural area with 3 occupants (older couple with adult child). All-electric home.",
                climate: "Cold/Northern",
                baseline: {
                  total: 14500, // Annual kWh usage - higher due to all-electric home and colder climate
                  breakdown: {
                    heating: 5800,  // 40%
                    cooling: 1450,  // 10%
                    waterHeating: 2610, // 18%
                    refrigeration: 1160,  // 8% (includes extra freezer)
                    lighting: 1015,   // 7%
                    cooking: 870,   // 6%
                    laundry: 725,   // 5%
                    electronics: 580,   // 4%
                    other: 290     // 2% (includes well pump)
                  }
                },
                appliances: [
                  { name: "Electric heat pump", age: 15, details: "Primary heating/cooling, aging efficiency" },
                  { name: "Supplemental electric space heaters", age: 5, details: "Used in very cold weather" },
                  { name: "Electric water heater", age: 12, details: "80-gallon traditional tank" },
                  { name: "Refrigerator", age: 10, details: "Side-by-side model, not ENERGY STAR" },
                  { name: "Freezer", age: 20, details: "Separate standing freezer in garage" },
                  { name: "Washer & dryer", age: 8, details: "Standard electric models" },
                  { name: "Lighting", age: "Mixed", details: "80% incandescent/halogen, 20% LED" },
                  { name: "Electronics", age: "Mixed", details: "2 TVs, 1 computer, various devices" },
                  { name: "Well pump", age: 6, details: "For household water supply" }
                ]
              }
            ],
            energySavingActions: [
              // HEATING & COOLING (HVAC) - Adjusted savings based on potential relevance
              { id: "thermostat_winter", category: "Heating", action: "Lower winter thermostat by 3°F when home", savings: 315, cost: 0, effort: "Low", details: "Adjust thermostat manually or programmatically.", relevantTo: ["suburban_family", "rural_house"] },
              { id: "thermostat_winter_night", category: "Heating", action: "Lower winter thermostat by 8°F at night/away", savings: 520, cost: 0, effort: "Low", details: "Requires manual or programmable adjustment.", relevantTo: ["suburban_family", "rural_house"] },
              { id: "smart_thermostat", category: "Heating & Cooling", action: "Install programmable/smart thermostat", savings: 600, cost: 150, effort: "Medium", details: "Automates adjustments. Requires installation.", relevantTo: ["suburban_family", "rural_house"] },
              { id: "thermostat_summer", category: "Cooling", action: "Raise summer thermostat by 4°F", savings: 248, cost: 0, effort: "Low", details: "Adjust AC settings.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // Relevant if AC exists
              { id: "air_filters", category: "Heating & Cooling", action: "Replace HVAC/furnace filters regularly", savings: 105, cost: 40, effort: "Low", details: "Improves central system efficiency.", relevantTo: ["suburban_family", "rural_house"] }, // Only if central system
              { id: "ceiling_fans", category: "Cooling", action: "Use ceiling fans to feel cooler", savings: 180, cost: 0, effort: "Low", details: "Allows higher AC setting. Assumes fans installed.", relevantTo: ["suburban_family", "rural_house"] }, // Assumes fans exist
              { id: "seal_leaks", category: "Heating & Cooling", action: "Seal air leaks (windows, doors)", savings: 270, cost: 30, effort: "Medium", details: "Weatherstripping/caulking. DIY possible.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // Generally applicable
              { id: "hvac_tuneup", category: "Heating & Cooling", action: "Schedule professional HVAC tune-up", savings: 190, cost: 150, effort: "Low", details: "Annual maintenance for central systems.", relevantTo: ["suburban_family", "rural_house"] }, // Only if central system
              { id: "attic_insulation", category: "Heating & Cooling", action: "Add/improve attic insulation", savings: 720, cost: 1500, effort: "High", details: "Major impact, high upfront cost.", relevantTo: ["suburban_family", "rural_house"] }, // Only for houses with attics

              // WATER HEATING
              { id: "water_temp", category: "Water Heating", action: "Lower water heater temp to 120°F", savings: 225, cost: 0, effort: "Low", details: "Adjust setting on tank. Check local codes.", relevantTo: ["suburban_family", "rural_house"] }, // Only if accessible WH
              { id: "short_showers", category: "Water Heating", action: "Take shorter showers (e.g., 5 min)", savings: 170, cost: 0, effort: "Medium", details: "Behavior change. Savings vary.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },
              { id: "water_heater_blanket", category: "Water Heating", action: "Install water heater blanket", savings: 115, cost: 30, effort: "Medium", details: "For older tanks in unconditioned spaces.", relevantTo: ["suburban_family", "rural_house"] }, // If accessible WH
              { id: "low_flow", category: "Water Heating", action: "Install low-flow showerheads/aerators", savings: 140, cost: 40, effort: "Low", details: "Reduces hot water use.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // Generally applicable
              { id: "dishwasher_full", category: "Water Heating", action: "Run dishwasher only when full", savings: 60, cost: 0, effort: "Low", details: "Reduces cycles.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // If has dishwasher

              // LIGHTING
              { id: "led_bulbs", category: "Lighting", action: "Replace 10 incandescent/halogen bulbs with LEDs", savings: 450, cost: 50, effort: "Low", details: "Significant savings, easy swap.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // Universally applicable
              { id: "turn_off_lights", category: "Lighting", action: "Turn off lights when leaving a room", savings: 90, cost: 0, effort: "Low", details: "Behavior change.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // Universally applicable
              { id: "motion_sensors", category: "Lighting", action: "Use motion sensors in low-traffic areas", savings: 65, cost: 60, effort: "Medium", details: "Basements, garages, closets.", relevantTo: ["suburban_family", "rural_house"] }, // More relevant for houses

              // APPLIANCES
              { id: "refrigerator_replace", category: "Appliances", action: "Replace old fridge (>10yrs) with ENERGY STAR", savings: 420, cost: 800, effort: "High", details: "Major purchase, significant savings.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // If fridge is old
              { id: "fridge_temp", category: "Appliances", action: "Set fridge to 38°F, freezer to 0°F", savings: 35, cost: 0, effort: "Low", details: "Check temps with thermometer.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },
              { id: "fridge_coils", category: "Appliances", action: "Clean refrigerator coils annually", savings: 40, cost: 0, effort: "Medium", details: "Improves efficiency. Check manual.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },
              { id: "cold_laundry", category: "Appliances", action: "Wash clothes in cold water", savings: 225, cost: 0, effort: "Low", details: "Most energy is for heating water.", relevantTo: ["suburban_family", "rural_house"] }, // If has own washer
              { id: "line_dry", category: "Appliances", action: "Line-dry clothes (50% of loads)", savings: 385, cost: 20, effort: "Medium", details: "Avoids dryer energy use.", relevantTo: ["suburban_family", "rural_house"] }, // If space/rules allow
              { id: "clean_dryer_lint", category: "Appliances", action: "Clean dryer lint filter every load", savings: 45, cost: 0, effort: "Low", details: "Improves efficiency and safety.", relevantTo: ["suburban_family", "rural_house"] }, // If has own dryer
              { id: "dishwasher_air_dry", category: "Appliances", action: "Use dishwasher air-dry setting", savings: 90, cost: 0, effort: "Low", details: "Skips heated drying.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }, // If has dishwasher with setting
              { id: "microwave_small_meals", category: "Appliances", action: "Use microwave instead of oven for small meals", savings: 65, cost: 0, effort: "Low", details: "Microwaves are more efficient for reheating/small portions.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },

              // ELECTRONICS
              { id: "power_strips", category: "Electronics", action: "Use smart power strips for entertainment/office", savings: 105, cost: 40, effort: "Low", details: "Reduces phantom load.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },
              { id: "unplug_chargers", category: "Electronics", action: "Unplug chargers when not in use", savings: 15, cost: 0, effort: "Medium", details: "Small savings, good habit.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },
              { id: "computer_settings", category: "Electronics", action: "Enable computer sleep/hibernate modes", savings: 80, cost: 0, effort: "Low", details: "Reduces energy during inactivity.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] },
              { id: "tv_brightness", category: "Electronics", action: "Reduce TV brightness/use eco-mode", savings: 30, cost: 0, effort: "Low", details: "Factory settings often too bright.", relevantTo: ["suburban_family", "urban_apartment", "rural_house"] }
            ],
            reductionGoals: [
              { type: "percentage", value: 0.10, description: (h) => `Reduce annual electricity usage by 10%` },
              { type: "percentage", value: 0.15, description: (h) => `Reduce annual electricity usage by 15%` },
              { type: "absolute", value: (h) => Math.round(h.baseline.total * 0.10), description: (h) => `Reduce annual electricity usage by ${Math.round(h.baseline.total * 0.10)} kWh` },
              { type: "absolute", value: (h) => Math.round(h.baseline.total * 0.15), description: (h) => `Reduce annual electricity usage by ${Math.round(h.baseline.total * 0.15)} kWh` },
              // Add monetary later if needed, requires cost assumption
            ],
            // Simplified templates for demo purposes
            llmResponseTemplates: {
                // Info Provider
                infoResponse: (action) => `The action "${action.action}" is estimated to save approximately ${action.savings} kWh per year. It typically involves ${action.effort.toLowerCase()} effort and has an estimated upfront cost of $${action.cost}.`,
                applianceInfoResponse: (applianceName, usage, percentage) => `A typical ${applianceName} in a home like this uses around ${usage.toLocaleString()} kWh per year, which is about ${percentage}% of the total household usage.`,
                cantFindInfo: (query) => `I couldn't find specific information for "${query}". Could you rephrase or ask about a standard action like adjusting thermostats, changing bulbs, or appliance usage?`,

                // Feedback Provider
                feedbackIntro: (savings, goal, accuracy) => `Okay, I've reviewed your plan. It currently achieves ${savings.toLocaleString()} kWh in savings, which is ${accuracy}% of your ${goal.toLocaleString()} kWh goal.`,
                feedbackGood: () => `This is a solid plan that meets or exceeds your goal! Well done.`,
                feedbackNeedsMore: (shortfall) => `You're on the right track, but the plan is currently short of the goal by ${shortfall.toLocaleString()} kWh.`,
                feedbackSuggestionHighImpact: (action) => `Consider adding actions with higher impact, such as "${action.action}" (saves ${action.savings} kWh/year).`,
                feedbackSuggestionLowCost: (action) => `If budget is a concern, actions like "${action.action}" (saves ${action.savings} kWh/year) cost $${action.cost}.`,
                feedbackFeasibility: (action) => `Make sure you've considered the feasibility of "${action.action}", which requires ${action.effort.toLowerCase()} effort.`,
                feedbackOverestimated: (action) => `Remember that actions like "${action.action}" often have lower impact (${action.savings} kWh/year) than people perceive. Ensure your plan isn't overly reliant on these.`,
                feedbackUnderestimated: (action) => `Don't overlook high-impact areas like heating/cooling adjustments or water heater settings. For example, "${action.action}" saves ${action.savings} kWh/year.`,

                // Plan Generator
                generatorIntro: (goal) => `Based on your household profile and goal of saving ${goal.toLocaleString()} kWh, here's a draft plan focusing on high-impact and feasible actions. You can review and modify it:`,
                generatorAction: (action) => `* **${action.action}:** Saves ~${action.savings} kWh/year (Cost: $${action.cost}, Effort: ${action.effort})`,
                generatorOutro: (savings, goal) => `This draft plan saves approximately ${savings.toLocaleString()} kWh/year. Feel free to add, remove, or modify actions to better suit your preferences and reach the ${goal.toLocaleString()} kWh target.`,

                // Structured Guide
                guideIntro: (goal) => `Let's build your energy plan step-by-step to reach the goal of saving ${goal.toLocaleString()} kWh/year. We can start by looking at major energy use categories.`,
                guideCategoryFocus: (categoryName, usage, percentage) => `A good area to focus on is **${categoryName}**, which uses about ${usage.toLocaleString()} kWh (${percentage}%) in this household. Would you like to see potential actions for ${categoryName}?`,
                guideActionSuggestion: (action) => `One option for ${action.category} is "${action.action}", saving ~${action.savings} kWh/year. Would you like to add this to your plan?`,
                guideProgressUpdate: (savings, goal, remaining) => `Okay, your plan now saves ${savings.toLocaleString()} kWh/year. You need ${remaining.toLocaleString()} kWh more to reach the ${goal.toLocaleString()} kWh goal. Shall we look at another category or specific actions?`,
                guideCompleted: (savings, goal) => `Excellent! Your plan now saves ${savings.toLocaleString()} kWh/year, meeting your goal of ${goal.toLocaleString()} kWh. You can finalize this plan or explore further options.`,

                // Brainstorming Partner
                brainstormIntro: () => `Let's brainstorm some energy-saving ideas! What area are you interested in (e.g., heating, lighting, appliances), or would you like general suggestions?`,
                brainstormIdeas: (actions) => `Here are a few ideas to consider:\n${actions.map(a => `* ${a.action} (~${a.savings} kWh/year)`).join('\n')}\nWould you like details on any of these or ideas for a different area?`,
                brainstormNoMore: () => `I've suggested most of the common actions. Perhaps review your current plan or consider combining smaller actions?`
            },
            // Background Info Content
            backgroundInfo: {
                study: `
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Study Background & Rationale</h3>
                    <p class="mb-3">This demo showcases different interfaces for tasks aimed at understanding how people plan to achieve energy reduction goals. Planning involves translating a high-level goal (e.g., "reduce usage by 10%") into concrete, feasible actions.</p>
                    <p class="mb-3">Prior research (e.g., Attari et al., 2010; Marghetis et al., 2019) shows systematic biases in energy perception: people often overestimate savings from visible, low-impact actions (like unplugging chargers) and underestimate savings from high-impact actions (like thermostat adjustments).</p>
                    <p class="mb-3">These tasks explore how different forms of support, potentially provided by Large Language Models (LLMs) or other tools, might influence the planning process and the quality of the resulting plans. Key factors include:</p>
                    <ul class="list-disc list-inside mb-3 space-y-1 text-gray-600">
                        <li><strong>Task Structure:</strong> Presenting household context, setting clear goals, providing realistic action options with estimated savings.</li>
                        <li><strong>Realism:</strong> Grounding savings data, prompting implementation details, considering constraints (cost, effort, relevance).</li>
                        <li><strong>Addressing Biases:</strong> Including both typically over/underestimated actions, potentially measuring baseline perceptions, and testing corrective feedback.</li>
                    </ul>
                    <p>The different tabs demonstrate various ways an "AI assistant" could interact with a user during planning, ranging from passive information provision to active guidance or plan generation.</p>
                `,
                hypotheses: `
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Potential Research Questions & Hypotheses</h3>
                    <p class="mb-3">These task variations allow for exploring questions like:</p>
                    <ul class="list-disc list-inside mb-3 space-y-2 text-gray-600">
                        <li><strong>Information Access (Info Provider vs. Control):</strong> Does providing easy access to accurate savings data improve plan accuracy compared to relying on user estimates or a static list? Hypothesis: Yes, readily available info reduces reliance on biased heuristics.</li>
                        <li><strong>Feedback (Feedback Provider vs. Control):</strong> Does critiquing a user's plan lead to revisions that improve accuracy and feasibility? Hypothesis: Targeted feedback helps users identify and correct errors or suboptimal choices.</li>
                        <li><strong>Anchoring & Automation Bias (Plan Generator vs. Control/Others):</strong> Do users heavily anchor on an AI-generated initial plan? Do they critically evaluate and modify it, or accept it with minimal changes? Hypothesis: Users may exhibit anchoring and automation bias, potentially accepting suboptimal AI plans.</li>
                        <li><strong>Cognitive Load & Scaffolding (Structured Guide vs. Control/Others):</strong> Does guiding users step-by-step reduce cognitive load and lead to more comprehensive or accurate plans? Hypothesis: Scaffolding improves plan quality, especially for complex goals, but might reduce user agency.</li>
                        <li><strong>Idea Generation (Brainstorming Partner vs. Control):</strong> Does prompting for ideas help users overcome fixation on common low-impact actions and consider a wider range of options? Hypothesis: Brainstorming support leads to more diverse plans, potentially including more high-impact actions.</li>
                        <li><strong>Plan Quality Metrics:</strong> Across conditions, plans can be evaluated on:
                            <ul class="list-circle list-inside ml-4 mt-1">
                                <li>Accuracy (Total savings vs. Goal)</li>
                                <li>Feasibility (Considering cost, effort, relevance)</li>
                                <li>Action Diversity (Range of categories covered)</li>
                                <li>Bias Reflection (Over-reliance on low-impact actions?)</li>
                                <li>User Experience (Perceived difficulty, confidence, satisfaction)</li>
                            </ul>
                        </li>
                    </ul>
                `
            }
        };

        // --- APPLICATION STATE ---
        const state = {
            activeTab: 'control', // Default tab
            currentTasks: {}, // Store state for each task tab { tabId: { profile, goal, goalKwh, plan: [], savings, history: [] } }
        };

        // --- CORE FUNCTIONS ---

        /**
         * Initializes the application: sets up tabs and renders the initial view.
         */
        function init() {
            console.log("Initializing Demo...");
            renderTabs();
            // Initialize and render the default tab first
            switchTab(state.activeTab);
            console.log("Initialization Complete.");
        }

        /**
         * Renders the tab buttons.
         */
        function renderTabs() {
            const tabsContainer = document.getElementById('tabs');
            if (!tabsContainer) {
                console.error("Tabs container not found!");
                return;
            }
            tabsContainer.innerHTML = ''; // Clear existing tabs

            const tabConfig = [
                { id: 'control', name: 'Control Task', type: 'task' },
                { id: 'info_provider', name: 'LLM: Info Provider', type: 'task' },
                { id: 'feedback_provider', name: 'LLM: Feedback Provider', type: 'task' },
                { id: 'plan_generator', name: 'LLM: Plan Generator', type: 'task' },
                { id: 'structured_guide', name: 'LLM: Structured Guide', type: 'task' },
                { id: 'brainstorming_partner', name: 'LLM: Brainstorming Partner', type: 'task' },
                { id: 'study_info', name: 'Study Info', type: 'background' },
                { id: 'hypotheses', name: 'Hypotheses', type: 'background' }
            ];

            tabConfig.forEach(tab => {
                const li = document.createElement('li');
                li.classList.add('mr-2');
                const button = document.createElement('button');
                button.id = `tab-${tab.id}`;
                button.setAttribute('role', 'tab');
                button.setAttribute('aria-controls', `tab-pane-${tab.id}`);
                button.setAttribute('aria-selected', state.activeTab === tab.id ? 'true' : 'false');
                button.classList.add('tab-button', 'inline-block', 'p-2', 'sm:p-4', 'border-b-2', 'border-transparent', 'rounded-t-lg', 'hover:text-gray-600', 'hover:border-gray-300');
                 if (state.activeTab === tab.id) {
                    button.classList.add('active');
                 }
                button.textContent = tab.name;
                button.onclick = () => switchTab(tab.id, tab.type);
                li.appendChild(button);
                tabsContainer.appendChild(li);
            });
        }

        /**
         * Switches the active tab and renders its content.
         * @param {string} tabId - The ID of the tab to switch to.
         * @param {string} tabType - 'task' or 'background'.
         */
        function switchTab(tabId, tabType = null) {
            console.log(`Switching to tab: ${tabId}`);
            const tabContentContainer = document.getElementById('tab-content');
            if (!tabContentContainer) {
                console.error("Tab content container not found!");
                return;
            }

            // Determine tab type if not provided (e.g., on initial load)
            if (!tabType) {
                 const tabConfig = [
                    { id: 'control', type: 'task' }, { id: 'info_provider', type: 'task' },
                    { id: 'feedback_provider', type: 'task' }, { id: 'plan_generator', type: 'task' },
                    { id: 'structured_guide', type: 'task' }, { id: 'brainstorming_partner', type: 'task' },
                    { id: 'study_info', type: 'background' }, { id: 'hypotheses', type: 'background' }
                 ];
                 const config = tabConfig.find(t => t.id === tabId);
                 tabType = config ? config.type : 'task'; // Default to task if not found
            }


            // Avoid re-rendering if already active and pane exists
            if (state.activeTab === tabId && document.getElementById(`tab-pane-${tabId}`)) {
                 console.log("Tab already active and rendered.");
                 // Ensure the correct pane is visible even if no re-render
                 document.querySelectorAll('#tab-content > div').forEach(pane => {
                    pane.classList.toggle('hidden', pane.id !== `tab-pane-${tabId}`);
                 });
                 // Update tab button styles
                 document.querySelectorAll('#tabs .tab-button').forEach(button => {
                    const isActive = button.id === `tab-${tabId}`;
                    button.setAttribute('aria-selected', isActive ? 'true' : 'false');
                    button.classList.toggle('active', isActive);
                 });
                 return;
            }

            state.activeTab = tabId;

            // Update tab button styles
            document.querySelectorAll('#tabs .tab-button').forEach(button => {
                const isActive = button.id === `tab-${tabId}`;
                button.setAttribute('aria-selected', isActive ? 'true' : 'false');
                button.classList.toggle('active', isActive);
            });

            // Hide all content panes first
            Array.from(tabContentContainer.children).forEach(pane => {
                pane.classList.add('hidden');
            });

            // Show or create the target pane
            let targetPane = document.getElementById(`tab-pane-${tabId}`);
            if (!targetPane) {
                console.log(`Creating pane for tab: ${tabId}`);
                targetPane = document.createElement('div');
                targetPane.id = `tab-pane-${tabId}`;
                targetPane.setAttribute('role', 'tabpanel');
                targetPane.setAttribute('aria-labelledby', `tab-${tabId}`);
                tabContentContainer.appendChild(targetPane); // Append before rendering content

                // Render content based on type
                if (tabType === 'task') {
                    initializeTaskState(tabId);
                    renderTaskPane(tabId); // Render into the newly created pane
                } else if (tabType === 'background') {
                    renderBackgroundPane(tabId); // Render into the newly created pane
                }
            }

            // Ensure the correct pane is visible
             if (targetPane) {
                 targetPane.classList.remove('hidden');
             } else {
                 console.error(`Failed to create or find pane for tab: ${tabId}`);
             }
        }

         /**
         * Initializes or resets the state for a specific task tab.
         * @param {string} tabId - The ID of the task tab.
         */
        function initializeTaskState(tabId) {
            console.log(`Initializing state for task: ${tabId}`);
            // Ensure appData is loaded
            if (!appData || !appData.householdProfiles || !appData.reductionGoals) {
                console.error("App data not loaded correctly!");
                return;
            }
            const profile = getRandomItem(appData.householdProfiles);
            const goal = getRandomItem(appData.reductionGoals);
            const goalKwh = calculateGoalKwh(goal, profile);

            // Specific initializations based on task type
            let initialPlan = [];
            let initialHistory = [];
            let initialSavings = 0;

            if (tabId === 'plan_generator') {
                // Generate an initial plan for the generator task
                const { plan, savings } = generateInitialPlan(profile, goalKwh);
                initialPlan = plan;
                initialSavings = savings;
                initialHistory.push({
                    sender: 'llm',
                    content: appData.llmResponseTemplates.generatorIntro(goalKwh) + '\n' +
                             initialPlan.map(action => appData.llmResponseTemplates.generatorAction(action)).join('\n') + '\n\n' +
                             appData.llmResponseTemplates.generatorOutro(initialSavings, goalKwh)
                });
            } else if (tabId === 'structured_guide') {
                 initialHistory.push({ sender: 'llm', content: appData.llmResponseTemplates.guideIntro(goalKwh) });
                 // Suggest starting category
                 const topCategory = getTopEnergyCategories(profile, 1)[0];
                 if (topCategory) {
                    initialHistory.push({ sender: 'llm', content: appData.llmResponseTemplates.guideCategoryFocus(topCategory.name, topCategory.usage, topCategory.percentage) });
                 }
            } else if (tabId === 'brainstorming_partner') {
                 initialHistory.push({ sender: 'llm', content: appData.llmResponseTemplates.brainstormIntro() });
            } else if (tabId === 'feedback_provider') {
                // No initial history, user builds plan first
            } else if (tabId === 'info_provider') {
                 initialHistory.push({ sender: 'llm', content: `I can provide information about energy saving actions or appliance energy use. What would you like to know? You can ask things like "How much does lowering the thermostat save?" or "Energy use of refrigerator".` });
            }


            state.currentTasks[tabId] = {
                profile: profile,
                goal: goal,
                goalKwh: goalKwh,
                plan: initialPlan, // Array of action objects
                savings: initialSavings,
                history: initialHistory, // For chat-like interfaces
                status: 'active' // e.g., active, feedback_requested, completed
            };
        }


        /**
         * Renders the content for a specific task pane.
         * @param {string} tabId - The ID of the task tab.
         */
        function renderTaskPane(tabId) {
            const taskState = state.currentTasks[tabId];
            const pane = document.getElementById(`tab-pane-${tabId}`);

            // Ensure task state and pane exist before proceeding
            if (!taskState) {
                console.error(`No state found for task tab: ${tabId}. Initializing...`);
                initializeTaskState(tabId); // Try to initialize if missing
                // Re-check state after attempting initialization
                if (!state.currentTasks[tabId]) {
                    console.error(`Failed to initialize state for task tab: ${tabId}`);
                    if(pane) pane.innerHTML = `<p class="text-red-500">Error: Could not load task state for ${tabId}.</p>`;
                    return; // Exit if still no state
                }
                // Update local taskState variable if initialization was successful
                const newTaskState = state.currentTasks[tabId];
                 if (!newTaskState) { // Final check
                     console.error(`State still missing after re-init for task tab: ${tabId}`);
                     if(pane) pane.innerHTML = `<p class="text-red-500">Error: Could not load task state for ${tabId}.</p>`;
                     return;
                 }
                 // If successful, proceed with the newly initialized state (though this path might indicate other issues)
                 console.warn(`Proceeding after re-initialization for tab ${tabId}`);
                 // taskState = newTaskState; // Reassign if needed, though direct use below should work
            }
             if (!pane) {
                console.error(`Pane element not found for tab: ${tabId}`);
                return;
            }
            pane.innerHTML = ''; // Clear previous content

            // --- Create and append sections ---
            const container = document.createElement('div');
            container.classList.add('space-y-6'); // Add spacing between sections

            // Household Profile Section
            const profileSection = document.createElement('div');
            profileSection.id = `profile-section-${tabId}`;
            profileSection.classList.add('p-4', 'bg-white', 'rounded-lg', 'shadow');
            container.appendChild(profileSection);

            // Goal & Progress Section
            const goalSection = document.createElement('div');
            goalSection.id = `goal-section-${tabId}`;
            goalSection.classList.add('p-4', 'bg-white', 'rounded-lg', 'shadow');
            container.appendChild(goalSection);

             // Task-specific UI Section
             const taskUISpecific = document.createElement('div');
             taskUISpecific.id = `task-ui-${tabId}`;
             taskUISpecific.classList.add('p-4', 'bg-white', 'rounded-lg', 'shadow');
             container.appendChild(taskUISpecific);

             // Plan Section (Common to most tasks)
             const planSection = document.createElement('div');
             planSection.id = `plan-section-${tabId}`;
             planSection.classList.add('p-4', 'bg-white', 'rounded-lg', 'shadow');
             // Only append plan section immediately if it's not the guide task initially
             if (tabId !== 'structured_guide') {
                container.appendChild(planSection);
             }

             // Append the main container to the pane *before* filling content
             pane.appendChild(container);

             // --- Fill content into the appended sections ---
             // Use the potentially re-initialized state here
             const currentTaskState = state.currentTasks[tabId];
             if (!currentTaskState) {
                  console.error(`Task state lost before filling content for tab: ${tabId}`);
                  return; // Cannot proceed without state
             }

             renderHouseholdProfile(profileSection, currentTaskState.profile);
             renderGoal(goalSection, currentTaskState.goal.description(currentTaskState.profile), currentTaskState.savings, currentTaskState.goalKwh);

             // Render task-specific UI *into* the taskUISpecific div
             switch (tabId) {
                case 'control':
                    renderControlTask(taskUISpecific, tabId);
                    break;
                case 'info_provider':
                    renderInfoProviderTask(taskUISpecific, tabId);
                    break;
                case 'feedback_provider':
                    renderFeedbackTask(taskUISpecific, tabId);
                    break;
                case 'plan_generator':
                    renderGeneratorTask(taskUISpecific, tabId);
                    break;
                case 'structured_guide':
                    renderGuideTask(taskUISpecific, tabId);
                    // Append the plan section now for the guide task
                    container.appendChild(planSection);
                    break;
                case 'brainstorming_partner':
                    renderBrainstormingTask(taskUISpecific, tabId);
                    break;
             }

             // Render the plan section (unless it's the guide task and plan is empty)
             if (tabId !== 'structured_guide' || currentTaskState.plan.length > 0) {
                renderPlan(planSection, tabId);
             } else if (tabId === 'structured_guide') {
                 // Ensure plan section is empty initially for guide
                 planSection.innerHTML = '<p class="text-sm text-gray-500 italic">Your plan will appear here as you add actions.</p>';
             }
        }

        /**
         * Renders the UI for the Control task.
         * @param {HTMLElement} container - The parent element for the UI.
         * @param {string} tabId - The current tab ID.
         */
        function renderControlTask(container, tabId) {
            // Create the placeholder div for the selector
            const selectorContainerId = `action-selector-container-${tabId}`;
            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Build Your Plan</h3>
                <p class="text-sm text-gray-600 mb-4">Select actions from the list below to add to your plan and reach the energy reduction goal.</p>
                <div id="${selectorContainerId}" class="mb-4">
                    </div>
            `;
            // Now find the container *within the passed container* and render the selector
            const selectorContainer = container.querySelector(`#${selectorContainerId}`);
            if (selectorContainer) {
                renderActionSelector(selectorContainer, tabId);
            } else {
                 console.error(`Could not find ${selectorContainerId} in renderControlTask`);
            }
        }

        /**
         * Renders the UI for the Info Provider task.
         * @param {HTMLElement} container - The parent element for the UI.
         * @param {string} tabId - The current tab ID.
         */
        function renderInfoProviderTask(container, tabId) {
             const selectorContainerId = `action-selector-container-${tabId}`;
             const chatHistoryId = `chat-history-${tabId}`;
             const userInputId = `user-input-${tabId}`;
             container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Build Your Plan (with Info Assistant)</h3>
                <p class="text-sm text-gray-600 mb-4">Select actions below. You can also ask the assistant for information about specific actions or appliance energy use before adding them.</p>
                <div id="${selectorContainerId}" class="mb-4">
                    </div>
                <div class="mt-6 border-t pt-4">
                    <h4 class="text-lg font-semibold mb-2 text-gray-700">Information Assistant</h4>
                    <div id="${chatHistoryId}" class="h-48 overflow-y-auto border rounded-md p-3 mb-3 bg-gray-50 text-sm space-y-2">
                        </div>
                    <div class="chat-input-container">
                        <textarea id="${userInputId}" class="chat-input block w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ask about an action (e.g., 'LED bulbs savings') or appliance ('refrigerator energy use')..."></textarea>
                        <button onclick="handleLLMInteraction('${tabId}', 'info_request')" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm self-end">Ask</button>
                    </div>
                </div>
            `;
            // Render selector and chat history into the created elements
            const selectorContainer = container.querySelector(`#${selectorContainerId}`);
             if (selectorContainer) {
                renderActionSelector(selectorContainer, tabId);
             } else {
                 console.error(`Could not find ${selectorContainerId} in renderInfoProviderTask`);
             }
             renderChatHistory(tabId); // Assumes chat history container exists now
        }

        /**
         * Renders the UI for the Feedback Provider task.
         * @param {HTMLElement} container - The parent element for the UI.
         * @param {string} tabId - The current tab ID.
         */
        function renderFeedbackTask(container, tabId) {
            const taskState = state.currentTasks[tabId];
            if (!taskState) {
                 console.error(`Task state missing for ${tabId} in renderFeedbackTask`);
                 container.innerHTML = "<p class='text-red-500'>Error loading task.</p>";
                 return;
            }

            const selectorContainerId = `action-selector-container-${tabId}`;
            const chatHistoryId = `chat-history-${tabId}`;
            const feedbackButtonId = `feedback-button-${tabId}`;

            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Build Your Plan & Get Feedback</h3>
                <p class="text-sm text-gray-600 mb-4">First, create your plan by selecting actions below. When you're ready, ask the assistant for feedback.</p>
                <div id="${selectorContainerId}" class="mb-4">
                    </div>
                <div class="mt-6 border-t pt-4">
                     <button id="${feedbackButtonId}" onclick="handleLLMInteraction('${tabId}', 'feedback_request')" class="px-4 py-2 bg-green-500 text-white rounded-md hover:bg-green-600 text-sm ${taskState.plan.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${taskState.plan.length === 0 ? 'disabled' : ''}>
                        Get Feedback on My Plan
                    </button>
                    <div id="${chatHistoryId}" class="mt-4 h-48 overflow-y-auto border rounded-md p-3 mb-3 bg-gray-50 text-sm space-y-2 ${taskState.history.length === 0 ? 'hidden' : ''}">
                        </div>
                </div>
            `;
            // Render selector and chat history
             const selectorContainer = container.querySelector(`#${selectorContainerId}`);
             if (selectorContainer) {
                renderActionSelector(selectorContainer, tabId);
             } else {
                  console.error(`Could not find ${selectorContainerId} in renderFeedbackTask`);
             }
             renderChatHistory(tabId);
        }

        /**
         * Renders the UI for the Plan Generator task.
         * @param {HTMLElement} container - The parent element for the UI.
         * @param {string} tabId - The current tab ID.
         */
        function renderGeneratorTask(container, tabId) {
             const selectorContainerId = `action-selector-container-${tabId}`;
             const chatHistoryId = `chat-history-${tabId}`;

             container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Review & Modify Generated Plan</h3>
                <p class="text-sm text-gray-600 mb-4">The assistant has generated an initial plan below. Review the actions, add or remove items to meet the goal and fit your preferences.</p>
                 <div id="${chatHistoryId}" class="h-48 overflow-y-auto border rounded-md p-3 mb-3 bg-gray-50 text-sm space-y-2">
                    </div>
                <div id="${selectorContainerId}" class="mt-4 border-t pt-4">
                     <h4 class="text-lg font-semibold mb-2 text-gray-700">Add More Actions</h4>
                     </div>
            `;
             // Render chat history and selector
             renderChatHistory(tabId);
             const selectorContainer = container.querySelector(`#${selectorContainerId}`);
             if (selectorContainer) {
                renderActionSelector(selectorContainer, tabId);
             } else {
                 console.error(`Could not find ${selectorContainerId} in renderGeneratorTask`);
             }
        }

        /**
         * Renders the UI for the Structured Guide task.
         * @param {HTMLElement} container - The parent element for the UI.
         * @param {string} tabId - The current tab ID.
         */
        function renderGuideTask(container, tabId) {
            const chatHistoryId = `chat-history-${tabId}`;
            const userInputId = `user-input-${tabId}`;
            // Note: Plan section is handled by renderTaskPane for this task type

            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Guided Planning Session</h3>
                <p class="text-sm text-gray-600 mb-4">Follow the assistant's prompts to build your plan step-by-step.</p>
                <div id="${chatHistoryId}" class="h-64 overflow-y-auto border rounded-md p-3 mb-3 bg-gray-50 text-sm space-y-2">
                    </div>
                <div class="chat-input-container">
                    <textarea id="${userInputId}" class="chat-input block w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Respond to the assistant... (e.g., 'Yes', 'Suggest lighting actions', 'Add LED bulbs')"></textarea>
                    <button onclick="handleLLMInteraction('${tabId}', 'guide_response')" class="px-4 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 text-sm self-end">Send</button>
                </div>
                 `;
             // Render chat history
             renderChatHistory(tabId);
        }

        /**
         * Renders the UI for the Brainstorming Partner task.
         * @param {HTMLElement} container - The parent element for the UI.
         * @param {string} tabId - The current tab ID.
         */
        function renderBrainstormingTask(container, tabId) {
             const selectorContainerId = `action-selector-container-${tabId}`;
             const chatHistoryId = `chat-history-${tabId}`;
             const userInputId = `user-input-${tabId}`;

             container.innerHTML = `
                <h3 class="text-xl font-semibold mb-3 text-gray-700">Brainstorm & Build Plan</h3>
                <p class="text-sm text-gray-600 mb-4">Select actions below, or ask the assistant to brainstorm ideas if you're stuck or want suggestions for specific areas.</p>
                <div id="${selectorContainerId}" class="mb-4">
                    </div>
                 <div class="mt-6 border-t pt-4">
                    <h4 class="text-lg font-semibold mb-2 text-gray-700">Brainstorming Assistant</h4>
                    <div id="${chatHistoryId}" class="h-48 overflow-y-auto border rounded-md p-3 mb-3 bg-gray-50 text-sm space-y-2">
                        </div>
                    <div class="chat-input-container">
                        <textarea id="${userInputId}" class="chat-input block w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500" placeholder="Ask for ideas (e.g., 'Suggest heating ideas', 'General suggestions', 'More appliance ideas')..."></textarea>
                        <button onclick="handleLLMInteraction('${tabId}', 'brainstorm_request')" class="px-4 py-2 bg-purple-500 text-white rounded-md hover:bg-purple-600 text-sm self-end">Brainstorm</button>
                    </div>
                </div>
            `;
             // Render selector and chat history
             const selectorContainer = container.querySelector(`#${selectorContainerId}`);
             if (selectorContainer) {
                renderActionSelector(selectorContainer, tabId);
             } else {
                 console.error(`Could not find ${selectorContainerId} in renderBrainstormingTask`);
             }
            renderChatHistory(tabId);
        }


        /**
         * Renders the household profile information.
         * @param {HTMLElement} container - The parent element.
         * @param {object} profile - The household profile object.
         */
        function renderHouseholdProfile(container, profile) {
             if (!container) {
                 console.error("Household profile container is null.");
                 return;
             }
             if (!profile) {
                  console.error("Household profile data is missing.");
                  container.innerHTML = "<p class='text-red-500'>Error: Profile data missing.</p>";
                  return;
             }
            // Basic Info
            let html = `
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Household Profile: ${profile.name}</h3>
                <p class="text-sm text-gray-600 mb-1">${profile.description}</p>
                <p class="text-sm text-gray-600 mb-3">Climate: ${profile.climate} | Baseline Usage: <strong>${profile.baseline.total.toLocaleString()} kWh/year</strong></p>
            `;

            // Usage Breakdown Chart (Simple Bars)
            html += '<h4 class="text-md font-semibold mb-2 text-gray-600">Annual Usage Breakdown:</h4>';
            html += '<div class="space-y-1">'; // Use space-y for spacing between bars
            const categories = Object.entries(profile.baseline.breakdown)
                                    .filter(([key, value]) => key !== 'total' && value > 0) // Exclude total and zero values
                                    .sort(([,a], [,b]) => b - a); // Sort descending by usage

            categories.forEach(([category, usage]) => {
                const percentage = Math.round((usage / profile.baseline.total) * 100);
                const categoryName = category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1').trim(); // Format category name
                html += `
                    <div class="flex items-center text-xs">
                        <span class="w-28 text-right pr-2 text-gray-600">${categoryName}:</span>
                        <div class="flex-grow bg-gray-200 rounded-full h-3 mr-2">
                            <div class="bg-blue-500 h-3 rounded-full" style="width: ${percentage}%" title="${usage.toLocaleString()} kWh (${percentage}%)"></div>
                        </div>
                        <span class="w-16 text-left text-gray-500">${percentage}%</span>
                    </div>
                `;
            });
            html += '</div>'; // Close space-y div

            // Key Appliances List
            if (profile.appliances && profile.appliances.length > 0) {
                 html += '<h4 class="text-md font-semibold mt-4 mb-2 text-gray-600">Key Appliances/Features:</h4>';
                 html += '<ul class="list-disc list-inside text-sm text-gray-600 space-y-1">';
                 profile.appliances.forEach(app => {
                     html += `<li>${app.name} (${app.details}, Age: ${app.age})</li>`;
                 });
                 html += '</ul>';
            }


            container.innerHTML = html;
        }

        /**
         * Renders the goal description and progress bar.
         * @param {HTMLElement} container - The parent element.
         * @param {string} goalDesc - The textual description of the goal.
         * @param {number} currentSavings - Current savings achieved by the plan.
         * @param {number} goalKwh - The target savings goal in kWh.
         */
        function renderGoal(container, goalDesc, currentSavings, goalKwh) {
             if (!container) {
                 console.error("Goal container is null.");
                 return;
             }
            const progressPercentage = goalKwh > 0 ? Math.min(100, Math.round((currentSavings / goalKwh) * 100)) : 0;
            container.innerHTML = `
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Your Goal</h3>
                <p class="text-lg text-blue-600 font-medium mb-3">${goalDesc} (~${goalKwh.toLocaleString()} kWh/year)</p>
                <div class="mb-1 text-sm font-medium text-gray-600">Progress: ${currentSavings.toLocaleString()} / ${goalKwh.toLocaleString()} kWh</div>
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div class="progress-bar-fill bg-green-500 h-2.5 rounded-full" style="width: ${progressPercentage}%"></div>
                </div>
                <div class="text-xs text-gray-500 mt-1 text-right">${progressPercentage}% achieved</div>
            `;
        }

         /**
         * Renders the action selector dropdown and button.
         * @param {HTMLElement} container - The parent element for the action selector.
         * @param {string} tabId - The ID of the current task tab.
         */
        function renderActionSelector(container, tabId) {
            // Ensure container exists before proceeding
            if (!container) {
                console.error(`Action selector container is null for tab ${tabId}.`);
                return;
            }
            const taskState = state.currentTasks[tabId];
            if (!taskState) {
                 console.error(`Task state not found for ${tabId} in renderActionSelector.`);
                 container.innerHTML = "<p class='text-red-500'>Error loading actions.</p>";
                 return;
            }

            // Filter actions relevant to the household profile
            const relevantActions = appData.energySavingActions.filter(action =>
                 // Ensure relevantTo exists and includes the profile ID
                 Array.isArray(action.relevantTo) && action.relevantTo.includes(taskState.profile.id)
            );


            // Filter out actions already in the plan
            const availableActions = relevantActions.filter(action =>
                !taskState.plan.some(pAction => pAction.id === action.id)
            );

            // Sort available actions (e.g., by category, then savings)
            availableActions.sort((a, b) => {
                if (a.category < b.category) return -1;
                if (a.category > b.category) return 1;
                return b.savings - a.savings; // Higher savings first within category
            });

            let optionsHTML = '<option value="">-- Select an action to add --</option>';
            let currentCategory = '';
            availableActions.forEach(action => {
                 if (action.category !== currentCategory) {
                    if (currentCategory !== '') optionsHTML += '</optgroup>';
                    currentCategory = action.category;
                    optionsHTML += `<optgroup label="${currentCategory}">`;
                 }
                optionsHTML += `<option value="${action.id}">${action.action} (~${action.savings} kWh, $${action.cost}, ${action.effort} effort)</option>`;
            });
             if (currentCategory !== '') optionsHTML += '</optgroup>'; // Close last optgroup

            // Set the innerHTML of the valid container
            container.innerHTML = `
                <div class="flex items-center space-x-2">
                    <select id="action-select-${tabId}" class="block w-full border border-gray-300 rounded-md p-2 text-sm focus:ring-blue-500 focus:border-blue-500 flex-grow bg-white" ${availableActions.length === 0 ? 'disabled' : ''}>
                        ${availableActions.length > 0 ? optionsHTML : '<option value="">-- No more relevant actions available --</option>'}
                    </select>
                    <button onclick="addActionFromSelector('${tabId}')" class="px-4 py-2 bg-indigo-500 text-white rounded-md hover:bg-indigo-600 text-sm whitespace-nowrap ${availableActions.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}" ${availableActions.length === 0 ? 'disabled' : ''}>
                        Add to Plan
                    </button>
                </div>
            `;
        }

        /**
         * Renders the current plan (list of selected actions).
         * @param {HTMLElement} container - The parent element for the plan list.
         * @param {string} tabId - The ID of the current task tab.
         */
        function renderPlan(container, tabId) {
             if (!container) {
                 console.error(`Plan container is null for tab ${tabId}.`);
                 return;
             }
            const taskState = state.currentTasks[tabId];
            if (!taskState) {
                 console.error(`Task state not found for ${tabId} in renderPlan.`);
                 container.innerHTML = "<p class='text-red-500'>Error loading plan.</p>";
                 return;
            }

            let planHTML = `<h3 class="text-xl font-semibold mb-3 text-gray-700">Current Plan (Total Savings: ${taskState.savings.toLocaleString()} kWh)</h3>`;

            if (taskState.plan.length === 0) {
                planHTML += '<p class="text-sm text-gray-500 italic">No actions added yet.</p>';
            } else {
                planHTML += '<ul class="space-y-2">';
                taskState.plan.forEach((action, index) => {
                    planHTML += `
                        <li class="action-item">
                            <div class="action-item-details">
                                <span class="action-item-name">${action.action}</span>
                                <div class="flex flex-wrap gap-x-3 gap-y-1"> <span class="action-item-savings">Savings: ~${action.savings} kWh/yr</span>
                                     <span class="action-item-cost">Cost: $${action.cost}</span>
                                     <span class="action-item-effort">Effort: ${action.effort}</span>
                                </div>
                            </div>
                            <button onclick="removeAction('${tabId}', ${index})" class="px-2 py-1 bg-red-500 text-white rounded-md hover:bg-red-600 text-xs flex-shrink-0"> Remove
                            </button>
                        </li>
                    `;
                });
                planHTML += '</ul>';
            }
            container.innerHTML = planHTML;

             // --- Update other UI elements that depend on the plan ---
             // Find the main pane for the current tab to scope the search
             const mainPane = document.getElementById(`tab-pane-${tabId}`);
             if (mainPane) {
                 // Update goal section
                 const goalContainer = mainPane.querySelector(`#goal-section-${tabId}`);
                 if (goalContainer) {
                     renderGoal(goalContainer, taskState.goal.description(taskState.profile), taskState.savings, taskState.goalKwh);
                 } else {
                     console.warn(`Goal container not found for update in tab ${tabId}`);
                 }

                 // Re-render action selector if it exists within the task UI section
                 const taskUIContainer = mainPane.querySelector(`#task-ui-${tabId}`);
                 if (taskUIContainer) {
                     const selectorContainer = taskUIContainer.querySelector(`#action-selector-container-${tabId}`);
                     if (selectorContainer) {
                         renderActionSelector(selectorContainer, tabId);
                     }
                 }


                  // Enable/disable feedback button if it exists
                  const feedbackButton = mainPane.querySelector(`#feedback-button-${tabId}`);
                  if (feedbackButton) {
                      const disabled = taskState.plan.length === 0;
                      feedbackButton.disabled = disabled;
                      feedbackButton.classList.toggle('opacity-50', disabled);
                      feedbackButton.classList.toggle('cursor-not-allowed', disabled);
                  }
             } else {
                 console.error(`Main pane not found for tab ${tabId} during plan render update.`);
             }
        }

         /**
         * Renders the chat history for LLM interaction tabs.
         * @param {string} tabId - The ID of the current task tab.
         */
        function renderChatHistory(tabId) {
            const historyContainer = document.getElementById(`chat-history-${tabId}`);
            const taskState = state.currentTasks[tabId];

            // Ensure container and history exist
             if (!historyContainer) {
                 // Don't log error here, as it might not exist yet during initial render steps
                 return;
             }
             if (!taskState || !taskState.history) {
                 console.error(`Task state or history not found for ${tabId} in renderChatHistory.`);
                 historyContainer.innerHTML = "<p class='text-red-500'>Error loading chat history.</p>";
                 return;
             }


             historyContainer.innerHTML = ''; // Clear previous history
             taskState.history.forEach(msg => {
                const msgDiv = document.createElement('div');
                // Define classes as arrays
                const commonClasses = ['p-2', 'rounded-md', 'max-w-[85%]', 'w-fit'];
                const userClasses = ['bg-blue-100', 'text-blue-800', 'ml-auto'];
                const llmClasses = ['bg-gray-100', 'text-gray-800', 'mr-auto'];

                const senderLabel = msg.sender === 'user' ? 'You' : 'Assistant';
                const classesToAdd = msg.sender === 'user' ? userClasses : llmClasses;

                // Add common classes first
                msgDiv.classList.add(...commonClasses);
                // Add sender-specific classes
                msgDiv.classList.add(...classesToAdd);


                // Basic sanitization: replace potential HTML tags
                const sanitizedContent = msg.content.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                 // Convert markdown-like lists (* item) and newlines to HTML
                 let formattedContent = sanitizedContent.split('\n').map(line => {
                    line = line.trim();
                    if (line.startsWith('* ')) {
                        // Ensure list items are properly closed even if followed by non-list items
                        return `<li>${line.substring(2)}</li>`;
                    }
                    // Wrap non-list lines in paragraphs or divs if they aren't empty
                    return line.length > 0 ? `<p>${line}</p>` : '';
                 }).join(''); // Join without adding extra breaks yet

                 // Wrap consecutive list items in <ul>
                 formattedContent = formattedContent.replace(/(<li>.*?<\/li>)+/g, (match) => `<ul>${match}</ul>`);

                 // Clean up potential empty paragraphs generated
                 formattedContent = formattedContent.replace(/<p><\/p>/g, '');
                 // Remove breaks inside list items if accidentally added
                 formattedContent = formattedContent.replace(/<li><p>(.*?)<\/p><\/li>/g, '<li>$1</li>');
                 formattedContent = formattedContent.replace(/<p><ul>/g, '<ul>').replace(/<\/ul><\/p>/g, '</ul>');


                // Use innerHTML carefully after sanitization and formatting
                 msgDiv.innerHTML = `<strong class="text-xs block mb-1">${senderLabel}:</strong><div class="llm-message-content text-sm">${formattedContent}</div>`;
                historyContainer.appendChild(msgDiv);
             });

             // Scroll to bottom
             historyContainer.scrollTop = historyContainer.scrollHeight;
             // Make visible if hidden and has content
             historyContainer.classList.toggle('hidden', taskState.history.length === 0);
        }

        /**
         * Renders the content for background information tabs.
         * @param {string} tabId - The ID of the background tab ('study_info' or 'hypotheses').
         */
        function renderBackgroundPane(tabId) {
            const pane = document.getElementById(`tab-pane-${tabId}`);
            if (!pane) {
                 console.error(`Pane not found for background tab ${tabId}.`);
                 return;
            }

            const contentKey = tabId === 'study_info' ? 'study' : 'hypotheses';
            if (!appData.backgroundInfo || !appData.backgroundInfo[contentKey]) {
                 console.error(`Background info content not found for key: ${contentKey}`);
                 pane.innerHTML = `<p class="text-red-500">Error: Content not found.</p>`;
                 return;
            }

            // Added prose classes for better typography from Tailwind Typography plugin
            pane.innerHTML = `
                <div class="p-4 bg-white rounded-lg shadow prose prose-sm sm:prose lg:prose-lg max-w-none">
                    ${appData.backgroundInfo[contentKey]}
                </div>
            `;
        }


        // --- EVENT HANDLERS & ACTIONS ---

        /**
         * Adds the selected action from the dropdown to the plan.
         * @param {string} tabId - The ID of the current task tab.
         */
        function addActionFromSelector(tabId) {
            const selector = document.getElementById(`action-select-${tabId}`);
            if (!selector) {
                console.error(`Action selector element not found for tab ${tabId}`);
                return;
            }
            const actionId = selector.value;
            if (actionId) {
                addAction(tabId, actionId);
                selector.value = ""; // Reset selector
            }
        }

        /**
         * Adds a specific action to the plan state and updates the UI.
         * @param {string} tabId - The ID of the current task tab.
         * @param {string} actionId - The ID of the action to add.
         */
        function addAction(tabId, actionId) {
            const taskState = state.currentTasks[tabId];
            if (!taskState) {
                 console.error(`Task state not found for ${tabId} in addAction.`);
                 return;
            }
            const actionToAdd = appData.energySavingActions.find(a => a.id === actionId);

            if (actionToAdd && !taskState.plan.some(a => a.id === actionId)) {
                taskState.plan.push({...actionToAdd}); // Add a copy to avoid potential state issues
                taskState.savings = calculateTotalSavings(taskState.plan);
                console.log(`Action added to ${tabId}: ${actionId}, New savings: ${taskState.savings}`);

                 // Find the plan container *within the specific tab pane* to re-render
                 const planContainer = document.querySelector(`#tab-pane-${tabId} #plan-section-${tabId}`);
                 if (planContainer) {
                    renderPlan(planContainer, tabId); // Update plan display & dependent UI elements
                 } else {
                     console.error(`Plan section container not found for update in tab ${tabId}`);
                 }
            } else {
                console.warn(`Action ${actionId} not found or already in plan for ${tabId}.`);
            }
        }

        /**
         * Removes an action from the plan state and updates the UI.
         * @param {string} tabId - The ID of the current task tab.
         * @param {number} index - The index of the action to remove in the plan array.
         */
        function removeAction(tabId, index) {
            const taskState = state.currentTasks[tabId];
             if (!taskState) {
                 console.error(`Task state not found for ${tabId} in removeAction.`);
                 return;
             }
            if (index >= 0 && index < taskState.plan.length) {
                const removedAction = taskState.plan.splice(index, 1)[0];
                taskState.savings = calculateTotalSavings(taskState.plan);
                console.log(`Action removed from ${tabId}: ${removedAction.id}, New savings: ${taskState.savings}`);

                 // Find the plan container *within the specific tab pane* to re-render
                 const planContainer = document.querySelector(`#tab-pane-${tabId} #plan-section-${tabId}`);
                 if (planContainer) {
                    renderPlan(planContainer, tabId); // Update plan display & dependent UI elements
                 } else {
                     console.error(`Plan section container not found for update in tab ${tabId}`);
                 }
            }
        }

        /**
         * Handles interactions with the simulated LLM based on the task type.
         * @param {string} tabId - The ID of the current task tab.
         * @param {string} interactionType - Type of interaction (e.g., 'info_request', 'feedback_request').
         */
        function handleLLMInteraction(tabId, interactionType) {
            const taskState = state.currentTasks[tabId];
             if (!taskState) {
                 console.error(`Task state not found for ${tabId} in handleLLMInteraction.`);
                 return;
             }
            const userInputElement = document.getElementById(`user-input-${tabId}`);
            const userQuery = userInputElement ? userInputElement.value.trim() : '';

            // Add user message to history if applicable and query exists
            if (userQuery && (interactionType === 'info_request' || interactionType === 'guide_response' || interactionType === 'brainstorm_request')) {
                 taskState.history.push({ sender: 'user', content: userQuery });
            } else if (!userQuery && interactionType === 'feedback_request') {
                 // Add placeholder for feedback button click
                 taskState.history.push({ sender: 'user', content: "(Requested feedback on current plan)" });
            }


            let llmResponse = "Sorry, I didn't understand that."; // Default response

            // --- Generate LLM Response based on interaction type ---
            try { // Add try-catch around simulation logic
                switch (interactionType) {
                    case 'info_request':
                        llmResponse = simulateInfoProvider(userQuery, taskState.profile);
                        break;
                    case 'feedback_request':
                        llmResponse = simulateFeedbackProvider(taskState.plan, taskState.goalKwh);
                        break;
                     case 'guide_response':
                         llmResponse = simulateGuide(userQuery, tabId); // Guide needs more context
                         break;
                     case 'brainstorm_request':
                         llmResponse = simulateBrainstormer(userQuery, tabId);
                         break;
                }
            } catch (error) {
                 console.error(`Error during LLM simulation (${interactionType}):`, error);
                 llmResponse = "Sorry, an internal error occurred while processing your request.";
            }

             // Add LLM response to history
             taskState.history.push({ sender: 'llm', content: llmResponse });

             // Clear input if it exists
             if (userInputElement) {
                 userInputElement.value = '';
             }

             // Update the chat history display (scoped to the current tab)
             const chatContainer = document.querySelector(`#tab-pane-${tabId} #chat-history-${tabId}`);
             if (chatContainer) {
                 renderChatHistory(tabId); // Pass tabId to ensure correct container is updated
             }

             // Potentially update plan or other UI elements if LLM action caused changes
             if (interactionType === 'guide_response') {
                  // Guide might add actions, so re-render the plan section
                  const planContainer = document.querySelector(`#tab-pane-${tabId} #plan-section-${tabId}`);
                  if (planContainer) {
                      renderPlan(planContainer, tabId);
                  }
             }
        }

        // --- SIMULATION LOGIC for LLM Roles ---

        function simulateInfoProvider(query, profile) {
            if (!query) return "Please ask a question about an action or appliance.";
            const lowerQuery = query.toLowerCase();
            // Try to match an action
            for (const action of appData.energySavingActions) {
                // Improved matching: check action name keywords and ID
                const actionKeywords = action.action.toLowerCase().split(' ').filter(w => w.length > 3 && !['action', 'savings', 'details'].includes(w));
                const queryWords = lowerQuery.split(' ');
                const keywordMatch = actionKeywords.some(kw => lowerQuery.includes(kw));
                const idMatch = lowerQuery.includes(action.id.replace('_', ' '));
                // Require at least two query words to match action keywords, or ID match
                const sufficientKeywordMatch = keywordMatch && queryWords.filter(qw => actionKeywords.some(kw => kw.includes(qw))).length >= 1;

                 if (idMatch || sufficientKeywordMatch) {
                    return appData.llmResponseTemplates.infoResponse(action);
                 }
            }
             // Try to match an appliance
             if (profile && profile.appliances) { // Check if profile and appliances exist
                 for (const appliance of profile.appliances) {
                     const applianceNameLower = appliance.name.toLowerCase();
                     // Match if query includes significant part of appliance name
                     if (lowerQuery.split(' ').some(word => word.length > 3 && applianceNameLower.includes(word))) {
                        // Try to find corresponding breakdown category
                        let categoryKey = Object.keys(profile.baseline.breakdown).find(k => applianceNameLower.includes(k.toLowerCase().split(' ')[0])); // Match first word of category key
                         if (!categoryKey && applianceNameLower.includes('heat')) categoryKey = 'heating'; // Manual mapping
                         if (!categoryKey && applianceNameLower.includes('fridge')) categoryKey = 'refrigeration';
                         if (!categoryKey && applianceNameLower.includes('washer') || applianceNameLower.includes('dryer')) categoryKey = 'laundry';
                         if (!categoryKey && applianceNameLower.includes('light')) categoryKey = 'lighting';

                        const usage = categoryKey && profile.baseline.breakdown[categoryKey] ? profile.baseline.breakdown[categoryKey] : (profile.baseline.other / 2); // Crude estimate if no category match
                        const percentage = profile.baseline.total > 0 ? Math.round((usage / profile.baseline.total) * 100) : 0;
                        return appData.llmResponseTemplates.applianceInfoResponse(appliance.name, usage, percentage);
                     }
                 }
             }


            return appData.llmResponseTemplates.cantFindInfo(query);
        }

        function simulateFeedbackProvider(plan, goalKwh) {
             if (!plan) return "Error: Plan data is missing."; // Basic check

            const currentSavings = calculateTotalSavings(plan);
            const accuracy = goalKwh > 0 ? Math.round((currentSavings / goalKwh) * 100) : 100; // Avoid division by zero
            const shortfall = Math.max(0, goalKwh - currentSavings);

            let feedback = appData.llmResponseTemplates.feedbackIntro(currentSavings, goalKwh, accuracy);

            if (currentSavings >= goalKwh) {
                feedback += '\n' + appData.llmResponseTemplates.feedbackGood();
            } else {
                feedback += '\n' + appData.llmResponseTemplates.feedbackNeedsMore(shortfall);

                // Suggest high-impact action not in plan
                const highImpactActions = appData.energySavingActions
                    .filter(a => a.savings > 400 && !plan.some(p => p.id === a.id)) // Example threshold for high impact
                    .sort((a, b) => b.savings - a.savings);
                if (highImpactActions.length > 0) {
                    feedback += '\n' + appData.llmResponseTemplates.feedbackSuggestionHighImpact(highImpactActions[0]);
                } else {
                     // Suggest medium impact if no high impact available
                     const mediumImpactActions = appData.energySavingActions
                         .filter(a => a.savings > 150 && a.savings <= 400 && !plan.some(p => p.id === a.id))
                         .sort((a, b) => b.savings - a.savings);
                     if (mediumImpactActions.length > 0) {
                        feedback += '\n' + `You could also consider actions like "${mediumImpactActions[0].action}" (saves ${mediumImpactActions[0].savings} kWh/year).`;
                     }
                }

                 // Comment on feasibility if high-effort actions are present
                 const highEffortAction = plan.find(a => a.effort === 'High');
                 if (highEffortAction) {
                     feedback += '\n' + appData.llmResponseTemplates.feedbackFeasibility(highEffortAction);
                 }

                 // Check for over-reliance on low-impact (e.g., < 50 kWh)
                 const lowImpactSavings = calculateTotalSavings(plan.filter(a => a.savings < 50));
                 if (plan.length > 2 && currentSavings > 0 && lowImpactSavings / currentSavings > 0.2) { // If > 20% of savings are from tiny actions (and plan has >2 items)
                     const lowImpactAction = plan.find(a => a.savings < 50);
                     if (lowImpactAction) {
                        feedback += '\n' + appData.llmResponseTemplates.feedbackOverestimated(lowImpactAction);
                     }
                 }
                 // Check if major underestimated categories are missed
                 const hasHeatingAction = plan.some(a => a.category.includes('Heating'));
                 const hasWaterHeatingAction = plan.some(a => a.category.includes('Water Heating'));
                 if (!hasHeatingAction || !hasWaterHeatingAction) {
                     const missedAction = appData.energySavingActions.find(a =>
                         (!hasHeatingAction && a.category.includes('Heating') && a.savings > 300 && !plan.some(p => p.id === a.id)) ||
                         (!hasWaterHeatingAction && a.category.includes('Water Heating') && a.savings > 150 && !plan.some(p => p.id === a.id))
                     );
                     if (missedAction) {
                         feedback += '\n' + appData.llmResponseTemplates.feedbackUnderestimated(missedAction);
                     }
                 }
            }
            return feedback;
        }

        function generateInitialPlan(profile, goalKwh) {
             console.log(`Generating initial plan for goal: ${goalKwh} kWh`);
             let generatedPlan = [];
             let generatedSavings = 0;
             // Aim slightly under or over, randomly, to encourage modification
             const targetSavings = goalKwh * (0.85 + Math.random() * 0.25); // Target 85% to 110% of goal

             // Filter relevant actions and sort by impact/cost ratio (higher savings, lower cost preferred)
             const relevantActions = appData.energySavingActions
                 .filter(action => Array.isArray(action.relevantTo) && action.relevantTo.includes(profile.id)) // Ensure relevantTo is array
                 .sort((a, b) => (b.savings / (b.cost + 1)) - (a.savings / (a.cost + 1))); // +1 cost to avoid division by zero


             for (const action of relevantActions) {
                 if (generatedSavings < targetSavings) {
                     // Add action if it doesn't drastically overshoot and isn't redundant in category (simple check)
                     const existingCategoryAction = generatedPlan.find(a => a.category === action.category);
                     if (!existingCategoryAction || existingCategoryAction.savings < action.savings) { // Prefer higher saving action in category
                          if(existingCategoryAction) { // Remove lower saving action if adding higher one
                              const indexToRemove = generatedPlan.findIndex(a => a.id === existingCategoryAction.id);
                              if(indexToRemove > -1) {
                                  generatedSavings -= generatedPlan[indexToRemove].savings;
                                  generatedPlan.splice(indexToRemove, 1);
                              }
                          }
                         generatedPlan.push({...action}); // Add copy
                         generatedSavings += action.savings;
                     }
                 } else if (generatedPlan.length > 2) { // Stop if over target, unless plan is very short
                     break;
                 }
             }
             console.log(`Generated plan: ${generatedPlan.length} actions, ${generatedSavings} kWh`);
             return { plan: generatedPlan, savings: generatedSavings };
        }

         function simulateGuide(userQuery, tabId) {
             const taskState = state.currentTasks[tabId];
             if (!taskState) return "Error: Task state missing.";
             const lowerQuery = userQuery.toLowerCase();
             let response = "Okay, let's continue.";

             // Check if user is agreeing to add a suggested action
             // Look at the last *two* LLM messages to find the suggestion, as the last one might be the progress update
             let suggestionFound = false;
             let actionToAddFromSuggestion = null;
             for(let i = taskState.history.length - 1; i >= Math.max(0, taskState.history.length - 3); i--) {
                 const msg = taskState.history[i];
                 if (msg && msg.sender === 'llm' && msg.content) { // Check msg and content exist
                     const suggestedActionMatch = msg.content.match(/One option for (.*?) is "(.+?)", saving ~(\d+) kWh/);
                     if (suggestedActionMatch && (lowerQuery.includes('yes') || lowerQuery.includes('add') || lowerQuery.includes('okay') || lowerQuery.includes(suggestedActionMatch[2].toLowerCase()))) {
                         const actionName = suggestedActionMatch[2];
                         const action = appData.energySavingActions.find(a => a.action === actionName);
                         if (action && !taskState.plan.some(p => p.id === action.id)) { // Check if not already added
                             actionToAddFromSuggestion = action;
                             suggestionFound = true;
                             break;
                         }
                     }
                 }
             }


             if (suggestionFound && actionToAddFromSuggestion) {
                 addAction(tabId, actionToAddFromSuggestion.id); // This will trigger renderPlan which updates savings
                 const currentSavings = calculateTotalSavings(taskState.plan); // Recalculate after adding
                 const remaining = Math.max(0, taskState.goalKwh - currentSavings);
                  if (remaining <= 0) { // Use <= 0 to handle exact match or exceeding
                     response = appData.llmResponseTemplates.guideCompleted(currentSavings, taskState.goalKwh);
                  } else {
                     response = appData.llmResponseTemplates.progressUpdate(currentSavings, taskState.goalKwh, remaining);
                     // Suggest next category
                     const categoriesInPlan = [...new Set(taskState.plan.map(a => a.category))];
                     const nextCategory = getTopEnergyCategories(taskState.profile, 5)
                         .find(cat => cat && !categoriesInPlan.includes(cat.name) && !categoriesInPlan.includes(cat.name.replace(' & ','/'))); // Find top category not yet covered, check cat exists
                     if (nextCategory) {
                         response += '\n' + appData.llmResponseTemplates.guideCategoryFocus(nextCategory.name, nextCategory.usage, nextCategory.percentage);
                     } else {
                         response += '\nShall we look for other specific actions?'; // Fallback if no new categories
                     }
                  }
                 return response;
             }

             // Check if user wants to focus on a category
             const categoryKeywords = ['heating', 'cooling', 'hvac', 'light', 'lighting', 'appliance', 'appliances', 'water', 'electronics'];
             const mentionedCategory = categoryKeywords.find(cat => lowerQuery.includes(cat));
             if (mentionedCategory) {
                  // Normalize category name slightly
                  let searchCategory = mentionedCategory;
                  if (searchCategory === 'light') searchCategory = 'lighting';
                  if (searchCategory === 'appliance') searchCategory = 'appliances';

                 const actionsInCategory = appData.energySavingActions
                     .filter(a => a.category.toLowerCase().includes(searchCategory) && !taskState.plan.some(p => p.id === a.id) && Array.isArray(a.relevantTo) && a.relevantTo.includes(taskState.profile.id)) // Ensure relevantTo check
                     .sort((a, b) => b.savings - a.savings);


                 if (actionsInCategory.length > 0) {
                     response = `Okay, for ${searchCategory}, ` + appData.llmResponseTemplates.guideActionSuggestion(actionsInCategory[0]);
                 } else {
                     response = `I don't have any more suggestions for ${searchCategory} that aren't already in your plan. Shall we look at another area?`;
                 }
                 return response;
             }

             // Default: Update progress and ask what next
             const currentSavings = calculateTotalSavings(taskState.plan);
             const remaining = Math.max(0, taskState.goalKwh - currentSavings);
              if (remaining <= 0) {
                 response = appData.llmResponseTemplates.guideCompleted(currentSavings, taskState.goalKwh);
              } else {
                 response = `Current savings: ${currentSavings.toLocaleString()} kWh. Remaining needed: ${remaining.toLocaleString()} kWh. What area should we focus on next (e.g., heating, lighting, appliances)?`;
              }
             return response;
         }

         function simulateBrainstormer(userQuery, tabId) {
             const taskState = state.currentTasks[tabId];
             if (!taskState) return "Error: Task state missing.";
             const lowerQuery = userQuery.toLowerCase();

             // Try to identify a category
             const categoryKeywords = ['heating', 'cooling', 'hvac', 'light', 'lighting', 'appliance', 'appliances', 'water', 'water heating', 'electronics', 'general'];
              // Find the most specific match first
             let mentionedCategory = categoryKeywords
                .filter(cat => lowerQuery.includes(cat))
                .sort((a, b) => b.length - a.length)[0]; // Sort by length descending, take first

             let filterCategory = null;
             if (mentionedCategory && mentionedCategory !== 'general') {
                 // Normalize
                 if (mentionedCategory === 'light') mentionedCategory = 'lighting';
                 if (mentionedCategory === 'appliance') mentionedCategory = 'appliances';
                 if (mentionedCategory === 'water') mentionedCategory = 'water heating';
                 filterCategory = mentionedCategory;
             }

             // Find relevant actions not already in the plan
             const availableActions = appData.energySavingActions
                 .filter(action =>
                     Array.isArray(action.relevantTo) && action.relevantTo.includes(taskState.profile.id) && // Check relevance
                     !taskState.plan.some(pAction => pAction.id === action.id) &&
                     (!filterCategory || action.category.toLowerCase().includes(filterCategory))
                 )
                 // Shuffle randomly for brainstorming effect, then take top N
                 .sort(() => 0.5 - Math.random());


             // Suggest a few (e.g., 3)
             const suggestions = availableActions.slice(0, 3);

             if (suggestions.length > 0) {
                  let responseIntro = filterCategory
                      ? `Here are some ideas for ${filterCategory}:`
                      : "Here are a few general energy-saving ideas:";
                 return responseIntro + '\n' + appData.llmResponseTemplates.brainstormIdeas(suggestions);
             } else {
                  let noMoreIntro = filterCategory
                      ? `I've run out of specific ideas for ${filterCategory} that aren't in your plan.`
                      : "I've suggested most of the common actions applicable here.";
                 return noMoreIntro + '\n' + appData.llmResponseTemplates.brainstormNoMore();
             }
         }


        // --- UTILITY FUNCTIONS ---

        /**
         * Calculates the total savings for a given plan.
         * @param {Array<object>} plan - Array of action objects.
         * @returns {number} - Total kWh savings.
         */
        function calculateTotalSavings(plan) {
            if (!plan) return 0;
            return plan.reduce((sum, action) => sum + (action.savings || 0), 0);
        }

        /**
         * Selects a random item from an array.
         * @param {Array<any>} arr - The array to select from.
         * @returns {any} - A random item from the array, or null if array is empty/invalid.
         */
        function getRandomItem(arr) {
            if (!arr || arr.length === 0) return null;
            return arr[Math.floor(Math.random() * arr.length)];
        }

        /**
         * Calculates the absolute goal in kWh.
         * @param {object} goal - The goal object.
         * @param {object} profile - The household profile object.
         * @returns {number} - Goal in kWh. Returns 0 if input is invalid.
         */
        function calculateGoalKwh(goal, profile) {
             if (!goal || !profile || !profile.baseline || typeof profile.baseline.total !== 'number') return 0; // Safety check including type


            if (typeof goal.value === 'function') {
                try { // Add try-catch for function execution
                    return goal.value(profile);
                } catch (e) {
                    console.error("Error executing goal value function:", e);
                    return 0;
                }
            } else if (goal.type === 'percentage' && typeof goal.value === 'number') {
                return Math.round(profile.baseline.total * goal.value);
            } else if (typeof goal.value === 'number') {
                return goal.value; // Absolute goal value
            }
            return 0; // Default fallback
        }

         /**
          * Gets the top N energy consuming categories for a profile.
          * @param {object} profile - The household profile.
          * @param {number} count - The number of categories to return.
          * @returns {Array<object>} - Array of category objects {name, usage, percentage}. Returns empty array if invalid input.
          */
         function getTopEnergyCategories(profile, count) {
             if (!profile || !profile.baseline || !profile.baseline.breakdown || typeof profile.baseline.total !== 'number') { // Check type of total
                 return []; // Return empty array if data is missing or invalid
             }
             const categories = [];
             const totalUsage = profile.baseline.total;
             if (totalUsage <= 0) return []; // Avoid division by zero

             for (const [category, usage] of Object.entries(profile.baseline.breakdown)) {
                 // Ensure usage is a number and category is valid
                 if (category !== 'total' && typeof usage === 'number' && usage > 0) {
                     categories.push({
                         name: category.charAt(0).toUpperCase() + category.slice(1).replace(/([A-Z])/g, ' $1').trim(), // Format name
                         usage: usage,
                         percentage: Math.round((usage / totalUsage) * 100)
                     });
                 }
             }
             // Sort by usage (descending) and take the top 'count'
             return categories.sort((a, b) => b.usage - a.usage).slice(0, count);
         }


        // --- INITIALIZATION ---
        // Initialize the demo when the DOM is ready
        document.addEventListener('DOMContentLoaded', init);

    </script>

</body>
</html>
