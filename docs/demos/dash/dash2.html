<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Reduction Planning Tasks</title>
    <style>
        :root {
            --primary-color: #2c73d2;
            --secondary-color: #2a9d8f;
            --light-bg: #f8f9fa;
            --border-color: #dee2e6;
            --text-color: #212529;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --error-color: #dc3545;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: #f5f7f9;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .dashboard {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }
        
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        header h1 {
            font-size: 24px;
            margin-bottom: 5px;
        }
        
        header p {
            opacity: 0.8;
            font-size: 16px;
        }
        
        /* Tab navigation */
        .tabs {
            display: flex;
            background-color: var(--light-bg);
            border-bottom: 1px solid var(--border-color);
            overflow-x: auto;
        }
        
        .tab-button {
            padding: 12px 16px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-weight: 500;
            color: #495057;
            white-space: nowrap;
            transition: all 0.2s;
        }
        
        .tab-button:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .tab-button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }
        
        .tab-content {
            padding: 20px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* Dashboard components */
        .card {
            background-color: white;
            border-radius: 6px;
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: var(--primary-color);
        }
        
        .task-description {
            background-color: var(--light-bg);
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 -10px;
        }
        
        .col {
            flex: 1;
            padding: 0 10px;
            min-width: 300px;
        }
        
        /* Form elements */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
        }
        
        .form-control {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
        }
        
        .form-control:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(44, 115, 210, 0.2);
        }
        
        /* Buttons */
        .btn {
            display: inline-block;
            font-weight: 500;
            text-align: center;
            vertical-align: middle;
            cursor: pointer;
            padding: 8px 16px;
            font-size: 16px;
            border-radius: 4px;
            border: 1px solid transparent;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background-color: var(--primary-color);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #2055a5;
        }
        
        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #228276;
        }
        
        /* Profile card */
        .profile-card {
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .profile-card:hover {
            border-color: var(--primary-color);
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        }
        
        .profile-card.selected {
            border-color: var(--primary-color);
            background-color: rgba(44, 115, 210, 0.05);
        }
        
        .profile-card h3 {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--primary-color);
        }
        
        /* Action item */
        .action-item {
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .action-item:hover {
            border-color: var(--primary-color);
            background-color: rgba(44, 115, 210, 0.05);
        }
        
        .action-item h4 {
            font-size: 16px;
            margin-bottom: 5px;
        }
        
        .action-tag {
            display: inline-block;
            padding: 3px 8px;
            font-size: 12px;
            border-radius: 12px;
            margin-right: 8px;
            background-color: rgba(44, 115, 210, 0.1);
            color: var(--primary-color);
        }
        
        /* Plan display */
        .plan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            margin-bottom: 10px;
        }
        
        .plan-item-content {
            flex-grow: 1;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #e9ecef;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            transition: width 0.3s ease;
        }
        
        /* AI feedback panel */
        .feedback-panel {
            background-color: #f0f7ff;
            border-left: 4px solid var(--primary-color);
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
        }
        
        .feedback-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* Background tabs */
        .info-section {
            margin-bottom: 25px;
        }
        
        .info-section h3 {
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .row {
                flex-direction: column;
            }
            
            .tab-button {
                padding: 10px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="dashboard">
            <header>
                <h1>Energy Reduction Planning Tasks Dashboard</h1>
                <p>An interactive demo of experimental paradigms for human-AI collaboration in energy conservation</p>
            </header>
            
            <div class="tabs" id="dashboard-tabs">
                <button class="tab-button active" data-target="intro">Introduction</button>
                <button class="tab-button" data-target="estimate-plan">Estimate-then-Plan</button>
                <button class="tab-button" data-target="critique-revision">Critique & Revision</button>
                <button class="tab-button" data-target="seed-plan">Seed Plan Anchoring</button>
                <button class="tab-button" data-target="implementation">Implementation Intentions</button>
                <button class="tab-button" data-target="compare">Comparative Planning</button>
                <button class="tab-button" data-target="background">Background & Hypotheses</button>
            </div>
            
            <div class="tab-content">
                <!-- Introduction Tab -->
                <div id="intro" class="tab-pane active">
                    <h2>Energy Reduction Planning Experiments</h2>
                    <div class="task-description">
                        <p>This dashboard demonstrates various experimental tasks designed to study how people create energy reduction plans from abstract goals, with assistance from AI systems. Each task tests different cognitive aspects of planning and decision-making in energy conservation.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Research Objectives</div>
                                <p>This research examines how people translate high-level energy reduction goals (e.g., "reduce energy by 10%") into concrete, appliance-specific actions. We explore how different forms of AI assistance affect:</p>
                                <ul style="margin-top: 10px; padding-left: 20px;">
                                    <li>Planning accuracy and efficiency</li>
                                    <li>Cognitive load during the planning process</li>
                                    <li>Correction of common energy misconceptions</li>
                                    <li>Perceived agency and implementation intentions</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Try Different Task Paradigms</div>
                                <p>Each tab represents a different experimental paradigm:</p>
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-primary" onclick="switchTab('estimate-plan')">Estimate-then-Plan</button>
                                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="switchTab('critique-revision')">Critique & Revision</button>
                                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="switchTab('seed-plan')">Seed Plan Anchoring</button>
                                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="switchTab('implementation')">Implementation Intentions</button>
                                    <button class="btn btn-primary" style="margin-top: 10px;" onclick="switchTab('compare')">Comparative Planning</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">Key Literature and Data Sources</div>
                        <p>This research builds on established findings in energy perception and conservation:</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            <li><strong>Attari et al. (2010)</strong> - Found that people systematically underestimate high-impact energy actions while overestimating low-impact ones</li>
                            <li><strong>Marghetis et al. (2019)</strong> - Demonstrated that simple interventions can improve energy judgments</li>
                            <li><strong>EIA Residential Energy Consumption Survey</strong> - Source for realistic household profiles</li>
                            <li><strong>ENERGY STAR and DOE data</strong> - Sources for accurate appliance energy savings estimates</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Estimate-then-Plan Tab -->
                <div id="estimate-plan" class="tab-pane">
                    <h2>Task 1: Estimate-then-Plan with Causal Explanations</h2>
                    <div class="task-description">
                        <p>This task has two phases: (1) estimate the energy use of different categories and receive feedback, then (2) create an energy reduction plan. The AI can provide either basic numeric feedback or detailed explanatory feedback.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Household Profile</div>
                                <div id="estimate-profiles">
                                    <div class="profile-card selected" data-profile="suburban">
                                        <h3>Suburban Family Home</h3>
                                        <p>2,500 sq ft with 4 occupants</p>
                                        <p><strong>Annual Usage:</strong> 12,000 kWh</p>
                                    </div>
                                    <div class="profile-card" data-profile="apartment">
                                        <h3>Urban Apartment</h3>
                                        <p>900 sq ft with 2 occupants</p>
                                        <p><strong>Annual Usage:</strong> 7,000 kWh</p>
                                    </div>
                                    <div class="profile-card" data-profile="rural">
                                        <h3>Rural Home with Electric Heat</h3>
                                        <p>1,800 sq ft with 3 occupants</p>
                                        <p><strong>Annual Usage:</strong> 15,000 kWh</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task Settings</div>
                                <div class="form-group">
                                    <label>Reduction Target:</label>
                                    <select id="estimate-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15">15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Goal Format:</label>
                                    <select id="estimate-format" class="form-control">
                                        <option value="kwh">kilowatt-hours (kWh)</option>
                                        <option value="percent">Percentage (%)</option>
                                        <option value="dollars">Dollars ($)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Feedback Type:</label>
                                    <select id="estimate-feedback" class="form-control">
                                        <option value="explanation">With Explanations</option>
                                        <option value="basic">Basic (Numbers Only)</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div id="estimation-phase" class="card">
                                <div class="card-title">Phase 1: Energy Estimation</div>
                                <p>Estimate what percentage of total home energy each category represents:</p>
                                
                                <div class="form-group" style="margin-top: 15px;">
                                    <label>Heating:</label>
                                    <input type="number" id="estimate-heating" class="form-control" min="0" max="100" placeholder="Enter percentage">
                                </div>
                                
                                <div class="form-group">
                                    <label>Cooling:</label>
                                    <input type="number" id="estimate-cooling" class="form-control" min="0" max="100" placeholder="Enter percentage">
                                </div>
                                
                                <div class="form-group">
                                    <label>Water Heating:</label>
                                    <input type="number" id="estimate-water" class="form-control" min="0" max="100" placeholder="Enter percentage">
                                </div>
                                
                                <div class="form-group">
                                    <label>Appliances:</label>
                                    <input type="number" id="estimate-appliances" class="form-control" min="0" max="100" placeholder="Enter percentage">
                                </div>
                                
                                <div class="form-group">
                                    <label>Lighting:</label>
                                    <input type="number" id="estimate-lighting" class="form-control" min="0" max="100" placeholder="Enter percentage">
                                </div>
                                
                                <div class="form-group">
                                    <label>Electronics:</label>
                                    <input type="number" id="estimate-electronics" class="form-control" min="0" max="100" placeholder="Enter percentage">
                                </div>
                                
                                <button id="submit-estimates" class="btn btn-primary">Submit Estimates & Get Feedback</button>
                            </div>
                            
                            <div id="estimate-feedback-panel" class="feedback-panel" style="display: none;">
                                <div class="feedback-title">AI Feedback on Your Estimates</div>
                                <div id="estimate-feedback-content"></div>
                                <button id="continue-to-planning" class="btn btn-secondary" style="margin-top: 15px;">Continue to Planning Phase</button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="planning-phase" style="display: none;">
                        <h3>Phase 2: Energy Reduction Planning</h3>
                        <p>Now create a concrete plan to reduce energy consumption by selecting specific actions.</p>
                        
                        <div class="row" style="margin-top: 20px;">
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Available Actions</div>
                                    <input type="text" id="action-search" class="form-control" placeholder="Search actions..." style="margin-bottom: 15px;">
                                    
                                    <div id="available-actions" style="max-height: 500px; overflow-y: auto;">
                                        <!-- Actions will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Your Energy Reduction Plan</div>
                                    
                                    <div id="selected-plan" style="min-height: 200px;">
                                        <p id="empty-plan-message">Select actions from the left panel to add to your plan.</p>
                                    </div>
                                    
                                    <div class="progress-container">
                                        <div class="progress-label">
                                            <span>Target: <span id="reduction-target">0</span></span>
                                            <span>Current: <span id="current-savings">0</span></span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="progress-fill" class="progress-fill" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                    
                                    <button id="submit-plan" class="btn btn-primary">Submit Final Plan</button>
                                </div>
                            </div>
                        </div>
                        
                        <div id="plan-feedback" class="feedback-panel" style="display: none;">
                            <div class="feedback-title">Plan Analysis</div>
                            <div id="plan-feedback-content"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Critique & Revision Tab -->
                <div id="critique-revision" class="tab-pane">
                    <h2>Task 2: LLM Critique-and-Revision Loop</h2>
                    <div class="task-description">
                        <p>Create an energy-saving plan, receive AI feedback on its accuracy and balance, and then revise it. The AI can provide basic or detailed criticism, highlighting where your plan could be improved.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Household & Settings</div>
                                
                                <div class="form-group">
                                    <label>Household Profile:</label>
                                    <select id="critique-household" class="form-control">
                                        <option value="suburban">Suburban Family Home (12,000 kWh)</option>
                                        <option value="apartment">Urban Apartment (7,000 kWh)</option>
                                        <option value="rural">Rural Home with Electric Heat (15,000 kWh)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Reduction Target:</label>
                                    <select id="critique-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15">15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Feedback Detail:</label>
                                    <select id="critique-detail" class="form-control">
                                        <option value="detailed">Detailed Feedback</option>
                                        <option value="basic">Basic Feedback</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Available Actions</div>
                                <input type="text" id="critique-search" class="form-control" placeholder="Search actions..." style="margin-bottom: 15px;">
                                
                                <div id="critique-actions" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Actions will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Your Plan <span id="revision-cycle">(Initial Draft)</span></div>
                                
                                <div id="critique-plan" style="min-height: 200px;">
                                    <p id="empty-critique-plan">Select actions from the left panel to add to your plan.</p>
                                </div>
                                
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Target: <span id="critique-target-value">0</span></span>
                                        <span>Current: <span id="critique-current-savings">0</span></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="critique-progress" class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <button id="request-critique" class="btn btn-secondary">Request AI Critique</button>
                                    <button id="submit-critique-plan" class="btn btn-primary" disabled>Submit Final Plan</button>
                                </div>
                            </div>
                            
                            <div id="critique-feedback" class="feedback-panel" style="display: none;">
                                <div class="feedback-title">AI Critique</div>
                                <div id="critique-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Seed Plan Anchoring Tab -->
                <div id="seed-plan" class="tab-pane">
                    <h2>Task 3: Seed Plan Anchoring</h2>
                    <div class="task-description">
                        <p>This task starts with an AI-generated initial plan that you must edit to reach your energy reduction goal. The seed plan may be accurate or biased, testing how starting points influence your final decisions.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Task Settings</div>
                                
                                <div class="form-group">
                                    <label>Household Profile:</label>
                                    <select id="seed-household" class="form-control">
                                        <option value="suburban">Suburban Family Home (12,000 kWh)</option>
                                        <option value="apartment">Urban Apartment (7,000 kWh)</option>
                                        <option value="rural">Rural Home with Electric Heat (15,000 kWh)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Reduction Target:</label>
                                    <select id="seed-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15">15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Goal Format:</label>
                                    <select id="seed-format" class="form-control">
                                        <option value="kwh">kilowatt-hours (kWh)</option>
                                        <option value="percent">Percentage (%)</option>
                                        <option value="dollars">Dollars ($)</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Seed Plan Quality:</label>
                                    <select id="seed-quality" class="form-control">
                                        <option value="accurate">Accurate Seed Plan</option>
                                        <option value="biased">Biased Seed Plan (Lighting/Electronics Heavy)</option>
                                    </select>
                                </div>
                                
                                <button id="generate-seed" class="btn btn-primary">Generate AI Seed Plan</button>
                            </div>
                            
                            <div id="seed-actions-card" class="card" style="display: none;">
                                <div class="card-title">Additional Actions</div>
                                <p>You can add these actions to your plan:</p>
                                <div id="seed-actions" style="max-height: 300px; overflow-y: auto; margin-top: 10px;">
                                    <!-- Actions will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div id="seed-plan-card" class="card" style="display: none;">
                                <div class="card-title">Your Plan (Based on AI Seed)</div>
                                <div style="margin-bottom: 10px; font-size: 14px; color: #6c757d;">
                                    <span id="edit-count">0</span> edits made from original seed
                                </div>
                                
                                <div id="seed-plan" style="min-height: 200px;">
                                    <!-- Seed plan will be populated by JavaScript -->
                                </div>
                                
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Target: <span id="seed-target-value">0</span></span>
                                        <span>Current: <span id="seed-current-savings">0</span></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="seed-progress" class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                </div>
                                
                                <button id="submit-seed-plan" class="btn btn-primary">Submit Final Plan</button>
                            </div>
                            
                            <div id="seed-feedback" class="feedback-panel" style="display: none;">
                                <div class="feedback-title">Plan Analysis</div>
                                <div id="seed-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Implementation Intentions Tab -->
                <div id="implementation" class="tab-pane">
                    <h2>Task 4: Implementation-Intention Wizard</h2>
                    <div class="task-description">
                        <p>This task focuses on creating specific "if-then" implementation intentions for energy-saving actions. The AI wizard can help you craft effective implementation plans that overcome the intention-action gap.</p>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Task Settings</div>
                                
                                <div class="form-group">
                                    <label>Household Profile:</label>
                                    <select id="implementation-household" class="form-control">
                                        <option value="suburban">Suburban Family Home</option>
                                        <option value="apartment">Urban Apartment</option>
                                        <option value="rural">Rural Home with Electric Heat</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>AI Assistance:</label>
                                    <select id="implementation-assistance" class="form-control">
                                        <option value="enabled">AI Wizard Enabled</option>
                                        <option value="disabled">No Assistance</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Recommended High-Impact Actions</div>
                                <p>Select actions to create implementation intentions for:</p>
                                
                                <div id="implementation-actions" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                                    <!-- High-impact actions will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div id="implementation-form" style="display: none;" class="card">
                                <div class="card-title">Create Implementation Intention</div>
                                <div id="current-action-info" style="margin-bottom: 15px; padding: 10px; background-color: #f8f9fa; border-radius: 4px;">
                                    <!-- Current action info will be populated by JavaScript -->
                                </div>
                                
                                <div class="form-group">
                                    <label>If (situation/cue):</label>
                                    <textarea id="if-condition" class="form-control" rows="2" placeholder="When will you perform this action? What will trigger you?"></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label>Then (specific action):</label>
                                    <textarea id="then-action" class="form-control" rows="2" placeholder="What exactly will you do? Be as specific as possible."></textarea>
                                </div>
                                
                                <div id="wizard-suggestions" style="margin: 15px 0; padding: 15px; background-color: #e2f3ff; border-radius: 4px;">
                                    <h4 style="margin-top: 0; font-size: 16px;">AI Wizard Suggestions:</h4>
                                    <div id="wizard-content">
                                        <!-- Suggestions will be populated by JavaScript -->
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: flex-end; gap: 10px;">
                                    <button id="cancel-implementation" class="btn btn-secondary">Cancel</button>
                                    <button id="save-implementation" class="btn btn-primary">Save Implementation</button>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Your Implementation Plan</div>
                                <div id="implementation-plan" style="min-height: 200px;">
                                    <p id="empty-implementation-plan">Select actions from the left panel to add implementation intentions.</p>
                                </div>
                                
                                <button id="submit-implementation" class="btn btn-primary">Submit Final Implementation Plan</button>
                            </div>
                            
                            <div id="implementation-feedback" class="feedback-panel" style="display: none;">
                                <div class="feedback-title">Implementation Plan Analysis</div>
                                <div id="implementation-feedback-content"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Comparative Planning Tab -->
                <div id="compare" class="tab-pane">
                    <h2>Task 5: Comparative Planning</h2>
                    <div class="task-description">
                        <p>This task compares human-created and AI-generated energy reduction plans. You'll either create your plan first and then see the AI's plan, or vice versa, and then choose which plan you prefer or create a hybrid.</p>
                    </div>
                    
                    <div class="card" id="compare-setup">
                        <div class="card-title">Task Setup</div>
                        <div class="row">
                            <div class="col" style="min-width: 200px;">
                                <div class="form-group">
                                    <label>Household Profile:</label>
                                    <select id="compare-household" class="form-control">
                                        <option value="suburban">Suburban Family Home (12,000 kWh)</option>
                                        <option value="apartment">Urban Apartment (7,000 kWh)</option>
                                        <option value="rural">Rural Home with Electric Heat (15,000 kWh)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col" style="min-width: 200px;">
                                <div class="form-group">
                                    <label>Reduction Target:</label>
                                    <select id="compare-target" class="form-control">
                                        <option value="10">10% reduction</option>
                                        <option value="15">15% reduction</option>
                                        <option value="20">20% reduction</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="col" style="min-width: 200px;">
                                <div class="form-group">
                                    <label>Planning Order:</label>
                                    <select id="compare-order" class="form-control">
                                        <option value="human-first">Human First, Then AI</option>
                                        <option value="ai-first">AI First, Then Human</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <button id="start-compare" class="btn btn-primary" style="margin-top: 15px;">Start Planning Process</button>
                    </div>
                    
                    <div id="compare-planning" style="display: none;">
                        <div id="phase-indicator" class="card" style="margin-bottom: 20px;">
                            <div class="card-title">Current Phase: <span id="phase-name">Human Planning</span></div>
                            <p id="phase-description">Create your energy reduction plan by selecting actions from the list.</p>
                        </div>
                        
                        <div class="row">
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Available Actions</div>
                                    <input type="text" id="compare-search" class="form-control" placeholder="Search actions..." style="margin-bottom: 15px;">
                                    
                                    <div id="compare-actions" style="max-height: 400px; overflow-y: auto;">
                                        <!-- Actions will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card">
                                    <div class="card-title" id="current-plan-title">Your Plan</div>
                                    
                                    <div id="compare-plan" style="min-height: 200px;">
                                        <p id="empty-compare-plan">Select actions from the left panel to add to your plan.</p>
                                    </div>
                                    
                                    <div class="progress-container">
                                        <div class="progress-label">
                                            <span>Target: <span id="compare-target-value">0</span></span>
                                            <span>Current: <span id="compare-current-savings">0</span></span>
                                        </div>
                                        <div class="progress-bar">
                                            <div id="compare-progress" class="progress-fill" style="width: 0%;"></div>
                                        </div>
                                    </div>
                                    
                                    <button id="next-phase" class="btn btn-primary">Continue to Next Phase</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="comparison-phase" style="display: none;">
                        <h3>Compare Plans and Choose Your Preferred Approach</h3>
                        <p>Now that you've seen both plans, choose which one you prefer or create a hybrid plan.</p>
                        
                        <div class="row">
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">Human Plan</div>
                                    <div id="human-plan-display" style="min-height: 300px;">
                                        <!-- Human plan will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card">
                                    <div class="card-title">AI Plan</div>
                                    <div id="ai-plan-display" style="min-height: 300px;">
                                        <!-- AI plan will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-title">Your Final Choice</div>
                            
                            <div class="form-group">
                                <label>Select plan type:</label>
                                <div style="margin: 10px 0;">
                                    <label style="display: block; margin-bottom: 10px;">
                                        <input type="radio" name="final-plan-choice" value="human" style="margin-right: 10px;">
                                        Use Human Plan
                                    </label>
                                    <label style="display: block; margin-bottom: 10px;">
                                        <input type="radio" name="final-plan-choice" value="ai" style="margin-right: 10px;">
                                        Use AI Plan
                                    </label>
                                    <label style="display: block;">
                                        <input type="radio" name="final-plan-choice" value="hybrid" style="margin-right: 10px;">
                                        Create Hybrid Plan
                                    </label>
                                </div>
                            </div>
                            
                            <div id="hybrid-editor" style="display: none;">
                                <p>Create your hybrid plan by selecting actions from both plans:</p>
                                <div id="hybrid-plan" style="min-height: 150px; border: 1px solid #ddd; border-radius: 4px; padding: 10px; margin: 10px 0;">
                                    <p id="empty-hybrid-plan">No actions selected yet. Use the checkboxes above to select actions.</p>
                                </div>
                                
                                <div class="progress-container">
                                    <div class="progress-label">
                                        <span>Target: <span id="hybrid-target-value">0</span></span>
                                        <span>Current: <span id="hybrid-current-savings">0</span></span>
                                    </div>
                                    <div class="progress-bar">
                                        <div id="hybrid-progress" class="progress-fill" style="width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group" style="margin-top: 15px;">
                                <label>Why did you make this choice?</label>
                                <textarea id="choice-justification" class="form-control" rows="3" placeholder="Please explain your reasoning..."></textarea>
                            </div>
                            
                            <button id="submit-comparison" class="btn btn-primary">Submit Final Choice</button>
                        </div>
                        
                        <div id="comparison-feedback" class="feedback-panel" style="display: none;">
                            <div class="feedback-title">Comparative Analysis</div>
                            <div id="comparison-feedback-content"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Background & Hypotheses Tab -->
                <div id="background" class="tab-pane">
                    <h2>Background Information & Research Hypotheses</h2>
                    
                    <div class="info-section">
                        <h3>Theoretical Framework</h3>
                        <p>This research integrates several theoretical domains:</p>
                        <ul style="padding-left: 20px; margin-top: 10px;">
                            <li><strong>Mental Models:</strong> People have systematic misconceptions about energy use, typically underestimating high-impact actions (heating, cooling) while overestimating visible, low-wattage activities (lighting).</li>
                            <li><strong>Cognitive Load Theory:</strong> Different forms of AI assistance may affect intrinsic, extraneous, and germane load during planning.</li>
                            <li><strong>Anchoring and Adjustment:</strong> Initial values or plans influence final judgments, even when they're known to be biased.</li>
                            <li><strong>Implementation Intentions:</strong> Specific "if-then" plans help bridge the intention-action gap in behavior change.</li>
                            <li><strong>Human-AI Collaboration:</strong> Different collaboration models affect trust, reliance, and agency.</li>
                        </ul>
                    </div>
                    
                    <div class="row">
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Task 1: Estimate-then-Plan Hypotheses</div>
                                <ul style="padding-left: 20px;">
                                    <li><strong>H1:</strong> Explanatory feedback will lead to greater improvement in estimation accuracy than numeric-only feedback.</li>
                                    <li><strong>H2:</strong> The advantage of kWh format (vs. % or $) will be reduced when explanatory feedback is provided.</li>
                                    <li><strong>H3:</strong> Explanatory feedback will increase selection of high-impact actions in the planning phase.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task 2: Critique-and-Revision Hypotheses</div>
                                <ul style="padding-left: 20px;">
                                    <li><strong>H1:</strong> Detailed critique will yield larger accuracy gains than basic critique.</li>
                                    <li><strong>H2:</strong> Plans will show greater balance across categories after critique.</li>
                                    <li><strong>H3:</strong> Two rounds of critique will produce more accurate plans than one round.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task 3: Seed Plan Anchoring Hypotheses</div>
                                <ul style="padding-left: 20px;">
                                    <li><strong>H1:</strong> Participants starting with biased seed plans will produce final plans with greater deviation from optimal allocations.</li>
                                    <li><strong>H2:</strong> The anchoring effect will be stronger with percentage/dollar formats than with kWh.</li>
                                    <li><strong>H3:</strong> Edit distance will be smaller for percentage/dollar conditions than for kWh.</li>
                                </ul>
                            </div>
                        </div>
                        
                        <div class="col">
                            <div class="card">
                                <div class="card-title">Task 4: Implementation Intentions Hypotheses</div>
                                <ul style="padding-left: 20px;">
                                    <li><strong>H1:</strong> AI wizard assistance will produce higher-quality implementation intentions (more specific cues and actions).</li>
                                    <li><strong>H2:</strong> AI-assisted implementation intentions will lead to higher perceived feasibility for high-impact actions.</li>
                                    <li><strong>H3:</strong> Self-generated intentions will be associated with higher perceived ownership.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Task 5: Comparative Planning Hypotheses</div>
                                <ul style="padding-left: 20px;">
                                    <li><strong>H1:</strong> When human-plan comes first, participants will be more likely to select the human plan or create a human-dominant hybrid.</li>
                                    <li><strong>H2:</strong> When AI-plan comes first, participants will incorporate more AI-suggested high-impact actions.</li>
                                    <li><strong>H3:</strong> Hybrid plans will be more accurate than either pure human or pure AI plans.</li>
                                </ul>
                            </div>
                            
                            <div class="card">
                                <div class="card-title">Cross-Task Hypotheses</div>
                                <ul style="padding-left: 20px;">
                                    <li><strong>H1:</strong> Cognitive load will be highest with no AI assistance, lowest in delegation-heavy tasks, and moderate in collaborative tasks.</li>
                                    <li><strong>H2:</strong> Perceived agency will be inversely related to the level of AI involvement.</li>
                                    <li><strong>H3:</strong> All forms of AI assistance will improve plan accuracy compared to no assistance, but the magnitude will vary by assistance type.</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <h3>Key Literature</h3>
                        <div style="margin-top: 10px;">
                            <p><strong>Attari et al. (2010).</strong> Public perceptions of energy consumption and savings. <em>Proceedings of the National Academy of Sciences, 107</em>(37), 16054-16059.</p>
                            <p style="margin-top: 5px;">Found that people systematically underestimate energy use and savings of high-impact actions by factor of 2.8 while overestimating low-impact actions.</p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <p><strong>Marghetis et al. (2019).</strong> Simple interventions can correct misperceptions of home energy use. <em>Nature Energy, 4</em>(10), 874-881.</p>
                            <p style="margin-top: 5px;">Demonstrated that providing calibrated examples and energy-relevant heuristics could improve energy judgments.</p>
                        </div>
                        
                        <div style="margin-top: 15px;">
                            <p><strong>Gollwitzer & Sheeran (2006).</strong> Implementation intentions and goal achievement: A meta-analysis of effects and processes. <em>Advances in Experimental Social Psychology, 38</em>, 69-119.</p>
                            <p style="margin-top: 5px;">Meta-analysis showing that specific "if-then" implementation intentions significantly increase goal achievement.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Data for the dashboard
        const households = {
            suburban: {
                name: "Suburban Family Home",
                description: "2,500 sq ft home with 4 occupants in a moderate climate",
                annualKwh: 12000,
                monthlyCost: 150,
                breakdown: {
                    heating: 35,
                    cooling: 15,
                    waterHeating: 20,
                    appliances: 15,
                    lighting: 10,
                    electronics: 5
                }
            },
            apartment: {
                name: "Urban Apartment",
                description: "900 sq ft apartment with 2 occupants in a mild climate",
                annualKwh: 7000,
                monthlyCost: 90,
                breakdown: {
                    heating: 25,
                    cooling: 10,
                    waterHeating: 25,
                    appliances: 20,
                    lighting: 12,
                    electronics: 8
                }
            },
            rural: {
                name: "Rural Home with Electric Heat",
                description: "1,800 sq ft home with 3 occupants in a cold climate",
                annualKwh: 15000,
                monthlyCost: 180,
                breakdown: {
                    heating: 45,
                    cooling: 8,
                    waterHeating: 18,
                    appliances: 14,
                    lighting: 9,
                    electronics: 6
                }
            }
        };
        
        const energyActions = [
            {
                id: "action1",
                category: "heating",
                name: "Lower thermostat by 2F in winter",
                savingsKwh: 550,
                savingsPercent: 5,
                savingsDollars: 66,
                cost: 0,
                effort: "low",
                description: "Reducing thermostat setting by just 2F can save significant energy with minimal comfort impact."
            },
            {
                id: "action2",
                category: "heating",
                name: "Install programmable thermostat",
                savingsKwh: 800,
                savingsPercent: 7.5,
                savingsDollars: 96,
                cost: 150,
                effort: "medium",
                description: "Automatically adjusts temperature based on schedule, avoiding heating empty homes."
            },
            {
                id: "action3",
                category: "heating",
                name: "Upgrade to high-efficiency heat pump",
                savingsKwh: 3500,
                savingsPercent: 32.7,
                savingsDollars: 420,
                cost: 7000,
                effort: "high",
                description: "Modern heat pumps can reduce heating energy use by 50% compared to electric resistance heating."
            },
            {
                id: "action4",
                category: "heating",
                name: "Add attic insulation (R-30 to R-60)",
                savingsKwh: 1100,
                savingsPercent: 10.3,
                savingsDollars: 132,
                cost: 1800,
                effort: "high",
                description: "Prevents heat loss through ceiling, accounting for up to 25% of home heating costs."
            },
            {
                id: "action5",
                category: "cooling",
                name: "Raise thermostat by 2F in summer",
                savingsKwh: 225,
                savingsPercent: 2.1,
                savingsDollars: 27,
                cost: 0,
                effort: "low",
                description: "Each degree you raise your thermostat in summer reduces cooling energy use."
            },
            {
                id: "action6",
                category: "cooling",
                name: "Use ceiling fans to supplement AC",
                savingsKwh: 175,
                savingsPercent: 1.6,
                savingsDollars: 21,
                cost: 0,
                effort: "low",
                description: "Fans create a wind-chill effect, allowing you to set the thermostat higher."
            },
            {
                id: "action7",
                category: "cooling",
                name: "Replace AC older than 15 years",
                savingsKwh: 500,
                savingsPercent: 4.7,
                savingsDollars: 60,
                cost: 3500,
                effort: "high",
                description: "New ENERGY STAR air conditioners can be up to 40% more efficient than older models."
            },
            {
                id: "action8",
                category: "waterHeating",
                name: "Lower water heater temperature to 120F",
                savingsKwh: 450,
                savingsPercent: 4.2,
                savingsDollars: 54,
                cost: 0,
                effort: "low",
                description: "Most water heaters are set higher than necessary, wasting energy."
            },
            {
                id: "action9",
                category: "waterHeating",
                name: "Install low-flow showerheads",
                savingsKwh: 350,
                savingsPercent: 3.3,
                savingsDollars: 42,
                cost: 40,
                effort: "low",
                description: "Uses less hot water while maintaining good water pressure."
            },
            {
                id: "action10",
                category: "waterHeating",
                name: "Wash clothes in cold water",
                savingsKwh: 225,
                savingsPercent: 2.1,
                savingsDollars: 27,
                cost: 0,
                effort: "low",
                description: "Modern detergents work well in cold water, eliminating need for energy-intensive hot water."
            },
            {
                id: "action11",
                category: "waterHeating",
                name: "Upgrade to heat pump water heater",
                savingsKwh: 1400,
                savingsPercent: 13.1,
                savingsDollars: 168,
                cost: 1600,
                effort: "high",
                description: "Uses electricity to move heat rather than generate it directly, reducing energy use by up to 60%."
            },
            {
                id: "action12",
                category: "appliances",
                name: "Replace refrigerator older than 15 years",
                savingsKwh: 550,
                savingsPercent: 5.1,
                savingsDollars: 66,
                cost: 800,
                effort: "high",
                description: "New ENERGY STAR refrigerators use significantly less energy than older models."
            },
            {
                id: "action13",
                category: "appliances",
                name: "Run dishwasher only when full",
                savingsKwh: 100,
                savingsPercent: 0.9,
                savingsDollars: 12,
                cost: 0,
                effort: "low",
                description: "Maximizes the efficiency of each dishwasher cycle."
            },
            {
                id: "action14",
                category: "appliances",
                name: "Air dry clothes instead of using dryer",
                savingsKwh: 375,
                savingsPercent: 3.5,
                savingsDollars: 45,
                cost: 20,
                effort: "medium",
                description: "Clothes dryers are one of the most energy-intensive appliances in homes."
            },
            {
                id: "action15",
                category: "lighting",
                name: "Replace 10 incandescent bulbs with LEDs",
                savingsKwh: 150,
                savingsPercent: 1.4,
                savingsDollars: 18,
                cost: 60,
                effort: "low",
                description: "LED bulbs use 75-80% less energy than incandescent bulbs and last much longer."
            },
            {
                id: "action16",
                category: "lighting",
                name: "Install dimmer switches in 5 rooms",
                savingsKwh: 60,
                savingsPercent: 0.6,
                savingsDollars: 7,
                cost: 125,
                effort: "medium",
                description: "Dimming lights reduces their energy consumption proportionally."
            },
            {
                id: "action17",
                category: "lighting",
                name: "Install motion sensors for outdoor lighting",
                savingsKwh: 80,
                savingsPercent: 0.7,
                savingsDollars: 10,
                cost: 100,
                effort: "medium",
                description: "Ensures lights are only on when needed."
            },
            {
                id: "action18",
                category: "electronics",
                name: "Use advanced power strips for entertainment centers",
                savingsKwh: 125,
                savingsPercent: 1.2,
                savingsDollars: 15,
                cost: 35,
                effort: "low",
                description: "Eliminates 'vampire power' draw from devices in standby mode."
            },
            {
                id: "action19",
                category: "electronics",
                name: "Enable power management on computers",
                savingsKwh: 75,
                savingsPercent: 0.7,
                savingsDollars: 9,
                cost: 0,
                effort: "low",
                description: "Automatically reduces power consumption during periods of inactivity."
            },
            {
                id: "action20",
                category: "electronics",
                name: "Unplug chargers when not in use",
                savingsKwh: 40,
                savingsPercent: 0.4,
                savingsDollars: 5,
                cost: 0,
                effort: "medium",
                description: "Eliminates small but continuous power draw from device chargers."
            }
        ];
        
        // AI Response Templates
        const aiResponses = {
            estimationFeedback: {
                heating: {
                    basic: "Your estimate for heating energy use was too low. Heating typically accounts for 30-45% of home energy use.",
                    detailed: "Your estimate for heating energy use was too low. Heating typically accounts for 30-45% of home energy use because heating requires raising the temperature of a large volume of air repeatedly throughout cold seasons. The physics of heating requires significant energy to overcome heat loss through walls, windows, and air leaks."
                },
                cooling: {
                    basic: "Your estimate for cooling energy use was close. Cooling typically accounts for 8-15% of home energy use.",
                    detailed: "Your estimate for cooling energy use was close. Cooling typically accounts for 8-15% of home energy use. Air conditioners use electricity to extract heat from indoor air and transfer it outside. While this process requires significant power, it's generally less energy-intensive than heating in most climate zones."
                },
                waterHeating: {
                    basic: "Your estimate for water heating was too low. Water heating typically accounts for 15-25% of home energy use.",
                    detailed: "Your estimate for water heating was too low. Water heating typically accounts for 15-25% of home energy use. This is significant because water has high thermal mass  it requires substantial energy to heat. Additionally, households use hot water multiple times daily for showers, dishes, and laundry, which continuously depletes the heated water."
                },
                lighting: {
                    basic: "Your estimate for lighting was too high. Lighting typically accounts for only 5-10% of home energy use.",
                    detailed: "Your estimate for lighting was too high. Lighting typically accounts for only 5-10% of home energy use. While lights are very visible in daily life, most modern bulbs (especially LEDs) are quite efficient. The small percentage is counterintuitive because we interact with lights frequently, creating an availability bias that leads to overestimation."
                },
                appliances: {
                    basic: "Your estimate for appliances was reasonable. Appliances typically account for 15-20% of home energy use.",
                    detailed: "Your estimate for appliances was reasonable. Appliances typically account for 15-20% of home energy use. The largest energy users are refrigerators (running 24/7), clothes dryers (which use intense heat), and cooking appliances. Smaller kitchen appliances like toasters use high power but for very short durations, making their total contribution smaller."
                },
                electronics: {
                    basic: "Your estimate for electronics was too high. Electronics typically account for only 5-8% of home energy use.",
                    detailed: "Your estimate for electronics was too high. Electronics typically account for only 5-8% of home energy use. While many households have numerous electronic devices, most modern electronics are designed to be relatively energy-efficient, especially in standby mode. Even active use of TVs and computers consumes less energy than thermal processes like heating or drying clothes."
                }
            },
            planCritique: {
                underTarget: {
                    basic: "Your plan falls short of the target reduction by approximately {gap} kWh. Consider adding more actions to reach your goal.",
                    detailed: "Your plan currently achieves {current} kWh in savings, which is {gap} kWh below your target of {target} kWh. I recommend focusing on higher-impact categories like heating, cooling, or water heating, which typically offer the largest savings opportunities."
                },
                overTarget: {
                    basic: "Your plan exceeds the target reduction by approximately {gap} kWh. You may want to prioritize the most feasible actions.",
                    detailed: "Your plan currently achieves {current} kWh in savings, which exceeds your target of {target} kWh by {gap} kWh. While this extra reduction is beneficial, you might want to focus on the most cost-effective and convenient actions if implementation is a concern."
                },
                lowImpactHeavy: {
                    basic: "Your plan relies heavily on low-impact actions. Consider including more high-impact measures.",
                    detailed: "I notice your plan emphasizes lighting and electronics changes, which typically have smaller energy impacts. While these are good starting points, replacing your focus to include heating, cooling, or water heating measures would likely achieve your goal more efficiently. For example, adjusting your thermostat settings could save more energy than multiple lighting changes combined."
                },
                highCostHeavy: {
                    basic: "Your plan includes several high-cost measures. Consider if these fit within your budget constraints.",
                    detailed: "Your plan includes several expensive upgrades like {action1} (${cost1}) and {action2} (${cost2}). While these provide excellent energy savings, they represent significant investments. If budget is a concern, you might consider starting with lower-cost actions like {alternativeAction1} and {alternativeAction2}, which offer good savings for less upfront cost."
                },
                wellBalanced: {
                    basic: "Your plan includes a good balance of different action types.",
                    detailed: "Your plan effectively balances quick, no-cost behavioral changes with strategic equipment upgrades. This approach is ideal, as it allows for immediate savings while planning for larger improvements over time. Your focus on the highest-impact categories (heating, cooling, and water heating) is also appropriate, as these typically offer the greatest savings potential."
                }
            },
            implementationSuggestions: {
                heating: [
                    "If I feel cold in the evening, then I will put on a sweater instead of turning up the heat",
                    "When I leave for work in the morning, then I will lower the thermostat by 5 degrees",
                    "When I go to bed, then I will lower the thermostat to 65F",
                    "If it's a sunny winter day, then I will open curtains on south-facing windows to let in natural heat"
                ],
                cooling: [
                    "When the outside temperature drops below indoor temperature in the evening, then I will open windows instead of using AC",
                    "If I'm using the air conditioner, then I will keep all windows and doors closed",
                    "When I leave home for more than 2 hours, then I will raise the thermostat setting by 7 degrees",
                    "If the sun is shining directly into windows, then I will close blinds or curtains to block heat"
                ],
                waterHeating: [
                    "When I take a shower, then I will limit it to 5 minutes",
                    "If I'm doing laundry, then I will use cold water for all loads",
                    "When I check the water heater, then I will make sure it's set to 120F",
                    "If I'm going on vacation for more than 3 days, then I will set the water heater to vacation mode"
                ],
                appliances: [
                    "When loading the dishwasher, then I will make sure it's completely full before running",
                    "If the weather is nice, then I will hang clothes to dry outside instead of using the dryer",
                    "After using kitchen appliances, then I will unplug them rather than leaving them plugged in",
                    "When shopping for a new appliance, then I will look for the ENERGY STAR label"
                ],
                lighting: [
                    "When I leave a room, then I will turn off all lights",
                    "If a light bulb burns out, then I will replace it with an LED",
                    "When I'm only using part of a room, then I will use task lighting instead of overhead lights",
                    "If I notice outdoor lights are on during daytime, then I will adjust the timer settings"
                ],
                electronics: [
                    "After purchasing new electronics, then I will enable their power-saving features immediately",
                    "When I go to bed, then I will completely turn off all entertainment devices",
                    "If I'm leaving home for more than a day, then I will unplug non-essential electronics",
                    "When setting up my computer, then I will set it to sleep after 15 minutes of inactivity"
                ]
            },
            comparativeFeedback: {
                humanBetter: "The human-created plan includes more realistic actions for this specific household context. The selections account for the household's particular circumstances and constraints better than the AI-generated alternatives.",
                aiBetter: "The AI-generated plan identifies higher-impact opportunities that were overlooked in the human plan. The AI plan achieves the same savings with fewer total actions, focusing on the most efficient interventions.",
                complementary: "Both plans have strengths. The human plan includes more personalized actions suited to the household's lifestyle, while the AI plan identifies some high-impact technical opportunities. A hybrid approach combining elements from both would likely be most effective."
            }
        };
        
        // Tab switching functionality
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetId = this.getAttribute('data-target');
                    switchTab(targetId);
                });
            });
            
            // Initialize task 1 (Estimate-then-Plan)
            initEstimateThenPlanTask();
            
            // Initialize other tasks
            initCritiqueRevisionTask();
            initSeedPlanTask();
            initImplementationIntentionTask();
            initComparativePlanningTask();
        });
        
        function switchTab(tabId) {
            // Hide all tab panes
            document.querySelectorAll('.tab-pane').forEach(pane => {
                pane.classList.remove('active');
            });
            
            // Deactivate all tab buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show the selected tab pane
            document.getElementById(tabId).classList.add('active');
            
            // Activate the corresponding tab button
            document.querySelector(`.tab-button[data-target="${tabId}"]`).classList.add('active');
        }
        
        // Task 1: Estimate-then-Plan
        function initEstimateThenPlanTask() {
            // Task state
            const state = {
                household: households.suburban,
                targetPercent: 10,
                targetUnit: 'kwh',
                feedbackType: 'explanation',
                estimations: {},
                selectedActions: [],
                phase: 'estimation', // 'estimation' or 'planning'
                feedbackProvided: false
            };
            
            // Profile selection
            document.querySelectorAll('#estimate-profiles .profile-card').forEach(card => {
                card.addEventListener('click', function() {
                    const profileId = this.getAttribute('data-profile');
                    document.querySelectorAll('#estimate-profiles .profile-card').forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    state.household = households[profileId];
                });
            });
            
            // Target selection
            document.getElementById('estimate-target').addEventListener('change', function() {
                state.targetPercent = parseInt(this.value);
            });
            
            // Format selection
            document.getElementById('estimate-format').addEventListener('change', function() {
                state.targetUnit = this.value;
            });
            
            // Feedback type selection
            document.getElementById('estimate-feedback').addEventListener('change', function() {
                state.feedbackType = this.value === 'explanation' ? 'explanation' : 'basic';
            });
            
            // Submit estimates
            document.getElementById('submit-estimates').addEventListener('click', function() {
                // Collect estimates
                const categories = ['heating', 'cooling', 'water', 'appliances', 'lighting', 'electronics'];
                let total = 0;
                let missingEstimates = false;
                
                categories.forEach(category => {
                    const input = document.getElementById(`estimate-${category}`);
                    const value = parseInt(input.value);
                    
                    if (isNaN(value)) {
                        input.style.borderColor = '#dc3545';
                        missingEstimates = true;
                    } else {
                        input.style.borderColor = '';
                        state.estimations[category] = value;
                        total += value;
                    }
                });
                
                if (missingEstimates) {
                    alert('Please provide estimates for all categories.');
                    return;
                }
                
                if (total < 90 || total > 110) {
                    if (!confirm(`Your estimates total ${total}%, which is not close to 100%. Continue anyway?`)) {
                        return;
                    }
                }
                
                // Display feedback
                const feedbackPanel = document.getElementById('estimate-feedback-panel');
                const feedbackContent = document.getElementById('estimate-feedback-content');
                let feedbackHtml = '';
                
                // Generate feedback for each category
                categories.forEach(category => {
                    const actualValue = state.household.breakdown[category === 'water' ? 'waterHeating' : category];
                    const userEstimate = state.estimations[category];
                    let feedbackType = '';
                    
                    if (Math.abs(userEstimate - actualValue) <= 5) {
                        feedbackType = 'accurate';
                    } else if (userEstimate < actualValue) {
                        feedbackType = 'too low';
                    } else {
                        feedbackType = 'too high';
                    }
                    
                    const categoryLabel = category === 'water' ? 'Water Heating' : 
                                          category.charAt(0).toUpperCase() + category.slice(1);
                    
                    const feedbackKey = category === 'water' ? 'waterHeating' : category;
                    const feedbackText = aiResponses.estimationFeedback[feedbackKey]?.[state.feedbackType === 'explanation' ? 'detailed' : 'basic'] || 
                                        `Your estimate for ${categoryLabel} was ${feedbackType}. The actual value is approximately ${actualValue}%.`;
                    
                    const dotColor = feedbackType === 'accurate' ? '#28a745' : 
                                    feedbackType === 'too low' ? '#ffc107' : '#dc3545';
                    
                    feedbackHtml += `
                        <div style="display: flex; align-items: center; margin-bottom: 15px;">
                            <div style="width: 12px; height: 12px; border-radius: 50%; background-color: ${dotColor}; margin-right: 10px;"></div>
                            <div>
                                <strong>${categoryLabel}:</strong> ${feedbackText}
                            </div>
                        </div>
                    `;
                });
                
                feedbackContent.innerHTML = feedbackHtml;
                feedbackPanel.style.display = 'block';
                
                // Disable inputs
                categories.forEach(category => {
                    document.getElementById(`estimate-${category}`).disabled = true;
                });
                
                document.getElementById('submit-estimates').disabled = true;
                state.feedbackProvided = true;
            });
            
            // Continue to planning phase
            document.getElementById('continue-to-planning').addEventListener('click', function() {
                if (!state.feedbackProvided) {
                    alert('Please submit your estimates first.');
                    return;
                }
                
                document.getElementById('estimation-phase').style.display = 'none';
                document.getElementById('planning-phase').style.display = 'block';
                state.phase = 'planning';
                
                // Populate available actions
                populateAvailableActions();
                updateTargetDisplay();
            });
            
            // Populate available actions
            function populateAvailableActions() {
                const actionsContainer = document.getElementById('available-actions');
                actionsContainer.innerHTML = '';
                
                // Group actions by category
                const groupedActions = {};
                energyActions.forEach(action => {
                    if (!groupedActions[action.category]) {
                        groupedActions[action.category] = [];
                    }
                    groupedActions[action.category].push(action);
                });
                
                // Add actions by category
                Object.keys(groupedActions).forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = categoryLabel;
                    categoryHeader.style.marginTop = '15px';
                    categoryHeader.style.marginBottom = '10px';
                    actionsContainer.appendChild(categoryHeader);
                    
                    groupedActions[category].forEach(action => {
                        if (state.selectedActions.some(a => a.id === action.id)) {
                            return; // Skip actions already in the plan
                        }
                        
                        const actionElement = createActionElement(action);
                        actionsContainer.appendChild(actionElement);
                    });
                });
            }
            
            // Create action element
            function createActionElement(action) {
                const actionElement = document.createElement('div');
                actionElement.className = 'action-item';
                
                // Determine savings value based on target unit
                let savingsValue, savingsUnit;
                switch (state.targetUnit) {
                    case 'kwh':
                        savingsValue = action.savingsKwh;
                        savingsUnit = 'kWh';
                        break;
                    case 'percent':
                        savingsValue = action.savingsPercent;
                        savingsUnit = '%';
                        break;
                    case 'dollars':
                        savingsValue = action.savingsDollars;
                        savingsUnit = '$';
                        break;
                }
                
                actionElement.innerHTML = `
                    <h4>${action.name}</h4>
                    <div>
                        <span class="action-tag">Saves ${savingsValue} ${savingsUnit}</span>
                        <span style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                            ${action.cost > 0 ? 'Cost: $' + action.cost : 'No cost'}
                        </span>
                    </div>
                    <p style="margin-top: 5px; font-size: 14px;">${action.description}</p>
                `;
                
                actionElement.addEventListener('click', () => {
                    addActionToPlan(action);
                });
                
                return actionElement;
            }
            
            // Add action to plan
            function addActionToPlan(action) {
                state.selectedActions.push(action);
                updatePlanDisplay();
                populateAvailableActions();
                updateTargetDisplay();
            }
            
            // Update plan display
            function updatePlanDisplay() {
                const planContainer = document.getElementById('selected-plan');
                const emptyMessage = document.getElementById('empty-plan-message');
                
                if (state.selectedActions.length === 0) {
                    emptyMessage.style.display = 'block';
                    return;
                }
                
                emptyMessage.style.display = 'none';
                planContainer.innerHTML = '';
                
                state.selectedActions.forEach(action => {
                    const planItem = document.createElement('div');
                    planItem.className = 'plan-item';
                    
                    // Determine savings value based on target unit
                    let savingsValue, savingsUnit;
                    switch (state.targetUnit) {
                        case 'kwh':
                            savingsValue = action.savingsKwh;
                            savingsUnit = 'kWh';
                            break;
                        case 'percent':
                            savingsValue = action.savingsPercent;
                            savingsUnit = '%';
                            break;
                        case 'dollars':
                            savingsValue = action.savingsDollars;
                            savingsUnit = '$';
                            break;
                    }
                    
                    planItem.innerHTML = `
                        <div class="plan-item-content">
                            <strong>${action.name}</strong>
                            <div>Saves ${savingsValue} ${savingsUnit}</div>
                        </div>
                        <button class="remove-btn" style="background: none; border: none; color: #dc3545; cursor: pointer;"></button>
                    `;
                    
                    planItem.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeActionFromPlan(action.id);
                    });
                    
                    planContainer.appendChild(planItem);
                });
            }
            
            // Remove action from plan
            function removeActionFromPlan(actionId) {
                state.selectedActions = state.selectedActions.filter(action => action.id !== actionId);
                updatePlanDisplay();
                populateAvailableActions();
                updateTargetDisplay();
            }
            
            // Update target display
            function updateTargetDisplay() {
                const targetPercent = state.targetPercent;
                const targetUnit = state.targetUnit;
                
                let targetValue, unitText;
                switch (targetUnit) {
                    case 'kwh':
                        targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                        unitText = 'kWh';
                        break;
                    case 'percent':
                        targetValue = targetPercent;
                        unitText = '%';
                        break;
                    case 'dollars':
                        targetValue = Math.round(state.household.monthlyCost * 12 * (targetPercent / 100));
                        unitText = '$';
                        break;
                }
                
                document.getElementById('reduction-target').textContent = `${targetValue} ${unitText}`;
                
                // Calculate current savings
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    switch (targetUnit) {
                        case 'kwh':
                            currentSavings += action.savingsKwh;
                            break;
                        case 'percent':
                            currentSavings += action.savingsPercent;
                            break;
                        case 'dollars':
                            currentSavings += action.savingsDollars;
                            break;
                    }
                });
                
                document.getElementById('current-savings').textContent = `${currentSavings} ${unitText}`;
                
                // Update progress bar
                const progressPercent = Math.min(100, Math.round((currentSavings / targetValue) * 100));
                document.getElementById('progress-fill').style.width = `${progressPercent}%`;
            }
            
            // Submit final plan
            document.getElementById('submit-plan').addEventListener('click', function() {
                if (state.selectedActions.length === 0) {
                    alert('Please add at least one action to your plan.');
                    return;
                }
                
                const targetPercent = state.targetPercent;
                const targetUnit = state.targetUnit;
                
                let targetValue, unitText;
                switch (targetUnit) {
                    case 'kwh':
                        targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                        unitText = 'kWh';
                        break;
                    case 'percent':
                        targetValue = targetPercent;
                        unitText = '%';
                        break;
                    case 'dollars':
                        targetValue = Math.round(state.household.monthlyCost * 12 * (targetPercent / 100));
                        unitText = '$';
                        break;
                }
                
                // Calculate current savings
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    switch (targetUnit) {
                        case 'kwh':
                            currentSavings += action.savingsKwh;
                            break;
                        case 'percent':
                            currentSavings += action.savingsPercent;
                            break;
                        case 'dollars':
                            currentSavings += action.savingsDollars;
                            break;
                    }
                });
                
                const progressPercent = Math.round((currentSavings / targetValue) * 100);
                
                // Display feedback
                const feedbackPanel = document.getElementById('plan-feedback');
                const feedbackContent = document.getElementById('plan-feedback-content');
                
                let feedbackHtml = '';
                
                if (progressPercent < 90) {
                    feedbackHtml = `
                        <p>Your plan achieves ${currentSavings} ${unitText} in savings, which is ${progressPercent}% of your target.</p>
                        <p>To reach your goal, consider adding more actions, especially high-impact ones related to heating, cooling, or water heating.</p>
                    `;
                } else if (progressPercent > 110) {
                    feedbackHtml = `
                        <p>Your plan achieves ${currentSavings} ${unitText} in savings, which exceeds your target by ${progressPercent - 100}%.</p>
                        <p>You've created an ambitious plan! If you're concerned about implementation, you might want to prioritize the most cost-effective actions.</p>
                    `;
                } else {
                    feedbackHtml = `
                        <p>Congratulations! Your plan achieves ${currentSavings} ${unitText} in savings, which is ${progressPercent}% of your target.</p>
                        <p>You've created a well-balanced plan that meets your energy reduction goal.</p>
                    `;
                }
                
                // Add category breakdown
                const categoryBreakdown = {};
                state.selectedActions.forEach(action => {
                    if (!categoryBreakdown[action.category]) {
                        categoryBreakdown[action.category] = 0;
                    }
                    
                    switch (targetUnit) {
                        case 'kwh':
                            categoryBreakdown[action.category] += action.savingsKwh;
                            break;
                        case 'percent':
                            categoryBreakdown[action.category] += action.savingsPercent;
                            break;
                        case 'dollars':
                            categoryBreakdown[action.category] += action.savingsDollars;
                            break;
                    }
                });
                
                feedbackHtml += `
                    <h4 style="margin-top: 15px;">Category Breakdown:</h4>
                    <ul style="margin-top: 10px;">
                `;
                
                Object.keys(categoryBreakdown).forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    const percent = Math.round((categoryBreakdown[category] / currentSavings) * 100);
                    
                    feedbackHtml += `
                        <li><strong>${categoryLabel}:</strong> ${categoryBreakdown[category]} ${unitText} (${percent}% of your plan)</li>
                    `;
                });
                
                feedbackHtml += `</ul>`;
                
                feedbackContent.innerHTML = feedbackHtml;
                feedbackPanel.style.display = 'block';
                
                document.getElementById('submit-plan').disabled = true;
            });
            
            // Search functionality
            document.getElementById('action-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const actionItems = document.querySelectorAll('#available-actions .action-item');
                
                actionItems.forEach(item => {
                    const actionName = item.querySelector('h4').textContent.toLowerCase();
                    const actionDesc = item.querySelector('p').textContent.toLowerCase();
                    
                    if (actionName.includes(searchTerm) || actionDesc.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
        
        // Task 2: Critique & Revision
        function initCritiqueRevisionTask() {
            // Task state
            const state = {
                household: households.suburban,
                targetPercent: 10,
                feedbackDetail: 'detailed',
                selectedActions: [],
                critiqueCycle: 0,
                planSubmitted: false
            };
            
            // Household selection
            document.getElementById('critique-household').addEventListener('change', function() {
                state.household = households[this.value];
                updateCritiqueTargetDisplay();
            });
            
            // Target selection
            document.getElementById('critique-target').addEventListener('change', function() {
                state.targetPercent = parseInt(this.value);
                updateCritiqueTargetDisplay();
            });
            
            // Feedback detail selection
            document.getElementById('critique-detail').addEventListener('change', function() {
                state.feedbackDetail = this.value;
            });
            
            // Populate critique actions
            function populateCritiqueActions() {
                const actionsContainer = document.getElementById('critique-actions');
                actionsContainer.innerHTML = '';
                
                // Group actions by category
                const groupedActions = {};
                energyActions.forEach(action => {
                    if (!groupedActions[action.category]) {
                        groupedActions[action.category] = [];
                    }
                    groupedActions[action.category].push(action);
                });
                
                // Add actions by category
                Object.keys(groupedActions).forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = categoryLabel;
                    categoryHeader.style.marginTop = '15px';
                    categoryHeader.style.marginBottom = '10px';
                    actionsContainer.appendChild(categoryHeader);
                    
                    groupedActions[category].forEach(action => {
                        if (state.selectedActions.some(a => a.id === action.id)) {
                            return; // Skip actions already in the plan
                        }
                        
                        const actionElement = document.createElement('div');
                        actionElement.className = 'action-item';
                        
                        actionElement.innerHTML = `
                            <h4>${action.name}</h4>
                            <div>
                                <span class="action-tag">Saves ${action.savingsKwh} kWh</span>
                                <span style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                                    ${action.cost > 0 ? 'Cost: $' + action.cost : 'No cost'}
                                </span>
                            </div>
                            <p style="margin-top: 5px; font-size: 14px;">${action.description}</p>
                        `;
                        
                        actionElement.addEventListener('click', () => {
                            addActionToCritiquePlan(action);
                        });
                        
                        actionsContainer.appendChild(actionElement);
                    });
                });
            }
            
            // Add action to critique plan
            function addActionToCritiquePlan(action) {
                state.selectedActions.push(action);
                updateCritiquePlanDisplay();
                populateCritiqueActions();
                updateCritiqueTargetDisplay();
            }
            
            // Update critique plan display
            function updateCritiquePlanDisplay() {
                const planContainer = document.getElementById('critique-plan');
                const emptyMessage = document.getElementById('empty-critique-plan');
                
                if (state.selectedActions.length === 0) {
                    emptyMessage.style.display = 'block';
                    return;
                }
                
                emptyMessage.style.display = 'none';
                planContainer.innerHTML = '';
                
                state.selectedActions.forEach(action => {
                    const planItem = document.createElement('div');
                    planItem.className = 'plan-item';
                    
                    planItem.innerHTML = `
                        <div class="plan-item-content">
                            <strong>${action.name}</strong>
                            <div>Saves ${action.savingsKwh} kWh</div>
                        </div>
                        <button class="remove-btn" style="background: none; border: none; color: #dc3545; cursor: pointer;"></button>
                    `;
                    
                    planItem.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeActionFromCritiquePlan(action.id);
                    });
                    
                    planContainer.appendChild(planItem);
                });
            }
            
            // Remove action from critique plan
            function removeActionFromCritiquePlan(actionId) {
                state.selectedActions = state.selectedActions.filter(action => action.id !== actionId);
                updateCritiquePlanDisplay();
                populateCritiqueActions();
                updateCritiqueTargetDisplay();
            }
            
            // Update critique target display
            function updateCritiqueTargetDisplay() {
                const targetPercent = state.targetPercent;
                const targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                
                document.getElementById('critique-target-value').textContent = `${targetValue} kWh`;
                
                // Calculate current savings
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    currentSavings += action.savingsKwh;
                });
                
                document.getElementById('critique-current-savings').textContent = `${currentSavings} kWh`;
                
                // Update progress bar
                const progressPercent = Math.min(100, Math.round((currentSavings / targetValue) * 100));
                document.getElementById('critique-progress').style.width = `${progressPercent}%`;
            }
            
            // Request critique button
            document.getElementById('request-critique').addEventListener('click', function() {
                if (state.selectedActions.length === 0) {
                    alert('Please add at least one action to your plan before requesting a critique.');
                    return;
                }
                
                // Calculate values for feedback
                const targetPercent = state.targetPercent;
                const targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    currentSavings += action.savingsKwh;
                });
                
                const percentOfTarget = Math.round((currentSavings / targetValue) * 100);
                
                // Display feedback
                const feedbackPanel = document.getElementById('critique-feedback');
                const feedbackContent = document.getElementById('critique-feedback-content');
                
                // Determine critique type
                let critiqueFeedback = '';
                
                // Check target achievement
                let targetCritiqueKey = '';
                if (currentSavings < targetValue * 0.9) {
                    targetCritiqueKey = 'underTarget';
                } else if (currentSavings > targetValue * 1.1) {
                    targetCritiqueKey = 'overTarget';
                }
                
                // Check action balance
                let balanceCritiqueKey = '';
                const categoryBreakdown = {};
                state.selectedActions.forEach(action => {
                    if (!categoryBreakdown[action.category]) {
                        categoryBreakdown[action.category] = 0;
                    }
                    categoryBreakdown[action.category] += action.savingsKwh;
                });
                
                // Check if too focused on low-impact categories
                const lowImpactSavings = (categoryBreakdown.lighting || 0) + (categoryBreakdown.electronics || 0);
                const totalSavings = Object.values(categoryBreakdown).reduce((sum, val) => sum + val, 0);
                
                if (lowImpactSavings / totalSavings > 0.5) {
                    balanceCritiqueKey = 'lowImpactHeavy';
                }
                
                // Check if too many high-cost actions
                const highCostActions = state.selectedActions.filter(action => action.cost > 500);
                if (highCostActions.length >= 2) {
                    balanceCritiqueKey = 'highCostHeavy';
                }
                
                // If no specific issues, it's well-balanced
                if (!balanceCritiqueKey && (targetCritiqueKey === '' || state.critiqueCycle > 0)) {
                    balanceCritiqueKey = 'wellBalanced';
                }
                
                // Build critique message
                let critiqueTitle = `AI Critique - Cycle ${state.critiqueCycle + 1}`;
                let critiqueHtml = '<div style="margin-bottom: 15px;">';
                
                if (targetCritiqueKey) {
                    let feedbackType = state.feedbackDetail === 'detailed' ? 'detailed' : 'basic';
                    let feedback = aiResponses.planCritique[targetCritiqueKey][feedbackType];
                    
                    // Replace placeholders
                    feedback = feedback.replace('{gap}', Math.abs(targetValue - currentSavings).toLocaleString());
                    feedback = feedback.replace('{current}', currentSavings.toLocaleString());
                    feedback = feedback.replace('{target}', targetValue.toLocaleString());
                    
                    critiqueHtml += `<p style="margin-bottom: 10px;">${feedback}</p>`;
                }
                
                if (balanceCritiqueKey) {
                    let feedbackType = state.feedbackDetail === 'detailed' ? 'detailed' : 'basic';
                    let feedback = aiResponses.planCritique[balanceCritiqueKey][feedbackType];
                    
                    // For highCostHeavy, replace placeholders
                    if (balanceCritiqueKey === 'highCostHeavy' && state.feedbackDetail === 'detailed') {
                        const action1 = highCostActions[0];
                        const action2 = highCostActions[1] || highCostActions[0];
                        
                        // Get alternative lower-cost actions
                        const lowCostActions = energyActions.filter(action => action.cost < 100)
                            .sort((a, b) => b.savingsKwh - a.savingsKwh);
                        
                        const alternativeAction1 = lowCostActions[0];
                        const alternativeAction2 = lowCostActions[1];
                        
                        feedback = feedback.replace('{action1}', action1.name);
                        feedback = feedback.replace('{cost1}', action1.cost);
                        feedback = feedback.replace('{action2}', action2.name);
                        feedback = feedback.replace('{cost2}', action2.cost);
                        feedback = feedback.replace('{alternativeAction1}', alternativeAction1.name);
                        feedback = feedback.replace('{alternativeAction2}', alternativeAction2.name);
                    }
                    
                    critiqueHtml += `<p>${feedback}</p>`;
                }
                critiqueHtml += '</div>';
                
                // Add specific suggestions
                if (state.feedbackDetail === 'detailed') {
                    critiqueHtml += `<div style="margin-top: 15px;">
                        <h4>Specific Suggestions:</h4>
                        <ul style="padding-left: 20px; margin-top: 10px;">`;
                    
                    // Add context-specific suggestions
                    if (targetCritiqueKey === 'underTarget') {
                        // Suggest high-impact actions not already in the plan
                        const highImpactActions = energyActions
                            .filter(action => action.savingsKwh > targetValue * 0.25 && !state.selectedActions.some(a => a.id === action.id))
                            .sort((a, b) => b.savingsKwh - a.savingsKwh);
                        
                        for (let i = 0; i < Math.min(2, highImpactActions.length); i++) {
                            const action = highImpactActions[i];
                            critiqueHtml += `<li><strong>${action.name}</strong> could save approximately ${action.savingsKwh} kWh.</li>`;
                        }
                    } else if (balanceCritiqueKey === 'lowImpactHeavy') {
                        // Suggest focusing on neglected high-impact categories
                        const neglectedCategories = ['heating', 'cooling', 'waterHeating'].filter(category => 
                            !categoryBreakdown[category] || categoryBreakdown[category] / totalSavings < 0.2);
                        
                        neglectedCategories.forEach(category => {
                            const categoryName = category.charAt(0).toUpperCase() + category.slice(1);
                            const bestActionInCategory = energyActions
                                .filter(action => action.category === category && !state.selectedActions.some(a => a.id === action.id))
                                .sort((a, b) => b.savingsKwh - a.savingsKwh)[0];
                            
                            if (bestActionInCategory) {
                                critiqueHtml += `<li>Consider <strong>${bestActionInCategory.name}</strong> to address ${categoryName}, which could save ${bestActionInCategory.savingsKwh} kWh.</li>`;
                            }
                        });
                    }
                    
                    // Generic suggestions if needed
                    if (!targetCritiqueKey && !balanceCritiqueKey) {
                        critiqueHtml += `<li>Your plan looks well-balanced and meets the target. Consider if the actions you've chosen are feasible within your time and budget constraints.</li>
                        <li>Think about which actions you could implement immediately versus which might require planning or saving up for.</li>`;
                    }
                    
                    critiqueHtml += `</ul>
                    </div>`;
                }
                
                feedbackContent.innerHTML = critiqueHtml;
                feedbackPanel.style.display = 'block';
                
                // Update cycle indicator
                const cycleIndicator = document.getElementById('revision-cycle');
                cycleIndicator.textContent = `(Revision ${state.critiqueCycle})`;
                
                state.critiqueCycle++;
                
                // Enable submit button after one critique
                document.getElementById('submit-critique-plan').disabled = false;
                
                // Limit to two critique cycles
                if (state.critiqueCycle >= 2) {
                    document.getElementById('request-critique').disabled = true;
                    document.getElementById('request-critique').textContent = 'Maximum Critiques Reached';
                }
            });
            
            // Submit final plan button
            document.getElementById('submit-critique-plan').addEventListener('click', function() {
                if (state.selectedActions.length === 0) {
                    alert('Please add at least one action to your plan.');
                    return;
                }
                
                state.planSubmitted = true;
                
                // Calculate final values
                const targetPercent = state.targetPercent;
                const targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    currentSavings += action.savingsKwh;
                });
                
                const percentOfTarget = Math.round((currentSavings / targetValue) * 100);
                
                // Add submission message
                const feedbackPanel = document.getElementById('critique-feedback');
                feedbackPanel.innerHTML += `
                    <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #ddd;">
                        <h3>Final Plan Submitted</h3>
                        <p>Your plan achieves ${currentSavings.toLocaleString()} kWh in savings, which is ${percentOfTarget}% of your target.</p>
                        <p>You went through ${state.critiqueCycle} ${state.critiqueCycle === 1 ? 'revision' : 'revisions'} based on AI feedback.</p>
                    </div>
                `;
                
                // Disable interactive elements
                document.getElementById('request-critique').disabled = true;
                document.getElementById('submit-critique-plan').disabled = true;
                document.getElementById('submit-critique-plan').textContent = 'Plan Submitted';
                
                document.querySelectorAll('#critique-plan .remove-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('#critique-actions .action-item').forEach(item => item.style.pointerEvents = 'none');
            });
            
            // Search functionality
            document.getElementById('critique-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const actionItems = document.querySelectorAll('#critique-actions .action-item');
                
                actionItems.forEach(item => {
                    const actionName = item.querySelector('h4').textContent.toLowerCase();
                    const actionDesc = item.querySelector('p').textContent.toLowerCase();
                    
                    if (actionName.includes(searchTerm) || actionDesc.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
            
            // Initialize the task
            populateCritiqueActions();
            updateCritiqueTargetDisplay();
        }
        
        // Task 3: Seed Plan Anchoring
        function initSeedPlanTask() {
            // Task state
            const state = {
                household: households.suburban,
                targetPercent: 10,
                targetUnit: 'kwh',
                seedQuality: 'accurate',
                selectedActions: [],
                originalSeed: [],
                editsMade: 0,
                planSubmitted: false
            };
            
            // Household selection
            document.getElementById('seed-household').addEventListener('change', function() {
                state.household = households[this.value];
            });
            
            // Target selection
            document.getElementById('seed-target').addEventListener('change', function() {
                state.targetPercent = parseInt(this.value);
            });
            
            // Format selection
            document.getElementById('seed-format').addEventListener('change', function() {
                state.targetUnit = this.value;
            });
            
            // Seed quality selection
            document.getElementById('seed-quality').addEventListener('change', function() {
                state.seedQuality = this.value;
            });
            
            // Generate seed plan
            document.getElementById('generate-seed').addEventListener('click', function() {
                // Clear previous plan
                state.selectedActions = [];
                state.originalSeed = [];
                state.editsMade = 0;
                
                // Calculate target
                const targetPercent = state.targetPercent;
                let targetValue;
                
                switch (state.targetUnit) {
                    case 'kwh':
                        targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                        break;
                    case 'percent':
                        targetValue = targetPercent;
                        break;
                    case 'dollars':
                        targetValue = Math.round(state.household.monthlyCost * 12 * (targetPercent / 100));
                        break;
                }
                
                // Create seed plan based on quality
                if (state.seedQuality === 'accurate') {
                    // Accurate seed plan
                    // Focus on high-impact actions first (heating, cooling, water heating)
                    const highImpactCategories = ['heating', 'cooling', 'waterHeating'];
                    const otherCategories = ['appliances', 'lighting', 'electronics'];
                    
                    let currentTotal = 0;
                    const selectedIds = new Set();
                    
                    // Add 1-2 high-impact actions
                    highImpactCategories.forEach(category => {
                        const actionsInCategory = energyActions.filter(action => action.category === category)
                                                            .sort((a, b) => {
                                                                const aSavings = getSavingsForUnit(a, state.targetUnit);
                                                                const bSavings = getSavingsForUnit(b, state.targetUnit);
                                                                return bSavings - aSavings;
                                                            });
                        
                        if (actionsInCategory.length > 0 && currentTotal < targetValue * 0.7) {
                            // Add the highest impact action
                            const action = actionsInCategory[0];
                            state.selectedActions.push(action);
                            state.originalSeed.push(action);
                            selectedIds.add(action.id);
                            currentTotal += getSavingsForUnit(action, state.targetUnit);
                        }
                    });
                    
                    // Add some medium-impact actions if needed
                    otherCategories.forEach(category => {
                        const actionsInCategory = energyActions.filter(action => action.category === category)
                                                            .sort((a, b) => {
                                                                const aSavings = getSavingsForUnit(a, state.targetUnit);
                                                                const bSavings = getSavingsForUnit(b, state.targetUnit);
                                                                return bSavings - aSavings;
                                                            });
                        
                        if (actionsInCategory.length > 0 && currentTotal < targetValue * 0.9) {
                            // Add the highest impact action
                            const action = actionsInCategory[0];
                            if (!selectedIds.has(action.id)) {
                                state.selectedActions.push(action);
                                state.originalSeed.push(action);
                                selectedIds.add(action.id);
                                currentTotal += getSavingsForUnit(action, state.targetUnit);
                            }
                        }
                    });
                } else {
                    // Biased seed plan (overemphasizes lighting/electronics)
                    const lowImpactCategories = ['lighting', 'electronics'];
                    const otherCategories = ['heating', 'cooling', 'waterHeating', 'appliances'];
                    
                    let currentTotal = 0;
                    const selectedIds = new Set();
                    
                    // Add multiple low-impact actions (overrepresented)
                    lowImpactCategories.forEach(category => {
                        const actionsInCategory = energyActions.filter(action => action.category === category)
                                                            .sort((a, b) => {
                                                                const aSavings = getSavingsForUnit(a, state.targetUnit);
                                                                const bSavings = getSavingsForUnit(b, state.targetUnit);
                                                                return bSavings - aSavings;
                                                            });
                        
                        // Add all available actions in these categories
                        actionsInCategory.forEach(action => {
                            if (!selectedIds.has(action.id) && currentTotal < targetValue * 0.6) {
                                state.selectedActions.push(action);
                                state.originalSeed.push(action);
                                selectedIds.add(action.id);
                                // For biased seed, overestimate the impact of lighting/electronics
                                currentTotal += getSavingsForUnit(action, state.targetUnit) * 1.5;
                            }
                        });
                    });
                    
                    // Add some high-impact actions, but underrepresented
                    otherCategories.forEach(category => {
                        const actionsInCategory = energyActions.filter(action => action.category === category)
                                                            .sort((a, b) => {
                                                                const aSavings = getSavingsForUnit(a, state.targetUnit);
                                                                const bSavings = getSavingsForUnit(b, state.targetUnit);
                                                                return bSavings - aSavings;
                                                            });
                        
                        if (actionsInCategory.length > 0 && currentTotal < targetValue * 0.9) {
                            // Add just one action per category, underestimating impact
                            const action = actionsInCategory[0];
                            if (!selectedIds.has(action.id)) {
                                state.selectedActions.push(action);
                                state.originalSeed.push(action);
                                selectedIds.add(action.id);
                                // For biased seed, underestimate the impact of high-impact categories
                                currentTotal += getSavingsForUnit(action, state.targetUnit) * 0.7;
                            }
                        }
                    });
                }
                
                // Show the plan
                document.getElementById('seed-actions-card').style.display = 'block';
                document.getElementById('seed-plan-card').style.display = 'block';
                document.getElementById('generate-seed').style.display = 'none';
                
                // Populate actions and update displays
                populateSeedActions();
                updateSeedPlanDisplay();
                updateSeedTargetDisplay();
            });
            
            // Helper function to get savings based on unit
            function getSavingsForUnit(action, unit) {
                switch (unit) {
                    case 'kwh':
                        return action.savingsKwh;
                    case 'percent':
                        return action.savingsPercent;
                    case 'dollars':
                        return action.savingsDollars;
                }
            }
            
            // Populate additional actions
            function populateSeedActions() {
                const actionsContainer = document.getElementById('seed-actions');
                actionsContainer.innerHTML = '';
                
                // Group actions by category
                const groupedActions = {};
                energyActions.forEach(action => {
                    if (!groupedActions[action.category]) {
                        groupedActions[action.category] = [];
                    }
                    groupedActions[action.category].push(action);
                });
                
                // Add actions by category
                Object.keys(groupedActions).forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = categoryLabel;
                    categoryHeader.style.marginTop = '15px';
                    categoryHeader.style.marginBottom = '10px';
                    actionsContainer.appendChild(categoryHeader);
                    
                    groupedActions[category].forEach(action => {
                        // Skip actions already in the plan
                        if (state.selectedActions.some(a => a.id === action.id)) {
                            return;
                        }
                        
                        const actionElement = document.createElement('div');
                        actionElement.className = 'action-item';
                        
                        // Determine savings value based on target unit
                        let savingsValue, savingsUnit;
                        switch (state.targetUnit) {
                            case 'kwh':
                                savingsValue = action.savingsKwh;
                                savingsUnit = 'kWh';
                                break;
                            case 'percent':
                                savingsValue = action.savingsPercent;
                                savingsUnit = '%';
                                break;
                            case 'dollars':
                                savingsValue = action.savingsDollars;
                                savingsUnit = '$';
                                break;
                        }
                        
                        actionElement.innerHTML = `
                            <h4>${action.name}</h4>
                            <div>
                                <span class="action-tag">Saves ${savingsValue} ${savingsUnit}</span>
                                <span style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                                    ${action.cost > 0 ? 'Cost: $' + action.cost : 'No cost'}
                                </span>
                            </div>
                            <p style="margin-top: 5px; font-size: 14px;">${action.description}</p>
                        `;
                        
                        actionElement.addEventListener('click', () => {
                            addActionToSeedPlan(action);
                        });
                        
                        actionsContainer.appendChild(actionElement);
                    });
                });
            }
            
            // Add action to seed plan
            function addActionToSeedPlan(action) {
                state.selectedActions.push(action);
                state.editsMade++;
                updateSeedPlanDisplay();
                populateSeedActions();
                updateSeedTargetDisplay();
                
                // Update edits counter
                document.getElementById('edit-count').textContent = state.editsMade;
            }
            
            // Update seed plan display
            function updateSeedPlanDisplay() {
                const planContainer = document.getElementById('seed-plan');
                planContainer.innerHTML = '';
                
                if (state.selectedActions.length === 0) {
                    planContainer.innerHTML = '<p>No actions in your plan yet. Generate a seed plan to get started.</p>';
                    return;
                }
                
                state.selectedActions.forEach(action => {
                    const planItem = document.createElement('div');
                    planItem.className = 'plan-item';
                    
                    // Check if this was in the original seed
                    const wasInSeed = state.originalSeed.some(a => a.id === action.id);
                    
                    // Determine savings value based on target unit
                    let savingsValue, savingsUnit;
                    switch (state.targetUnit) {
                        case 'kwh':
                            savingsValue = action.savingsKwh;
                            savingsUnit = 'kWh';
                            break;
                        case 'percent':
                            savingsValue = action.savingsPercent;
                            savingsUnit = '%';
                            break;
                        case 'dollars':
                            savingsValue = action.savingsDollars;
                            savingsUnit = '$';
                            break;
                    }
                    
                    planItem.innerHTML = `
                        <div class="plan-item-content">
                            <strong>${action.name}</strong>
                            <div>
                                Saves ${savingsValue} ${savingsUnit}
                                ${wasInSeed ? '<span style="font-size: 12px; color: #6c757d;">(In original seed)</span>' : ''}
                            </div>
                        </div>
                        <button class="remove-btn" style="background: none; border: none; color: #dc3545; cursor: pointer;"></button>
                    `;
                    
                    planItem.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeActionFromSeedPlan(action.id);
                    });
                    
                    planContainer.appendChild(planItem);
                });
            }
            
            // Remove action from seed plan
            function removeActionFromSeedPlan(actionId) {
                state.selectedActions = state.selectedActions.filter(action => action.id !== actionId);
                state.editsMade++;
                updateSeedPlanDisplay();
                populateSeedActions();
                updateSeedTargetDisplay();
                
                // Update edits counter
                document.getElementById('edit-count').textContent = state.editsMade;
            }
            
            // Update seed target display
            function updateSeedTargetDisplay() {
                const targetPercent = state.targetPercent;
                const targetUnit = state.targetUnit;
                
                let targetValue, unitText;
                switch (targetUnit) {
                    case 'kwh':
                        targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                        unitText = 'kWh';
                        break;
                    case 'percent':
                        targetValue = targetPercent;
                        unitText = '%';
                        break;
                    case 'dollars':
                        targetValue = Math.round(state.household.monthlyCost * 12 * (targetPercent / 100));
                        unitText = '$';
                        break;
                }
                
                document.getElementById('seed-target-value').textContent = `${targetValue} ${unitText}`;
                
                // Calculate current savings
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    switch (targetUnit) {
                        case 'kwh':
                            currentSavings += action.savingsKwh;
                            break;
                        case 'percent':
                            currentSavings += action.savingsPercent;
                            break;
                        case 'dollars':
                            currentSavings += action.savingsDollars;
                            break;
                    }
                });
                
                document.getElementById('seed-current-savings').textContent = `${currentSavings} ${unitText}`;
                
                // Update progress bar
                const progressPercent = Math.min(100, Math.round((currentSavings / targetValue) * 100));
                const progressBar = document.getElementById('seed-progress');
                
                if (Math.abs(progressPercent - 100) <= 2) {
                    progressBar.style.backgroundColor = '#28a745'; // Green if very close to target
                } else if (progressPercent > 100) {
                    progressBar.style.backgroundColor = '#dc3545'; // Red if over target
                } else {
                    progressBar.style.backgroundColor = '#2c73d2'; // Blue otherwise
                }
                
                progressBar.style.width = `${Math.min(progressPercent, 100)}%`;
            }
            
            // Submit seed plan
            document.getElementById('submit-seed-plan').addEventListener('click', function() {
                if (state.selectedActions.length === 0) {
                    alert('Please add at least one action to your plan.');
                    return;
                }
                
                state.planSubmitted = true;
                
                // Calculate final values
                const targetPercent = state.targetPercent;
                const targetUnit = state.targetUnit;
                
                let targetValue, unitText;
                switch (targetUnit) {
                    case 'kwh':
                        targetValue = Math.round(state.household.annualKwh * (targetPercent / 100));
                        unitText = 'kWh';
                        break;
                    case 'percent':
                        targetValue = targetPercent;
                        unitText = '%';
                        break;
                    case 'dollars':
                        targetValue = Math.round(state.household.monthlyCost * 12 * (targetPercent / 100));
                        unitText = '$';
                        break;
                }
                
                // Calculate current savings
                let currentSavings = 0;
                state.selectedActions.forEach(action => {
                    switch (targetUnit) {
                        case 'kwh':
                            currentSavings += action.savingsKwh;
                            break;
                        case 'percent':
                            currentSavings += action.savingsPercent;
                            break;
                        case 'dollars':
                            currentSavings += action.savingsDollars;
                            break;
                    }
                });
                
                const percentOfTarget = Math.round((currentSavings / targetValue) * 100);
                
                // Calculate changes from seed plan
                const actionsRemoved = state.originalSeed.filter(action => 
                    !state.selectedActions.some(a => a.id === action.id)).length;
                
                const actionsAdded = state.selectedActions.filter(action => 
                    !state.originalSeed.some(a => a.id === action.id)).length;
                
                // Display feedback
                const feedbackPanel = document.getElementById('seed-feedback');
                const feedbackContent = document.getElementById('seed-feedback-content');
                
                let feedbackHtml = `
                    <p>Your final plan achieves ${currentSavings.toLocaleString()} ${unitText} in savings, which is ${percentOfTarget}% of your target.</p>
                    
                    <h4 style="margin-top: 15px;">Changes from Seed Plan:</h4>
                    <ul style="margin-top: 5px; padding-left: 20px;">
                        <li>Total edits made: ${state.editsMade}</li>
                        <li>Actions removed: ${actionsRemoved}</li>
                        <li>Actions added: ${actionsAdded}</li>
                    </ul>
                    
                    <h4 style="margin-top: 15px;">Anchoring Analysis:</h4>
                    <p>Your seed plan was "${state.seedQuality}" (${state.seedQuality === 'accurate' ? 'based on accurate energy estimates' : 'biased toward overestimating lighting/electronics impact'}).</p>
                `;
                
                // Provide different analysis based on seed type
                if (state.seedQuality === 'biased') {
                    // Calculate category breakdown
                    const seedCategories = {};
                    const finalCategories = {};
                    
                    // Calculate savings by category for seed plan
                    state.originalSeed.forEach(action => {
                        if (!seedCategories[action.category]) {
                            seedCategories[action.category] = 0;
                        }
                        
                        const savings = getSavingsForUnit(action, targetUnit);
                        seedCategories[action.category] += savings;
                    });
                    
                    // Calculate savings by category for final plan
                    state.selectedActions.forEach(action => {
                        if (!finalCategories[action.category]) {
                            finalCategories[action.category] = 0;
                        }
                        
                        const savings = getSavingsForUnit(action, targetUnit);
                        finalCategories[action.category] += savings;
                    });
                    
                    // Combine categories
                    const highImpactSeed = (seedCategories.heating || 0) + (seedCategories.cooling || 0) + (seedCategories.waterHeating || 0);
                    const lowImpactSeed = (seedCategories.lighting || 0) + (seedCategories.electronics || 0);
                    
                    const highImpactFinal = (finalCategories.heating || 0) + (finalCategories.cooling || 0) + (finalCategories.waterHeating || 0);
                    const lowImpactFinal = (finalCategories.lighting || 0) + (finalCategories.electronics || 0);
                    
                    // Calculate percentages
                    const seedTotal = Object.values(seedCategories).reduce((sum, val) => sum + val, 0);
                    const finalTotal = Object.values(finalCategories).reduce((sum, val) => sum + val, 0);
                    
                    const highImpactSeedPercent = Math.round((highImpactSeed / seedTotal) * 100);
                    const lowImpactSeedPercent = Math.round((lowImpactSeed / seedTotal) * 100);
                    
                    const highImpactFinalPercent = Math.round((highImpactFinal / finalTotal) * 100);
                    const lowImpactFinalPercent = Math.round((lowImpactFinal / finalTotal) * 100);
                    
                    feedbackHtml += `
                        <p style="margin-top: 10px;">Your seed plan allocated ${highImpactSeedPercent}% to high-impact categories (heating, cooling, water heating) and ${lowImpactSeedPercent}% to low-impact categories (lighting, electronics).</p>
                        
                        <p style="margin-top: 10px;">Your final plan allocates ${highImpactFinalPercent}% to high-impact categories and ${lowImpactFinalPercent}% to low-impact categories.</p>
                        
                        <p style="margin-top: 10px;">
                            ${highImpactFinalPercent > highImpactSeedPercent ? 
                                'You successfully adjusted the biased seed plan to better reflect the true impact of different energy categories.' : 
                                'The initial bias in the seed plan appears to have influenced your final allocation, as it still emphasizes lower-impact categories more than is optimal.'}
                        </p>
                    `;
                } else {
                    feedbackHtml += `
                        <p style="margin-top: 10px;">
                            ${state.editsMade <= 3 ? 
                                'You made relatively few changes to the seed plan, suggesting that you found it to be a reasonable starting point.' : 
                                'You made significant changes to the seed plan, demonstrating active evaluation rather than simple acceptance of the initial suggestions.'}
                        </p>
                    `;
                }
                
                feedbackContent.innerHTML = feedbackHtml;
                feedbackPanel.style.display = 'block';
                
                // Disable interactive elements
                document.getElementById('submit-seed-plan').disabled = true;
                document.getElementById('submit-seed-plan').textContent = 'Plan Submitted';
                
                document.querySelectorAll('#seed-plan .remove-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('#seed-actions .action-item').forEach(item => item.style.pointerEvents = 'none');
            });
        }
        
        // Task 4: Implementation Intentions
        function initImplementationIntentionTask() {
            // Task state
            const state = {
                household: households.suburban,
                wizardEnabled: true,
                selectedActions: [],
                implementationIntentions: {},
                currentAction: null,
                planSubmitted: false
            };
            
            // Household selection
            document.getElementById('implementation-household').addEventListener('change', function() {
                state.household = households[this.value];
                populateImplementationActions();
            });
            
            // Wizard toggle
            document.getElementById('implementation-assistance').addEventListener('change', function() {
                state.wizardEnabled = this.value === 'enabled';
                
                // Update wizard suggestions visibility if form is open
                const wizardSuggestions = document.getElementById('wizard-suggestions');
                if (wizardSuggestions) {
                    wizardSuggestions.style.display = state.wizardEnabled ? 'block' : 'none';
                }
            });
            
            // Populate high-impact actions
            function populateImplementationActions() {
                const actionsContainer = document.getElementById('implementation-actions');
                actionsContainer.innerHTML = '';
                
                // Sort actions by kWh savings (descending)
                const sortedActions = [...energyActions].sort((a, b) => b.savingsKwh - a.savingsKwh);
                
                // Group actions by category
                const groupedActions = {};
                sortedActions.forEach(action => {
                    if (!groupedActions[action.category]) {
                        groupedActions[action.category] = [];
                    }
                    groupedActions[action.category].push(action);
                });
                
                // Add top actions from each category
                Object.keys(groupedActions).forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = categoryLabel;
                    categoryHeader.style.marginTop = '15px';
                    categoryHeader.style.marginBottom = '10px';
                    actionsContainer.appendChild(categoryHeader);
                    
                    // Take the top 3 actions from each category
                    const topActions = groupedActions[category].slice(0, 3);
                    
                    topActions.forEach(action => {
                        const actionElement = document.createElement('div');
                        actionElement.className = 'action-item';
                        
                        // Check if this action already has an implementation intention
                        const hasImplementation = state.implementationIntentions[action.id] !== undefined;
                        
                        actionElement.innerHTML = `
                            <h4>${action.name}</h4>
                            <div>
                                <span class="action-tag">Saves ${action.savingsKwh} kWh</span>
                                <span style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                                    ${action.cost > 0 ? 'Cost: $' + action.cost : 'No cost'}
                                </span>
                                ${hasImplementation ? '<span style="margin-left: 10px; color: #28a745;"> Implementation Plan Created</span>' : ''}
                            </div>
                            <p style="margin-top: 5px; font-size: 14px;">${action.description}</p>
                        `;
                        
                        actionElement.addEventListener('click', () => {
                            openImplementationForm(action);
                        });
                        
                        actionsContainer.appendChild(actionElement);
                    });
                });
            }
            
            // Open implementation form
            function openImplementationForm(action) {
                state.currentAction = action;
                
                // Add to selected actions if not already there
                if (!state.selectedActions.some(a => a.id === action.id)) {
                    state.selectedActions.push(action);
                }
                
                const implementationForm = document.getElementById('implementation-form');
                implementationForm.style.display = 'block';
                
                // Update action info
                const actionInfo = document.getElementById('current-action-info');
                actionInfo.innerHTML = `
                    <h4>${action.name}</h4>
                    <p>${action.description}</p>
                    <p><strong>Energy Savings:</strong> ${action.savingsKwh} kWh per year</p>
                `;
                
                // Check for existing implementation
                const existingImplementation = state.implementationIntentions[action.id];
                
                // Fill in existing values if available
                const ifCondition = document.getElementById('if-condition');
                const thenAction = document.getElementById('then-action');
                
                ifCondition.value = existingImplementation ? existingImplementation.ifCondition : '';
                thenAction.value = existingImplementation ? existingImplementation.thenAction : '';
                
                // Update wizard suggestions
                const wizardSuggestions = document.getElementById('wizard-suggestions');
                wizardSuggestions.style.display = state.wizardEnabled ? 'block' : 'none';
                
                if (state.wizardEnabled) {
                    // Get suggestions for this category
                    const suggestions = aiResponses.implementationSuggestions[action.category] || [];
                    const wizardContent = document.getElementById('wizard-content');
                    
                    let suggestionsHtml = '<ul style="padding-left: 20px;">';
                    suggestions.forEach(suggestion => {
                        const parts = suggestion.split('then');
                        const ifPart = parts[0].trim();
                        const thenPart = parts.length > 1 ? parts[1].trim() : '';
                        
                        suggestionsHtml += `
                            <li style="margin-bottom: 8px;">
                                <strong>If</strong> ${ifPart}, <strong>then</strong> ${thenPart}
                                <button class="use-suggestion" data-if="${ifPart}" data-then="${thenPart}" style="margin-left: 8px; padding: 3px 8px; font-size: 12px; background-color: #2c73d2; color: white; border: none; border-radius: 3px; cursor: pointer;">Use</button>
                            </li>
                        `;
                    });
                    suggestionsHtml += '</ul>';
                    
                    wizardContent.innerHTML = suggestionsHtml;
                    
                    // Add event listeners for suggestion buttons
                    document.querySelectorAll('.use-suggestion').forEach(button => {
                        button.addEventListener('click', () => {
                            ifCondition.value = button.getAttribute('data-if');
                            thenAction.value = button.getAttribute('data-then');
                        });
                    });
                }
            }
            
            // Save implementation intention
            document.getElementById('save-implementation').addEventListener('click', function() {
                const ifCondition = document.getElementById('if-condition').value.trim();
                const thenAction = document.getElementById('then-action').value.trim();
                
                if (!ifCondition || !thenAction) {
                    alert('Please fill in both the "If" and "Then" fields.');
                    return;
                }
                
                // Save the implementation intention
                state.implementationIntentions[state.currentAction.id] = {
                    actionId: state.currentAction.id,
                    ifCondition: ifCondition,
                    thenAction: thenAction
                };
                
                // Close the form
                document.getElementById('implementation-form').style.display = 'none';
                
                // Update the implementation plan display
                updateImplementationPlanDisplay();
                
                // Refresh the actions list to show checkmarks
                populateImplementationActions();
            });
            
            // Cancel implementation button
            document.getElementById('cancel-implementation').addEventListener('click', function() {
                document.getElementById('implementation-form').style.display = 'none';
            });
            
            // Update implementation plan display
            function updateImplementationPlanDisplay() {
                const planContainer = document.getElementById('implementation-plan');
                const emptyMessage = document.getElementById('empty-implementation-plan');
                
                if (state.selectedActions.length === 0) {
                    if (emptyMessage) {
                        emptyMessage.style.display = 'block';
                    }
                    return;
                }
                
                if (emptyMessage) {
                    emptyMessage.style.display = 'none';
                }
                
                planContainer.innerHTML = '';
                
                state.selectedActions.forEach(action => {
                    const planItem = document.createElement('div');
                    planItem.className = 'plan-item';
                    planItem.style.flexDirection = 'column';
                    planItem.style.alignItems = 'stretch';
                    
                    const intention = state.implementationIntentions[action.id];
                    
                    planItem.innerHTML = `
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <strong>${action.name}</strong>
                            <div>
                                <button class="edit-btn" style="background: none; border: none; color: #2c73d2; cursor: pointer; margin-right: 5px;">Edit</button>
                                <button class="remove-btn" style="background: none; border: none; color: #dc3545; cursor: pointer;"></button>
                            </div>
                        </div>
                        
                        <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px;">
                            ${intention ? `
                                <div><strong>If:</strong> ${intention.ifCondition}</div>
                                <div style="margin-top: 5px;"><strong>Then:</strong> ${intention.thenAction}</div>
                            ` : `
                                <div style="color: #dc3545;">Implementation intention not yet defined</div>
                            `}
                        </div>
                    `;
                    
                    const editBtn = planItem.querySelector('.edit-btn');
                    editBtn.addEventListener('click', () => {
                        openImplementationForm(action);
                    });
                    
                    const removeBtn = planItem.querySelector('.remove-btn');
                    removeBtn.addEventListener('click', () => {
                        // Remove from selected actions
                        state.selectedActions = state.selectedActions.filter(a => a.id !== action.id);
                        
                        // Remove implementation intention if exists
                        if (state.implementationIntentions[action.id]) {
                            delete state.implementationIntentions[action.id];
                        }
                        
                        // Update displays
                        updateImplementationPlanDisplay();
                        populateImplementationActions();
                    });
                    
                    planContainer.appendChild(planItem);
                });
            }
            
            // Submit implementation plan
            document.getElementById('submit-implementation').addEventListener('click', function() {
                // Check if we have actions
                if (state.selectedActions.length === 0) {
                    alert('Please select at least one action for your implementation plan.');
                    return;
                }
                
                // Check if all actions have implementation intentions
                const missingIntentions = state.selectedActions.filter(action => 
                    !state.implementationIntentions[action.id]);
                
                if (missingIntentions.length > 0) {
                    alert(`Please define implementation intentions for all selected actions. The following actions are missing intentions: ${missingIntentions.map(a => a.name).join(', ')}`);
                    return;
                }
                
                state.planSubmitted = true;
                
                // Calculate total energy savings
                const totalSavings = state.selectedActions.reduce((sum, action) => sum + action.savingsKwh, 0);
                
                // Analyze implementation intentions for quality
                let intentionQualityScores = [];
                
                Object.values(state.implementationIntentions).forEach(intention => {
                    let score = 0;
                    
                    // Check if "If" includes specific details (when, where)
                    const ifHasWhen = /when|time|morning|evening|night|day|after|before|during|while|weekend|weekday/i.test(intention.ifCondition);
                    const ifHasWhere = /in the|at the|in my|at my|in our|at our|at home|room|kitchen|bathroom|living room|bedroom/i.test(intention.ifCondition);
                    
                    if (ifHasWhen) score += 1;
                    if (ifHasWhere) score += 1;
                    
                    // Check if "Then" includes specific action details
                    const thenHasSpecifics = /degrees|minutes|hours|times|settings|level|switch|turn|adjust|set|reduce|lower|raise|increase|decrease/i.test(intention.thenAction);
                    
                    if (thenHasSpecifics) score += 1;
                    
                    intentionQualityScores.push(score);
                });
                
                // Calculate average quality score
                const avgQualityScore = intentionQualityScores.reduce((sum, score) => sum + score, 0) / intentionQualityScores.length;
                
                let qualityAssessment;
                if (avgQualityScore >= 2.5) {
                    qualityAssessment = "excellent";
                } else if (avgQualityScore >= 1.5) {
                    qualityAssessment = "good";
                } else {
                    qualityAssessment = "basic";
                }
                
                // Display feedback
                const feedbackPanel = document.getElementById('implementation-feedback');
                const feedbackContent = document.getElementById('implementation-feedback-content');
                
                let feedbackHtml = `
                    <p>Your implementation plan includes ${state.selectedActions.length} energy-saving actions, with a total potential savings of ${totalSavings.toLocaleString()} kWh per year.</p>
                    
                    <h4 style="margin-top: 15px;">Implementation Intention Quality:</h4>
                    <p>Your implementation intentions are of <strong>${qualityAssessment}</strong> quality. ${qualityAssessment === 'excellent' ? 
                        'They include specific details about when, where, and how you will perform each action, which significantly increases the likelihood of successful implementation.' : 
                        qualityAssessment === 'good' ? 
                        'They include some specific details, but could benefit from more precise information about when, where, and how you will perform each action.' : 
                        'They would benefit from more specific details about when, where, and how you will perform each action to increase the likelihood of successful implementation.'}
                    </p>
                    
                    <h4 style="margin-top: 15px;">Wizard Assistance:</h4>
                    <p>You completed this task with the AI Wizard ${state.wizardEnabled ? 'enabled' : 'disabled'}. ${state.wizardEnabled ? 
                        'The wizard provided suggestions for implementation intentions, which may have helped you create more specific and effective plans.' : 
                        'You created your implementation intentions without assistance, which may have required more cognitive effort but potentially increased your sense of ownership over the plans.'}
                    </p>
                    
                    <h4 style="margin-top: 15px;">Next Steps:</h4>
                    <p>Research shows that implementation intentions are most effective when:</p>
                    <ul style="padding-left: 20px; margin-top: 5px;">
                        <li>They are written down and placed in visible locations</li>
                        <li>They link to existing habits or routines</li>
                        <li>They are reviewed and adjusted regularly</li>
                    </ul>
                    <p style="margin-top: 10px;">Consider creating reminders or visual cues in your environment to support your implementation intentions.</p>
                `;
                
                feedbackContent.innerHTML = feedbackHtml;
                feedbackPanel.style.display = 'block';
                
                // Disable interactive elements
                document.getElementById('submit-implementation').disabled = true;
                document.getElementById('submit-implementation').textContent = 'Plan Submitted';
                
                document.querySelectorAll('#implementation-plan .edit-btn, #implementation-plan .remove-btn').forEach(btn => btn.disabled = true);
                document.querySelectorAll('#implementation-actions .action-item').forEach(item => item.style.pointerEvents = 'none');
            });
            
            // Initialize the task
            populateImplementationActions();
            updateImplementationPlanDisplay();
        }
        
        // Task 5: Comparative Planning
        function initComparativePlanningTask() {
            // Task state
            const state = {
                household: households.suburban,
                targetPercent: 10,
                planOrder: 'human-first',
                currentPhase: 'setup', // 'setup', 'human-planning', 'ai-planning', 'comparison'
                humanPlan: [],
                aiPlan: [],
                finalPlan: [],
                planSubmitted: false
            };
            
            // Household selection
            document.getElementById('compare-household').addEventListener('change', function() {
                state.household = households[this.value];
            });
            
            // Target selection
            document.getElementById('compare-target').addEventListener('change', function() {
                state.targetPercent = parseInt(this.value);
            });
            
            // Planning order selection
            document.getElementById('compare-order').addEventListener('change', function() {
                state.planOrder = this.value;
            });
            
            // Start planning process
            document.getElementById('start-compare').addEventListener('click', function() {
                // Hide setup, show planning
                document.getElementById('compare-setup').style.display = 'none';
                document.getElementById('compare-planning').style.display = 'block';
                
                // Set initial phase based on selected order
                if (state.planOrder === 'human-first') {
                    state.currentPhase = 'human-planning';
                    updatePhaseDisplay('Human Planning', 'Create your own energy reduction plan by selecting actions from the list.');
                } else {
                    state.currentPhase = 'ai-planning';
                    // Generate AI plan
                    generateAIPlan();
                    updatePhaseDisplay('AI Plan Editing', 'The AI has generated an initial plan. You can modify it by adding or removing actions.');
                }
                
                // Populate actions and update displays
                populateCompareActions();
                updateComparePlanDisplay();
                updateCompareTargetDisplay();
            });
            
            // Generate AI plan
            function generateAIPlan() {
                // Clear any existing AI plan
                state.aiPlan = [];
                
                // Calculate target value
                const targetValue = Math.round(state.household.annualKwh * (state.targetPercent / 100));
                
                // For the AI plan, create a plan focused on high-efficiency actions
                // Sort actions by efficiency (savings per dollar cost)
                const sortedActions = [...energyActions].map(action => {
                    const efficiency = action.cost > 0 ? action.savingsKwh / action.cost : Infinity; // Free actions get highest priority
                    
                    return {
                        ...action,
                        efficiency
                    };
                }).sort((a, b) => b.efficiency - a.efficiency);
                
                let currentSavings = 0;
                
                // First, add high-impact, no-cost actions
                const noCostActions = sortedActions.filter(action => action.cost === 0);
                for (const action of noCostActions) {
                    if (currentSavings + action.savingsKwh <= targetValue * 1.05) {
                        state.aiPlan.push(action);
                        currentSavings += action.savingsKwh;
                    }
                    
                    if (currentSavings >= targetValue) break;
                }
                
                // If we need more savings, add low-cost, high-efficiency actions
                if (currentSavings < targetValue) {
                    const lowCostActions = sortedActions.filter(action => action.cost > 0 && action.cost <= 100);
                    for (const action of lowCostActions) {
                        if (currentSavings + action.savingsKwh <= targetValue * 1.05) {
                            state.aiPlan.push(action);
                            currentSavings += action.savingsKwh;
                        }
                        
                        if (currentSavings >= targetValue) break;
                    }
                }
                
                // If still needed, add medium-cost actions
                if (currentSavings < targetValue * 0.9) {
                    const mediumCostActions = sortedActions.filter(action => action.cost > 100 && action.cost <= 500);
                    for (const action of mediumCostActions) {
                        if (currentSavings + action.savingsKwh <= targetValue * 1.05) {
                            state.aiPlan.push(action);
                            currentSavings += action.savingsKwh;
                        }
                        
                        if (currentSavings >= targetValue) break;
                    }
                }
            }
            
            // Update phase display
            function updatePhaseDisplay(phaseName, description) {
                document.getElementById('phase-name').textContent = phaseName;
                document.getElementById('phase-description').textContent = description;
                
                // Update plan title
                const planTitle = document.getElementById('current-plan-title');
                if (planTitle) {
                    planTitle.textContent = state.currentPhase === 'human-planning' ? 'Your Plan' : 'AI Plan';
                }
            }
            
            // Populate comparative planning actions
            function populateCompareActions() {
                const actionsContainer = document.getElementById('compare-actions');
                actionsContainer.innerHTML = '';
                
                // Determine which plan we're currently working with
                const currentPlan = state.currentPhase === 'human-planning' ? state.humanPlan : state.aiPlan;
                
                // Group actions by category
                const groupedActions = {};
                energyActions.forEach(action => {
                    if (!groupedActions[action.category]) {
                        groupedActions[action.category] = [];
                    }
                    groupedActions[action.category].push(action);
                });
                
                // Add actions by category
                Object.keys(groupedActions).forEach(category => {
                    const categoryLabel = category.charAt(0).toUpperCase() + category.slice(1);
                    const categoryHeader = document.createElement('h3');
                    categoryHeader.textContent = categoryLabel;
                    categoryHeader.style.marginTop = '15px';
                    categoryHeader.style.marginBottom = '10px';
                    actionsContainer.appendChild(categoryHeader);
                    
                    groupedActions[category].forEach(action => {
                        // Skip actions already in the current plan
                        if (currentPlan.some(a => a.id === action.id)) {
                            return;
                        }
                        
                        const actionElement = document.createElement('div');
                        actionElement.className = 'action-item';
                        
                        actionElement.innerHTML = `
                            <h4>${action.name}</h4>
                            <div>
                                <span class="action-tag">Saves ${action.savingsKwh} kWh</span>
                                <span style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                                    ${action.cost > 0 ? 'Cost: $' + action.cost : 'No cost'}
                                </span>
                            </div>
                            <p style="margin-top: 5px; font-size: 14px;">${action.description}</p>
                        `;
                        
                        actionElement.addEventListener('click', () => {
                            addActionToComparePlan(action);
                        });
                        
                        actionsContainer.appendChild(actionElement);
                    });
                });
            }
            
            // Add action to compare plan
            function addActionToComparePlan(action) {
                if (state.currentPhase === 'human-planning') {
                    state.humanPlan.push(action);
                } else if (state.currentPhase === 'ai-planning') {
                    state.aiPlan.push(action);
                }
                
                updateComparePlanDisplay();
                populateCompareActions();
                updateCompareTargetDisplay();
            }
            
            // Update compare plan display
            function updateComparePlanDisplay() {
                const planContainer = document.getElementById('compare-plan');
                const emptyMessage = document.getElementById('empty-compare-plan');
                
                // Determine which plan we're currently working with
                const currentPlan = state.currentPhase === 'human-planning' ? state.humanPlan : state.aiPlan;
                
                if (currentPlan.length === 0) {
                    if (emptyMessage) {
                        emptyMessage.style.display = 'block';
                    }
                    return;
                }
                
                if (emptyMessage) {
                    emptyMessage.style.display = 'none';
                }
                
                planContainer.innerHTML = '';
                
                currentPlan.forEach(action => {
                    const planItem = document.createElement('div');
                    planItem.className = 'plan-item';
                    
                    planItem.innerHTML = `
                        <div class="plan-item-content">
                            <strong>${action.name}</strong>
                            <div>Saves ${action.savingsKwh} kWh</div>
                        </div>
                        <button class="remove-btn" style="background: none; border: none; color: #dc3545; cursor: pointer;"></button>
                    `;
                    
                    planItem.querySelector('.remove-btn').addEventListener('click', (e) => {
                        e.stopPropagation();
                        removeActionFromComparePlan(action.id);
                    });
                    
                    planContainer.appendChild(planItem);
                });
            }
            
            // Remove action from compare plan
            function removeActionFromComparePlan(actionId) {
                if (state.currentPhase === 'human-planning') {
                    state.humanPlan = state.humanPlan.filter(action => action.id !== actionId);
                } else if (state.currentPhase === 'ai-planning') {
                    state.aiPlan = state.aiPlan.filter(action => action.id !== actionId);
                }
                
                updateComparePlanDisplay();
                populateCompareActions();
                updateCompareTargetDisplay();
            }
            
            // Update compare target display
            function updateCompareTargetDisplay() {
                const targetValue = Math.round(state.household.annualKwh * (state.targetPercent / 100));
                
                document.getElementById('compare-target-value').textContent = `${targetValue} kWh`;
                
                // Calculate current savings
                let currentSavings = 0;
                const currentPlan = state.currentPhase === 'human-planning' ? state.humanPlan : state.aiPlan;
                
                currentPlan.forEach(action => {
                    currentSavings += action.savingsKwh;
                });
                
                document.getElementById('compare-current-savings').textContent = `${currentSavings} kWh`;
                
                // Update progress bar
                const progressPercent = Math.min(100, Math.round((currentSavings / targetValue) * 100));
                document.getElementById('compare-progress').style.width = `${progressPercent}%`;
            }
            
            // Next phase button
            document.getElementById('next-phase').addEventListener('click', function() {
                // Check if the current plan has any actions
                const currentPlan = state.currentPhase === 'human-planning' ? state.humanPlan : state.aiPlan;
                
                if (currentPlan.length === 0) {
                    alert('Please add at least one action to your plan before continuing.');
                    return;
                }
                
                // Move to the next phase
                if (state.currentPhase === 'human-planning') {
                    if (state.planOrder === 'human-first') {
                        // Next is AI planning
                        state.currentPhase = 'ai-planning';
                        generateAIPlan();
                        updatePhaseDisplay('AI Plan Editing', 'The AI has generated an initial plan. You can modify it by adding or removing actions.');
                    } else {
                        // Move to comparison phase
                        showComparisonPhase();
                        return;
                    }
                } else if (state.currentPhase === 'ai-planning') {
                    if (state.planOrder === 'ai-first') {
                        // Next is human planning
                        state.currentPhase = 'human-planning';
                        updatePhaseDisplay('Human Planning', 'Create your own energy reduction plan by selecting actions from the list.');
                    } else {
                        // Move to comparison phase
                        showComparisonPhase();
                        return;
                    }
                }
                
                // Update UI for the new phase
                populateCompareActions();
                updateComparePlanDisplay();
                updateCompareTargetDisplay();
            });
            
            // Show comparison phase
            function showComparisonPhase() {
                // Hide planning phase, show comparison phase
                document.getElementById('compare-planning').style.display = 'none';
                document.getElementById('comparison-phase').style.display = 'block';
                
                state.currentPhase = 'comparison';
                
                // Display both plans for comparison
                displayPlansForComparison();
                
                // Set up event listeners for final choice
                document.querySelectorAll('input[name="final-plan-choice"]').forEach(input => {
                    input.addEventListener('change', function() {
                        const choice = this.value;
                        
                        // Reset final plan
                        state.finalPlan = [];
                        
                        if (choice === 'human') {
                            // Use human plan
                            state.finalPlan = [...state.humanPlan];
                            document.getElementById('hybrid-editor').style.display = 'none';
                        } else if (choice === 'ai') {
                            // Use AI plan
                            state.finalPlan = [...state.aiPlan];
                            document.getElementById('hybrid-editor').style.display = 'none';
                        } else if (choice === 'hybrid') {
                            // Show hybrid editor
                            document.getElementById('hybrid-editor').style.display = 'block';
                            setupHybridEditor();
                        }
                    });
                });
            }
            
            // Display plans for comparison
            function displayPlansForComparison() {
                const humanDisplay = document.getElementById('human-plan-display');
                const aiDisplay = document.getElementById('ai-plan-display');
                
                // Clear previous content
                humanDisplay.innerHTML = '';
                aiDisplay.innerHTML = '';
                
                // Calculate total savings for both plans
                const humanSavings = state.humanPlan.reduce((sum, action) => sum + action.savingsKwh, 0);
                const aiSavings = state.aiPlan.reduce((sum, action) => sum + action.savingsKwh, 0);
                
                // Calculate target
                const targetValue = Math.round(state.household.annualKwh * (state.targetPercent / 100));
                
                // Human plan header
                const humanPercentOfTarget = Math.round((humanSavings / targetValue) * 100);
                humanDisplay.innerHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>Total Savings:</strong>
                            <span>${humanSavings.toLocaleString()} kWh (${humanPercentOfTarget}% of target)</span>
                        </div>
                        <div style="margin-top: 5px;">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${Math.min(humanPercentOfTarget, 100)}%;"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // AI plan header
                const aiPercentOfTarget = Math.round((aiSavings / targetValue) * 100);
                aiDisplay.innerHTML += `
                    <div style="margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <strong>Total Savings:</strong>
                            <span>${aiSavings.toLocaleString()} kWh (${aiPercentOfTarget}% of target)</span>
                        </div>
                        <div style="margin-top: 5px;">
                            <div class="progress-bar-container">
                                <div class="progress-bar-fill" style="width: ${Math.min(aiPercentOfTarget, 100)}%;"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Add actions to human plan display
                state.humanPlan.forEach(action => {
                    const actionItem = document.createElement('div');
                    actionItem.style.padding = '10px';
                    actionItem.style.marginBottom = '10px';
                    actionItem.style.borderBottom = '1px solid #eee';
                    
                    actionItem.innerHTML = `
                        <div>
                            <strong>${action.name}</strong>
                            <div>Saves ${action.savingsKwh.toLocaleString()} kWh</div>
                            <div style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                                ${action.cost > 0 ? 'Cost: $' + action.cost.toLocaleString() : 'No cost'}
                            </div>
                        </div>
                    `;
                    
                    humanDisplay.appendChild(actionItem);
                });
                
                // Add actions to AI plan display
                state.aiPlan.forEach(action => {
                    const actionItem = document.createElement('div');
                    actionItem.style.padding = '10px';
                    actionItem.style.marginBottom = '10px';
                    actionItem.style.borderBottom = '1px solid #eee';
                    
                    actionItem.innerHTML = `
                        <div>
                            <strong>${action.name}</strong>
                            <div>Saves ${action.savingsKwh.toLocaleString()} kWh</div>
                            <div style="color: ${action.cost > 0 ? '#dc3545' : '#28a745'};">
                                ${action.cost > 0 ? 'Cost: $' + action.cost.toLocaleString() : 'No cost'}
                            </div>
                        </div>
                    `;
                    
                    aiDisplay.appendChild(actionItem);
                });
            }
            
            // Set up hybrid editor
            function setupHybridEditor() {
                // Add checkboxes to human and AI plans
                const humanDisplay = document.getElementById('human-plan-display');
                const aiDisplay = document.getElementById('ai-plan-display');
                
                // Clear and rebuild displays
                displayPlansForComparison();
                
                // Add checkboxes to human plan
                const humanActionItems = humanDisplay.querySelectorAll('div > div');
                humanActionItems.forEach((item, index) => {
                    if (index === 0) return; // Skip the header
                    
                    const action = state.humanPlan[index - 1];
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.style.marginRight = '10px';
                    checkbox.dataset.actionId = action.id;
                    checkbox.dataset.source = 'human';
                    
                    checkbox.addEventListener('change', function() {
                        if (this.checked) {
                            // Add to final plan if not already there
                            if (!state.finalPlan.some(a => a.id === action.id)) {
                                state.finalPlan.push(action);
                            }
                        } else {
                            // Remove from final plan
                            state.finalPlan = state.finalPlan.filter(a => a.id !== action.id);
                        }
                        
                        updateHybridPlan();
                    });
                    
                    item.insertBefore(checkbox, item.firstChild);
                });
                
                // Add checkboxes to AI plan
                const aiActionItems = aiDisplay.querySelectorAll('div > div');
                aiActionItems.forEach((item, index) => {
                    if (index === 0) return; // Skip the header
                    
                    const action = state.aiPlan[index - 1];
                    
                    // Check if this action is also in the human plan
                    const isInHumanPlan = state.humanPlan.some(a => a.id === action.id);
                    
                    if (isInHumanPlan) {
                        const note = document.createElement('div');
                        note.textContent = '(Also in Human Plan)';
                        note.style.fontSize = '12px';
                        note.style.color = '#6c757d';
                        note.style.marginTop = '5px';
                        item.appendChild(note);
                    } else {
                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.style.marginRight = '10px';
                        checkbox.dataset.actionId = action.id;
                        checkbox.dataset.source = 'ai';
                        
                        checkbox.addEventListener('change', function() {
                            if (this.checked) {
                                // Add to final plan if not already there
                                if (!state.finalPlan.some(a => a.id === action.id)) {
                                    state.finalPlan.push(action);
                                }
                            } else {
                                // Remove from final plan
                                state.finalPlan = state.finalPlan.filter(a => a.id !== action.id);
                            }
                            
                            updateHybridPlan();
                        });
                        
                        item.insertBefore(checkbox, item.firstChild);
                    }
                });
                
                // Initialize hybrid plan display
                updateHybridPlan();
            }
            
            // Update hybrid plan display
            function updateHybridPlan() {
                const hybridPlan = document.getElementById('hybrid-plan');
                const emptyHybridPlan = document.getElementById('empty-hybrid-plan');
                
                if (state.finalPlan.length === 0) {
                    if (emptyHybridPlan) {
                        emptyHybridPlan.style.display = 'block';
                    }
                    
                    // Update progress
                    updateHybridProgress(0);
                    return;
                }
                
                if (emptyHybridPlan) {
                    emptyHybridPlan.style.display = 'none';
                }
                
                hybridPlan.innerHTML = '';
                
                // Sort actions by category
                const sortedActions = [...state.finalPlan].sort((a, b) => {
                    if (a.category !== b.category) {
                        return a.category.localeCompare(b.category);
                    }
                    return b.savingsKwh - a.savingsKwh;
                });
                
                sortedActions.forEach(action => {
                    const actionItem = document.createElement('div');
                    actionItem.style.padding = '10px';
                    actionItem.style.marginBottom = '10px';
                    actionItem.style.border = '1px solid #ddd';
                    actionItem.style.borderRadius = '5px';
                    actionItem.style.display = 'flex';
                    actionItem.style.justifyContent = 'space-between';
                    
                    // Determine the source(s) of this action
                    const inHuman = state.humanPlan.some(a => a.id === action.id);
                    const inAI = state.aiPlan.some(a => a.id === action.id);
                    let sourceText = '';
                    
                    if (inHuman && inAI) {
                        sourceText = '<span style="color: #28a745;">In both Human and AI plans</span>';
                    } else if (inHuman) {
                        sourceText = '<span style="color: #2c73d2;">From Human plan</span>';
                    } else if (inAI) {
                        sourceText = '<span style="color: #6610f2;">From AI plan</span>';
                    }
                    
                    actionItem.innerHTML = `
                        <div>
                            <strong>${action.name}</strong>
                            <div>Saves ${action.savingsKwh.toLocaleString()} kWh</div>
                            <div style="margin-top: 5px; font-size: 12px;">${sourceText}</div>
                        </div>
                        <button class="remove-hybrid-item" data-action-id="${action.id}" style="background: none; border: none; color: #dc3545; cursor: pointer; align-self: flex-start;"></button>
                    `;
                    
                    // Add event listener to remove button
                    actionItem.querySelector('.remove-hybrid-item').addEventListener('click', function() {
                        const actionId = this.dataset.actionId;
                        
                        // Remove from final plan
                        state.finalPlan = state.finalPlan.filter(a => a.id !== actionId);
                        
                        // Uncheck the corresponding checkbox
                        document.querySelectorAll(`input[data-action-id="${actionId}"]`).forEach(checkbox => {
                            checkbox.checked = false;
                        });
                        
                        // Update display
                        updateHybridPlan();
                    });
                    
                    hybridPlan.appendChild(actionItem);
                });
                
                // Calculate and update progress
                const totalSavings = state.finalPlan.reduce((sum, action) => sum + action.savingsKwh, 0);
                const targetValue = Math.round(state.household.annualKwh * (state.targetPercent / 100));
                const percentOfTarget = Math.round((totalSavings / targetValue) * 100);
                
                updateHybridProgress(totalSavings);
            }
            
            // Update hybrid progress display
            function updateHybridProgress(savings) {
                const targetValue = Math.round(state.household.annualKwh * (state.targetPercent / 100));
                const percentOfTarget = savings > 0 ? Math.round((savings / targetValue) * 100) : 0;
                
                document.getElementById('hybrid-target-value').textContent = `${targetValue} kWh`;
                document.getElementById('hybrid-current-savings').textContent = `${savings} kWh`;
                document.getElementById('hybrid-progress').style.width = `${Math.min(percentOfTarget, 100)}%`;
            }
            
            // Submit comparison button
            document.getElementById('submit-comparison').addEventListener('click', function() {
                // Check if a plan type is selected
                const selectedPlanType = document.querySelector('input[name="final-plan-choice"]:checked');
                if (!selectedPlanType) {
                    alert('Please select a plan type (Human, AI, or Hybrid).');
                    return;
                }
                
                // Check if justification is provided
                const justification = document.getElementById('choice-justification').value.trim();
                if (justification.length < 10) {
                    alert('Please provide a more detailed justification for your choice.');
                    return;
                }
                
                // For hybrid plan, check if actions are selected
                if (selectedPlanType.value === 'hybrid' && state.finalPlan.length === 0) {
                    alert('Please select at least one action for your hybrid plan.');
                    return;
                }
                
                state.planSubmitted = true;
                
                // Calculate metrics for all plans
                const humanSavings = state.humanPlan.reduce((sum, action) => sum + action.savingsKwh, 0);
                const aiSavings = state.aiPlan.reduce((sum, action) => sum + action.savingsKwh, 0);
                const finalSavings = state.finalPlan.reduce((sum, action) => sum + action.savingsKwh, 0);
                
                const targetValue = Math.round(state.household.annualKwh * (state.targetPercent / 100));
                
                const humanPercentOfTarget = Math.round((humanSavings / targetValue) * 100);
                const aiPercentOfTarget = Math.round((aiSavings / targetValue) * 100);
                const finalPercentOfTarget = Math.round((finalSavings / targetValue) * 100);
                
                // Calculate overlap between plans
                const humanActionIds = state.humanPlan.map(a => a.id);
                const aiActionIds = state.aiPlan.map(a => a.id);
                const overlapCount = humanActionIds.filter(id => aiActionIds.includes(id)).length;
                const overlapPercent = Math.round((overlapCount / Math.max(humanActionIds.length, aiActionIds.length)) * 100);
                
                // Determine hybrid type
                let hybridType = '';
                if (selectedPlanType.value === 'hybrid') {
                    const actionsFromHuman = state.finalPlan.filter(a => state.humanPlan.some(ha => ha.id === a.id)).length;
                    const actionsFromAI = state.finalPlan.filter(a => state.aiPlan.some(aia => aia.id === a.id)).length;
                    
                    if (actionsFromHuman > actionsFromAI) {
                        hybridType = 'Human-dominant';
                    } else if (actionsFromAI > actionsFromHuman) {
                        hybridType = 'AI-dominant';
                    } else {
                        hybridType = 'Balanced';
                    }
                }
                
                // Generate AI commentary
                let aiCommentary = '';
                if (selectedPlanType.value === 'human') {
                    if (humanSavings > aiSavings) {
                        aiCommentary = aiResponses.comparativeFeedback.humanBetter;
                    } else {
                        aiCommentary = 'You chose the human plan despite the AI plan ' + 
                                      (aiSavings > humanSavings ? 'achieving greater energy savings' : 'being comparable in energy savings') + 
                                      '. This may indicate a preference for the specific actions in the human plan or greater trust in your own selections.';
                    }
                } else if (selectedPlanType.value === 'ai') {
                    if (aiSavings > humanSavings) {
                        aiCommentary = aiResponses.comparativeFeedback.aiBetter;
                    } else {
                        aiCommentary = 'You chose the AI plan despite the human plan ' + 
                                      (humanSavings > aiSavings ? 'achieving greater energy savings' : 'being comparable in energy savings') + 
                                      '. This may indicate trust in the AI\'s optimization or a preference for the specific actions it suggested.';
                    }
                } else {
                    aiCommentary = aiResponses.comparativeFeedback.complementary;
                }
                
                // Display feedback
                const feedbackPanel = document.getElementById('comparison-feedback');
                const feedbackContent = document.getElementById('comparison-feedback-content');
                
                let feedbackHtml = `
                    <p>You chose the <strong>${selectedPlanType.value === 'human' ? 'Human' : (selectedPlanType.value === 'ai' ? 'AI' : `Hybrid (${hybridType})`)}</strong> plan as your final approach.</p>
                    
                    <h4 style="margin-top: 15px;">Plan Comparison:</h4>
                    <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                        <thead>
                            <tr>
                                <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;"></th>
                                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">Total Savings</th>
                                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">% of Target</th>
                                <th style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Human Plan</strong></td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${humanSavings.toLocaleString()} kWh</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${humanPercentOfTarget}%</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${state.humanPlan.length}</td>
                            </tr>
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>AI Plan</strong></td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${aiSavings.toLocaleString()} kWh</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${aiPercentOfTarget}%</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${state.aiPlan.length}</td>
                            </tr>
                            ${selectedPlanType.value === 'hybrid' ? `
                            <tr>
                                <td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Hybrid Plan</strong></td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${finalSavings.toLocaleString()} kWh</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${finalPercentOfTarget}%</td>
                                <td style="text-align: center; padding: 8px; border-bottom: 1px solid #ddd;">${state.finalPlan.length}</td>
                            </tr>
                            ` : ''}
                        </tbody>
                    </table>
                    
                    <h4 style="margin-top: 15px;">Plan Overlap:</h4>
                    <p>The human and AI plans had ${overlapCount} actions in common (${overlapPercent}% overlap).</p>
                    
                    <h4 style="margin-top: 15px;">Your Justification:</h4>
                    <div style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 5px;">
                        "${justification}"
                    </div>
                    
                    <h4 style="margin-top: 15px;">AI Commentary:</h4>
                    <p>${aiCommentary}</p>
                    
                    <h4 style="margin-top: 15px;">Research Implications:</h4>
                    <p>Your decision process offers insights into how humans evaluate and integrate AI recommendations in energy planning tasks. ${selectedPlanType.value === 'human' ? 
                        'Your preference for the human-created plan may indicate the importance of agency and personal relevance in energy decision-making.' : 
                        (selectedPlanType.value === 'ai' ? 
                        'Your acceptance of the AI-generated plan suggests potential benefits of AI assistance in optimizing complex decisions.' : 
                        'Your creation of a hybrid plan demonstrates how AI and human approaches can complement each other, potentially leading to more personalized and effective outcomes.')}
                    </p>
                `;
                
                feedbackContent.innerHTML = feedbackHtml;
                feedbackPanel.style.display = 'block';
                
                // Disable interactive elements
                document.getElementById('submit-comparison').disabled = true;
                document.getElementById('choice-justification').disabled = true;
                document.querySelectorAll('input[name="final-plan-choice"]').forEach(input => {
                    input.disabled = true;
                });
                document.querySelectorAll('.remove-hybrid-item').forEach(btn => {
                    btn.style.display = 'none';
                });
            });
            
            // Search functionality
            document.getElementById('compare-search').addEventListener('input', function() {
                const searchTerm = this.value.toLowerCase();
                const actionItems = document.querySelectorAll('#compare-actions .action-item');
                
                actionItems.forEach(item => {
                    const actionName = item.querySelector('h4').textContent.toLowerCase();
                    const actionDesc = item.querySelector('p').textContent.toLowerCase();
                    
                    if (actionName.includes(searchTerm) || actionDesc.includes(searchTerm)) {
                        item.style.display = 'block';
                    } else {
                        item.style.display = 'none';
                    }
                });
            });
        }
    </script>
</body>
</html>