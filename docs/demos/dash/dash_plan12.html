<!DOCTYPE html><html lang="en"><head><meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Energy Planning Task Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                        primaryDark: '#4A49B0',
                        lightBg: '#FFFFFF',
                        darkBg: '#181818',
                        darkSecondary: '#282828',
                        lightText: '#333333',
                        darkText: '#E0E0E0'
                    },
                }
            }
        }
    </script>
    <style>
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.2);
            border-radius: 4px;
        }
        .dark .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
        }
        .dark .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(255, 255, 255, 0.2);
        }
        /* Prevent iOS zoom on input */
        input[type="text"], 
        input[type="number"],
        textarea,
        select {
            font-size: 16px;
        }
        @keyframes pulse {
            0% { opacity: 0.5; }
            50% { opacity: 1; }
            100% { opacity: 0.5; }
        }
        .loading-dots::after {
            content: '...';
            animation: pulse 1.5s infinite;
            display: inline-block;
        }
    </style>
</head>
<body class="bg-lightBg dark:bg-darkBg text-lightText dark:text-darkText transition-colors duration-200">
    <div class="container mx-auto px-4 py-6">
        <!-- Header -->
        <header class="mb-8">
            <div class="flex flex-col md:flex-row justify-between items-center">
                <h1 class="text-2xl md:text-3xl font-bold text-primary dark:text-primary mb-4 md:mb-0">Energy Planning Task Dashboard</h1>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:block"></i>
                    </button>
                </div>
            </div>
            <p class="mt-2 text-gray-600 dark:text-gray-300 max-w-3xl">
                This dashboard demonstrates different experimental tasks for studying how people create energy reduction plans. 
                Use the tabs below to explore different task versions and background information.
            </p>
        </header>

        <!-- Tab Navigation -->
        <div class="mb-6 border-b border-gray-200 dark:border-gray-700 overflow-x-auto whitespace-nowrap pb-1">
            <div class="inline-flex">
                <button class="tab-button px-4 py-2 font-medium text-sm rounded-t-lg bg-primary text-white" data-tab="overview">
                    Overview
                </button>
                <button class="tab-button px-4 py-2 font-medium text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg" data-tab="study1">
                    Study 1: LLM Information Source
                </button>
                <button class="tab-button px-4 py-2 font-medium text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg" data-tab="study2">
                    Study 2: Structured LLM Support
                </button>
                <button class="tab-button px-4 py-2 font-medium text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg" data-tab="profiles">
                    Household Profiles
                </button>
                <button class="tab-button px-4 py-2 font-medium text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg" data-tab="applianceData">
                    Appliance Data
                </button>
                <button class="tab-button px-4 py-2 font-medium text-sm hover:bg-gray-100 dark:hover:bg-gray-700 rounded-t-lg" data-tab="hypotheses">
                    Hypotheses
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content active" id="overview">
            <div class="bg-white dark:bg-darkSecondary rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Study Overview</h2>
                <p class="mb-4">This dashboard provides a demonstration of the experimental tasks that will be used in studies examining how people create energy reduction plans and how Large Language Models (LLMs) can assist in this process.</p>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-8">
                    <div class="bg-gray-50 dark:bg-gray-800 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">Study 1: LLM as Reactive Information Source</h3>
                        <p>Examines how providing access to an LLM for querying specific energy information influences the accuracy of household energy-saving plans.</p>
                        <button class="tab-nav-button mt-4 px-4 py-2 bg-primary hover:bg-primaryDark text-white rounded" data-tab="study1">
                            Try Demo
                        </button>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-800 p-5 rounded-lg">
                        <h3 class="text-lg font-semibold mb-3">Study 2: Structured LLM Support</h3>
                        <p>Investigates how different levels of LLM structural support during planning affect plan quality, cognitive load, and sense of agency.</p>
                        <button class="tab-nav-button mt-4 px-4 py-2 bg-primary hover:bg-primaryDark text-white rounded" data-tab="study2">
                            Try Demo
                        </button>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-3">Key Research Areas</h3>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>Impact of information format (kWh, percentage, or USD) on planning accuracy</li>
                        <li>Effects of different LLM assistance types on plan quality</li>
                        <li>Cognitive load during energy planning tasks</li>
                        <li>User sense of agency when working with AI assistance</li>
                        <li>Overcoming knowledge barriers about appliance energy usage</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Study 1 Tab Content -->
        <div class="tab-content" id="study1">
            <div class="bg-white dark:bg-darkSecondary rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Study 1: LLM as Reactive Information Source</h2>
                <p class="mb-6">This task investigates how providing access to an LLM functioning as a reactive, on-demand information source influences the accuracy of household energy-saving plans.</p>
                
                <!-- Parameter Controls -->
                <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h3 class="font-semibold mb-3">Task Parameters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" for="study1-household">Household Profile:</label>
                            <select id="study1-household" class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                <option value="profile1">Profile 1: Small Apartment (8,500 kWh/year)</option>
                                <option value="profile2">Profile 2: Large Home, Cold Climate (14,000 kWh/year)</option>
                                <option value="profile3">Profile 3: Medium Home, Hot Climate (11,500 kWh/year)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" for="study1-goal-format">Goal Format:</label>
                            <select id="study1-goal-format" class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                <option value="kwh">Absolute (kWh)</option>
                                <option value="percentage">Percentage (%)</option>
                                <option value="cost">Monetary ($)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" for="study1-reduction">Reduction Target:</label>
                            <div class="flex items-center">
                                <input type="number" id="study1-reduction" min="5" max="30" value="10" class="w-16 rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3 mr-2">
                                <span id="study1-reduction-unit">%</span>
                            </div>
                        </div>
                    </div>
                    <button id="study1-update-params" class="mt-4 px-4 py-2 bg-primary hover:bg-primaryDark text-white rounded">
                        Update Parameters
                    </button>
                </div>

                <!-- Task Interface -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Profile Info -->
                    <div class="lg:col-span-2">
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold mb-2">Household Profile</h3>
                            <div id="study1-profile-info">
                                <p class="font-medium">Profile 1: Small Apartment</p>
                                <p>Annual Usage: 8,500 kWh</p>
                                <p>Monthly Cost: ~$102 (avg)</p>
                                <p>Occupants: 2</p>
                                <p>Climate: Moderate</p>
                            </div>
                            <div class="mt-4">
                                <h4 class="font-medium mb-2">Energy Breakdown</h4>
                                <div class="h-64">
                                    <canvas id="study1-energy-chart"></canvas>
                                </div>
                            </div>
                        </div>

                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Your Goal</h3>
                            <div id="study1-goal-display" class="p-3 bg-primary bg-opacity-10 border border-primary rounded-lg">
                                <p class="text-lg font-medium">Reduce annual energy use by <span id="study1-target-value">850 kWh</span> (<span id="study1-target-percentage">10%</span>)</p>
                                <p class="text-sm mt-1 text-gray-500 dark:text-gray-400">Current: 8,500 kWh → Target: 7,650 kWh</p>
                            </div>
                        </div>
                    </div>

                    <!-- Task Area -->
                    <div class="lg:col-span-3">
                        <!-- LLM Information Source -->
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold mb-2">Ask About Energy Savings</h3>
                            <p class="text-sm mb-3">Query the LLM for specific information about energy-saving actions.</p>
                            <div class="flex">
                                <input type="text" id="study1-query-input" placeholder="e.g., 'energy savings from LED bulbs'" class="flex-grow rounded-l border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                <button id="study1-query-button" class="bg-primary hover:bg-primaryDark text-white rounded-r px-4 py-2">Ask</button>
                            </div>
                            <div id="study1-query-results" class="mt-3 h-48 overflow-y-auto custom-scrollbar bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-3">
                                <p class="text-gray-500 dark:text-gray-400 italic">Ask a question about energy savings to get information.</p>
                            </div>
                        </div>

                        <!-- Energy Plan Builder -->
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Build Your Energy Saving Plan</h3>
                            <p class="text-sm mb-3">Add actions to your plan to reach your reduction goal.</p>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1" for="study1-action-input">Action Description:</label>
                                <input type="text" id="study1-action-input" placeholder="e.g., Replace 5 incandescent bulbs with LEDs" class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                            </div>
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1" for="study1-savings-input">Estimated Annual Savings (kWh):</label>
                                <input type="number" id="study1-savings-input" min="0" value="0" class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                            </div>
                            <button id="study1-add-action" class="w-full bg-primary hover:bg-primaryDark text-white rounded px-4 py-2">Add to Plan</button>
                            
                            <div class="mt-4">
                                <h4 class="font-medium mb-2">Your Plan</h4>
                                <div id="study1-plan-items" class="min-h-[150px] max-h-[300px] overflow-y-auto custom-scrollbar mb-3 bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-3">
                                    <p class="text-gray-500 dark:text-gray-400 italic">No actions added yet. Add actions to build your plan.</p>
                                </div>
                                <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded">
                                    <span>Total Estimated Savings:</span>
                                    <span id="study1-total-savings" class="font-bold">0 kWh (0%)</span>
                                </div>
                                <div id="study1-goal-progress" class="mt-3 w-full h-4 bg-gray-200 dark:bg-gray-600 rounded overflow-hidden">
                                    <div id="study1-progress-bar" class="h-full bg-primary" style="width: 0%"></div>
                                </div>
                                <div class="mt-2 text-sm text-center" id="study1-goal-status">
                                    Not started
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Survey Questions -->
                <div class="mt-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h3 class="font-semibold mb-3">Sample Survey Questions</h3>
                    <div class="space-y-4">
                        <div>
                            <p class="font-medium mb-2">How did you decide which actions to include in your plan?</p>
                            <textarea class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3 h-20"></textarea>
                        </div>
                        <div>
                            <p class="font-medium mb-2">Rate the cognitive effort required to create your plan:</p>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="cognitive-effort" value="1" class="mr-1">
                                    <span>1 (Very Low)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="cognitive-effort" value="2" class="mr-1">
                                    <span>2</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="cognitive-effort" value="3" class="mr-1">
                                    <span>3</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="cognitive-effort" value="4" class="mr-1">
                                    <span>4</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="cognitive-effort" value="5" class="mr-1">
                                    <span>5 (Very High)</span>
                                </label>
                            </div>
                        </div>
                        <div>
                            <p class="font-medium mb-2">How helpful was the information provided by the AI assistant?</p>
                            <div class="flex space-x-4">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="ai-helpfulness" value="1" class="mr-1">
                                    <span>1 (Not Helpful)</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="ai-helpfulness" value="2" class="mr-1">
                                    <span>2</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="ai-helpfulness" value="3" class="mr-1">
                                    <span>3</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="ai-helpfulness" value="4" class="mr-1">
                                    <span>4</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="ai-helpfulness" value="5" class="mr-1">
                                    <span>5 (Very Helpful)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Study 2 Tab Content -->
        <div class="tab-content" id="study2">
            <div class="bg-white dark:bg-darkSecondary rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Study 2: Structured LLM Support</h2>
                <p class="mb-6">This task investigates how different levels of structural support from an LLM influence the quality of the resulting energy plan, perceived cognitive load, and the user's sense of agency.</p>
                
                <!-- Parameter Controls -->
                <div class="mb-6 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                    <h3 class="font-semibold mb-3">Task Parameters</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium mb-1" for="study2-household">Household Profile:</label>
                            <select id="study2-household" class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                <option value="profile1">Profile 1: Small Apartment (8,500 kWh/year)</option>
                                <option value="profile2">Profile 2: Large Home, Cold Climate (14,000 kWh/year)</option>
                                <option value="profile3">Profile 3: Medium Home, Hot Climate (11,500 kWh/year)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium mb-1" for="study2-support-level">LLM Support Level:</label>
                            <select id="study2-support-level" class="w-full rounded border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                <option value="none">No LLM Support (Control)</option>
                                <option value="info">LLM as Information Source</option>
                                <option value="prompter">LLM as Structured Prompter</option>
                                <option value="drafter">LLM Drafts Plan</option>
                            </select>
                        </div>
                    </div>
                    <button id="study2-update-params" class="mt-4 px-4 py-2 bg-primary hover:bg-primaryDark text-white rounded">
                        Update Parameters
                    </button>
                </div>

                <!-- Task Interface -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-6">
                    <!-- Profile Info -->
                    <div class="lg:col-span-2">
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold mb-2">Household Profile</h3>
                            <div id="study2-profile-info">
                                <p class="font-medium">Profile 1: Small Apartment</p>
                                <p>Annual Usage: 8,500 kWh</p>
                                <p>Monthly Cost: ~$102 (avg)</p>
                                <p>Occupants: 2</p>
                                <p>Climate: Moderate</p>
                            </div>
                            <div class="mt-4">
                                <h4 class="font-medium mb-2">Energy Breakdown</h4>
                                <div class="h-64">
                                    <canvas id="study2-energy-chart"></canvas>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h4 class="font-medium mb-2">Your Goal</h4>
                                <div class="p-3 bg-primary bg-opacity-10 border border-primary rounded-lg">
                                    <p class="text-lg font-medium">Reduce annual energy use by <span id="study2-target-value">850 kWh</span> (<span id="study2-target-percentage">10%</span>)</p>
                                    <p class="text-sm mt-1 text-gray-500 dark:text-gray-400">Current: 8,500 kWh → Target: 7,650 kWh</p>
                                </div>
                            </div>

                            <div class="mt-4">
                                <h4 class="font-medium mb-2">Sample Actions (with Estimated Savings)</h4>
                                <div class="h-64 overflow-y-auto custom-scrollbar bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-3">
                                    <div class="space-y-2">
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Replace 5 incandescent bulbs with LEDs" data-savings="275">
                                            <p class="font-medium">Replace 5 incandescent bulbs with LEDs</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 275 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Lower thermostat by 2°F during heating season" data-savings="700">
                                            <p class="font-medium">Lower thermostat by 2°F during heating season</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 700 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Wash clothes in cold water" data-savings="400">
                                            <p class="font-medium">Wash clothes in cold water</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 400 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Unplug electronics when not in use" data-savings="150">
                                            <p class="font-medium">Unplug electronics when not in use</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 150 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Install low-flow showerhead" data-savings="400">
                                            <p class="font-medium">Install low-flow showerhead</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 400 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Air dry clothes instead of using dryer (2 loads/week)" data-savings="300">
                                            <p class="font-medium">Air dry clothes instead of using dryer (2 loads/week)</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 300 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Replace old refrigerator with ENERGY STAR model" data-savings="250">
                                            <p class="font-medium">Replace old refrigerator with ENERGY STAR model</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 250 kWh/year</p>
                                        </div>
                                        <div class="p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded cursor-pointer action-item" data-action="Install motion sensors for outdoor lighting" data-savings="220">
                                            <p class="font-medium">Install motion sensors for outdoor lighting</p>
                                            <p class="text-sm text-gray-500 dark:text-gray-400">Savings: 220 kWh/year</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Task Area -->
                    <div class="lg:col-span-3">
                        <!-- LLM Support Interface -->
                        <div id="study2-llm-interface" class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg mb-4">
                            <h3 class="font-semibold mb-2">LLM Support</h3>
                            <div id="study2-support-description" class="mb-3 text-sm p-3 bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded">
                                <p><strong>No LLM Support (Control):</strong> You'll create your energy plan without AI assistance. Use the provided action list to build your plan.</p>
                            </div>
                            
                            <div id="study2-conversation" class="min-h-[200px] max-h-[400px] overflow-y-auto custom-scrollbar bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-3 mb-3">
                                <!-- This will be filled dynamically -->
                            </div>
                            
                            <div id="study2-input-container" class="flex">
                                <input type="text" id="study2-llm-input" placeholder="Type your message here..." class="flex-grow rounded-l border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                <button id="study2-send-button" class="bg-primary hover:bg-primaryDark text-white rounded-r px-4 py-2">Send</button>
                            </div>
                        </div>

                        <!-- Energy Plan Builder -->
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Your Energy Saving Plan</h3>
                            <div id="study2-plan-editor" class="min-h-[200px] max-h-[400px] overflow-y-auto custom-scrollbar bg-white dark:bg-gray-900 border border-gray-200 dark:border-gray-700 rounded p-3 mb-3">
                                <div id="study2-plan-items">
                                    <p class="text-gray-500 dark:text-gray-400 italic">No actions added yet. Add actions to build your plan.</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="block text-sm font-medium mb-1" for="study2-custom-action">Add Custom Action:</label>
                                <div class="flex">
                                    <input type="text" id="study2-custom-action" placeholder="Action description" class="flex-grow rounded-l border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                    <input type="number" id="study2-custom-savings" placeholder="kWh savings" class="w-32 border-l-0 border border-gray-300 dark:border-gray-600 dark:bg-gray-700 py-2 px-3">
                                    <button id="study2-add-custom" class="bg-primary hover:bg-primaryDark text-white rounded-r px-4 py-2">Add</button>
                                </div>
                            </div>
                            
                            <div class="flex justify-between items-center p-3 bg-gray-100 dark:bg-gray-700 rounded">
                                <span>Total Estimated Savings:</span>
                                <span id="study2-total-savings" class="font-bold">0 kWh (0%)</span>
                            </div>
                            <div id="study2-goal-progress" class="mt-3 w-full h-4 bg-gray-200 dark:bg-gray-600 rounded overflow-hidden">
                                <div id="study2-progress-bar" class="h-full bg-primary" style="width: 0%"></div>
                            </div>
                            <div class="mt-2 text-sm text-center" id="study2-goal-status">
                                Not started
                            </div>
                        </div>

                        <!-- Cognitive Load Assessment -->
                        <div class="mt-4 bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                            <h3 class="font-semibold mb-2">Task Assessment</h3>
                            <div class="space-y-4">
                                <div>
                                    <p class="font-medium mb-2">Mental Demand: How mentally demanding was the task?</p>
                                    <input type="range" min="1" max="10" value="5" class="w-full">
                                    <div class="flex justify-between text-xs mt-1">
                                        <span>Very Low</span>
                                        <span>Very High</span>
                                    </div>
                                </div>
                                <div>
                                    <p class="font-medium mb-2">Sense of Agency: To what extent do you feel that the final plan represents YOUR decisions?</p>
                                    <input type="range" min="1" max="10" value="5" class="w-full">
                                    <div class="flex justify-between text-xs mt-1">
                                        <span>Not at all mine</span>
                                        <span>Completely mine</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Household Profiles Tab Content -->
        <div class="tab-content" id="profiles">
            <div class="bg-white dark:bg-darkSecondary rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Household Energy Profiles</h2>
                <p class="mb-6">These standardized household profiles are based on real-world energy usage data from the U.S. Energy Information Administration's Residential Energy Consumption Survey (RECS).</p>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Profile 1 -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-semibold mb-3">Profile 1: Small Apartment</h3>
                        <div class="space-y-2">
                            <p><strong>Annual Electricity Use:</strong> 8,500 kWh</p>
                            <p><strong>Monthly Cost:</strong> ~$102 (@ $0.14/kWh)</p>
                            <p><strong>Housing Type:</strong> 2-bedroom apartment</p>
                            <p><strong>Occupants:</strong> 2 adults</p>
                            <p><strong>Climate Zone:</strong> Moderate</p>
                            <p><strong>Key Equipment:</strong> Window AC units, electric water heater, standard appliances</p>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-medium mb-2">Energy Breakdown</h4>
                            <div class="h-64">
                                <canvas id="profile1-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile 2 -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-semibold mb-3">Profile 2: Large Home, Cold Climate</h3>
                        <div class="space-y-2">
                            <p><strong>Annual Electricity Use:</strong> 14,000 kWh</p>
                            <p><strong>Monthly Cost:</strong> ~$168 (@ $0.14/kWh)</p>
                            <p><strong>Housing Type:</strong> 4-bedroom single-family home</p>
                            <p><strong>Occupants:</strong> 4 (2 adults, 2 children)</p>
                            <p><strong>Climate Zone:</strong> Cold</p>
                            <p><strong>Key Equipment:</strong> Electric heating, central AC, electric water heater, multiple appliances</p>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-medium mb-2">Energy Breakdown</h4>
                            <div class="h-64">
                                <canvas id="profile2-chart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Profile 3 -->
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <h3 class="font-semibold mb-3">Profile 3: Medium Home, Hot Climate</h3>
                        <div class="space-y-2">
                            <p><strong>Annual Electricity Use:</strong> 11,500 kWh</p>
                            <p><strong>Monthly Cost:</strong> ~$138 (@ $0.14/kWh)</p>
                            <p><strong>Housing Type:</strong> 3-bedroom single-family home</p>
                            <p><strong>Occupants:</strong> 3 (2 adults, 1 child)</p>
                            <p><strong>Climate Zone:</strong> Hot</p>
                            <p><strong>Key Equipment:</strong> Central AC (heavy use), gas heating, electric water heater, standard appliances</p>
                        </div>
                        <div class="mt-4">
                            <h4 class="font-medium mb-2">Energy Breakdown</h4>
                            <div class="h-64">
                                <canvas id="profile3-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-3">Background on Profile Development</h3>
                    <p class="mb-3">These profiles were developed based on data from the following sources:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>U.S. Energy Information Administration (EIA) Residential Energy Consumption Survey (RECS)</li>
                        <li>ENERGY STAR household energy data</li>
                        <li>National Renewable Energy Laboratory (NREL) residential building models</li>
                        <li>Regional utility company average usage data</li>
                    </ul>
                    <p class="mt-3">The energy usage breakdowns reflect typical patterns for each housing type, climate zone, and occupancy level, providing realistic scenarios for testing energy reduction planning strategies.</p>
                </div>
            </div>
        </div>

        <!-- Appliance Data Tab Content -->
        <div class="tab-content" id="applianceData">
            <div class="bg-white dark:bg-darkSecondary rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Appliance Energy Data</h2>
                <p class="mb-6">This information represents typical energy usage and potential savings for common household appliances and actions. This data forms the knowledge base for the simulated LLM in the experimental tasks.</p>
                
                <div class="overflow-x-auto">
                    <table class="min-w-full border border-gray-200 dark:border-gray-700">
                        <thead>
                            <tr class="bg-gray-50 dark:bg-gray-800">
                                <th class="px-4 py-2 text-left border-b border-r border-gray-200 dark:border-gray-700">Category</th>
                                <th class="px-4 py-2 text-left border-b border-r border-gray-200 dark:border-gray-700">Action</th>
                                <th class="px-4 py-2 text-left border-b border-r border-gray-200 dark:border-gray-700">Annual kWh Savings</th>
                                <th class="px-4 py-2 text-left border-b border-gray-200 dark:border-gray-700">Assumptions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Lighting -->
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700 font-medium" rowspan="3">Lighting</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Replace one 60W incandescent bulb with a 10W LED</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">55 kWh</td>
                                <td class="px-4 py-2">Used 3 hours/day</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Replace five 60W incandescent bulbs with 10W LEDs</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">275 kWh</td>
                                <td class="px-4 py-2">Used 3 hours/day</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Install motion sensor for outdoor light</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">220 kWh</td>
                                <td class="px-4 py-2">Avoiding 6 hrs/night unnecessary use of 100W bulb</td>
                            </tr>
                            
                            <!-- Heating/Cooling -->
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700 font-medium" rowspan="6">Heating/Cooling</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Lower thermostat by 1°F for 8 hours/day (heating season)</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">50-300 kWh</td>
                                <td class="px-4 py-2">1-3% of heating energy, varies by climate</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Lower thermostat by 2°F for 24 hours/day (heating season)</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">250-1000 kWh</td>
                                <td class="px-4 py-2">5-10% of heating energy, varies by climate</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Set thermostat up by 1°F for 8 hours/day (cooling season)</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">20-150 kWh</td>
                                <td class="px-4 py-2">1-3% of cooling energy, varies by climate</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Install programmable/smart thermostat</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">200-1200 kWh</td>
                                <td class="px-4 py-2">5-15% heating/cooling savings</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Seal air leaks around windows/doors</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">500-2000 kWh</td>
                                <td class="px-4 py-2">10-20% heating/cooling savings</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Clean/replace HVAC filters regularly</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">100-750 kWh</td>
                                <td class="px-4 py-2">5-15% HVAC efficiency improvement</td>
                            </tr>
                            
                            <!-- Water Heating -->
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700 font-medium" rowspan="4">Water Heating</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Lower water heater thermostat from 140°F to 120°F</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">150-450 kWh</td>
                                <td class="px-4 py-2">4-10% water heating energy savings</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Install low-flow showerhead (family of 4)</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">300-500 kWh</td>
                                <td class="px-4 py-2">Electric water heater</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Wash clothes in cold water instead of hot</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">300-500 kWh</td>
                                <td class="px-4 py-2">Electric water heater</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Fix leaky hot water faucet (1 drip/sec)</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">100 kWh</td>
                                <td class="px-4 py-2">Electric water heater</td>
                            </tr>
                            
                            <!-- Appliances/Electronics -->
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700 font-medium" rowspan="5">Appliances/Electronics</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Unplug "vampire" electronics when not in use</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">44 kWh per device cluster</td>
                                <td class="px-4 py-2">Saving ~5W continuous</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Use laptop instead of desktop computer</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">73 kWh</td>
                                <td class="px-4 py-2">Saving ~50W for 4 hrs/day</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Air dry clothes instead of using electric dryer</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">200-400 kWh</td>
                                <td class="px-4 py-2">2 loads/week</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Replace old refrigerator with ENERGY STAR model</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">100-300 kWh</td>
                                <td class="px-4 py-2">15-year-old refrigerator</td>
                            </tr>
                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">Run dishwasher only when full</td>
                                <td class="px-4 py-2 border-r border-gray-200 dark:border-gray-700">20-50 kWh</td>
                                <td class="px-4 py-2">Reducing weekly cycles</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3">Human Knowledge of Energy Use</h3>
                    <p class="mb-3">Research studies have found systematic misperceptions in how people understand household energy use:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li><strong>Overestimation of small savings:</strong> People tend to overestimate the energy savings from small, visible actions (like turning off lights) by a factor of 2-10.</li>
                        <li><strong>Underestimation of large savings:</strong> People significantly underestimate the impact of high-energy systems like heating, cooling, and water heating.</li>
                        <li><strong>Visibility bias:</strong> People pay more attention to devices with visible operation (like lights) and less to background systems (like water heaters).</li>
                        <li><strong>Size heuristic:</strong> People often judge energy use by the physical size of devices, which can be misleading.</li>
                    </ul>
                    <p class="mt-3">These misperceptions can lead to suboptimal energy conservation strategies, with too much focus on low-impact actions and neglect of high-impact opportunities.</p>
                </div>
                
                <div class="mt-6">
                    <h3 class="text-lg font-semibold mb-3">Data Sources</h3>
                    <ul class="list-disc pl-5 space-y-2">
                        <li>U.S. Department of Energy (DOE)</li>
                        <li>ENERGY STAR</li>
                        <li>American Council for an Energy-Efficient Economy (ACEEE)</li>
                        <li>National Renewable Energy Laboratory (NREL)</li>
                        <li>Attari et al. (2010): "Public perceptions of energy consumption and savings"</li>
                        <li>Marghetis et al. (2019): "Cognitive constraints on how economic rewards affect cooperation"</li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- Hypotheses Tab Content -->
        <div class="tab-content" id="hypotheses">
            <div class="bg-white dark:bg-darkSecondary rounded-lg shadow p-6">
                <h2 class="text-xl font-bold mb-4">Study Hypotheses</h2>
                <p class="mb-6">These studies aim to test specific hypotheses about how LLM assistance affects energy reduction planning.</p>
                
                <!-- Study 1 Hypotheses -->
                <div class="mb-8">
                    <h3 class="text-lg font-semibold mb-3">Study 1: LLM as Reactive Information Source</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H1: Accuracy</h4>
                            <p>Participants with access to the LLM information source will formulate energy-saving plans where the summed estimated savings of selected actions more closely match the target reduction goal, compared to participants relying solely on their own knowledge.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H2: Action Selection</h4>
                            <p>Access to the LLM will lead participants to incorporate a broader range of actions into their plans, including more high-impact (but typically underestimated) actions related to heating, cooling, or water heating.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H3: Cognitive Load</h4>
                            <p>Querying the LLM for specific savings estimates will reduce the subjective cognitive load associated with the planning task, particularly concerning information retrieval and calculation demands.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H4: Trust and Reliance</h4>
                            <p>Participants' self-reported trust in the LLM's information and their reliance on it during the planning task will be positively correlated with the perceived accuracy and consistency of the LLM's responses.</p>
                        </div>
                    </div>
                </div>
                
                <!-- Study 2 Hypotheses -->
                <div>
                    <h3 class="text-lg font-semibold mb-3">Study 2: Structured LLM Support</h3>
                    <div class="space-y-4">
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H1: Cognitive Load</h4>
                            <p>Perceived cognitive load will decrease as the level of structural support from the LLM increases. The Control (No LLM) condition will have the highest load, the LLM Drafts condition the lowest, and the Information Source and Structured Prompter conditions intermediate loads.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H2: Plan Accuracy</h4>
                            <p>Plan accuracy (closeness to the 10% target) will be highest in conditions where the LLM provides direct support related to calculation or structure (Structured Prompter and LLM Drafts), compared to Control or Information Source conditions.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H3: Plan Specificity</h4>
                            <p>Plan specificity will be higher in conditions where the user is guided to elaborate on actions (Structured Prompter) or actively selects/modifies content (Information Source, potentially LLM Drafts with editing), compared to Control.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H4: Sense of Agency/Ownership</h4>
                            <p>Sense of agency and ownership will be highest in the Control and Information Source conditions, where the user is solely responsible for structuring the plan, and lowest in the LLM Drafts condition.</p>
                        </div>
                        <div class="p-4 bg-gray-50 dark:bg-gray-800 rounded-lg">
                            <h4 class="font-medium mb-2">H5: Efficiency</h4>
                            <p>Planning efficiency (time taken) will improve as the level of structural support increases. The LLM Drafts condition will be the fastest, and Control the slowest.</p>
                        </div>
                    </div>
                </div>
                
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-3">Theoretical Framework</h3>
                    <p class="mb-3">These hypotheses are grounded in several theoretical frameworks:</p>
                    <ul class="list-disc pl-5 space-y-2">
                        <li><strong>Bounded Rationality:</strong> People have limited cognitive resources for complex planning tasks. LLM assistance may help overcome these limitations.</li>
                        <li><strong>Cognitive Load Theory:</strong> High cognitive load can impair decision-making. External aids that reduce cognitive load may improve task performance.</li>
                        <li><strong>Dual-Process Theory:</strong> People often rely on intuitive, heuristic-based judgments (System 1) rather than effortful analysis (System 2). LLM assistance may help engage System 2 thinking.</li>
                        <li><strong>Human-AI Collaboration:</strong> The way AI provides assistance influences not only task performance but also user experience, including trust, reliance, and sense of agency.</li>
                    </ul>
                </div>
                
                <div class="mt-8">
                    <h3 class="text-lg font-semibold mb-3">Expected Outcomes</h3>
                    <p>If the hypotheses are supported, these studies would demonstrate that:</p>
                    <ol class="list-decimal pl-5 space-y-2">
                        <li>LLM assistance can significantly improve the accuracy of energy reduction planning.</li>
                        <li>Different types of LLM support have different effects on plan quality, cognitive load, and user experience.</li>
                        <li>Effective human-AI collaboration in energy planning involves balancing automation with user agency.</li>
                        <li>LLM assistance can help overcome systematic misperceptions about household energy use.</li>
                    </ol>
                    <p class="mt-3">These findings would have implications for the design of AI tools to support energy conservation planning and other complex quantitative planning tasks.</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Theme Toggle
        const themeToggle = document.getElementById('theme-toggle');
        
        // Check for system preference
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        
        // Listen for preference changes
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });
        
        // Toggle button functionality
        themeToggle.addEventListener('click', () => {
            document.documentElement.classList.toggle('dark');
        });
        
        // Tab Navigation
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabNavButtons = document.querySelectorAll('.tab-nav-button');
        const tabContents = document.querySelectorAll('.tab-content');
        
        function setActiveTab(tabId) {
            // Update tab buttons
            tabButtons.forEach(button => {
                if (button.dataset.tab === tabId) {
                    button.classList.add('bg-primary', 'text-white');
                    button.classList.remove('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                } else {
                    button.classList.remove('bg-primary', 'text-white');
                    button.classList.add('hover:bg-gray-100', 'dark:hover:bg-gray-700');
                }
            });
            
            // Update tab content
            tabContents.forEach(content => {
                if (content.id === tabId) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
        }
        
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveTab(button.dataset.tab);
            });
        });
        
        tabNavButtons.forEach(button => {
            button.addEventListener('click', () => {
                setActiveTab(button.dataset.tab);
            });
        });
        
        // Define household profiles data
        const householdProfiles = {
            profile1: {
                name: "Profile 1: Small Apartment",
                annualUsage: 8500,
                monthlyCost: 102,
                occupants: 2,
                climate: "Moderate",
                breakdown: {
                    "Heating/Cooling": 25,
                    "Water Heating": 15,
                    "Lighting": 10,
                    "Refrigeration": 8,
                    "Electronics/Appliances": 42
                }
            },
            profile2: {
                name: "Profile 2: Large Home, Cold Climate",
                annualUsage: 14000,
                monthlyCost: 168,
                occupants: 4,
                climate: "Cold",
                breakdown: {
                    "Heating/Cooling": 45,
                    "Water Heating": 20,
                    "Lighting": 8,
                    "Refrigeration": 6,
                    "Electronics/Appliances": 21
                }
            },
            profile3: {
                name: "Profile 3: Medium Home, Hot Climate",
                annualUsage: 11500,
                monthlyCost: 138,
                occupants: 3,
                climate: "Hot",
                breakdown: {
                    "Heating/Cooling": 50,
                    "Water Heating": 12,
                    "Lighting": 9,
                    "Refrigeration": 7,
                    "Electronics/Appliances": 22
                }
            }
        };
        
        // Create energy breakdown charts
        function createEnergyChart(canvasId, profile) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            const categoryColors = {
                "Heating/Cooling": '#4C9AFF',
                "Water Heating": '#FF5630',
                "Lighting": '#FFC400',
                "Refrigeration": '#36B37E',
                "Electronics/Appliances": '#6554C0'
            };
            
            const data = {
                labels: Object.keys(profile.breakdown),
                datasets: [{
                    data: Object.values(profile.breakdown),
                    backgroundColor: Object.keys(profile.breakdown).map(key => categoryColors[key]),
                    borderWidth: 0
                }]
            };
            
            return new Chart(ctx, {
                type: 'pie',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                usePointStyle: true,
                                padding: 15,
                                color: document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#333333'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const kWh = Math.round(profile.annualUsage * value / 100);
                                    return `${label}: ${value}% (${kWh} kWh)`;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Update chart based on theme
        function updateChartsTheme() {
            if (profile1Chart) {
                profile1Chart.options.plugins.legend.labels.color = document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#333333';
                profile1Chart.update();
            }
            if (profile2Chart) {
                profile2Chart.options.plugins.legend.labels.color = document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#333333';
                profile2Chart.update();
            }
            if (profile3Chart) {
                profile3Chart.options.plugins.legend.labels.color = document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#333333';
                profile3Chart.update();
            }
            if (study1Chart) {
                study1Chart.options.plugins.legend.labels.color = document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#333333';
                study1Chart.update();
            }
            if (study2Chart) {
                study2Chart.options.plugins.legend.labels.color = document.documentElement.classList.contains('dark') ? '#E0E0E0' : '#333333';
                study2Chart.update();
            }
        }
        
        // Listen for theme changes to update charts
        themeToggle.addEventListener('click', updateChartsTheme);
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', updateChartsTheme);
        
        // Initialize profile charts
        let profile1Chart, profile2Chart, profile3Chart;
        let study1Chart, study2Chart;
        
        // Create charts when tabs are activated
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                
                if (tabId === 'profiles' && !profile1Chart) {
                    setTimeout(() => {
                        profile1Chart = createEnergyChart('profile1-chart', householdProfiles.profile1);
                        profile2Chart = createEnergyChart('profile2-chart', householdProfiles.profile2);
                        profile3Chart = createEnergyChart('profile3-chart', householdProfiles.profile3);
                    }, 100);
                }
                
                if (tabId === 'study1' && !study1Chart) {
                    setTimeout(() => {
                        study1Chart = createEnergyChart('study1-energy-chart', householdProfiles.profile1);
                    }, 100);
                }
                
                if (tabId === 'study2' && !study2Chart) {
                    setTimeout(() => {
                        study2Chart = createEnergyChart('study2-energy-chart', householdProfiles.profile1);
                    }, 100);
                }
            });
        });
        
        // Study 1 Functionality
        const study1QueryInput = document.getElementById('study1-query-input');
        const study1QueryButton = document.getElementById('study1-query-button');
        const study1QueryResults = document.getElementById('study1-query-results');
        const study1HouseholdSelect = document.getElementById('study1-household');
        const study1GoalFormatSelect = document.getElementById('study1-goal-format');
        const study1ReductionInput = document.getElementById('study1-reduction');
        const study1ReductionUnit = document.getElementById('study1-reduction-unit');
        const study1UpdateParamsButton = document.getElementById('study1-update-params');
        const study1ProfileInfo = document.getElementById('study1-profile-info');
        const study1TargetValue = document.getElementById('study1-target-value');
        const study1TargetPercentage = document.getElementById('study1-target-percentage');
        const study1ActionInput = document.getElementById('study1-action-input');
        const study1SavingsInput = document.getElementById('study1-savings-input');
        const study1AddActionButton = document.getElementById('study1-add-action');
        const study1PlanItems = document.getElementById('study1-plan-items');
        const study1TotalSavings = document.getElementById('study1-total-savings');
        const study1ProgressBar = document.getElementById('study1-progress-bar');
        const study1GoalStatus = document.getElementById('study1-goal-status');
        
        // Simulated LLM responses for energy savings queries
        const energySavingsResponses = {
            "led bulbs": "Replacing standard incandescent bulbs with LED bulbs typically saves around 45-55 kWh per year per bulb, assuming 3 hours of daily use. For 5 bulbs, that would be approximately 225-275 kWh per year.",
            "5 led bulbs": "Replacing 5 standard 60W incandescent bulbs with 10W LED equivalents (used 3 hours daily) would save approximately 275 kWh per year.",
            "thermostat": "Adjusting your thermostat can yield significant savings. Lowering it by 1°F for 8 hours daily during heating season saves about 50-300 kWh per year depending on your climate. Lowering by 2°F consistently could save 250-1000 kWh annually.",
            "washing": "Washing clothes in cold water instead of hot can save approximately 300-500 kWh per year with an electric water heater.",
            "cold water": "Washing clothes in cold water instead of hot can save approximately 300-500 kWh per year with an electric water heater.",
            "refrigerator": "Replacing a 15-year-old refrigerator with an ENERGY STAR model typically saves between 100-300 kWh per year.",
            "vampire": "Unplugging 'vampire' electronics (devices that draw power even when turned off) can save about 44 kWh per year per device cluster. This includes entertainment centers, computer setups, etc.",
            "air dry": "Air drying clothes instead of using an electric dryer (for about 2 loads per week) saves approximately 200-400 kWh per year.",
            "dryer": "Air drying clothes instead of using an electric dryer (for about 2 loads per week) saves approximately 200-400 kWh per year.",
            "showerhead": "Installing a low-flow showerhead for a family of 4 with an electric water heater saves approximately 300-500 kWh per year.",
            "water heater": "Lowering your water heater thermostat from 140°F to 120°F can save about 150-450 kWh per year (4-10% of water heating energy).",
            "motion sensor": "Installing a motion sensor for outdoor lighting to avoid unnecessary use (6 hours/night of a 100W bulb) saves around 220 kWh per year.",
            "hvac filter": "Regularly cleaning or replacing HVAC filters can improve efficiency by 5-15%, saving approximately 100-750 kWh per year depending on your system and climate.",
            "seal leaks": "Sealing air leaks around windows and doors can save 10-20% on heating and cooling energy, approximately 500-2000 kWh per year depending on home size and climate.",
            "smart thermostat": "Installing a programmable or smart thermostat typically saves 5-15% on heating and cooling costs, approximately 200-1200 kWh per year.",
            "laptop": "Using a laptop instead of a desktop computer (saving about 50W) for 4 hours per day saves approximately 73 kWh per year.",
            "dishwasher": "Running your dishwasher only when full can save about 20-50 kWh per year.",
            "windows": "Sealing air leaks around windows and doors can save 10-20% on heating and cooling energy, approximately 500-2000 kWh per year depending on home size and climate."
        };
        
        let study1TotalSavingsValue = 0;
        let study1CurrentGoal = 850;
        let study1CurrentPercentage = 10;
        let study1PlanActions = [];
        
        // Handle Study 1 Query Button
        study1QueryButton.addEventListener('click', () => {
            const query = study1QueryInput.value.toLowerCase().trim();
            
            if (!query) {
                return;
            }
            
            study1QueryResults.innerHTML = `
                <div class="flex items-start mb-3">
                    <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 p-2 rounded-full">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="ml-3 bg-blue-50 dark:bg-blue-900/20 p-2 px-3 rounded-lg">
                        <p>${study1QueryInput.value}</p>
                    </div>
                </div>
                <div class="flex items-start">
                    <div class="flex-shrink-0 bg-primary bg-opacity-20 text-primary p-2 rounded-full">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ml-3 mb-1 loading-dots">
                        <p>Generating response</p>
                    </div>
                </div>
            `;
            
            setTimeout(() => {
                let response = "I don't have specific information about that. Could you try asking about a particular appliance or energy-saving action?";
                
                // Check for matches in our knowledge base
                for (const [key, value] of Object.entries(energySavingsResponses)) {
                    if (query.includes(key)) {
                        response = value;
                        break;
                    }
                }
                
                const responseHtml = `
                    <div class="flex items-start">
                        <div class="flex-shrink-0 bg-primary bg-opacity-20 text-primary p-2 rounded-full">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="ml-3 bg-gray-50 dark:bg-gray-800 p-2 px-3 rounded-lg">
                            <p>${response}</p>
                        </div>
                    </div>
                `;
                
                // Replace the loading message with the response
                const loadingMessage = study1QueryResults.querySelector('.loading-dots').parentElement.parentElement;
                loadingMessage.outerHTML = responseHtml;
            }, 1000);
        });
        
        // Handle Study 1 Parameter Updates
        study1UpdateParamsButton.addEventListener('click', () => {
            const profileId = study1HouseholdSelect.value;
            const profile = householdProfiles[profileId];
            const goalFormat = study1GoalFormatSelect.value;
            const reductionValue = parseInt(study1ReductionInput.value);
            
            // Update profile info
            study1ProfileInfo.innerHTML = `
                <p class="font-medium">${profile.name}</p>
                <p>Annual Usage: ${profile.annualUsage.toLocaleString()} kWh</p>
                <p>Monthly Cost: ~$${profile.monthlyCost} (avg)</p>
                <p>Occupants: ${profile.occupants}</p>
                <p>Climate: ${profile.climate}</p>
            `;
            
            // Update goal format and unit
            if (goalFormat === 'kwh') {
                study1ReductionUnit.textContent = 'kWh';
                const targetKwh = Math.round(profile.annualUsage * reductionValue / 100);
                study1CurrentGoal = targetKwh;
                study1CurrentPercentage = reductionValue;
                study1TargetValue.textContent = `${targetKwh.toLocaleString()} kWh`;
                study1TargetPercentage.textContent = `${reductionValue}%`;
            } else if (goalFormat === 'percentage') {
                study1ReductionUnit.textContent = '%';
                const targetKwh = Math.round(profile.annualUsage * reductionValue / 100);
                study1CurrentGoal = targetKwh;
                study1CurrentPercentage = reductionValue;
                study1TargetValue.textContent = `${targetKwh.toLocaleString()} kWh`;
                study1TargetPercentage.textContent = `${reductionValue}%`;
            } else if (goalFormat === 'cost') {
                study1ReductionUnit.textContent = '$';
                // Assuming $0.14/kWh for conversion
                const targetKwh = Math.round((reductionValue / 0.14) * 12); // Annual kWh savings
                const effectivePercentage = Math.round((targetKwh / profile.annualUsage) * 100);
                study1CurrentGoal = targetKwh;
                study1CurrentPercentage = effectivePercentage;
                study1TargetValue.textContent = `${targetKwh.toLocaleString()} kWh`;
                study1TargetPercentage.textContent = `${effectivePercentage}%`;
            }
            
            // Update chart
            if (study1Chart) {
                study1Chart.destroy();
            }
            setTimeout(() => {
                study1Chart = createEnergyChart('study1-energy-chart', profile);
            }, 100);
            
            // Update progress calculation
            updateStudy1Progress();
        });
        
        // Update progress calculation for Study 1
        function updateStudy1Progress() {
            const percentComplete = Math.min(100, Math.round((study1TotalSavingsValue / study1CurrentGoal) * 100));
            study1ProgressBar.style.width = `${percentComplete}%`;
            
            const percentOfTotal = Math.round((study1TotalSavingsValue / householdProfiles[study1HouseholdSelect.value].annualUsage) * 100);
            study1TotalSavings.textContent = `${study1TotalSavingsValue.toLocaleString()} kWh (${percentOfTotal}%)`;
            
            if (percentComplete < 25) {
                study1GoalStatus.textContent = "Just getting started";
                study1GoalStatus.className = "mt-2 text-sm text-center text-gray-500 dark:text-gray-400";
            } else if (percentComplete < 75) {
                study1GoalStatus.textContent = "Making progress";
                study1GoalStatus.className = "mt-2 text-sm text-center text-blue-500";
            } else if (percentComplete < 100) {
                study1GoalStatus.textContent = "Almost there!";
                study1GoalStatus.className = "mt-2 text-sm text-center text-orange-500";
            } else {
                study1GoalStatus.textContent = "Goal achieved!";
                study1GoalStatus.className = "mt-2 text-sm text-center text-green-500";
            }
        }
        
        // Handle adding actions to the plan in Study 1
        study1AddActionButton.addEventListener('click', () => {
            const actionText = study1ActionInput.value.trim();
            const savingsValue = parseInt(study1SavingsInput.value);
            
            if (!actionText || isNaN(savingsValue) || savingsValue <= 0) {
                alert("Please enter a valid action description and savings value.");
                return;
            }
            
            // Add to plan
            const actionId = `action-${Date.now()}`;
            const actionHtml = `
                <div id="${actionId}" class="mb-2 p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded">
                    <div class="flex justify-between">
                        <p>${actionText}</p>
                        <div class="flex items-center">
                            <span class="font-medium mr-2">${savingsValue} kWh</span>
                            <button class="text-red-500 hover:text-red-700" onclick="removeAction('${actionId}', ${savingsValue})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            if (study1PlanItems.querySelector('.text-gray-500')) {
                study1PlanItems.innerHTML = ''; // Clear the placeholder text
            }
            
            study1PlanItems.insertAdjacentHTML('beforeend', actionHtml);
            
            // Update the totals
            study1TotalSavingsValue += savingsValue;
            updateStudy1Progress();
            
            // Track the action
            study1PlanActions.push({
                id: actionId,
                text: actionText,
                savings: savingsValue
            });
            
            // Clear inputs
            study1ActionInput.value = '';
            study1SavingsInput.value = '0';
        });
        
        // Handle removing actions from the plan
        window.removeAction = function(actionId, savingsValue) {
            const actionElement = document.getElementById(actionId);
            if (actionElement) {
                actionElement.remove();
                
                // Update the totals
                study1TotalSavingsValue -= savingsValue;
                updateStudy1Progress();
                
                // Remove from tracking array
                study1PlanActions = study1PlanActions.filter(action => action.id !== actionId);
                
                // Show placeholder if empty
                if (study1PlanItems.children.length === 0) {
                    study1PlanItems.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No actions added yet. Add actions to build your plan.</p>';
                }
            }
        };
        
        // Study 2 Functionality
        const study2HouseholdSelect = document.getElementById('study2-household');
        const study2SupportLevelSelect = document.getElementById('study2-support-level');
        const study2UpdateParamsButton = document.getElementById('study2-update-params');
        const study2ProfileInfo = document.getElementById('study2-profile-info');
        const study2TargetValue = document.getElementById('study2-target-value');
        const study2TargetPercentage = document.getElementById('study2-target-percentage');
        const study2LlmInterface = document.getElementById('study2-llm-interface');
        const study2SupportDescription = document.getElementById('study2-support-description');
        const study2Conversation = document.getElementById('study2-conversation');
        const study2InputContainer = document.getElementById('study2-input-container');
        const study2LlmInput = document.getElementById('study2-llm-input');
        const study2SendButton = document.getElementById('study2-send-button');
        const study2PlanEditor = document.getElementById('study2-plan-editor');
        const study2PlanItems = document.getElementById('study2-plan-items');
        const study2CustomAction = document.getElementById('study2-custom-action');
        const study2CustomSavings = document.getElementById('study2-custom-savings');
        const study2AddCustom = document.getElementById('study2-add-custom');
        const study2TotalSavings = document.getElementById('study2-total-savings');
        const study2ProgressBar = document.getElementById('study2-progress-bar');
        const study2GoalStatus = document.getElementById('study2-goal-status');
        
        let study2TotalSavingsValue = 0;
        let study2CurrentGoal = 850;
        let study2CurrentPercentage = 10;
        let study2PlanActions = [];
        let study2SupportLevel = 'none';
        
        // Initialize Study 2 conversation state
        let study2ConversationState = {
            prompterStep: 0,
            categories: ['heating_cooling', 'water_heating', 'lighting', 'appliances'],
            currentCategory: null,
            draftGenerated: false
        };
        
        // LLM support level descriptions
        const supportLevelDescriptions = {
            none: "<strong>No LLM Support (Control):</strong> You'll create your energy plan without AI assistance. Use the provided action list to build your plan.",
            info: "<strong>LLM as Information Source:</strong> The AI will answer your questions about energy savings, but won't guide your planning process. Ask specific questions to get information.",
            prompter: "<strong>LLM as Structured Prompter:</strong> The AI will guide you through the planning process step by step, asking questions and helping you build a structured plan.",
            drafter: "<strong>LLM Drafts Plan:</strong> The AI will create a draft energy reduction plan for you, which you can then review and modify as needed."
        };
        
        // Sample responses for different support levels
        const infoSourceResponses = {
            "heating": "Heating and cooling typically account for 25-50% of household energy use. Actions like lowering your thermostat by 2°F or sealing air leaks can save 700 kWh and 1000 kWh per year respectively.",
            "water": "Water heating accounts for about 12-20% of household energy use. Installing a low-flow showerhead can save 400 kWh per year, and washing clothes in cold water can save 400 kWh per year.",
            "lighting": "Lighting typically accounts for 8-10% of household energy use. Replacing 5 incandescent bulbs with LEDs can save about 275 kWh per year.",
            "appliances": "Appliances and electronics can account for 20-40% of household energy use. Unplugging 'vampire' electronics can save 150 kWh per year, and replacing an old refrigerator can save 250 kWh per year.",
            "thermostat": "Lowering your thermostat by 2°F during the heating season can save approximately 700 kWh per year in a moderate climate.",
            "leaks": "Sealing air leaks around windows and doors can save about 1000 kWh per year in typical homes.",
            "showerhead": "Installing a low-flow showerhead typically saves about 400 kWh per year for a family of 4.",
            "cold water": "Washing clothes in cold water instead of hot can save approximately 400 kWh per year.",
            "led": "Replacing 5 standard incandescent bulbs with LEDs can save about 275 kWh per year.",
            "unplugging": "Unplugging electronics when not in use can save around 150 kWh per year for a typical household.",
            "refrigerator": "Replacing an old refrigerator with an ENERGY STAR model saves about 250 kWh per year.",
            "dry clothes": "Air drying clothes instead of using a dryer for 2 loads per week saves approximately 300 kWh per year."
        };
        
        // Structured prompter responses (step-by-step guidance)
        const prompterSteps = [
            {
                message: "Let's create an energy-saving plan that meets your 10% reduction goal. I'll help you consider different categories of energy use. Let's start with heating and cooling, which typically accounts for the largest portion of household energy. Looking at the action list, which heating/cooling actions would you like to include in your plan?",
                category: "heating_cooling"
            },
            {
                message: "Great choices for heating and cooling. Now, let's look at water heating, which is often the second-largest energy user. Would you like to include any water heating actions from the list in your plan?",
                category: "water_heating"
            },
            {
                message: "Now let's consider lighting. While individual light bulbs don't use much energy, the total can add up. Would you like to add any lighting-related actions to your plan?",
                category: "lighting"
            },
            {
                message: "Finally, let's look at appliances and electronics. These might include refrigerators, washers, dryers, TVs, computers, etc. Which actions related to appliances or electronics would you like to add to your plan?",
                category: "appliances"
            },
            {
                message: "Let's review your energy-saving plan. Based on your selections, I've calculated the total estimated savings. How do you feel about this plan? Is there anything you'd like to add or modify to reach your 10% reduction goal?"
            }
        ];
        
        // Sample plan draft for the "LLM Drafts Plan" condition
        const planDraft = {
            message: "Here's a draft energy reduction plan to achieve your 10% (850 kWh) goal:",
            actions: [
                { text: "Lower thermostat by 2°F during heating season", savings: 700 },
                { text: "Replace 5 incandescent bulbs with LEDs", savings: 275 },
                { text: "Unplug electronics when not in use", savings: 150 }
            ]
        };
        
        // Handle Support Level Changes for Study 2
        study2UpdateParamsButton.addEventListener('click', () => {
            const profileId = study2HouseholdSelect.value;
            const profile = householdProfiles[profileId];
            const supportLevel = study2SupportLevelSelect.value;
            
            // Update profile info
            study2ProfileInfo.innerHTML = `
                <p class="font-medium">${profile.name}</p>
                <p>Annual Usage: ${profile.annualUsage.toLocaleString()} kWh</p>
                <p>Monthly Cost: ~$${profile.monthlyCost} (avg)</p>
                <p>Occupants: ${profile.occupants}</p>
                <p>Climate: ${profile.climate}</p>
            `;
            
            // Update target values
            const targetKwh = Math.round(profile.annualUsage * 0.1); // 10% reduction
            study2CurrentGoal = targetKwh;
            study2CurrentPercentage = 10;
            study2TargetValue.textContent = `${targetKwh.toLocaleString()} kWh`;
            study2TargetPercentage.textContent = `10%`;
            
            // Update support level description
            study2SupportDescription.innerHTML = supportLevelDescriptions[supportLevel];
            study2SupportLevel = supportLevel;
            
            // Reset conversation
            study2Conversation.innerHTML = '';
            study2ConversationState = {
                prompterStep: 0,
                categories: ['heating_cooling', 'water_heating', 'lighting', 'appliances'],
                currentCategory: null,
                draftGenerated: false
            };
            
            // Show/hide LLM interface based on support level
            if (supportLevel === 'none') {
                study2LlmInterface.style.display = 'none';
            } else {
                study2LlmInterface.style.display = 'block';
                
                // Initialize conversation based on support level
                if (supportLevel === 'prompter') {
                    // Add first prompter message
                    addLlmMessage(prompterSteps[0].message);
                    study2ConversationState.prompterStep = 0;
                    study2ConversationState.currentCategory = prompterSteps[0].category;
                } else if (supportLevel === 'drafter') {
                    // Add drafter intro message
                    addLlmMessage("I can draft an energy reduction plan to help you reach your 10% goal. Would you like me to create a draft plan for you?");
                }
            }
            
            // Update chart
            if (study2Chart) {
                study2Chart.destroy();
            }
            setTimeout(() => {
                study2Chart = createEnergyChart('study2-energy-chart', profile);
            }, 100);
            
            // Reset plan items
            study2PlanItems.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No actions added yet. Add actions to build your plan.</p>';
            study2TotalSavingsValue = 0;
            study2PlanActions = [];
            updateStudy2Progress();
        });
        
        // Helper function to add LLM messages to the conversation
        function addLlmMessage(message) {
            const messageHtml = `
                <div class="flex items-start mb-3">
                    <div class="flex-shrink-0 bg-primary bg-opacity-20 text-primary p-2 rounded-full">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ml-3 bg-gray-50 dark:bg-gray-800 p-2 px-3 rounded-lg">
                        <p>${message}</p>
                    </div>
                </div>
            `;
            
            study2Conversation.insertAdjacentHTML('beforeend', messageHtml);
            study2Conversation.scrollTop = study2Conversation.scrollHeight;
        }
        
        // Helper function to add user messages to the conversation
        function addUserMessage(message) {
            const messageHtml = `
                <div class="flex items-start mb-3">
                    <div class="flex-shrink-0 bg-blue-100 dark:bg-blue-900 text-blue-600 dark:text-blue-300 p-2 rounded-full">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="ml-3 bg-blue-50 dark:bg-blue-900/20 p-2 px-3 rounded-lg">
                        <p>${message}</p>
                    </div>
                </div>
            `;
            
            study2Conversation.insertAdjacentHTML('beforeend', messageHtml);
            study2Conversation.scrollTop = study2Conversation.scrollHeight;
        }
        
        // Helper function to add a draft plan
        function addDraftPlan() {
            let totalSavings = 0;
            let actionsHtml = '';
            
            planDraft.actions.forEach(action => {
                totalSavings += action.savings;
                actionsHtml += `
                    <div class="mb-2">
                        <p><strong>${action.text}</strong> - ${action.savings} kWh</p>
                    </div>
                `;
            });
            
            const draftHtml = `
                <div class="flex items-start mb-3">
                    <div class="flex-shrink-0 bg-primary bg-opacity-20 text-primary p-2 rounded-full">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ml-3 bg-gray-50 dark:bg-gray-800 p-2 px-3 rounded-lg">
                        <p class="mb-2">${planDraft.message}</p>
                        <div class="border-t border-gray-200 dark:border-gray-700 pt-2 mt-2">
                            ${actionsHtml}
                        </div>
                        <p class="mt-2 font-medium">Total Savings: ${totalSavings} kWh (${Math.round((totalSavings / study2CurrentGoal) * 100)}% of your goal)</p>
                        <p class="mt-2">You can now add these actions to your plan using the action list on the left, or modify the plan as needed.</p>
                    </div>
                </div>
            `;
            
            study2Conversation.insertAdjacentHTML('beforeend', draftHtml);
            study2Conversation.scrollTop = study2Conversation.scrollHeight;
            study2ConversationState.draftGenerated = true;
        }
        
        // Handle Study 2 Send Button
        study2SendButton.addEventListener('click', () => {
            const userMessage = study2LlmInput.value.trim();
            
            if (!userMessage) {
                return;
            }
            
            // Add user message to conversation
            addUserMessage(userMessage);
            study2LlmInput.value = '';
            
            // Add loading indicator
            const loadingHtml = `
                <div class="flex items-start mb-3 loading-element">
                    <div class="flex-shrink-0 bg-primary bg-opacity-20 text-primary p-2 rounded-full">
                        <i class="fas fa-robot"></i>
                    </div>
                    <div class="ml-3 loading-dots">
                        <p>Generating response</p>
                    </div>
                </div>
            `;
            
            study2Conversation.insertAdjacentHTML('beforeend', loadingHtml);
            study2Conversation.scrollTop = study2Conversation.scrollHeight;
            
            // Process based on support level
            setTimeout(() => {
                // Remove loading indicator
                const loadingElement = document.querySelector('.loading-element');
                if (loadingElement) {
                    loadingElement.remove();
                }
                
                if (study2SupportLevel === 'info') {
                    // Process information source query
                    let responseFound = false;
                    const query = userMessage.toLowerCase();
                    
                    for (const [key, value] of Object.entries(infoSourceResponses)) {
                        if (query.includes(key)) {
                            addLlmMessage(value);
                            responseFound = true;
                            break;
                        }
                    }
                    
                    if (!responseFound) {
                        addLlmMessage("I don't have specific information about that. Try asking about heating, cooling, water heating, lighting, or specific appliances like refrigerators.");
                    }
                } else if (study2SupportLevel === 'prompter') {
                    // Process structured prompter response
                    const currentStep = study2ConversationState.prompterStep;
                    
                    // If user mentions actions, simulate adding them
                    if (userMessage.toLowerCase().includes('thermostat') || 
                        userMessage.toLowerCase().includes('lower')) {
                        addLlmMessage("Great choice! Lowering the thermostat by 2°F can save about 700 kWh per year. I've noted this for your plan.");
                    } else if (userMessage.toLowerCase().includes('wash') || 
                              userMessage.toLowerCase().includes('cold water')) {
                        addLlmMessage("Excellent! Washing clothes in cold water can save about 400 kWh per year. I've noted this for your plan.");
                    } else if (userMessage.toLowerCase().includes('led') || 
                              userMessage.toLowerCase().includes('bulb')) {
                        addLlmMessage("Good choice! Replacing 5 incandescent bulbs with LEDs can save about 275 kWh per year. I've noted this for your plan.");
                    } else if (userMessage.toLowerCase().includes('yes') || 
                              userMessage.toLowerCase().includes('ok') ||
                              userMessage.toLowerCase().includes('sure')) {
                        // General acknowledgment
                        addLlmMessage("Great! Let me know which specific actions you'd like to include from the list.");
                    } else {
                        // Generic action acknowledgment
                        addLlmMessage("I've noted your selection. Would you like to add any more actions in this category?");
                    }
                    
                    // After user response, possibly advance to next prompter step
                    if (Math.random() > 0.5 && currentStep < prompterSteps.length - 1) {
                        setTimeout(() => {
                            study2ConversationState.prompterStep++;
                            const nextStep = prompterSteps[study2ConversationState.prompterStep];
                            study2ConversationState.currentCategory = nextStep.category;
                            addLlmMessage(nextStep.message);
                        }, 1000);
                    }
                } else if (study2SupportLevel === 'drafter') {
                    // Process drafter response
                    if (!study2ConversationState.draftGenerated &&
                        (userMessage.toLowerCase().includes('yes') || 
                         userMessage.toLowerCase().includes('ok') ||
                         userMessage.toLowerCase().includes('sure') ||
                         userMessage.toLowerCase().includes('draft') ||
                         userMessage.toLowerCase().includes('create'))) {
                        addDraftPlan();
                    } else if (study2ConversationState.draftGenerated) {
                        // After draft is generated
                        if (userMessage.toLowerCase().includes('modify') || 
                            userMessage.toLowerCase().includes('change') ||
                            userMessage.toLowerCase().includes('update')) {
                            addLlmMessage("You can modify the plan by adding or removing actions using the controls on the right. Which changes would you like to make?");
                        } else if (userMessage.toLowerCase().includes('add')) {
                            addLlmMessage("To add an action, click on it in the action list on the left, or use the 'Add Custom Action' field below your plan. What would you like to add?");
                        } else if (userMessage.toLowerCase().includes('remove')) {
                            addLlmMessage("To remove an action from your plan, click the X button next to the action. Which action would you like to remove?");
                        } else {
                            addLlmMessage("Is there anything specific you'd like to know about the draft plan or any modifications you'd like to make?");
                        }
                    } else {
                        addLlmMessage("I can create a draft energy reduction plan to help you reach your goal. Would you like me to proceed?");
                    }
                }
            }, 1000);
        });
        
        // Update progress calculation for Study 2
        function updateStudy2Progress() {
            const percentComplete = Math.min(100, Math.round((study2TotalSavingsValue / study2CurrentGoal) * 100));
            study2ProgressBar.style.width = `${percentComplete}%`;
            
            const percentOfTotal = Math.round((study2TotalSavingsValue / householdProfiles[study2HouseholdSelect.value].annualUsage) * 100);
            study2TotalSavings.textContent = `${study2TotalSavingsValue.toLocaleString()} kWh (${percentOfTotal}%)`;
            
            if (percentComplete < 25) {
                study2GoalStatus.textContent = "Just getting started";
                study2GoalStatus.className = "mt-2 text-sm text-center text-gray-500 dark:text-gray-400";
            } else if (percentComplete < 75) {
                study2GoalStatus.textContent = "Making progress";
                study2GoalStatus.className = "mt-2 text-sm text-center text-blue-500";
            } else if (percentComplete < 100) {
                study2GoalStatus.textContent = "Almost there!";
                study2GoalStatus.className = "mt-2 text-sm text-center text-orange-500";
            } else {
                study2GoalStatus.textContent = "Goal achieved!";
                study2GoalStatus.className = "mt-2 text-sm text-center text-green-500";
            }
        }
        
        // Handle adding actions to the plan in Study 2 (from action list)
        document.querySelectorAll('.action-item').forEach(item => {
            item.addEventListener('click', () => {
                const actionText = item.dataset.action;
                const savingsValue = parseInt(item.dataset.savings);
                
                addActionToStudy2Plan(actionText, savingsValue);
            });
        });
        
        // Handle custom action adding in Study 2
        study2AddCustom.addEventListener('click', () => {
            const actionText = study2CustomAction.value.trim();
            const savingsValue = parseInt(study2CustomSavings.value);
            
            if (!actionText || isNaN(savingsValue) || savingsValue <= 0) {
                alert("Please enter a valid action description and savings value.");
                return;
            }
            
            addActionToStudy2Plan(actionText, savingsValue);
            
            // Clear inputs
            study2CustomAction.value = '';
            study2CustomSavings.value = '';
        });
        
        // Helper function to add action to Study 2 plan
        function addActionToStudy2Plan(actionText, savingsValue) {
            // Add to plan
            const actionId = `study2-action-${Date.now()}`;
            const actionHtml = `
                <div id="${actionId}" class="mb-2 p-2 bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded">
                    <div class="flex justify-between">
                        <p>${actionText}</p>
                        <div class="flex items-center">
                            <span class="font-medium mr-2">${savingsValue} kWh</span>
                            <button class="text-red-500 hover:text-red-700" onclick="removeStudy2Action('${actionId}', ${savingsValue})">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            if (study2PlanItems.querySelector('.text-gray-500')) {
                study2PlanItems.innerHTML = ''; // Clear the placeholder text
            }
            
            study2PlanItems.insertAdjacentHTML('beforeend', actionHtml);
            
            // Update the totals
            study2TotalSavingsValue += savingsValue;
            updateStudy2Progress();
            
            // Track the action
            study2PlanActions.push({
                id: actionId,
                text: actionText,
                savings: savingsValue
            });
        }
        
        // Handle removing actions from Study 2 plan
        window.removeStudy2Action = function(actionId, savingsValue) {
            const actionElement = document.getElementById(actionId);
            if (actionElement) {
                actionElement.remove();
                
                // Update the totals
                study2TotalSavingsValue -= savingsValue;
                updateStudy2Progress();
                
                // Remove from tracking array
                study2PlanActions = study2PlanActions.filter(action => action.id !== actionId);
                
                // Show placeholder if empty
                if (study2PlanItems.children.length === 0) {
                    study2PlanItems.innerHTML = '<p class="text-gray-500 dark:text-gray-400 italic">No actions added yet. Add actions to build your plan.</p>';
                }
            }
        };
        
        // Initialize first tab
        setTimeout(() => {
            profile1Chart = createEnergyChart('profile1-chart', householdProfiles.profile1);
            profile2Chart = createEnergyChart('profile2-chart', householdProfiles.profile2);
            profile3Chart = createEnergyChart('profile3-chart', householdProfiles.profile3);
        }, 100);
    </script>


</body></html>