<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LLM Energy Planning Task Demo (Live API)</title>
    <style>
        body {
            font-family: sans-serif;
            line-height: 1.6;
            margin: 20px;
            background-color: #f4f4f4;
            color: #333;
        }

        h1, h2, h3, h4 {
            color: #2c3e50;
        }

        .api-key-section {
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 5px;
        }

        .api-key-section label,
        .api-key-section select,
        .api-key-section input,
        .api-key-section button {
            margin-right: 10px;
            padding: 8px;
        }

        .api-key-section input[type="password"] {
            width: 300px;
        }

        .warning {
            color: #856404;
            font-weight: bold;
            display: block;
            margin-top: 10px;
        }

        .loading-indicator {
            font-style: italic;
            color: #555;
            margin-left: 10px;
            display: none; /* Hidden by default */
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }


        .tab-container {
            overflow: hidden;
            background-color: #e9e9e9;
            border: 1px solid #ccc;
            margin-bottom: 15px;
        }

        .tab-button {
            background-color: inherit;
            float: left;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 14px 16px;
            transition: 0.3s;
            font-size: 1em;
        }

        .tab-button:hover {
            background-color: #ddd;
        }

        .tab-button.active {
            background-color: #ccc;
            font-weight: bold;
        }

        .tab-content {
            display: none; /* Hidden by default */
            padding: 20px;
            border: 1px solid #ccc;
            border-top: none;
            background-color: #fff;
            min-height: 400px; /* Ensure space */
        }

        .tab-content.active {
            display: block; /* Show active tab */
        }

        .info-tab ul {
            list-style-type: disc;
            margin-left: 20px;
        }

        .info-tab li {
            margin-bottom: 8px;
        }

        .controls {
            margin-bottom: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .controls label {
            margin-right: 10px;
            font-weight: bold;
        }

        .controls select, .controls button {
            padding: 8px 12px;
            font-size: 0.95em;
            margin-left: 10px;
            cursor: pointer;
        }

        .task-area {
            margin-top: 20px;
        }

        .profile-box, .goal-box, .feedback-box, .example-box {
            background-color: #eef;
            border: 1px solid #cce;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .goal-box {
            background-color: #efe;
            border: 1px solid #cec;
        }
        .feedback-box {
            background-color: #fef;
            border: 1px solid #ecc;
            white-space: pre-wrap; /* Preserve formatting */
            min-height: 50px;
        }
        .example-box {
            background-color: #fff;
            border: 1px dashed #aaa;
        }

        textarea {
            width: 95%;
            padding: 10px;
            margin-top: 5px;
            margin-bottom: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 1em;
            min-height: 100px;
        }

        button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.3s;
            vertical-align: middle;
        }

        button:hover:not(:disabled) {
            background-color: #2980b9;
        }

        /* Specific UI elements */
        .condition-ui {
            margin-top: 15px;
            padding: 15px;
            border: 1px dashed #ccc;
        }

        .chat-log {
            height: 250px;
            overflow-y: auto;
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #f8f8f8;
        }

        .chat-message {
            margin-bottom: 8px;
            padding: 8px 12px;
            border-radius: 15px;
            max-width: 80%;
            word-wrap: break-word;
            clear: both; /* Ensure messages don't overlap floats */
        }

        .chat-message.user {
            background-color: #dcf8c6;
            float: right; /* Align user messages to the right */
            border-bottom-right-radius: 0;
        }

        .chat-message.ai {
            background-color: #fff;
            border: 1px solid #eee;
            float: left; /* Align AI messages to the left */
            border-bottom-left-radius: 0;
        }
         .chat-message.error {
            background-color: #fdd;
            border: 1px solid #f00;
            float: left;
            color: red;
        }


        .chat-input {
            display: flex;
            clear: both; /* Ensure input is below floated messages */
            margin-top: 10px;
        }

        .chat-input input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px 0 0 4px;
        }

        .chat-input button {
            border-radius: 0 4px 4px 0;
        }

        /* Popup for Action DB */
        .popup {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        }

        .popup-content {
            background-color: #fefefe;
            margin: 10% auto; /* Adjusted margin */
            padding: 20px;
            border: 1px solid #888;
            width: 70%; /* Adjusted width */
            max-width: 700px;
            border-radius: 5px;
            position: relative;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 20px;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }

        #task-output, #task2-output {
            color: green;
            border: 1px solid green;
            padding: 10px;
            background-color: #eaffeaf;
            margin-top: 15px;
            display: none; /* Hide initially */
        }
    </style>
</head>
<body>
    <h1>LLM-Assisted Energy Planning: Task Demo Dashboard (Live API)</h1>

    <div class="api-key-section">
         <label for="api-provider">LLM Provider:</label>
         <select id="api-provider">
             <option value="openai">OpenAI (GPT-4o-mini)</option>
             <option value="gemini">Google Gemini (Gemini 1.5 Flash)</option>
         </select>
         <label for="api-key">API Key:</label>
         <input type="password" id="api-key" placeholder="Enter your API Key here">
         <button onclick="setApiKey()">Set API Key</button>
         <span id="api-status" style="margin-left: 10px; color: red;">API Key Not Set</span>
         <span class="warning">⚠️ WARNING: Never deploy this page publicly with your key. This demo is for local testing ONLY. Keys in browser code are insecure.</span>
    </div>

    <div class="tab-container">
        <button class="tab-button active" onclick="openTab('tab-task1')">Task 1: LLM Roles Demo</button>
        <button class="tab-button" onclick="openTab('tab-task2')">Task 2: Heuristic Feedback Demo</button>
        <button class="tab-button" onclick="openTab('tab-info-study1')">Info: Study 1 Design</button>
        <button class="tab-button" onclick="openTab('tab-info-study2')">Info: Study 2 Design</button>
        <button class="tab-button" onclick="openTab('tab-info-general')">Info: General Materials</button>
    </div>

    <!-- Task 1: LLM Roles Demo -->
    <div id="tab-task1" class="tab-content active">
        <h2>Task 1 Demo: Comparing LLM Assistance Roles</h2>
        <p>This demo simulates Study 1, where participants plan energy savings under different LLM assistance roles using live API calls.</p>

        <div class="controls">
            <label for="task1-condition">Select Condition:</label>
            <select id="task1-condition">
                <option value="control">Control (No AI)</option>
                <option value="generator">Generator (AI provides draft)</option>
                <option value="critic">Critic (AI critiques draft)</option>
                <option value="collaborator">Collaborator (AI chat)</option>
            </select>
            <button onclick="loadTask1Demo()">Load Selected Condition</button>
        </div>

        <hr>

        <div class="task-area">
            <h3>Scenario</h3>
            <div id="task1-profile" class="profile-box">Select a condition to load profile...</div>
            <div id="task1-goal" class="goal-box">Select a condition to load goal...</div>

            <div id="task1-workspace">
                <!-- Control Interface -->
                <div id="task1-control-ui" class="condition-ui" style="display: none;">
                    <h4>Your Task (Control)</h4>
                    <p>Review the profile and goal. Use the space below to list specific actions to meet the goal. You can consult the Action Database for ideas.</p>
                    <label for="task1-control-plan">Enter your plan:</label>
                    <textarea id="task1-control-plan" rows="10" placeholder="List your specific actions here..."></textarea>
                    <button onclick="submitPlan('task1-control')">Submit Final Plan</button>
                    <button onclick="showActionDatabase()">View Action Database</button>
                </div>

                <!-- Generator Interface -->
                <div id="task1-generator-ui" class="condition-ui" style="display: none;">
                     <h4>Your Task (Generator)</h4>
                    <p>Review the profile and goal. The AI will generate an initial draft plan below. Review it, edit it as needed, and then submit your final version.</p>
                    <label for="task1-generator-plan">AI Draft Plan (Editable):</label>
                    <textarea id="task1-generator-plan" rows="10" placeholder="Generating AI plan..."></textarea>
                     <button onclick="submitPlan('task1-generator')">Submit Final Plan</button>
                     <span class="loading-indicator" id="task1-generator-loading">Generating...</span>
                </div>

                <!-- Critic Interface -->
                <div id="task1-critic-ui" class="condition-ui" style="display: none;">
                    <h4>Your Task (Critic)</h4>
                    <p>Review the profile and goal. First, create your own draft plan below. Then, submit it to get feedback from the AI critic. Finally, revise your plan based on the feedback.</p>
                    <label for="task1-critic-draft">Enter your initial draft plan:</label>
                    <textarea id="task1-critic-draft" rows="8" placeholder="List your specific actions here..."></textarea>
                    <button id="task1-critic-submit-draft" onclick="getCriticFeedback()">Submit Draft for Feedback <span class="loading-indicator" id="task1-critic-loading"></span></button>

                    <div id="task1-critic-feedback-area" style="display:none; margin-top: 15px;">
                        <h4>AI Critic Feedback:</h4>
                        <div id="task1-critic-feedback-text" class="feedback-box">Generating feedback...</div>
                        <label for="task1-critic-revision">Revise your plan based on feedback:</label>
                        <textarea id="task1-critic-revision" rows="8"></textarea>
                        <button onclick="submitPlan('task1-critic')">Submit Final Plan</button>
                    </div>
                </div>

                <!-- Collaborator Interface -->
                <div id="task1-collaborator-ui" class="condition-ui" style="display: none;">
                    <h4>Your Task (Collaborator)</h4>
                    <p>Review the profile and goal. Use the chat interface below to discuss with the AI energy advisor. Ask questions, brainstorm ideas, and get estimates to develop your plan together. Compile your final plan in the text area at the bottom when ready.</p>
                    <div id="task1-collaborator-chatlog" class="chat-log">
                        <!-- Chat messages will appear here -->
                    </div>
                    <div class="chat-input">
                        <input type="text" id="task1-collaborator-input" placeholder="Type your message to the AI...">
                        <button id="task1-collaborator-send" onclick="sendChatMessage()">Send <span class="loading-indicator" id="task1-collaborator-loading"></span></button>
                    </div>
                     <label for="task1-collaborator-finalplan" style="margin-top: 15px; display: block;">Compile your final plan here:</label>
                     <textarea id="task1-collaborator-finalplan" rows="6" placeholder="List the final actions agreed upon..."></textarea>
                     <button onclick="submitPlan('task1-collaborator')">Submit Final Plan</button>
                </div>
            </div>
             <div id="task-output" class="output-box"></div>
        </div>
    </div>

    <!-- Task 2: Heuristic Feedback Demo -->
    <div id="tab-task2" class="tab-content">
        <h2>Task 2 Demo: Targeted Heuristic Feedback</h2>
        <p>This demo simulates Study 2, focusing on providing different types of feedback after participants draft a plan *and provide justifications*, using live API calls.</p>

        <div class="controls">
            <label for="task2-condition">Select Feedback Condition:</label>
            <select id="task2-condition">
                <option value="control">Control (No Feedback)</option>
                <option value="generic">Generic Expert Feedback</option>
                <option value="targeted">Targeted Heuristic Feedback</option>
            </select>
             <button onclick="loadTask2Demo()">Load Selected Condition</button>
        </div>
         <hr>

         <div class="task-area">
            <h3>Scenario</h3>
            <div id="task2-profile" class="profile-box">Select a condition to load profile...</div>
            <div id="task2-goal" class="goal-box">Select a condition to load goal...</div>

             <div id="task2-workspace">
                <h4>Your Task (All Conditions - Step 1)</h4>
                <p>Review the profile and goal. Create your draft plan below. For *each action*, briefly explain **why** you chose it or how you estimated its savings.</p>
                <label for="task2-draft-plan-justifications">Enter your draft plan AND justifications:</label>
                <textarea id="task2-draft-plan-justifications" rows="12" placeholder="Example:
1. Turn off lights when leaving room. (Justification: Easy habit, saves electricity visibility).
2. Lower thermostat to 68F in winter. (Justification: Heating uses a lot, small change might save significantly).
..."></textarea>
                <button id="task2-submit-draft" onclick="getHeuristicFeedback()">Submit Draft + Justifications <span class="loading-indicator" id="task2-feedback-loading"></span></button>

                 <div id="task2-feedback-area" style="display:none; margin-top: 15px;">
                    <h4>Feedback Received:</h4>
                    <div id="task2-feedback-text" class="feedback-box">Generating feedback...</div>
                    <label for="task2-revision">Revise your plan based on feedback (or self-review):</label>
                    <textarea id="task2-revision" rows="8" placeholder="Enter revised plan here..."></textarea>
                    <button onclick="submitPlan('task2')">Submit Final Plan</button>
                 </div>
             </div>
             <div id="task2-output" class="output-box"></div>
        </div>
    </div>

    <!-- Info: Study 1 Design -->
    <div id="tab-info-study1" class="tab-content info-tab">
        <h2>Study 1 Info: Comparing LLM Assistance Roles</h2>
        <h3>Design</h3>
        <ul>
            <li>**Structure:** 4 (LLM Role: Control vs. Generator vs. Critic vs. Collaborator) between-subjects design.</li>
            <li>**Task:** Participants create a detailed energy reduction plan for a hypothetical household to meet a specific % cost savings goal.</li>
            <li>**Conditions:**
                <ul>
                    <li>**Control:** Plan created manually, reference database available.</li>
                    <li>**Generator:** AI provides an initial draft plan, user edits/finalizes.</li>
                    <li>**Critic:** User creates a draft, AI provides feedback, user revises.</li>
                    <li>**Collaborator:** User and AI co-create plan via interactive chat.</li>
                </ul>
            </li>
        </ul>
        <h3>Key Hypotheses (Examples)</h3>
        <ul>
            <li>**H1 (Quality):** Collaborator & Critic plans > Generator plans > Control plans in accuracy and feasibility.</li>
            <li>**H2 (Load/Learning):** Generator lowest cognitive load, but potentially least knowledge gain. Critic/Collaborator higher engagement and learning.</li>
            <li>**H3 (Anchoring):** Generator condition may show anchoring to AI's initial plan (less deviation).</li>
            <li>**H4 (User Perception):** User satisfaction/trust may vary; Generator might be seen as easy but Collaborator/Critic might foster more calibrated trust or satisfaction if effective.</li>
        </ul>
        <h3>Primary Measures</h3>
        <ul>
            <li>Plan Accuracy (vs. target, benchmarked)</li>
            <li>Plan Feasibility (expert rated)</li>
            <li>Action Prioritization (high vs. low impact actions)</li>
            <li>Plan Diversity</li>
            <li>Knowledge Change (pre/post quiz)</li>
            <li>Cognitive Load (NASA-TLX)</li>
            <li>Trust (MDMTv2 or similar)</li>
            <li>User Satisfaction/Perceptions (Likert scales)</li>
            <li>Interaction Logs (edits, chat analysis)</li>
        </ul>
    </div>

    <!-- Info: Study 2 Design -->
    <div id="tab-info-study2" class="tab-content info-tab">
        <h2>Study 2 Info: Targeted Heuristic Feedback</h2>
        <h3>Design</h3>
        <ul>
            <li>**Structure:** 3 (Feedback Type: Control vs. Generic Expert vs. Targeted Heuristic) between-subjects design.</li>
            <li>**Task:** Participants create an initial energy reduction plan WITH justifications for choices/estimates. After feedback (or none), they revise the plan.</li>
             <li>**Conditions:**
                <ul>
                    <li>**Control:** No feedback provided after draft submission.</li>
                    <li>**Generic Expert:** AI provides standard tips based on expert energy principles (e.g., "focus on heating/cooling").</li>
                    <li>**Targeted Heuristic:** AI infers likely novice heuristic(s) from plan/justifications (e.g., Visibility Bias, Curtailment Bias) and provides feedback specifically addressing that heuristic.</li>
                </ul>
            </li>
        </ul>
         <h3>Key Hypotheses (Examples)</h3>
        <ul>
            <li>**H1 (Plan Improvement):** Improvement from draft to final plan (accuracy, feasibility) will be greatest in the Targeted condition > Generic > Control.</li>
            <li>**H2 (Heuristic Shift):** Targeted condition participants will show greater reduction in endorsing targeted novice heuristics and greater adoption of expert heuristics (measured pre/post).</li>
            <li>**H3 (Learning):** Knowledge gain will be highest in the Targeted condition.</li>
             <li>**H4 (Trust/Perception):** Targeted feedback, if accurate and well-framed, may enhance perceived AI expertise and trust more than generic feedback.</li>
        </ul>
        <h3>Primary Measures</h3>
        <ul>
            <li>Plan Accuracy/Feasibility Improvement (Draft vs. Final)</li>
            <li>Heuristic Endorsement Change (pre/post quiz)</li>
            <li>Knowledge Change (pre/post quiz)</li>
            <li>Trust in Feedback (custom scale)</li>
            <li>Cognitive Load (NASA-TLX)</li>
             <li>Analysis of Justifications (coding for heuristic use)</li>
             <li>*(Internal: LLM Heuristic Inference Accuracy Validation)*</li>
        </ul>
    </div>

    <!-- Info: General Materials -->
    <div id="tab-info-general" class="tab-content info-tab">
        <h2>General Materials Info</h2>
        <h3>Household Profiles</h3>
        <p>Studies use hypothetical but realistic profiles detailing dwelling type, size, location (climate context), occupancy, key appliances (HVAC, water heater, fridge), and baseline energy use (kWh/$/therms). Example:</p>
        <div class="profile-box example-box">
            <strong>Profile Example (Midwest Homeowner):</strong><br>
            You own a 1800 sq ft single-family house in Indiana (4 occupants). It has a gas furnace (10 yrs old), central AC (8 yrs old), electric water heater (5 yrs old), standard refrigerator, washer/dryer. Baseline: ~12,000 kWh/year electricity, ~600 therms/year gas. Avg. monthly cost: ~$160.
        </div>

        <h3>Savings Goals</h3>
        <p>Goals are specific targets relative to the baseline, presented in different formats depending on the study (e.g., "Reduce costs by 15%", "Save $25/month", "Reduce electricity use by 100 kWh/month").</p>
         <div class="goal-box example-box">
             <strong>Goal Example:</strong> Reduce total annual energy costs by 15% (approx. $24/month based on the example profile).
         </div>

        <h3>Action Database (Concept for LLM Prompting)</h3>
        <p>A background database contains information on common energy-saving actions (behavioral, efficiency upgrades). For each action, it includes estimated savings (kWh/$), implementation cost, and feasibility notes. This database informs AI responses and can be made available to participants. For this demo, a pop-up shows a simplified version. The LLM is prompted with key examples from this database.</p>
         <div id="action-db-popup" class="popup">
             <div class="popup-content">
                 <span class="close-button" onclick="hideActionDatabase()">×</span>
                 <h4>Simulated Action Database (Examples Used in Prompts)</h4>
                 <ul>
                     <li><b>Set Thermostat Back 5°F (8hrs/day):</b> Saves ~5-10% heating/cooling costs. Cost: $0.</li>
                     <li><b>Wash Laundry in Cold Water:</b> Saves ~90% of washer energy (mostly water heating). Cost: $0.</li>
                     <li><b>Replace 5 Incandescent Bulbs with LEDs:</b> Saves ~50-75 kWh/year. Cost: ~$25.</li>
                     <li><b>Add Attic Insulation (R-30):</b> Saves ~10-20% heating/cooling costs. Cost: $500-$1500+. (Homeowner)</li>
                     <li><b>Unplug Phone Chargers When Not Used:</b> Saves <1 kWh/year per charger. Cost: $0.</li>
                     <li><b>Install Low-Flow Showerhead:</b> Saves water heating energy (~5-10%). Cost: ~$30.</li>
                     <li><b>Air Seal Leaks (Caulk/Weatherstrip):</b> Saves ~5% heating/cooling costs. Cost: ~$50.</li>
                     <li><b>Unplug Second Refrigerator:</b> Saves ~500-1000 kWh/year. Cost: $0 (if feasible).</li>
                     <li><b>Change HVAC Filter Regularly:</b> Improves efficiency ~5%. Cost: ~$20/filter.</li>
                 </ul>
                 <p><i>(Note: A real study uses a more extensive database to inform the LLM).</i></p>
             </div>
         </div>
    </div>

<script>
    // --- Global Variables ---
    let apiKey = '';
    let apiProvider = 'openai'; // 'openai' or 'gemini'
    let currentProfile;
    const currentConversation = []; // For collaborator chat

    // --- Data Simulation (Profiles, Goal) ---
    const householdProfiles = [
        // ... (Keep profiles from previous example) ...
         {
            id: 1,
            name: "Midwest Homeowner",
            description: "You own a 1800 sq ft single-family house in Indiana (4 occupants). It has a gas furnace (10 yrs old), central AC (8 yrs old), electric water heater (5 yrs old), standard refrigerator, washer/dryer.",
            baselineCost: 160, // $/month
            baselineKWh: 1000, // kWh/month electricity (approx)
            baselineTherms: 50 // therms/month gas (approx)
        },
        {
            id: 2,
            name: "Southern Apartment Renter",
            description: "You rent an 800 sq ft apartment in Texas (1 occupant). It has central AC (building system), electric heat (rarely used), an older refrigerator, and standard lighting/electronics. Water heating is electric (included in rent potentially).",
            baselineCost: 80, // $/month electricity
            baselineKWh: 600 // kWh/month electricity
        },
         {
            id: 3,
            name: "Older Large House",
            description: "You own a 2500 sq ft older house (built 1960s) in a moderate climate (e.g., Virginia) with 3 occupants. It has an oil furnace, window AC units, an electric water heater, two refrigerators (one old), and drafty windows.",
            baselineCost: 220, // $/month combined
            baselineKWh: 1200, // kWh/month electricity (approx)
            baselineOil: 60 // gallons/month oil (approx)
        }
    ];
    const savingsGoal = { value: 15, unit: '%' }; // Fixed 15% goal for demo

    // Simplified Action DB Summary for Prompts
    const actionDbSummary = `Key Energy Saving Action Examples:
- Thermostat setback (5-8F/8hrs): 5-10% heating/cooling savings, $0 cost.
- Cold water laundry: Saves ~90% washer energy, $0 cost.
- LED bulb replacement (per 5 bulbs): ~50-75 kWh/yr, ~$25 cost.
- Attic Insulation (R-30): ~10-20% heating/cooling savings, $500+ cost (owner).
- Unplug chargers: <1 kWh/yr savings, $0 cost. (Low impact)
- Low-flow showerhead: 5-10% water heating savings, ~$30 cost.
- Air seal leaks: ~5% heating/cooling savings, ~$50 cost.
- Unplug second fridge: ~500-1000 kWh/yr, $0 cost. (High impact if applicable)
- Change HVAC filter: ~5% efficiency gain, ~$20 cost.
Remember heating, cooling, and water heating are usually the largest energy users. Efficiency upgrades often save more than simple curtailment.`;

    // List of Heuristics for Task 2
    const noviceHeuristics = [
        { name: "Curtailment Bias", description: "Overemphasis on behavioral reduction (turning things off) vs. efficiency." },
        { name: "Visibility/Salience Bias", description: "Overestimating savings from frequently seen/used but low-power items (lights, chargers)." },
        { name: "Size Heuristic", description: "Assuming larger appliance = higher energy use, ignoring function (heating/cooling)." },
        { name: "Frequency Heuristic", description: "Assuming frequently performed actions save more, regardless of per-instance impact." },
        { name: "Heating/Cooling Function Neglect", description: "Underestimating the dominance of HVAC and water heating." }
    ];

    // --- API Key Management ---
    function setApiKey() {
        apiKey = document.getElementById('api-key').value;
        apiProvider = document.getElementById('api-provider').value;
        const statusEl = document.getElementById('api-status');
        if (apiKey && apiKey.trim() !== '') {
            statusEl.textContent = `API Key Set for ${apiProvider === 'openai' ? 'OpenAI' : 'Gemini'}`;
            statusEl.style.color = 'green';
            console.log(`API Key set for ${apiProvider}`);
        } else {
            statusEl.textContent = 'API Key Not Set';
            statusEl.style.color = 'red';
            apiKey = ''; // Clear if empty
            alert("API Key cannot be empty.");
        }
    }

    // --- Core LLM Call Function ---
    async function callLLM(systemPrompt, userPrompt, messages = null) {
        if (!apiKey || apiKey.trim() === '') {
            alert("API Key not set. Please enter your key in the section at the top.");
            return { error: "API Key not set." };
        }

        const provider = apiProvider; // Use the globally set provider
        let url = '';
        let headers = {};
        let body = {};

        try {
            if (provider === 'openai') {
                url = 'https://api.openai.com/v1/chat/completions';
                headers = {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${apiKey}`
                };
                // Use messages array if provided (for chat history), otherwise construct from prompts
                const llmMessages = messages ? messages : [
                    { role: "system", content: systemPrompt },
                    { role: "user", content: userPrompt }
                ];
                body = JSON.stringify({
                    model: "gpt-4o-mini", // Specify a model
                    messages: llmMessages,
                    temperature: 0.5, // Adjust temperature for creativity vs consistency
                    max_tokens: 500 // Limit response length
                });
            } else if (provider === 'gemini') {
                 url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                headers = {
                    'Content-Type': 'application/json'
                };
                 // Gemini structure - combine prompts or handle history
                 let geminiContent = [];
                 if (messages) { // Attempt to map chat history
                    geminiContent = messages.map(msg => ({
                        role: msg.role === 'user' ? 'user' : 'model', // Map roles
                        parts: [{ text: msg.content }]
                    }));
                    // Gemini requires alternating user/model roles, ensure last is user
                     if (geminiContent.length > 0 && geminiContent[geminiContent.length - 1].role === 'model') {
                        geminiContent.push({ role: 'user', parts: [{text: "(Continue response)"}] }); // Hack if last was model
                     }
                 } else {
                    // Combine system and user prompt for simpler cases
                     geminiContent = [{ role: 'user', parts: [{ text: systemPrompt + "\n\n---\n\n" + userPrompt }] }];
                 }

                 body = JSON.stringify({
                     contents: geminiContent,
                     generationConfig: {
                        temperature: 0.5,
                        maxOutputTokens: 500
                     }
                 });
            } else {
                throw new Error("Invalid API provider selected.");
            }

            console.log("Making API call to:", url);
            console.log("Request Body:", body); // Log request body for debugging

            const response = await fetch(url, {
                method: 'POST',
                headers: headers,
                body: body
            });

            if (!response.ok) {
                const errorData = await response.json();
                console.error("API Error Response:", errorData);
                throw new Error(`API request failed: ${response.status} ${response.statusText} - ${errorData?.error?.message || 'Unknown error'}`);
            }

            const data = await response.json();
            console.log("API Success Response:", data); // Log success response

            let aiResponseText = '';
            if (provider === 'openai') {
                aiResponseText = data.choices?.[0]?.message?.content || 'No content received from OpenAI.';
            } else if (provider === 'gemini') {
                aiResponseText = data.candidates?.[0]?.content?.parts?.[0]?.text || 'No content received from Gemini.';
            }
             return { text: aiResponseText.trim() };

        } catch (error) {
            console.error("Error calling LLM:", error);
            return { error: `LLM Call Failed: ${error.message}` };
        }
    }


    // --- Tab Handling ---
    function openTab(tabId) {
        // ... (Keep openTab function from previous example) ...
          // Hide all tab content
        document.querySelectorAll('.tab-content').forEach(content => {
            content.style.display = 'none';
            content.classList.remove('active');
        });
        // Deactivate all tab buttons
        document.querySelectorAll('.tab-button').forEach(button => {
            button.classList.remove('active');
        });

        // Show the selected tab content
        document.getElementById(tabId).style.display = 'block';
        document.getElementById(tabId).classList.add('active');

        // Activate the clicked button
        document.querySelectorAll('.tab-button').forEach(button => {
            if (button.getAttribute('onclick') === `openTab('${tabId}')`) {
                button.classList.add('active');
            }
        });

        // Initialize demos if they are opened for the first time or re-selected
        if (tabId === 'tab-task1') {
            loadTask1Demo();
        } else if (tabId === 'tab-task2') {
            loadTask2Demo();
        }
    }

    // --- Task 1: LLM Roles Demo Logic ---
    function displayProfileAndGoal(profileElId, goalElId, profile) {
        document.getElementById(profileElId).innerHTML = `<strong>Profile: ${profile.name}</strong><br>${profile.description}`;
        let goalValue = savingsGoal.value;
        let goalUnit = savingsGoal.unit;
        let goalCostEquivalent = Math.round(profile.baselineCost * (savingsGoal.value / 100));
        document.getElementById(goalElId).innerHTML = `<strong>Your Goal:</strong> Reduce total energy costs by <strong>${goalValue}${goalUnit}</strong> (approx. $${goalCostEquivalent}/month).`;
    }


    async function loadTask1Demo() {
        currentProfile = householdProfiles[Math.floor(Math.random() * householdProfiles.length)];
        displayProfileAndGoal('task1-profile', 'task1-goal', currentProfile);
        document.getElementById('task-output').style.display = 'none'; // Hide output box
        document.getElementById('task-output').textContent = '';


        const selectedCondition = document.getElementById('task1-condition').value;
        await setupTask1Condition(selectedCondition); // Make async for generator
    }

    async function setupTask1Condition(condition) {
        // Hide all condition-specific UIs
        document.querySelectorAll('#task1-workspace .condition-ui').forEach(ui => ui.style.display = 'none');

        // Show the selected UI
        const uiToShow = document.getElementById(`task1-${condition}-ui`);
         if (uiToShow) {
             uiToShow.style.display = 'block';
         } else {
             console.error("UI element not found for condition:", condition);
             return;
         }

        // Reset loading indicators
        document.querySelectorAll('.loading-indicator').forEach(el => el.style.display = 'none');
        document.querySelectorAll('button').forEach(el => el.disabled = false); // Re-enable buttons


        // Condition-specific setup
        if (condition === 'generator') {
            const planTextArea = document.getElementById('task1-generator-plan');
            const loadingIndicator = document.getElementById('task1-generator-loading');
            planTextArea.value = ''; // Clear previous
            planTextArea.placeholder = 'Generating AI plan... Please wait.';
            loadingIndicator.style.display = 'inline'; // Show loading

            const systemPrompt = `You are an AI energy advisor. Generate a concrete, actionable energy saving plan for the following household profile to meet the specified goal. Base your plan on realistic savings estimates, drawing from the provided examples. Focus on a mix of behavioral changes and feasible efficiency improvements. List 5-7 specific actions with brief estimated monthly $ savings for each, totaling close to the target savings. Household Profile: ${currentProfile.description}. Baseline Cost: $${currentProfile.baselineCost}/month. Goal: Reduce costs by ${savingsGoal.value}%. Key Action Examples & Estimates:\n${actionDbSummary}`;
            const userPrompt = "Generate the energy saving plan.";

            const result = await callLLM(systemPrompt, userPrompt);

            loadingIndicator.style.display = 'none'; // Hide loading
            if (result.error) {
                 planTextArea.value = `Error generating plan: ${result.error}`;
                 planTextArea.style.color = 'red';
            } else {
                planTextArea.value = result.text;
                 planTextArea.style.color = 'black';
                 planTextArea.placeholder = '';
            }

        } else if (condition === 'critic') {
            document.getElementById('task1-critic-draft').value = '';
            document.getElementById('task1-critic-feedback-area').style.display = 'none';
            document.getElementById('task1-critic-feedback-text').textContent = '';
            document.getElementById('task1-critic-revision').value = '';
            document.getElementById('task1-critic-submit-draft').disabled = false;
        } else if (condition === 'collaborator') {
             document.getElementById('task1-collaborator-chatlog').innerHTML = '';
             currentConversation.length = 0; // Clear history
             const initialSystemMessage = `You are a friendly and helpful AI energy advisor. Your goal is to collaboratively help the user create a plan to reduce their energy costs by ${savingsGoal.value}% (approx. $${Math.round(currentProfile.baselineCost * (savingsGoal.value / 100))}/month) for their household. Household Profile: ${currentProfile.description}. Baseline Cost: $${currentProfile.baselineCost}/month. Key Action Examples & Estimates:\n${actionDbSummary}\n\nStart by greeting the user and asking how you can help them begin planning. Do NOT give a full plan upfront. Be conversational, answer questions, provide estimates when asked, and suggest options interactively.`;
             // Add system prompt to history for OpenAI structure
             currentConversation.push({ role: "system", content: initialSystemMessage });

             // Simulate initial AI greeting (or could make initial call here)
             const initialAiGreeting = "Hi! I'm here to help you brainstorm a plan to save 15% on energy costs. Where would you like to start, or do you have any initial ideas?";
             addChatMessage('ai', initialAiGreeting);
             currentConversation.push({ role: "assistant", content: initialAiGreeting }); // Add AI greeting to history

             document.getElementById('task1-collaborator-input').value = '';
             document.getElementById('task1-collaborator-finalplan').value = '';
             document.getElementById('task1-collaborator-send').disabled = false;

        } else if (condition === 'control') {
             document.getElementById('task1-control-plan').value = '';
        }
    }

    async function getCriticFeedback() {
        const draftPlan = document.getElementById('task1-critic-draft').value;
        if (!draftPlan.trim()) {
            alert("Please enter your draft plan first.");
            return;
        }
        const submitButton = document.getElementById('task1-critic-submit-draft');
        const loadingIndicator = document.getElementById('task1-critic-loading');
        const feedbackArea = document.getElementById('task1-critic-feedback-area');
        const feedbackTextEl = document.getElementById('task1-critic-feedback-text');

        submitButton.disabled = true;
        loadingIndicator.textContent = 'Analyzing...';
        loadingIndicator.style.display = 'inline';
        feedbackArea.style.display = 'block'; // Show area while loading
        feedbackTextEl.textContent = 'Generating feedback... Please wait.';

        const systemPrompt = `You are an AI energy planning critic. Analyze the user's draft plan below in the context of their household profile and the goal of saving ${savingsGoal.value}% (approx. $${Math.round(currentProfile.baselineCost * (savingsGoal.value / 100))}/month). Provide constructive feedback focusing on: 1) Accuracy/Sufficiency: Does the plan likely meet the goal? Are savings estimates reasonable? 2) Feasibility: Are the actions practical for this profile (e.g., renter vs owner)? 3) Completeness/Prioritization: Are major energy uses (like heating/cooling/water heating) addressed? Are there missed high-impact opportunities? Be supportive but clear. Household Profile: ${currentProfile.description}. Baseline Cost: $${currentProfile.baselineCost}/month. Goal: Reduce costs by ${savingsGoal.value}%. Key Action Examples & Estimates:\n${actionDbSummary}`;
        const userPrompt = `Here is my draft plan:\n---\n${draftPlan}\n---\nPlease provide your critique.`;

        const result = await callLLM(systemPrompt, userPrompt);

        loadingIndicator.style.display = 'none'; // Hide loading
        if (result.error) {
            feedbackTextEl.textContent = `Error generating feedback: ${result.error}`;
            feedbackTextEl.style.color = 'red';
        } else {
             feedbackTextEl.textContent = result.text;
             feedbackTextEl.style.color = 'black';
             document.getElementById('task1-critic-revision').value = draftPlan; // Pre-fill revision area
        }
        // Keep button disabled after attempt
    }

     async function sendChatMessage() {
        const userInput = document.getElementById('task1-collaborator-input').value;
        if (!userInput.trim()) return;

        const sendButton = document.getElementById('task1-collaborator-send');
        const loadingIndicator = document.getElementById('task1-collaborator-loading');

        addChatMessage('user', userInput);
        currentConversation.push({ role: "user", content: userInput }); // Add user message to history
        document.getElementById('task1-collaborator-input').value = ''; // Clear input

        sendButton.disabled = true;
        loadingIndicator.textContent = 'Thinking...';
        loadingIndicator.style.display = 'inline';

        // Prepare message history for API call
        // For OpenAI, use the whole conversation array.
        // For Gemini, we need to ensure the structure is correct (roles might need mapping).
        // The callLLM function handles basic Gemini structure.

        const result = await callLLM(null, null, currentConversation); // Pass history via messages array

        sendButton.disabled = false;
        loadingIndicator.style.display = 'none';

        if (result.error) {
            addChatMessage('error', `LLM Error: ${result.error}`);
             // Optionally remove last user message from history if API failed
             // currentConversation.pop();
        } else {
            addChatMessage('ai', result.text);
            currentConversation.push({ role: "assistant", content: result.text }); // Add AI response to history
        }
    }


    function addChatMessage(sender, text) {
        const chatlog = document.getElementById('task1-collaborator-chatlog');
        const messageDiv = document.createElement('div');
        messageDiv.classList.add('chat-message', sender);
        // Basic sanitization to prevent HTML injection from LLM
         const textNode = document.createTextNode(text);
         messageDiv.appendChild(textNode);
        chatlog.appendChild(messageDiv);
        // Ensure proper clearing and scrolling after adding message
        const spacer = document.createElement('div');
        spacer.style.clear = 'both';
        chatlog.appendChild(spacer);
        chatlog.scrollTop = chatlog.scrollHeight; // Auto-scroll
    }


    // --- Task 2: Heuristic Feedback Demo Logic ---
    function loadTask2Demo() {
        currentProfile = householdProfiles[Math.floor(Math.random() * householdProfiles.length)];
        displayProfileAndGoal('task2-profile', 'task2-goal', currentProfile);

        // Reset state
        document.getElementById('task2-draft-plan-justifications').value = '';
        document.getElementById('task2-feedback-area').style.display = 'none';
        document.getElementById('task2-feedback-text').textContent = '';
        document.getElementById('task2-revision').value = '';
        document.getElementById('task2-submit-draft').disabled = false;
        document.getElementById('task2-output').style.display = 'none'; // Hide output box
        document.getElementById('task2-output').textContent = '';

        // Reset loading indicator
        document.querySelectorAll('#task2-workspace .loading-indicator').forEach(el => el.style.display = 'none');
        document.querySelectorAll('#task2-workspace button').forEach(el => el.disabled = false);
    }


    async function getHeuristicFeedback() {
        const draftPlanJust = document.getElementById('task2-draft-plan-justifications').value;
        if (!draftPlanJust.trim()) {
            alert("Please enter your draft plan and justifications first.");
            return;
        }

        const selectedCondition = document.getElementById('task2-condition').value;
        const submitButton = document.getElementById('task2-submit-draft');
        const loadingIndicator = document.getElementById('task2-feedback-loading');
        const feedbackArea = document.getElementById('task2-feedback-area');
        const feedbackTextEl = document.getElementById('task2-feedback-text');

        submitButton.disabled = true;
        loadingIndicator.textContent = 'Analyzing...';
        loadingIndicator.style.display = 'inline';
        feedbackArea.style.display = 'block';
        feedbackTextEl.textContent = 'Generating feedback... Please wait.';

        let feedbackText = '';

        if (selectedCondition === 'control') {
            feedbackText = "Thank you for your draft. Please take a moment to review your plan and justifications, then enter any revisions below.";
             loadingIndicator.style.display = 'none'; // Hide loading
             feedbackTextEl.textContent = feedbackText;
             feedbackTextEl.style.color = 'black';
             document.getElementById('task2-revision').value = draftPlanJust;
        } else if (selectedCondition === 'generic') {
             const systemPrompt = `You are an AI energy advisor. Provide generic expert feedback on the user's draft plan below, considering the goal of saving ${savingsGoal.value}%. Focus on general principles like prioritizing major energy users (heating, cooling, water heating) and considering efficiency improvements. Do not analyze specific justifications deeply, just give standard advice. Household Profile: ${currentProfile.description}. Goal: Reduce costs by ${savingsGoal.value}%. Key Action Examples:\n${actionDbSummary}`;
             const userPrompt = `My Draft Plan:\n${draftPlanJust}\n\nProvide generic expert feedback.`;
             const result = await callLLM(systemPrompt, userPrompt);

             loadingIndicator.style.display = 'none';
             if (result.error) {
                 feedbackText = `Error generating feedback: ${result.error}`;
                 feedbackTextEl.style.color = 'red';
             } else {
                 feedbackText = result.text;
                 feedbackTextEl.style.color = 'black';
             }
             feedbackTextEl.textContent = feedbackText;
             document.getElementById('task2-revision').value = draftPlanJust;

        } else if (selectedCondition === 'targeted') {
             // --- Step 1: Infer Heuristic ---
             loadingIndicator.textContent = 'Inferring Heuristic...';
             const inferenceSystemPrompt = `Analyze the user's energy saving plan and their justifications. Identify the ONE most prominent novice energy heuristic they seem to be relying on from the list below. Explain your reasoning briefly. If no specific heuristic clearly dominates, say "None Detected".
             Household Profile: ${currentProfile.description}.
             User Plan and Justifications:\n${draftPlanJust}\n\n
             Novice Heuristics List:
             - ${noviceHeuristics.map(h => `${h.name}: ${h.description}`).join('\n- ')}
             \nRespond ONLY with the name of the most likely heuristic (e.g., "Visibility Bias") or "None Detected".`;
             const inferenceUserPrompt = "Identify the most likely novice heuristic used in the plan above.";

             const inferenceResult = await callLLM(inferenceSystemPrompt, inferenceUserPrompt);
             let inferredHeuristicName = "None Detected"; // Default

             if (!inferenceResult.error) {
                 // Attempt to parse the heuristic name (LLM might add extra text)
                 const lines = inferenceResult.text.split('\n');
                 const foundHeuristic = noviceHeuristics.find(h => lines[0].includes(h.name));
                 if (foundHeuristic) {
                     inferredHeuristicName = foundHeuristic.name;
                 } else if (!lines[0].includes("None Detected")){
                    // If LLM gave a plausible name not exactly matching, try to find closest match (basic check)
                    const lowerResponse = lines[0].toLowerCase();
                    if(lowerResponse.includes("visibility") || lowerResponse.includes("salience")) inferredHeuristicName = "Visibility/Salience Bias";
                    else if(lowerResponse.includes("curtailment")) inferredHeuristicName = "Curtailment Bias";
                    else if(lowerResponse.includes("heating") || lowerResponse.includes("cooling") || lowerResponse.includes("hvac")) inferredHeuristicName = "Heating/Cooling Function Neglect";
                    // Add other fuzzy matches if needed
                 }
                 console.log("Inferred Heuristic:", inferredHeuristicName); // For debugging
             } else {
                 console.error("Error inferring heuristic:", inferenceResult.error);
                 // Proceed with default feedback on error
             }


             // --- Step 2: Generate Targeted Feedback ---
             loadingIndicator.textContent = 'Generating Feedback...';
             let feedbackSystemPrompt = '';
             let targetHeuristicDesc = "general energy saving principles"; // Default
             if (inferredHeuristicName !== "None Detected") {
                 const heuristic = noviceHeuristics.find(h => h.name === inferredHeuristicName);
                 targetHeuristicDesc = `the specific heuristic: ${heuristic.name} (${heuristic.description})`;
                 feedbackSystemPrompt = `You are an AI energy advisor. The user wrote a plan, and another analysis suggested they might be relying on ${targetHeuristicDesc}. Generate feedback for their plan. First, gently explain this common bias (without being accusatory, e.g., "Many people focus on...") and why it can be misleading. Then, provide specific, constructive suggestions on how to improve their plan to meet the ${savingsGoal.value}% savings goal, potentially by counteracting that bias. Reference their household profile. Be supportive. Household Profile: ${currentProfile.description}. Goal: Reduce costs by ${savingsGoal.value}%. Key Action Examples:\n${actionDbSummary}`;
             } else {
                 // If no heuristic detected, fall back to generic expert feedback logic
                  feedbackSystemPrompt = `You are an AI energy advisor. Provide generic expert feedback on the user's draft plan below, considering the goal of saving ${savingsGoal.value}%. Focus on general principles like prioritizing major energy users (heating, cooling, water heating) and considering efficiency improvements. No specific heuristic was detected. Household Profile: ${currentProfile.description}. Goal: Reduce costs by ${savingsGoal.value}%. Key Action Examples:\n${actionDbSummary}`;
             }

             const feedbackUserPrompt = `My Draft Plan:\n${draftPlanJust}\n\nProvide feedback ${inferredHeuristicName !== "None Detected" ? `specifically addressing the likely reliance on ${inferredHeuristicName}` : 'based on general expert principles'}.`;
             const feedbackResult = await callLLM(feedbackSystemPrompt, feedbackUserPrompt);

              loadingIndicator.style.display = 'none';
             if (feedbackResult.error) {
                 feedbackText = `Error generating feedback: ${feedbackResult.error}`;
                 feedbackTextEl.style.color = 'red';
             } else {
                 feedbackText = `[Demo Note: Targeted feedback based on inferred heuristic: '${inferredHeuristicName}']\n\n` + feedbackResult.text;
                 feedbackTextEl.style.color = 'black';
             }
             feedbackTextEl.textContent = feedbackText;
             document.getElementById('task2-revision').value = draftPlanJust; // Pre-fill
        }
         // Keep button disabled after attempt
    }


    // --- General Functions ---
    function submitPlan(taskPrefix) {
        let planData;
        let outputElId;

        switch(taskPrefix) {
            case 'task1-control':
                planData = document.getElementById('task1-control-plan').value;
                outputElId = 'task-output';
                break;
            case 'task1-generator':
                planData = document.getElementById('task1-generator-plan').value;
                 outputElId = 'task-output';
                break;
            case 'task1-critic':
                planData = document.getElementById('task1-critic-revision').value;
                 outputElId = 'task-output';
                break;
            case 'task1-collaborator':
                planData = document.getElementById('task1-collaborator-finalplan').value;
                 outputElId = 'task-output';
                break;
            case 'task2':
                 planData = document.getElementById('task2-revision').value;
                 outputElId = 'task2-output';
                 break;
             default:
                console.error("Unknown task prefix for submit:", taskPrefix);
                return;
        }


        if (planData && planData.trim()) {
            console.log(`--- ${taskPrefix} Final Plan Submitted ---`);
            console.log(planData);
            const outputEl = document.getElementById(outputElId);
            if(outputEl) {
                 outputEl.textContent = `Plan submitted successfully for ${taskPrefix}! (Check browser console for plan text)`;
                 outputEl.style.display = 'block'; // Show output box
            }
             alert(`Plan submitted for ${taskPrefix}! (See browser console for plan text). In a real experiment, data would be saved and participant would proceed.`);

        } else {
            alert("Please ensure your final plan is entered before submitting.");
        }
    }

    function showActionDatabase() {
         document.getElementById('action-db-popup').style.display = 'block';
    }

    function hideActionDatabase() {
         document.getElementById('action-db-popup').style.display = 'none';
    }

    // --- Initialization ---
    function initDemo() {
        // Set initial active tab
        openTab('tab-task1');
         // Add listener to condition dropdowns to reload demo when changed
        document.getElementById('task1-condition').addEventListener('change', loadTask1Demo);
        document.getElementById('task2-condition').addEventListener('change', loadTask2Demo);
         // Initial check for API key status
         const statusEl = document.getElementById('api-status');
         if (!apiKey || apiKey.trim() === '') {
             statusEl.textContent = 'API Key Not Set';
             statusEl.style.color = 'red';
         } else {
            statusEl.textContent = `API Key Set for ${apiProvider === 'openai' ? 'OpenAI' : 'Gemini'}`;
             statusEl.style.color = 'green';
         }
    }

    // Run initialization when the page loads
    window.onload = initDemo;

</script>
</body>
</html>