<!-- Revised Code with Aesthetic and Error-Prevention Updates -->

<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Security-Policy" content="default-src 'self' 'unsafe-inline' 'unsafe-eval' data: blob: https://cdnjs.cloudflare.com https://cdn.jsdelivr.net https://code.jquery.com https://unpkg.com https://d3js.org https://threejs.org https://cdn.plot.ly https://stackpath.bootstrapcdn.com https://maps.googleapis.com https://cdn.tailwindcss.com https://ajax.googleapis.com https://kit.fontawesome.com https://cdn.datatables.net https://maxcdn.bootstrapcdn.com https://code.highcharts.com https://tako-static-assets-production.s3.amazonaws.com https://www.youtube.com https://fonts.googleapis.com https://fonts.gstatic.com https://pfst.cf2.poecdn.net https://puc.poecdn.net https://i.imgur.com https://wikimedia.org https://*.icons8.com https://*.giphy.com https://picsum.photos https://images.unsplash.com; frame-src 'self' https://www.youtube.com https://trytako.com; child-src 'self'; manifest-src 'self'; worker-src 'self'; upgrade-insecure-requests; block-all-mixed-content;">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cognitive Science Simulation: Perception Biases</title>
    <style>
        /* --------------------------------------------------
           GLOBAL STYLES
        -------------------------------------------------- */
        * {
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }
        body {
            margin: 0;
            padding: 0;
            background-color: #fafafa;
            color: #333;
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            background-color: #264653;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 5px 5px 0 0;
        }
        .tabs {
            display: flex;
            background-color: #2a9d8f;
            overflow: hidden;
            border-radius: 0 0 5px 5px;
            flex-wrap: wrap;
        }
        .tab {
            background-color: #2a9d8f;
            color: white;
            border: none;
            outline: none;
            cursor: pointer;
            padding: 15px 20px;
            flex-grow: 1;
            transition: 0.3s;
            font-size: 16px;
            border-bottom: 3px solid transparent;
            text-align: center;
        }
        .tab:hover {
            background-color: #21867a;
        }
        .tab.active {
            background-color: #21867a;
            border-bottom: 3px solid #e9c46a;
        }
        .tab-content {
            display: none;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 0 0 5px 5px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .tab-content.active {
            display: block;
        }
        .slider-container {
            margin: 20px 0;
        }
        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        .slider {
            width: 100%;
            margin: 10px 0;
        }
        .visualization {
            width: 100%;
            height: 400px;
            background-color: #f9f9f9;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin: 20px 0;
            position: relative;
            overflow: hidden;
        }
        .explanation {
            background-color: #f7f7f7;
            border-left: 4px solid #e9c46a;
            padding: 15px;
            margin: 20px 0;
            border-radius: 0 5px 5px 0;
        }
        .flex-container {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
        }
        .flex-item {
            flex: 1;
            min-width: 300px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        table, th, td {
            border: 1px solid #ddd;
        }
        th, td {
            text-align: left;
            padding: 12px;
        }
        th {
            background-color: #f2f2f2;
        }
        .tooltip {
            position: absolute;
            background-color: rgba(0,0,0,0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            pointer-events: none;
            z-index: 100;
            display: none;
        }
        .chart-legend {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .legend-color {
            width: 15px;
            height: 15px;
            border-radius: 3px;
        }
        .paper-summary {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #2a9d8f;
        }
        @media screen and (max-width: 768px) {
            .flex-container {
                flex-direction: column;
            }
            .flex-item {
                width: 100%;
            }
            .tab {
                flex: 1 0 50%;
            }
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>Cognitive Science Simulation</h1>
        <p>Exploring Perception Biases in Energy Use and AI Knowledge</p>
    </div>

    <!-- TABS -->
    <div class="tabs">
        <button class="tab active" onclick="openTab('overview')">Overview</button>
        <button class="tab" onclick="openTab('attari')">Energy Perception (Attari)</button>
        <button class="tab" onclick="openTab('steyvers')">AI Confidence (Steyvers)</button>
        <button class="tab" onclick="openTab('combined')">Combined Simulation</button>
        <button class="tab" onclick="openTab('background-methods')">Methods</button>
        <button class="tab" onclick="openTab('background-implications')">Implications</button>
    </div>

    <!-- OVERVIEW TAB -->
    <div id="overview" class="tab-content active">
        <h2>Overview: Perception Biases in Human Cognition</h2>
        <div class="paper-summary">
            <h3>Attari et al. (2010): Public Perceptions of Energy Consumption</h3>
            <p>This foundational study (Attari et al., 2010) demonstrated systematic misperception in energy use. In particular:</p>
            <ul>
                <li>People underestimate high-consumption appliances (e.g., central AC) by ~2.8×</li>
                <li>People overestimate lower-consumption devices (light bulbs, etc.)</li>
                <li>People focus on less effective curtailment actions rather than more impactful efficiency improvements</li>
            </ul>
        </div>
        <div class="paper-summary">
            <h3>Steyvers et al. (2025): LLM Confidence and Human Perception</h3>
            <p>Steyvers et al. (2025) investigated how large language models (LLMs) communicate confidence, and how humans then interpret that confidence. Key insights include:</p>
            <ul>
                <li>A persistent calibration gap between LLMs’ internal confidence and human perception</li>
                <li>Overestimation of LLM accuracy by users, especially with “long” or “very confident” explanations</li>
                <li>Individual differences in numeracy and expertise also predict calibration accuracy</li>
            </ul>
        </div>
        <div class="explanation">
            <h3>Cognitive Connections</h3>
            <p>Both studies reveal cognitive biases in human judgment:</p>
            <ul>
                <li><strong>Compression of True Distributions:</strong> Flattening the slope in both energy and AI‐confidence domains</li>
                <li><strong>Anchoring & Adjustment:</strong> Overreliance on initial reference points</li>
                <li><strong>Numeracy & Expertise Effects:</strong> More knowledgeable individuals display smaller biases but do not entirely avoid them</li>
            </ul>
        </div>
    </div>

    <!-- ATTARI TAB (ENERGY PERCEPTION) -->
    <div id="attari" class="tab-content">
        <h2>Energy Perception Biases (Attari et al., 2010)</h2>
        <div class="flex-container">
            <div class="flex-item">
                <h3>The Compression Effect</h3>
                <p>Attari et al. (2010) showed that the slope between perceived and actual energy use is just ~0.28, compared to a perfect slope of 1.0.</p>
                <div class="slider-container">
                    <h4>Simulation Parameters</h4>
                    <div class="slider-label">
                        <span>Compression Factor:</span>
                        <span id="compression-value">2.8</span>
                    </div>
                    <input type="range" min="1" max="5" step="0.1" value="2.8" class="slider" id="compression-slider" oninput="updateAttariSimulation()">
                    <p><small>High value = greater underestimation of large usage</small></p>
                    <div class="slider-label">
                        <span>Perception Slope:</span>
                        <span id="slope-value">0.28</span>
                    </div>
                    <input type="range" min="0.1" max="1" step="0.01" value="0.28" class="slider" id="slope-slider" oninput="updateAttariSimulation()">
                    <p><small>1.0 = perfect accuracy</small></p>
                    <div class="slider-label">
                        <span>Numeracy Level:</span>
                        <span id="numeracy-value">Average</span>
                    </div>
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="numeracy-slider" oninput="updateAttariSimulation()">
                    <p><small>Higher numeracy → more accurate estimates</small></p>
                </div>
            </div>
            <div class="flex-item">
                <h3>Energy Perception Visualization</h3>
                <div class="visualization" id="energy-perception-chart"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Perfect Accuracy</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Perceived Energy</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-container">
            <div class="flex-item">
                <h3>Curtailment vs. Efficiency</h3>
                <div class="visualization" id="curtailment-efficiency-chart"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Actual Energy</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Perceived Energy</span>
                    </div>
                </div>
            </div>
            <div class="flex-item">
                <h3>Energy Perception Data</h3>
                <table id="energy-perception-table">
                    <tr>
                        <th>Energy Activity</th>
                        <th>Actual (Wh)</th>
                        <th>Perceived (Wh)</th>
                        <th>Ratio (P/A)</th>
                    </tr>
                </table>
            </div>
        </div>
    </div>

    <!-- STEYVERS TAB (AI CONFIDENCE) -->
    <div id="steyvers" class="tab-content">
        <h2>AI Confidence Calibration (Steyvers et al., 2025)</h2>
        <div class="flex-container">
            <div class="flex-item">
                <h3>Calibration Gap</h3>
                <p>Steyvers et al. (2025) highlight how an LLM’s reported confidence can mislead human perceptions. Adjust the sliders to simulate these effects:</p>
                <div class="slider-container">
                    <h4>Simulation Parameters</h4>
                    <div class="slider-label">
                        <span>Explanation Style:</span>
                        <span id="explanation-style-value">Moderately Confident</span>
                    </div>
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="explanation-style-slider" oninput="updateSteyversSimulation()">
                    <p><small>1=Uncertain, 2=Moderate, 3=Very Confident</small></p>
                    <div class="slider-label">
                        <span>Explanation Length:</span>
                        <span id="explanation-length-value">Medium</span>
                    </div>
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="explanation-length-slider" oninput="updateSteyversSimulation()">
                    <p><small>Short, Medium, or Long LLM Explanations</small></p>
                    <div class="slider-label">
                        <span>Model Accuracy:</span>
                        <span id="model-accuracy-value">70%</span>
                    </div>
                    <input type="range" min="50" max="90" step="5" value="70" class="slider" id="model-accuracy-slider" oninput="updateSteyversSimulation()">
                    <p><small>Higher = more correct answers overall</small></p>
                </div>
            </div>
            <div class="flex-item">
                <h3>AI Calibration Chart</h3>
                <div class="visualization" id="ai-calibration-chart"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Perfect Calibration</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Model Confidence</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span>Human Perception</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-container">
            <div class="flex-item">
                <h3>Example AI Explanations</h3>
                <div class="visualization" id="ai-explanation-examples" style="background-color: #ffffff;">
                    <div style="padding: 20px;">
                        <h4>Question:</h4>
                        <div id="question-text" style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-bottom: 10px;"></div>
                        <h4>LLM Answer:</h4>
                        <div id="llm-answer" style="background-color: #f1f1f1; padding: 15px; border-radius: 5px; margin-bottom: 10px;"></div>
                        <h4>Metrics:</h4>
                        <ul>
                            <li>Model’s Internal Confidence: <span id="model-confidence-value">70%</span></li>
                            <li>Human-Perceived Confidence: <span id="human-confidence-value">85%</span></li>
                            <li>Calibration Gap: <span id="calibration-gap-value">15%</span></li>
                            <li>Correct Answer? <span id="is-correct">Yes</span></li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="flex-item">
                <h3>Discrimination Ability</h3>
                <p>The ability to discern correct from incorrect AI answers. A higher AUC indicates better discrimination.</p>
                <div class="visualization" id="discrimination-chart"></div>
                <p><small>0.5 = random guessing, 1.0 = perfect discrimination</small></p>
            </div>
        </div>
    </div>

    <!-- COMBINED TAB -->
    <div id="combined" class="tab-content">
        <h2>Combined Simulation: Parallels Across Domains</h2>
        <div class="explanation">
            <h3>Integration of Attari & Steyvers</h3>
            <p>Adjust parameters to see how cognitive biases span energy perception (Attari et al., 2010) and AI confidence calibration (Steyvers et al., 2025). The same bias—compression—can appear in different guises.</p>
        </div>
        <div class="flex-container">
            <div class="flex-item">
                <h3>Parameters</h3>
                <div class="slider-container">
                    <div class="slider-label">
                        <span>Compression Factor:</span>
                        <span id="combined-compression-value">2.8</span>
                    </div>
                    <input type="range" min="1" max="5" step="0.1" value="2.8" class="slider" id="combined-compression-slider" oninput="updateCombinedSimulation()">
                    <p><small>Higher = more severe compression bias</small></p>
                    <div class="slider-label">
                        <span>Explanation Style:</span>
                        <span id="combined-explanation-style-value">Moderately Confident</span>
                    </div>
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="combined-explanation-style-slider" oninput="updateCombinedSimulation()">
                    <p><small>1=Uncertain, 2=Moderate, 3=Very Confident</small></p>
                    <div class="slider-label">
                        <span>User Expertise:</span>
                        <span id="combined-expertise-value">Average</span>
                    </div>
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="combined-expertise-slider" oninput="updateCombinedSimulation()">
                    <p><small>Higher = better numerical & domain skills</small></p>
                    <div class="slider-label">
                        <span>Domain Complexity:</span>
                        <span id="combined-complexity-value">Medium</span>
                    </div>
                    <input type="range" min="1" max="3" step="1" value="2" class="slider" id="combined-complexity-slider" oninput="updateCombinedSimulation()">
                    <p><small>Low, Medium, or High complexity domain</small></p>
                </div>
            </div>
            <div class="flex-item">
                <h3>Cross-Domain Visualization</h3>
                <div class="visualization" id="combined-chart"></div>
                <div class="chart-legend">
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #3498db;"></div>
                        <span>Perfect Accuracy</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #e74c3c;"></div>
                        <span>Energy Domain</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color" style="background-color: #2ecc71;"></div>
                        <span>AI Confidence Domain</span>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex-container">
            <div class="flex-item">
                <h3>Integrated Results</h3>
                <div class="visualization" id="integrated-results-chart"></div>
            </div>
            <div class="flex-item">
                <h3>Shared Cognitive Mechanisms</h3>
                <p>Similar biases emerge from anchoring and the compression of true distributions. Expertise can mitigate (but not fully eliminate) these distortions.</p>
            </div>
        </div>
    </div>

    <!-- METHODS TAB -->
    <div id="background-methods" class="tab-content">
        <h2>Study Methods and Approaches</h2>
        <!-- Summaries of Attari et al. (2010) and Steyvers et al. (2025) methods go here -->
        <p>Refer to Attari et al. (2010) and Steyvers et al. (2025) for detailed procedures on surveys, confidence assessments, and statistical modeling.</p>
    </div>

    <!-- IMPLICATIONS TAB -->
    <div id="background-implications" class="tab-content">
        <h2>Implications for Theory and Practice</h2>
        <!-- Summaries of policy and design implications -->
        <p>Both lines of research suggest that user education, improved design of feedback (for energy or AI explanations), and better calibration messaging can mitigate biases (Attari et al., 2010; Steyvers et al., 2025).</p>
    </div>
</div>

<script>
// -----------------------------------------------------
// DATA
// -----------------------------------------------------
const energyItems = [
    { name: "Central Air Conditioner (1 hour)", actual: 3500, type: "Device" },
    { name: "Clothes Dryer (1 hour)", actual: 3000, type: "Device" },
    { name: "Washing Machine (hot water)", actual: 900, type: "Device" },
    { name: "Dishwasher (hot water)", actual: 700, type: "Device" },
    { name: "Desktop Computer (1 hour)", actual: 100, type: "Device" },
    { name: "Laptop Computer (1 hour)", actual: 35, type: "Device" },
    { name: "Stereo (1 hour)", actual: 30, type: "Device" },
    { name: "Light Bulb 100W (1 hour)", actual: 100, type: "Device" },
    { name: "Light Bulb 75W (1 hour)", actual: 75, type: "Device" },
    { name: "Light Bulb CFL (1 hour)", actual: 25, type: "Device" }
];
const conservationActions = [
    { name: "Turn off lights", type: "Curtailment", actual: 100, mentions: 19.6 },
    { name: "Drive less/use public transit", type: "Curtailment", actual: 1800, mentions: 12.9 },
    { name: "Change thermostat settings", type: "Curtailment", actual: 300, mentions: 6.3 },
    { name: "Unplug appliances", type: "Curtailment", actual: 50, mentions: 5.7 },
    { name: "Use appliances less", type: "Curtailment", actual: 250, mentions: 4.9 },
    { name: "Use efficient light bulbs", type: "Efficiency", actual: 75, mentions: 3.6 },
    { name: "Use efficient appliances", type: "Efficiency", actual: 500, mentions: 3.2 },
    { name: "Drive efficient cars/hybrids", type: "Efficiency", actual: 1500, mentions: 2.8 },
    { name: "Insulate home", type: "Efficiency", actual: 1200, mentions: 2.1 }
];
const llmExamples = [
    {
        question: "What is the capital of Australia?",
        answer: "The capital of Australia is Canberra.",
        modelConfidence: { low: 0.89, medium: 0.89, high: 0.89 },
        humanConfidence: { low: 0.70, medium: 0.85, high: 0.95 },
        correct: true,
        explanations: {
            low: "I believe the capital of Australia is Canberra, though I'm not entirely certain.",
            medium: "The capital of Australia is Canberra. It's a planned city built as a compromise between Sydney and Melbourne.",
            high: "The capital of Australia is definitely Canberra. This is a well-established fact."
        }
    },
    {
        question: "Who wrote the novel 'Brave New World'?",
        answer: "Aldous Huxley wrote 'Brave New World'.",
        modelConfidence: { low: 0.92, medium: 0.92, high: 0.92 },
        humanConfidence: { low: 0.75, medium: 0.88, high: 0.97 },
        correct: true,
        explanations: {
            low: "I think Aldous Huxley wrote 'Brave New World', though I'm not completely sure.",
            medium: "Aldous Huxley wrote 'Brave New World'. It's a classic dystopian novel published in 1932.",
            high: "Aldous Huxley is definitely the author of 'Brave New World'."
        }
    },
    {
        question: "What is the largest moon in our solar system?",
        answer: "Jupiter's moon Ganymede is the largest moon in our solar system.",
        modelConfidence: { low: 0.76, medium: 0.76, high: 0.76 },
        humanConfidence: { low: 0.60, medium: 0.80, high: 0.92 },
        correct: true,
        explanations: {
            low: "I believe Ganymede is the largest, but I'm not entirely certain.",
            medium: "The largest moon is Ganymede, which orbits Jupiter, larger than Mercury.",
            high: "Ganymede is definitely the largest moon in the solar system, larger than Mercury."
        }
    },
    {
        question: "What causes the Aurora Borealis?",
        answer: "The Aurora Borealis is caused by solar particles interacting with Earth's magnetosphere.",
        modelConfidence: { low: 0.65, medium: 0.65, high: 0.65 },
        humanConfidence: { low: 0.55, medium: 0.75, high: 0.90 },
        correct: false, // intentionally mismatched
        explanations: {
            low: "I'm not entirely sure, but I think it's solar particles hitting Earth’s atmosphere.",
            medium: "Aurora Borealis arises from solar particles interacting with atmospheric atoms.",
            high: "The Aurora Borealis is definitely solar wind interacting with Earth's magnetosphere."
        }
    }
];

// -----------------------------------------------------
// TAB HANDLING
// -----------------------------------------------------
function openTab(tabName) {
    const tabContents = document.getElementsByClassName('tab-content');
    for (let i = 0; i < tabContents.length; i++) {
        tabContents[i].classList.remove('active');
    }
    const tabs = document.getElementsByClassName('tab');
    for (let i = 0; i < tabs.length; i++) {
        tabs[i].classList.remove('active');
    }
    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');

    if (tabName === 'attari') updateAttariSimulation();
    if (tabName === 'steyvers') updateSteyversSimulation();
    if (tabName === 'combined') updateCombinedSimulation();
}

// -----------------------------------------------------
// ATTARI SIMULATION
// -----------------------------------------------------
function updateAttariSimulation() {
    const compressionFactor = parseFloat(document.getElementById('compression-slider').value);
    document.getElementById('compression-value').textContent = compressionFactor.toFixed(1);
    const perceptionSlope = parseFloat(document.getElementById('slope-slider').value);
    document.getElementById('slope-value').textContent = perceptionSlope.toFixed(2);
    const numeracyLevel = parseInt(document.getElementById('numeracy-slider').value);
    const numeracyLabels = ['Low', 'Average', 'High'];
    document.getElementById('numeracy-value').textContent = numeracyLabels[numeracyLevel - 1];

    // Adjust slope for numeracy
    let adjustedSlope = perceptionSlope;
    if (numeracyLevel === 1) adjustedSlope *= 0.8;
    if (numeracyLevel === 3) adjustedSlope *= 1.2;

    // Compute perceived energy
    const energyData = energyItems.map(item => {
        const logActual = Math.log10(item.actual);
        const meanLog = 2.3; // typical mean
        const logPerceived = meanLog + adjustedSlope * (logActual - meanLog);
        const perceived = Math.pow(10, logPerceived);

        return {
            name: item.name,
            actual: item.actual,
            perceived: Math.round(perceived),
            ratio: (perceived / item.actual).toFixed(2)
        };
    });

    // Update table
    const table = document.getElementById('energy-perception-table');
    table.innerHTML = `
        <tr>
            <th>Energy Activity</th>
            <th>Actual (Wh)</th>
            <th>Perceived (Wh)</th>
            <th>Ratio (P/A)</th>
        </tr>`;
    energyData.forEach(item => {
        const row = table.insertRow();
        row.insertCell(0).textContent = item.name;
        row.insertCell(1).textContent = item.actual;
        row.insertCell(2).textContent = item.perceived;
        row.insertCell(3).textContent = item.ratio;
    });

    updateEnergyPerceptionChart(energyData);
    updateCurtailmentEfficiencyChart(conservationActions, adjustedSlope, compressionFactor);
}

// Safely compute chart dimensions
function getChartDimensions(chart) {
    const margin = { top: 40, right: 40, bottom: 60, left: 60 };
    const rawWidth = chart.clientWidth;
    const rawHeight = chart.clientHeight;
    // Ensure we never produce negative
    const width = Math.max(200, rawWidth - margin.left - margin.right);
    const height = Math.max(200, rawHeight - margin.top - margin.bottom);
    return { margin, width, height };
}

function updateEnergyPerceptionChart(data) {
    const chart = document.getElementById('energy-perception-chart');
    chart.innerHTML = '';
    data.sort((a, b) => a.actual - b.actual);

    const { margin, width, height } = getChartDimensions(chart);

    // Create SVG
    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', chart.clientWidth);
    svg.setAttribute('height', chart.clientHeight);
    // viewBox ensures consistent scaling
    svg.setAttribute('viewBox', `0 0 ${chart.clientWidth} ${chart.clientHeight}`);
    chart.appendChild(svg);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
    svg.appendChild(g);

    const xMax = Math.max(...data.map(d => d.actual));
    const yMax = Math.max(xMax, ...data.map(d => d.perceived)); // ensure top axis covers perceived or actual

    // log scales
    const xScale = v => {
        // clamp to avoid negative if v < 1
        const val = Math.max(1, v);
        return (Math.log10(val) / Math.log10(xMax)) * width;
    };
    const yScale = v => {
        const val = Math.max(1, v);
        return height - (Math.log10(val) / Math.log10(yMax)) * height;
    };

    // Axes
    // X-axis
    const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxisLine.setAttribute('x1', 0);
    xAxisLine.setAttribute('y1', height);
    xAxisLine.setAttribute('x2', width);
    xAxisLine.setAttribute('y2', height);
    xAxisLine.setAttribute('stroke', 'black');
    g.appendChild(xAxisLine);

    const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    xLabel.setAttribute('x', width / 2);
    xLabel.setAttribute('y', height + 40);
    xLabel.setAttribute('text-anchor', 'middle');
    xLabel.textContent = 'Actual Energy (Wh) - Log Scale';
    g.appendChild(xLabel);

    // Y-axis
    const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxisLine.setAttribute('x1', 0);
    yAxisLine.setAttribute('y1', 0);
    yAxisLine.setAttribute('x2', 0);
    yAxisLine.setAttribute('y2', height);
    yAxisLine.setAttribute('stroke', 'black');
    g.appendChild(yAxisLine);

    const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yLabel.setAttribute('x', -height / 2);
    yLabel.setAttribute('y', -40);
    yLabel.setAttribute('text-anchor', 'middle');
    yLabel.setAttribute('transform', 'rotate(-90)');
    yLabel.textContent = 'Perceived Energy (Wh) - Log Scale';
    g.appendChild(yLabel);

    // Perfect accuracy (diagonal dashed)
    const perfectLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    perfectLine.setAttribute('x1', 0);
    perfectLine.setAttribute('y1', height);
    perfectLine.setAttribute('x2', width);
    perfectLine.setAttribute('y2', 0);
    perfectLine.setAttribute('stroke', '#3498db');
    perfectLine.setAttribute('stroke-width', 2);
    perfectLine.setAttribute('stroke-dasharray', '5,5');
    g.appendChild(perfectLine);

    // Points
    data.forEach(d => {
        const cx = xScale(d.actual);
        const cy = yScale(d.perceived);

        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', cx);
        circle.setAttribute('cy', cy);
        circle.setAttribute('r', 6);
        circle.setAttribute('fill', '#e74c3c');
        g.appendChild(circle);

        circle.addEventListener('mouseover', e => {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `<strong>${d.name}</strong><br>
                                 Actual: ${d.actual} Wh<br>
                                 Perceived: ${d.perceived} Wh<br>
                                 Ratio: ${d.ratio}`;
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY + 10) + 'px';
            tooltip.style.display = 'block';
            document.body.appendChild(tooltip);
        });
        circle.addEventListener('mousemove', e => {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) {
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
            }
        });
        circle.addEventListener('mouseout', () => {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) tooltip.remove();
        });
    });

    // Title
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', width / 2);
    title.setAttribute('y', -10);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'Perceived vs. Actual Energy Consumption';
    g.appendChild(title);
}

function updateCurtailmentEfficiencyChart(data, slope, compressionFactor) {
    const chart = document.getElementById('curtailment-efficiency-chart');
    chart.innerHTML = '';
    data.sort((a, b) => b.actual - a.actual);

    const { margin, width, height } = getChartDimensions(chart);

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', chart.clientWidth);
    svg.setAttribute('height', chart.clientHeight);
    svg.setAttribute('viewBox', `0 0 ${chart.clientWidth} ${chart.clientHeight}`);
    chart.appendChild(svg);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
    svg.appendChild(g);

    // Compute perceived
    const perceivedData = data.map(d => {
        const logA = Math.log10(d.actual);
        const meanLogA = 2.5;
        const logP = meanLogA + slope * (logA - meanLogA);
        const perceived = Math.pow(10, logP);
        return { ...d, perceived: Math.round(perceived) };
    });

    const maxActual = Math.max(...data.map(d => d.actual));
    const maxPerceived = Math.max(...perceivedData.map(d => d.perceived));
    const maxValue = Math.max(maxActual, maxPerceived);

    const barCount = data.length;
    const barHeight = (height / barCount) * 0.6;
    const barGap = (height / barCount) * 0.4;

    // X scale
    const xScale = v => (v / maxValue) * width;

    // Y pos
    const yPos = i => i * (barHeight + barGap);

    // Y-axis category lines
    perceivedData.forEach((d, i) => {
        const baseY = yPos(i);
        // Horizontal grid line
        const gridLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        gridLine.setAttribute('x1', 0);
        gridLine.setAttribute('y1', baseY);
        gridLine.setAttribute('x2', width);
        gridLine.setAttribute('y2', baseY);
        gridLine.setAttribute('stroke', '#eee');
        g.appendChild(gridLine);

        // Label
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', -10);
        label.setAttribute('y', baseY + barHeight * 0.75);
        label.setAttribute('text-anchor', 'end');
        label.textContent = d.name;
        if (d.type === 'Curtailment') label.setAttribute('fill', '#e74c3c');
        else label.setAttribute('fill', '#3498db');
        g.appendChild(label);
    });

    // X-axis
    const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxisLine.setAttribute('x1', 0);
    xAxisLine.setAttribute('y1', height);
    xAxisLine.setAttribute('x2', width);
    xAxisLine.setAttribute('y2', height);
    xAxisLine.setAttribute('stroke', 'black');
    g.appendChild(xAxisLine);

    const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    xLabel.setAttribute('x', width / 2);
    xLabel.setAttribute('y', height + 40);
    xLabel.setAttribute('text-anchor', 'middle');
    xLabel.textContent = 'Energy Savings (Wh)';
    g.appendChild(xLabel);

    // Draw bars
    perceivedData.forEach((d, i) => {
        const baseY = yPos(i);

        // Actual bar
        const actualW = xScale(d.actual);
        const actualBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        actualBar.setAttribute('x', 0);
        actualBar.setAttribute('y', baseY);
        actualBar.setAttribute('width', Math.max(0, actualW));
        actualBar.setAttribute('height', barHeight * 0.5);
        actualBar.setAttribute('fill', '#3498db');
        g.appendChild(actualBar);

        // Perceived bar
        const perceivedW = xScale(d.perceived);
        const perceivedBar = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        perceivedBar.setAttribute('x', 0);
        perceivedBar.setAttribute('y', baseY + barHeight * 0.5);
        perceivedBar.setAttribute('width', Math.max(0, perceivedW));
        perceivedBar.setAttribute('height', barHeight * 0.5);
        perceivedBar.setAttribute('fill', '#e74c3c');
        g.appendChild(perceivedBar);

        // Value labels
        const actualText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        actualText.setAttribute('x', actualW + 5);
        actualText.setAttribute('y', baseY + barHeight * 0.3);
        actualText.textContent = d.actual;
        g.appendChild(actualText);

        const perceivedText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        perceivedText.setAttribute('x', perceivedW + 5);
        perceivedText.setAttribute('y', baseY + barHeight * 0.8);
        perceivedText.textContent = d.perceived;
        g.appendChild(perceivedText);

        // Tooltip
        [actualBar, perceivedBar].forEach(bar => {
            bar.addEventListener('mouseover', e => {
                const tooltip = document.createElement('div');
                tooltip.className = 'tooltip';
                tooltip.innerHTML = `
                  <strong>${d.name} (${d.type})</strong><br>
                  Actual: ${d.actual} Wh<br>
                  Perceived: ${d.perceived} Wh<br>
                  Mentioned by ${d.mentions}% of participants
                `;
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
                tooltip.style.display = 'block';
                document.body.appendChild(tooltip);
            });
            bar.addEventListener('mousemove', e => {
                const tooltip = document.querySelector('.tooltip');
                if (tooltip) {
                    tooltip.style.left = (e.pageX + 10) + 'px';
                    tooltip.style.top = (e.pageY + 10) + 'px';
                }
            });
            bar.addEventListener('mouseout', () => {
                const tooltip = document.querySelector('.tooltip');
                if (tooltip) tooltip.remove();
            });
        });
    });

    // Title
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', width / 2);
    title.setAttribute('y', -10);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'Actual vs. Perceived Energy Savings by Action Type';
    g.appendChild(title);
}

// -----------------------------------------------------
// STEYVERS SIMULATION
// -----------------------------------------------------
function updateSteyversSimulation() {
    const styleVal = parseInt(document.getElementById('explanation-style-slider').value);
    const styleLabels = ['Uncertain','Moderately Confident','Very Confident'];
    document.getElementById('explanation-style-value').textContent = styleLabels[styleVal - 1];

    const lengthVal = parseInt(document.getElementById('explanation-length-slider').value);
    const lengthLabels = ['Short','Medium','Long'];
    document.getElementById('explanation-length-value').textContent = lengthLabels[lengthVal - 1];

    const accuracyVal = parseInt(document.getElementById('model-accuracy-slider').value);
    document.getElementById('model-accuracy-value').textContent = accuracyVal + '%';

    updateAICalibrationChart(styleVal, lengthVal, accuracyVal);
    updateDiscriminationChart(styleVal, lengthVal, accuracyVal);
    updateAIExampleExplanation(styleVal, lengthVal);
}

function updateAICalibrationChart(styleVal, lengthVal, accuracyVal) {
    const chart = document.getElementById('ai-calibration-chart');
    chart.innerHTML = '';
    const { margin, width, height } = getChartDimensions(chart);

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', chart.clientWidth);
    svg.setAttribute('height', chart.clientHeight);
    svg.setAttribute('viewBox', `0 0 ${chart.clientWidth} ${chart.clientHeight}`);
    chart.appendChild(svg);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
    svg.appendChild(g);

    // Generate bins
    const bins = [0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0];

    // Model line
    const modelValues = bins.map(bin => {
        const variation = (Math.random() * 0.1) - 0.05;
        return {
            confidence: bin,
            accuracy: Math.min(1, Math.max(0, bin + variation))
        };
    });

    // Human line
    const humanValues = bins.map(bin => {
        let perceived = bin;
        // Explanation style
        if (styleVal === 3) perceived += 0.15; // Very conf => overshoot
        if (styleVal === 1) perceived -= 0.1;  // uncertain => undershoot
        // Explanation length
        if (lengthVal === 3) perceived += 0.1;
        if (lengthVal === 1) perceived -= 0.05;
        // Model accuracy effect
        const accEffect = (accuracyVal - 70)/100;
        perceived += accEffect;
        perceived = Math.min(1, Math.max(0, perceived));
        return { confidence: bin, accuracy: perceived };
    });

    const xScale = d => d * width;
    const yScale = d => height - d * height;

    // Axes
    const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxisLine.setAttribute('x1', 0);
    xAxisLine.setAttribute('y1', height);
    xAxisLine.setAttribute('x2', width);
    xAxisLine.setAttribute('y2', height);
    xAxisLine.setAttribute('stroke', 'black');
    g.appendChild(xAxisLine);

    const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    xLabel.setAttribute('x', width / 2);
    xLabel.setAttribute('y', height + 40);
    xLabel.setAttribute('text-anchor', 'middle');
    xLabel.textContent = 'Confidence';
    g.appendChild(xLabel);

    const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxisLine.setAttribute('x1', 0);
    yAxisLine.setAttribute('y1', 0);
    yAxisLine.setAttribute('x2', 0);
    yAxisLine.setAttribute('y2', height);
    yAxisLine.setAttribute('stroke', 'black');
    g.appendChild(yAxisLine);

    const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yLabel.setAttribute('x', -height / 2);
    yLabel.setAttribute('y', -40);
    yLabel.setAttribute('text-anchor', 'middle');
    yLabel.setAttribute('transform', 'rotate(-90)');
    yLabel.textContent = 'Accuracy';
    g.appendChild(yLabel);

    // Perfect calibration line
    const perfectLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    perfectLine.setAttribute('x1', 0);
    perfectLine.setAttribute('y1', height);
    perfectLine.setAttribute('x2', width);
    perfectLine.setAttribute('y2', 0);
    perfectLine.setAttribute('stroke', '#3498db');
    perfectLine.setAttribute('stroke-width', 2);
    perfectLine.setAttribute('stroke-dasharray', '5,5');
    g.appendChild(perfectLine);

    // Model path
    let pathM = `M ${xScale(modelValues[0].confidence)} ${yScale(modelValues[0].accuracy)}`;
    for (let i = 1; i < modelValues.length; i++) {
        pathM += ` L ${xScale(modelValues[i].confidence)} ${yScale(modelValues[i].accuracy)}`;
    }
    const modelPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    modelPath.setAttribute('d', pathM);
    modelPath.setAttribute('stroke', '#e74c3c');
    modelPath.setAttribute('fill', 'none');
    modelPath.setAttribute('stroke-width', 2);
    g.appendChild(modelPath);

    // Human path
    let pathH = `M ${xScale(humanValues[0].confidence)} ${yScale(humanValues[0].accuracy)}`;
    for (let i = 1; i < humanValues.length; i++) {
        pathH += ` L ${xScale(humanValues[i].confidence)} ${yScale(humanValues[i].accuracy)}`;
    }
    const humanPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    humanPath.setAttribute('d', pathH);
    humanPath.setAttribute('stroke', '#2ecc71');
    humanPath.setAttribute('fill', 'none');
    humanPath.setAttribute('stroke-width', 2);
    g.appendChild(humanPath);

    // Title
    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', width / 2);
    title.setAttribute('y', -10);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'Calibration of Model and Human Confidence';
    g.appendChild(title);
}

function updateDiscriminationChart(styleVal, lengthVal, accuracyVal) {
    const chart = document.getElementById('discrimination-chart');
    chart.innerHTML = '';
    const { margin, width, height } = getChartDimensions(chart);

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', chart.clientWidth);
    svg.setAttribute('height', chart.clientHeight);
    svg.setAttribute('viewBox', `0 0 ${chart.clientWidth} ${chart.clientHeight}`);
    chart.appendChild(svg);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
    svg.appendChild(g);

    // Base values
    const modelAUCBase = 0.75 + (accuracyVal - 70)/200; // range ~0.75-0.80
    let humanAUCBase = 0.60; // typical
    if (styleVal === 3) humanAUCBase -= 0.05; // overconfidence
    if (styleVal === 1) humanAUCBase += 0.07; // uncertain helps
    if (lengthVal === 3) humanAUCBase -= 0.02;
    if (lengthVal === 1) humanAUCBase += 0.03;
    humanAUCBase += (accuracyVal - 70)/300;
    const modelAUC = Math.min(1, Math.max(0.5, modelAUCBase));
    const humanAUC = Math.min(1, Math.max(0.5, humanAUCBase));
    const gap = modelAUC - humanAUC;

    const categories = ['Model','Human','Gap'];
    const values = [modelAUC, humanAUC, gap];
    const colors = ['#3498db', '#e74c3c', '#9b59b6'];
    const barWidth = width / 8;

    // Y-axis
    const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxisLine.setAttribute('x1', 0);
    yAxisLine.setAttribute('y1', 0);
    yAxisLine.setAttribute('x2', 0);
    yAxisLine.setAttribute('y2', height);
    yAxisLine.setAttribute('stroke', 'black');
    g.appendChild(yAxisLine);

    const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yLabel.setAttribute('x', -height / 2);
    yLabel.setAttribute('y', -40);
    yLabel.setAttribute('transform', 'rotate(-90)');
    yLabel.setAttribute('text-anchor', 'middle');
    yLabel.textContent = 'Discrimination (AUC)';
    g.appendChild(yLabel);

    // Chance line
    const chance = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    chance.setAttribute('x1', 0);
    chance.setAttribute('y1', height*0.5);
    chance.setAttribute('x2', width);
    chance.setAttribute('y2', height*0.5);
    chance.setAttribute('stroke', '#555');
    chance.setAttribute('stroke-dasharray', '5,5');
    g.appendChild(chance);

    categories.forEach((cat, i) => {
        const x = (i+1)*width/5 - barWidth/2;
        const val = values[i];
        const barHeight = val*height;

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', height - barHeight);
        rect.setAttribute('width', barWidth);
        rect.setAttribute('height', barHeight);
        rect.setAttribute('fill', colors[i]);
        g.appendChild(rect);

        // Labels
        const label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', x + barWidth/2);
        label.setAttribute('y', height + 20);
        label.setAttribute('text-anchor', 'middle');
        label.textContent = cat;
        g.appendChild(label);

        const valLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        valLabel.setAttribute('x', x + barWidth/2);
        valLabel.setAttribute('y', height - barHeight - 5);
        valLabel.setAttribute('text-anchor', 'middle');
        valLabel.textContent = val.toFixed(2);
        g.appendChild(valLabel);
    });

    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', width/2);
    title.setAttribute('y', -10);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'Discrimination Ability (AUC)';
    g.appendChild(title);
}

function updateAIExampleExplanation(styleVal, lengthVal) {
    const example = llmExamples[Math.floor(Math.random() * llmExamples.length)];
    document.getElementById('question-text').textContent = example.question;

    let explanation = '';
    if (styleVal === 1) explanation = example.explanations.low;
    if (styleVal === 2) explanation = example.explanations.medium;
    if (styleVal === 3) explanation = example.explanations.high;

    // Adjust length
    if (lengthVal === 1 && explanation.length > 80) {
        explanation = explanation.split('.')[0] + '.';
    }
    if (lengthVal === 3 && explanation.length < 150) {
        explanation += " This is generally agreed upon by experts and can be found in standard references.";
    }

    // Confidences
    let modelConf = 0, humanConf = 0;
    if (styleVal === 1) { modelConf=example.modelConfidence.low; humanConf=example.humanConfidence.low; }
    if (styleVal === 2) { modelConf=example.modelConfidence.medium; humanConf=example.humanConfidence.medium; }
    if (styleVal === 3) { modelConf=example.modelConfidence.high; humanConf=example.humanConfidence.high; }

    if (lengthVal === 1) humanConf -= 0.05;
    if (lengthVal === 3) humanConf += 0.07;
    humanConf = Math.min(1, Math.max(0, humanConf));

    const gap = Math.abs(humanConf - modelConf).toFixed(2);

    document.getElementById('llm-answer').innerHTML = `
        <strong>Answer:</strong> ${example.answer}<br><br>
        <strong>Explanation:</strong> ${explanation}
    `;
    document.getElementById('model-confidence-value').textContent = (modelConf*100).toFixed(0) + '%';
    document.getElementById('human-confidence-value').textContent = (humanConf*100).toFixed(0) + '%';
    document.getElementById('calibration-gap-value').textContent = (gap*100).toFixed(0) + '%';
    document.getElementById('is-correct').textContent = example.correct ? 'Yes' : 'No';
    document.getElementById('is-correct').style.color = example.correct ? 'green' : 'red';
}

// -----------------------------------------------------
// COMBINED SIMULATION
// -----------------------------------------------------
function updateCombinedSimulation() {
    const compVal = parseFloat(document.getElementById('combined-compression-slider').value);
    document.getElementById('combined-compression-value').textContent = compVal.toFixed(1);

    const styleVal = parseInt(document.getElementById('combined-explanation-style-slider').value);
    const styleLabels = ['Uncertain','Moderately Confident','Very Confident'];
    document.getElementById('combined-explanation-style-value').textContent = styleLabels[styleVal - 1];

    const expVal = parseInt(document.getElementById('combined-expertise-slider').value);
    const expLabels = ['Low','Average','High'];
    document.getElementById('combined-expertise-value').textContent = expLabels[expVal - 1];

    const compxVal = parseInt(document.getElementById('combined-complexity-slider').value);
    const cxLabels = ['Low','Medium','High'];
    document.getElementById('combined-complexity-value').textContent = cxLabels[compxVal - 1];

    updateCombinedChart(compVal, styleVal, expVal, compxVal);
    updateIntegratedResultsChart(compVal, styleVal, expVal, compxVal);
}

function updateCombinedChart(compVal, styleVal, expVal, compxVal) {
    const chart = document.getElementById('combined-chart');
    chart.innerHTML = '';
    const { margin, width, height } = getChartDimensions(chart);

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', chart.clientWidth);
    svg.setAttribute('height', chart.clientHeight);
    svg.setAttribute('viewBox', `0 0 ${chart.clientWidth} ${chart.clientHeight}`);
    chart.appendChild(svg);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
    svg.appendChild(g);

    // Base slopes
    let energySlope = 0.28;
    if (expVal === 1) energySlope *= 0.8;
    if (expVal === 3) energySlope *= 1.3;
    if (compxVal === 3) energySlope *= 0.9;
    if (compxVal === 1) energySlope *= 1.1;

    let aiSlope = 0.4;
    if (styleVal === 3) aiSlope *= 0.8;
    if (styleVal === 1) aiSlope *= 1.2;
    if (expVal === 1) aiSlope *= 0.9;
    if (expVal === 3) aiSlope *= 1.2;

    energySlope /= (compVal/2.8);
    aiSlope /= (compVal/2.8);

    // Generate data
    const actuals = [0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1.0];
    const energyData = actuals.map(a => ({
        actual: a,
        perceived: 0.5 + energySlope*(a - 0.5)
    }));
    const aiData = actuals.map(a => ({
        actual: a,
        perceived: 0.5 + aiSlope*(a - 0.5)
    }));

    const xScale = v => v*width;
    const yScale = v => height - v*height;

    // Axes
    const xAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    xAxisLine.setAttribute('x1', 0);
    xAxisLine.setAttribute('y1', height);
    xAxisLine.setAttribute('x2', width);
    xAxisLine.setAttribute('y2', height);
    xAxisLine.setAttribute('stroke', 'black');
    g.appendChild(xAxisLine);

    const xLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    xLabel.setAttribute('x', width/2);
    xLabel.setAttribute('y', height+40);
    xLabel.setAttribute('text-anchor', 'middle');
    xLabel.textContent = 'Actual Value';
    g.appendChild(xLabel);

    const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxisLine.setAttribute('x1', 0);
    yAxisLine.setAttribute('y1', 0);
    yAxisLine.setAttribute('x2', 0);
    yAxisLine.setAttribute('y2', height);
    yAxisLine.setAttribute('stroke', 'black');
    g.appendChild(yAxisLine);

    const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yLabel.setAttribute('x', -height/2);
    yLabel.setAttribute('y', -40);
    yLabel.setAttribute('transform', 'rotate(-90)');
    yLabel.setAttribute('text-anchor', 'middle');
    yLabel.textContent = 'Perceived Value';
    g.appendChild(yLabel);

    // Perfect line
    const perfectLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    perfectLine.setAttribute('x1', 0);
    perfectLine.setAttribute('y1', height);
    perfectLine.setAttribute('x2', width);
    perfectLine.setAttribute('y2', 0);
    perfectLine.setAttribute('stroke', '#3498db');
    perfectLine.setAttribute('stroke-width', 2);
    perfectLine.setAttribute('stroke-dasharray', '5,5');
    g.appendChild(perfectLine);

    // Energy line
    let ePath = `M ${xScale(energyData[0].actual)} ${yScale(energyData[0].perceived)}`;
    for (let i = 1; i < energyData.length; i++) {
        ePath += ` L ${xScale(energyData[i].actual)} ${yScale(energyData[i].perceived)}`;
    }
    const eLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    eLine.setAttribute('d', ePath);
    eLine.setAttribute('stroke', '#e74c3c');
    eLine.setAttribute('fill', 'none');
    eLine.setAttribute('stroke-width', 2);
    g.appendChild(eLine);

    energyData.forEach(pt => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', xScale(pt.actual));
        circle.setAttribute('cy', yScale(pt.perceived));
        circle.setAttribute('r', 4);
        circle.setAttribute('fill', '#e74c3c');
        g.appendChild(circle);
    });

    // AI line
    let aPath = `M ${xScale(aiData[0].actual)} ${yScale(aiData[0].perceived)}`;
    for (let i = 1; i < aiData.length; i++) {
        aPath += ` L ${xScale(aiData[i].actual)} ${yScale(aiData[i].perceived)}`;
    }
    const aLine = document.createElementNS('http://www.w3.org/2000/svg', 'path');
    aLine.setAttribute('d', aPath);
    aLine.setAttribute('stroke', '#2ecc71');
    aLine.setAttribute('fill', 'none');
    aLine.setAttribute('stroke-width', 2);
    g.appendChild(aLine);

    aiData.forEach(pt => {
        const circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        circle.setAttribute('cx', xScale(pt.actual));
        circle.setAttribute('cy', yScale(pt.perceived));
        circle.setAttribute('r', 4);
        circle.setAttribute('fill', '#2ecc71');
        g.appendChild(circle);
    });

    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', width/2);
    title.setAttribute('y', -10);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'Cross-Domain Perception Biases';
    g.appendChild(title);

    // Slope indicators
    const eText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    eText.setAttribute('x', 10);
    eText.setAttribute('y', 20);
    eText.setAttribute('fill', '#e74c3c');
    eText.textContent = `Energy Slope: ${energySlope.toFixed(2)}`;
    g.appendChild(eText);

    const aText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    aText.setAttribute('x', 10);
    aText.setAttribute('y', 40);
    aText.setAttribute('fill', '#2ecc71');
    aText.textContent = `AI Slope: ${aiSlope.toFixed(2)}`;
    g.appendChild(aText);
}

function updateIntegratedResultsChart(compVal, styleVal, expVal, compxVal) {
    const chart = document.getElementById('integrated-results-chart');
    chart.innerHTML = '';
    const { margin, width, height } = getChartDimensions(chart);

    const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
    svg.setAttribute('width', chart.clientWidth);
    svg.setAttribute('height', chart.clientHeight);
    svg.setAttribute('viewBox', `0 0 ${chart.clientWidth} ${chart.clientHeight}`);
    chart.appendChild(svg);

    const g = document.createElementNS('http://www.w3.org/2000/svg', 'g');
    g.setAttribute('transform', `translate(${margin.left}, ${margin.top})`);
    svg.appendChild(g);

    // Base metrics
    let compressionRatio = compVal;     // from 1 to 5
    let calibrationGap = 0.15;         // base
    if (styleVal === 3) calibrationGap += 0.1;
    if (styleVal === 1) calibrationGap -= 0.08;
    if (expVal === 1) { calibrationGap += 0.05; compressionRatio += 0.3; }
    if (expVal === 3) { calibrationGap -= 0.05; compressionRatio -= 0.3; }
    if (compxVal === 3) { calibrationGap += 0.05; compressionRatio += 0.2; }
    if (compxVal === 1) { calibrationGap -= 0.05; compressionRatio -= 0.2; }

    let humanDiscrimination = 0.60;
    if (styleVal === 1) humanDiscrimination += 0.07;
    if (styleVal === 3) humanDiscrimination -= 0.05;
    if (expVal === 3) humanDiscrimination += 0.07;
    if (expVal === 1) humanDiscrimination -= 0.07;

    let energySlope = 0.28;
    if (expVal === 3) energySlope += 0.07;
    if (expVal === 1) energySlope -= 0.07;
    if (compxVal === 3) energySlope -= 0.05;
    if (compxVal === 1) energySlope += 0.05;

    // clamp
    calibrationGap = Math.min(0.3, Math.max(0, calibrationGap));
    humanDiscrimination = Math.min(1, Math.max(0.5, humanDiscrimination));
    energySlope = Math.min(1, Math.max(0.1, energySlope));
    compressionRatio = Math.min(5, Math.max(1, compressionRatio));

    const metrics = [
        { name: 'Compression Ratio', value: compressionRatio, max: 5, color: '#e74c3c',
          desc: 'Factor for under/overestimation in the energy domain' },
        { name: 'Calibration Gap', value: calibrationGap, max: 0.3, color: '#3498db',
          desc: 'Model confidence vs. human perception gap (AI domain)' },
        { name: 'Human Discrimination', value: humanDiscrimination, max: 1, color: '#2ecc71',
          desc: 'AUC measure of distinguishing correct from incorrect' },
        { name: 'Energy Perception Slope', value: energySlope, max: 1, color: '#9b59b6',
          desc: 'Steepness of perceived/actual energy usage' }
    ];

    const barWidth = width / (metrics.length*2);

    // Y-axis
    const yAxisLine = document.createElementNS('http://www.w3.org/2000/svg', 'line');
    yAxisLine.setAttribute('x1', 0);
    yAxisLine.setAttribute('y1', 0);
    yAxisLine.setAttribute('x2', 0);
    yAxisLine.setAttribute('y2', height);
    yAxisLine.setAttribute('stroke', 'black');
    g.appendChild(yAxisLine);

    const yLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    yLabel.setAttribute('x', -height/2);
    yLabel.setAttribute('y', -40);
    yLabel.setAttribute('transform', 'rotate(-90)');
    yLabel.setAttribute('text-anchor', 'middle');
    yLabel.textContent = 'Normalized Value';
    g.appendChild(yLabel);

    const title = document.createElementNS('http://www.w3.org/2000/svg', 'text');
    title.setAttribute('x', width/2);
    title.setAttribute('y', -10);
    title.setAttribute('text-anchor', 'middle');
    title.setAttribute('font-weight', 'bold');
    title.textContent = 'Integrated Perception Metrics';
    g.appendChild(title);

    metrics.forEach((m, i) => {
        const x = (i+1)*width/(metrics.length+1) - barWidth/2;
        const normalized = m.value/m.max;
        const barHeight = normalized * height;

        const rect = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        rect.setAttribute('x', x);
        rect.setAttribute('y', height - barHeight);
        rect.setAttribute('width', barWidth);
        rect.setAttribute('height', barHeight);
        rect.setAttribute('fill', m.color);
        g.appendChild(rect);

        const nameLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        nameLabel.setAttribute('x', x + barWidth/2);
        nameLabel.setAttribute('y', height + 20);
        nameLabel.setAttribute('text-anchor', 'middle');
        nameLabel.textContent = m.name;
        nameLabel.setAttribute('font-size', '12px');
        g.appendChild(nameLabel);

        const valLabel = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        valLabel.setAttribute('x', x + barWidth/2);
        valLabel.setAttribute('y', height - barHeight - 10);
        valLabel.setAttribute('text-anchor', 'middle');
        valLabel.textContent = m.value.toFixed(2);
        g.appendChild(valLabel);

        // Tooltip
        rect.addEventListener('mouseover', e => {
            const tooltip = document.createElement('div');
            tooltip.className = 'tooltip';
            tooltip.innerHTML = `
               <strong>${m.name}:</strong> ${m.value.toFixed(2)}<br>
               <small>${m.desc}</small><br>
               <small>Normalized: ${(normalized*100).toFixed(0)}%</small>
            `;
            tooltip.style.left = (e.pageX + 10) + 'px';
            tooltip.style.top = (e.pageY + 10) + 'px';
            tooltip.style.display = 'block';
            document.body.appendChild(tooltip);
        });
        rect.addEventListener('mousemove', e => {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) {
                tooltip.style.left = (e.pageX + 10) + 'px';
                tooltip.style.top = (e.pageY + 10) + 'px';
            }
        });
        rect.addEventListener('mouseout', () => {
            const tooltip = document.querySelector('.tooltip');
            if (tooltip) tooltip.remove();
        });
    });
}

// -----------------------------------------------------
// ONLOAD INITIALIZATION
// -----------------------------------------------------
window.onload = () => {
    updateAttariSimulation();
};
</script>
</body>
</html>
