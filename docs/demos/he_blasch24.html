<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Comparison Experiment Demo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* Apply Inter font globally */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles for sliders if needed */
        input[type=range] {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            width: 100%; /* Full-width */
            height: 8px; /* Specified height */
            background: #d3d3d3; /* Grey background */
            outline: none; /* Remove outline */
            opacity: 0.7; /* Set transparency (for mouse-over effects on hover) */
            -webkit-transition: .2s; /* 0.2 seconds transition on hover */
            transition: opacity .2s;
            border-radius: 4px;
        }

        input[type=range]:hover {
            opacity: 1; /* Fully opaque on hover */
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; /* Override default look */
            appearance: none;
            width: 20px; /* Set a specific slider handle width */
            height: 20px; /* Slider handle height */
            background: #059669; /* Green background */
            cursor: pointer; /* Cursor on hover */
            border-radius: 50%; /* Circular handle */
        }

        input[type=range]::-moz-range-thumb {
            width: 20px; /* Set a specific slider handle width */
            height: 20px; /* Slider handle height */
            background: #059669; /* Green background */
            cursor: pointer; /* Cursor on hover */
            border-radius: 50%; /* Circular handle */
            border: none; /* Remove border */
        }
        /* Simple bar chart styling */
        .bar-container {
            display: flex;
            align-items: flex-end;
            height: 60px; /* Adjust height as needed */
            gap: 10px; /* Space between bars */
            margin-top: 10px;
            margin-bottom: 5px;
            padding-left: 20px; /* Ensure labels don't overlap */
            position: relative;
        }
         .bar-axis {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 1px;
            background-color: #9ca3af; /* gray-400 */
        }
        .bar-label-y {
             position: absolute;
             bottom: -5px; /* Position below axis */
             left: -20px; /* Position left of bars */
             font-size: 0.75rem; /* text-xs */
             color: #6b7280; /* gray-500 */
        }
        .bar {
            background-color: #3b82f6; /* blue-500 */
            width: 40px; /* Adjust width as needed */
            border-radius: 4px 4px 0 0; /* Rounded top corners */
            position: relative;
            text-align: center;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
            padding-top: 2px;
        }
         .bar-value {
             position: absolute;
             bottom: 100%; /* Position above the bar */
             left: 50%;
             transform: translateX(-50%);
             font-size: 0.75rem; /* text-xs */
             color: #1f2937; /* gray-800 */
             margin-bottom: 2px; /* Space between value and bar top */
             white-space: nowrap;
         }
        .bar-label-x {
            position: absolute;
            top: 100%; /* Position below the bar */
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.75rem; /* text-xs */
            color: #6b7280; /* gray-500 */
            margin-top: 4px; /* Space between bar bottom and label */
            white-space: nowrap;
        }
        .bar-peer {
             background-color: #6b7280; /* gray-500 */
        }
        /* Feedback box styling */
        .feedback-box {
            border: 1px solid #e5e7eb; /* gray-200 */
            padding: 1rem; /* p-4 */
            border-radius: 0.375rem; /* rounded-md */
            margin-top: 1rem; /* mt-4 */
            background-color: #f9fafb; /* gray-50 */
        }
        .injunctive-norm-positive { background-color: #dcfce7; border-left: 4px solid #22c55e; } /* green-100 border-green-500 */
        .injunctive-norm-negative { background-color: #fee2e2; border-left: 4px solid #ef4444; } /* red-100 border-red-500 */
        .injunctive-norm-neutral { background-color: #f3f4f6; border-left: 4px solid #6b7280; } /* gray-100 border-gray-500 */

        /* Hide elements */
        .hidden { display: none; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800 p-4 md:p-8">

    <div id="experiment-container" class="max-w-3xl mx-auto bg-white p-6 md:p-8 rounded-lg shadow-md">

        <div id="phase-welcome" class="phase-screen">
            <h1 class="text-2xl font-bold mb-4 text-center text-emerald-700">Experiment Demo</h1>
            <p class="mb-4">Welcome! This demo replicates the experimental task from the study by He et al. (2024) on social comparison feedback.</p>
            <p class="mb-4">You will complete three phases:</p>
            <ol class="list-decimal list-inside mb-4 space-y-1">
                <li>A quick task involving allocating balls.</li>
                <li>A multi-round purchasing task where your decisions affect your payoff and a carbon offset donation.</li>
                <li>A short survey (simplified for this demo).</li>
            </ol>
            <p class="mb-4">Your total earnings will depend on your decisions in the tasks. One round from the purchasing task will be randomly selected for payment.</p>
            <p class="mb-6 text-sm text-gray-600">Click "Start" to read the instructions and provide consent.</p>
            <div class="text-center">
                <button id="start-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Start
                </button>
            </div>
        </div>

        <div id="phase-consent" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">Informed Consent</h2>
            <p class="mb-4">Before you begin, please read the following:</p>
            <ul class="list-disc list-inside mb-4 space-y-1 text-sm bg-gray-50 p-4 rounded-md border">
                <li>Participation is voluntary. You can withdraw at any time.</li>
                <li>Your decisions will be recorded anonymously for the purpose of this demo.</li>
                <li>The experiment involves making decisions with potential monetary payoffs and simulated environmental consequences (carbon offsets).</li>
                <li>The estimated duration is about 15-20 minutes.</li>
            </ul>
            <p class="mb-6">By clicking "Agree and Continue", you confirm that you understand the information and consent to participate.</p>
             <div class="text-center">
                <button id="consent-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Agree and Continue
                </button>
            </div>
        </div>

        <div id="phase-norm-instructions" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">Phase 1: Ball Allocation Task</h2>
            <p class="mb-4">In this task, you will allocate 50 balls into two buckets: a yellow bucket and a blue bucket.</p>
            <p class="mb-4"><strong class="text-blue-600">The rule is to put the balls in the blue bucket.</strong></p>
            <p class="mb-4">Your payoff for this task depends on where you put the balls:</p>
            <ul class="list-disc list-inside mb-4 space-y-1">
                <li>Each ball in the <strong class="text-yellow-600">yellow bucket</strong> earns you 4 Experimental Currency Units (ECU).</li>
                <li>Each ball in the <strong class="text-blue-600">blue bucket</strong> earns you 2 ECU.</li>
            </ul>
            <p class="mb-6">You will use a slider to decide how many balls go into the yellow bucket (the rest will automatically go into the blue bucket).</p>
            <div class="text-center">
                <button id="start-norm-task-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Start Task
                </button>
            </div>
        </div>

        <div id="phase-norm-task" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">Allocate 50 Balls</h2>
            <p class="mb-4 text-center text-sm text-gray-600">Remember the rule: Put balls in the blue bucket.</p>
            <div class="flex justify-around items-center mb-6 p-4 border rounded-md">
                <div class="text-center">
                    <div class="w-16 h-16 bg-yellow-400 rounded-full mx-auto mb-2 border-2 border-yellow-600"></div>
                    <p class="font-semibold">Yellow Bucket</p>
                    <p class="text-sm text-gray-700">Earns 4 ECU per ball</p>
                    <p class="text-lg font-bold mt-2"><span id="yellow-balls-count">25</span> balls</p>
                </div>
                 <div class="text-center">
                    <div class="w-16 h-16 bg-blue-500 rounded-full mx-auto mb-2 border-2 border-blue-700"></div>
                    <p class="font-semibold">Blue Bucket</p>
                    <p class="text-sm text-gray-700">Earns 2 ECU per ball</p>
                     <p class="text-lg font-bold mt-2"><span id="blue-balls-count">25</span> balls</p>
                </div>
            </div>

            <div class="mb-6 px-4">
                <label for="norm-slider" class="block text-sm font-medium text-gray-700 mb-2">Number of balls in the YELLOW bucket:</label>
                <input type="range" id="norm-slider" name="norm-slider" min="0" max="50" value="25" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                <div class="flex justify-between text-xs text-gray-500 mt-1">
                    <span>0</span>
                    <span>25</span>
                    <span>50</span>
                </div>
                 <p class="text-center mt-2 font-semibold">Yellow Balls: <span id="slider-value-display" class="text-emerald-700">25</span></p>
            </div>

            <div class="text-center">
                <button id="submit-norm-task-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Confirm Allocation
                </button>
            </div>
        </div>

        <div id="phase-dictator-instructions" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">Phase 2: Purchasing Task</h2>
            <p class="mb-4">This phase consists of 10 rounds. In each round:</p>
            <ul class="list-disc list-inside mb-4 space-y-1">
                <li>You receive an endowment of <strong>100 ECU</strong>.</li>
                <li>There is an initial amount of <strong>100 kg of carbon offsets</strong> available for donation.</li>
                <li>You decide how many units of a virtual product to purchase (0 to 100 units).</li>
                <li>Each unit costs 1 ECU but gives you a payoff of 2 ECU (net gain of 1 ECU per unit).</li>
                <li><strong>Crucially:</strong> Each unit purchased generates carbon emissions, which <strong class="text-red-600">reduces</strong> the amount of carbon offsets donated to a real-world environmental project.</li>
            </ul>
            <p class="mb-4">The amount of carbon emissions per unit depends on the experimental condition you have been assigned to:</p>
            <ul class="list-disc list-inside mb-4 space-y-1">
                 <li><strong>Low Externality:</strong> Each unit causes 0.5 kg CO2 emissions. Max possible donation: 100 kg, Min: 50 kg.</li>
                 <li><strong>High Externality:</strong> Each unit causes 1 kg CO2 emissions. Max possible donation: 100 kg, Min: 0 kg.</li>
            </ul>
             <p class="mb-4">Your task is to decide how many units to purchase in each round, balancing your own payoff against the carbon offset donation.</p>
             <p class="mb-4">From round 2 onwards, you will receive feedback about your previous round's decision. Starting from round 6, the type of feedback might change based on your assigned group.</p>
             <p class="mb-6">One round will be randomly chosen at the end to determine your payoff from this phase and the actual carbon offset donation.</p>
             <div class="text-center">
                <button id="start-dictator-game-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Start Purchasing Task
                </button>
            </div>
        </div>

        <div id="phase-dictator-task" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-2 text-center">Purchasing Task - Round <span id="round-number">1</span>/10</h2>
            <p class="text-sm text-gray-600 text-center mb-4">(Condition: <span id="condition-display" class="font-medium">Loading...</span>)</p>

            <div id="feedback-section" class="feedback-box mb-6 hidden">
                <h3 class="text-lg font-semibold mb-3 text-center border-b pb-2">Results of Previous Round (<span id="prev-round-number">0</span>)</h3>
                <div id="feedback-content" class="text-sm space-y-2">
                    </div>
            </div>

            <div class="bg-gray-50 p-4 rounded-md border mb-6">
                <p class="mb-3">In this round, you have <strong>100 ECU</strong> and <strong>100 kg</strong> of carbon offsets are available.</p>
                <p class="mb-4">Each unit purchased costs 1 ECU, increases your payoff by 2 ECU, and causes <strong id="emissions-per-unit">X</strong> kg of CO2 emissions (reducing the donation).</p>

                <div class="mb-4">
                    <label for="purchase-slider" class="block text-sm font-medium text-gray-700 mb-2">How many units of the virtual product will you purchase?</label>
                    <input type="range" id="purchase-slider" name="purchase-slider" min="0" max="100" value="50" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                     <div class="flex justify-between text-xs text-gray-500 mt-1">
                        <span>0 units</span>
                        <span>50 units</span>
                        <span>100 units</span>
                    </div>
                    <p class="text-center mt-2 font-semibold">Purchased Units: <span id="purchase-value-display" class="text-emerald-700">50</span></p>
                </div>

                 <div id="consequences-summary" class="text-sm mt-4 p-3 bg-white rounded border border-gray-200">
                     <p>If you purchase <strong id="summary-purchase">50</strong> units:</p>
                     <ul class="list-disc list-inside ml-4 mt-1">
                         <li>Your payoff this round: <strong id="summary-payoff">150</strong> ECU</li>
                         <li>CO2 Emissions caused: <strong id="summary-emissions">XX</strong> kg</li>
                         <li>Carbon offsets donated: <strong id="summary-offsets">YY</strong> kg</li>
                     </ul>
                 </div>
            </div>

            <div class="text-center">
                <button id="submit-purchase-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Confirm Purchase for Round <span id="round-number-button">1</span>
                </button>
            </div>
        </div>

        <div id="phase-survey" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">Phase 3: Short Survey</h2>
            <p class="mb-6 text-center text-sm text-gray-600">Please answer a few final questions. (Simplified for demo)</p>

            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How much do you agree with the statement: "I enjoy testing myself in competitive situations."?</label>
                    <select id="survey-compete" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                        <option value="">Select an option</option>
                        <option value="1">Strongly Disagree</option>
                        <option value="2">Disagree</option>
                        <option value="3">Slightly Disagree</option>
                        <option value="4">Neutral</option>
                        <option value="5">Slightly Agree</option>
                        <option value="6">Agree</option>
                        <option value="7">Strongly Agree</option>
                    </select>
                </div>

                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">How concerned are you that "Water scarcity" might directly affect you, your family, or your local environment in the foreseeable future?</label>
                    <select id="survey-climate" class="w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-emerald-500 focus:border-emerald-500">
                         <option value="">Select an option</option>
                         <option value="1">Not at all concerned</option>
                         <option value="2">Slightly concerned</option>
                         <option value="3">Moderately concerned</option>
                         <option value="4">Concerned</option>
                         <option value="5">Very concerned</option>
                         <option value="6">Extremely concerned</option>
                         <option value="7">Fully concerned</option>
                    </select>
                </div>

                 <div>
                     <label for="survey-risk" class="block text-sm font-medium text-gray-700 mb-1">How willing are you to take risks in general?</label>
                     <div class="flex items-center space-x-2">
                         <span class="text-xs text-gray-500">Completely unwilling (0)</span>
                         <input type="range" id="survey-risk" name="survey-risk" min="0" max="10" value="5" class="w-full">
                         <span class="text-xs text-gray-500">Completely willing (10)</span>
                     </div>
                      <p class="text-center text-sm mt-1">Selected: <span id="risk-value-display" class="font-semibold">5</span></p>
                 </div>
            </div>

            <div class="text-center mt-8">
                <button id="submit-survey-button" class="bg-emerald-600 hover:bg-emerald-700 text-white font-bold py-2 px-6 rounded-md transition duration-150">
                    Submit Survey
                </button>
            </div>
        </div>

        <div id="phase-results" class="phase-screen hidden">
            <h2 class="text-xl font-semibold mb-4 text-center">Experiment Complete!</h2>
            <p class="mb-4 text-center">Thank you for participating.</p>

            <div class="bg-emerald-50 p-4 rounded-md border border-emerald-200">
                <h3 class="text-lg font-semibold mb-3 text-emerald-800">Your Results:</h3>
                <p class="mb-2">Assigned Condition: <strong id="results-condition" class="text-emerald-700"></strong></p>
                <p class="mb-2">Payoff from Ball Allocation Task: <strong id="results-norm-payoff" class="text-emerald-700"></strong> ECU</p>
                <p class="mb-2">Randomly Selected Round for Purchasing Task Payoff: <strong id="results-selected-round" class="text-emerald-700"></strong></p>
                <p class="mb-2">Purchase in Selected Round: <strong id="results-selected-purchase" class="text-emerald-700"></strong> units</p>
                <p class="mb-2">Payoff from Selected Round: <strong id="results-dictator-payoff" class="text-emerald-700"></strong> ECU</p>
                <p class="mb-2">Carbon Offsets Donated from Selected Round: <strong id="results-offsets-donated" class="text-emerald-700"></strong> kg</p>
                <hr class="my-3 border-emerald-200">
                <p class="mb-2 text-lg font-bold">Total Individual Payoff: <strong id="results-total-payoff-ecu" class="text-emerald-700"></strong> ECU</p>
                <p class="text-md font-semibold">(Equivalent to approximately <strong id="results-total-payoff-gbp" class="text-emerald-700"></strong> GBP)</p>
            </div>

             <p class="mt-6 text-sm text-gray-600 text-center">This concludes the demo. In a real experiment, the calculated payoff would be processed, and the carbon offsets would be purchased and donated.</p>
        </div>

    </div>

    <script>
        // --- Configuration ---
        const TOTAL_ROUNDS = 10;
        const BASELINE_ROUNDS = 5;
        const TOTAL_BALLS = 50;
        const ECU_PER_YELLOW_BALL = 4;
        const ECU_PER_BLUE_BALL = 2;
        const INITIAL_ENDOWMENT = 100;
        const INITIAL_OFFSETS = 100;
        const COST_PER_UNIT = 1;
        const PAYOFF_PER_UNIT = 2;
        const ECU_TO_GBP_RATE = 1 / 50;

        // Tangible Conversion Factors (derived from Fig 2 example: 25kg -> 208km, 14 months)
        const KM_PER_KG_CO2 = 208 / 25; // approx 8.32
        const MONTHS_TREE_PER_KG_CO2 = 14 / 25; // approx 0.56

        // Simulated Peer Data (Average purchase amount for rounds 6-10)
        // Based loosely on Fig 3 means (around 75), with slight variation per round
        const simulatedPeerAverages = {
            low_externality: [76, 74, 77, 75, 73], // Rounds 6-10
            high_externality: [75, 76, 73, 74, 75] // Rounds 6-10
        };

        // --- State Variables ---
        let currentPhase = 'welcome';
        let currentRound = 0; // 0 means not started
        let participantData = {
            consent: false,
            treatment: {
                externality: null, // 'low' or 'high'
                feedback: null, // 'self', 'social', 'tangible'
                label: ''
            },
            normTask: {
                yellowBalls: null,
                payoffECU: null
            },
            dictatorTask: [], // Stores { round, purchase, payoffECU, emissions, offsets, peerAvg (if applicable) }
            survey: {
                compete: null,
                climate: null,
                risk: null
            },
            finalPayoff: {
                selectedRound: null,
                totalECU: null,
                totalGBP: null,
                finalOffsetsDonated: null
            }
        };

        // --- DOM Elements ---
        const experimentContainer = document.getElementById('experiment-container');
        const phaseScreens = document.querySelectorAll('.phase-screen');

        // Welcome & Consent
        const startButton = document.getElementById('start-button');
        const consentButton = document.getElementById('consent-button');

        // Norm Task
        const startNormTaskButton = document.getElementById('start-norm-task-button');
        const normSlider = document.getElementById('norm-slider');
        const yellowBallsCount = document.getElementById('yellow-balls-count');
        const blueBallsCount = document.getElementById('blue-balls-count');
        const sliderValueDisplay = document.getElementById('slider-value-display');
        const submitNormTaskButton = document.getElementById('submit-norm-task-button');

        // Dictator Task
        const startDictatorGameButton = document.getElementById('start-dictator-game-button');
        const roundNumberDisplay = document.getElementById('round-number');
        const conditionDisplay = document.getElementById('condition-display');
        const feedbackSection = document.getElementById('feedback-section');
        const prevRoundNumberDisplay = document.getElementById('prev-round-number');
        const feedbackContent = document.getElementById('feedback-content');
        const emissionsPerUnitDisplay = document.getElementById('emissions-per-unit');
        const purchaseSlider = document.getElementById('purchase-slider');
        const purchaseValueDisplay = document.getElementById('purchase-value-display');
        const consequencesSummary = document.getElementById('consequences-summary');
        const summaryPurchase = document.getElementById('summary-purchase');
        const summaryPayoff = document.getElementById('summary-payoff');
        const summaryEmissions = document.getElementById('summary-emissions');
        const summaryOffsets = document.getElementById('summary-offsets');
        const submitPurchaseButton = document.getElementById('submit-purchase-button');
        const roundNumberButton = document.getElementById('round-number-button');

        // Survey
        const surveyCompete = document.getElementById('survey-compete');
        const surveyClimate = document.getElementById('survey-climate');
        const surveyRisk = document.getElementById('survey-risk');
        const riskValueDisplay = document.getElementById('risk-value-display');
        const submitSurveyButton = document.getElementById('submit-survey-button');

        // Results
        const resultsCondition = document.getElementById('results-condition');
        const resultsNormPayoff = document.getElementById('results-norm-payoff');
        const resultsSelectedRound = document.getElementById('results-selected-round');
        const resultsSelectedPurchase = document.getElementById('results-selected-purchase');
        const resultsDictatorPayoff = document.getElementById('results-dictator-payoff');
        const resultsOffsetsDonated = document.getElementById('results-offsets-donated');
        const resultsTotalPayoffECU = document.getElementById('results-total-payoff-ecu');
        const resultsTotalPayoffGBP = document.getElementById('results-total-payoff-gbp');


        // --- Functions ---

        /**
         * Shows the specified phase screen and hides others.
         * @param {string} phaseId The ID of the phase screen to show.
         */
        function showPhase(phaseId) {
            phaseScreens.forEach(screen => {
                if (screen.id === phaseId) {
                    screen.classList.remove('hidden');
                } else {
                    screen.classList.add('hidden');
                }
            });
            currentPhase = phaseId;
            window.scrollTo(0, 0); // Scroll to top
        }

        /**
         * Assigns the participant to a random treatment condition.
         */
        function assignTreatment() {
            const externalityLevels = ['low', 'high'];
            const feedbackTypes = ['self', 'social', 'tangible'];
            const randomExternality = externalityLevels[Math.floor(Math.random() * externalityLevels.length)];
            const randomFeedback = feedbackTypes[Math.floor(Math.random() * feedbackTypes.length)];

            participantData.treatment.externality = randomExternality;
            participantData.treatment.feedback = randomFeedback;
            participantData.treatment.label = `Externality: ${randomExternality.charAt(0).toUpperCase() + randomExternality.slice(1)}, Feedback: ${randomFeedback.charAt(0).toUpperCase() + randomFeedback.slice(1)}`;
            console.log("Assigned Treatment:", participantData.treatment); // For debugging
        }

        /**
         * Updates the display showing ball counts based on the slider.
         */
        function updateNormSliderDisplay() {
            const yellowBalls = parseInt(normSlider.value);
            const blueBalls = TOTAL_BALLS - yellowBalls;
            yellowBallsCount.textContent = yellowBalls;
            blueBallsCount.textContent = blueBalls;
            sliderValueDisplay.textContent = yellowBalls;
        }

        /**
         * Calculates and stores the payoff for the norm-following task.
         */
        function calculateNormPayoff() {
            const yellowBalls = parseInt(normSlider.value);
            const blueBalls = TOTAL_BALLS - yellowBalls;
            const payoff = (yellowBalls * ECU_PER_YELLOW_BALL) + (blueBalls * ECU_PER_BLUE_BALL);
            participantData.normTask.yellowBalls = yellowBalls;
            participantData.normTask.payoffECU = payoff;
            console.log("Norm Task Payoff:", payoff); // For debugging
        }

        /**
         * Updates the display showing purchase consequences based on the slider.
         */
        function updatePurchaseSliderDisplay() {
            const purchaseAmount = parseInt(purchaseSlider.value);
            const emissionsRate = participantData.treatment.externality === 'high' ? 1 : 0.5;

            const payoff = INITIAL_ENDOWMENT + (purchaseAmount * (PAYOFF_PER_UNIT - COST_PER_UNIT));
            const emissions = purchaseAmount * emissionsRate;
            const offsets = Math.max(0, INITIAL_OFFSETS - emissions); // Ensure offsets don't go below 0

            purchaseValueDisplay.textContent = purchaseAmount;
            summaryPurchase.textContent = purchaseAmount;
            summaryPayoff.textContent = payoff;
            summaryEmissions.textContent = emissions.toFixed(1);
            summaryOffsets.textContent = offsets.toFixed(1);
        }

        /**
         * Starts a new round in the dictator game.
         */
        function startRound() {
            currentRound++;
            if (currentRound > TOTAL_ROUNDS) {
                showPhase('phase-survey');
                return;
            }

            roundNumberDisplay.textContent = currentRound;
            roundNumberButton.textContent = currentRound;
            conditionDisplay.textContent = participantData.treatment.label;
            emissionsPerUnitDisplay.textContent = participantData.treatment.externality === 'high' ? '1.0' : '0.5';

            // Reset slider and display for the new round
            purchaseSlider.value = 50; // Default to 50
            updatePurchaseSliderDisplay();

            // Show feedback from round 2 onwards
            if (currentRound > 1) {
                displayFeedback();
                feedbackSection.classList.remove('hidden');
            } else {
                feedbackSection.classList.add('hidden');
            }

            showPhase('phase-dictator-task');
        }

        /**
         * Generates and displays feedback based on the previous round and treatment.
         */
        function displayFeedback() {
            const prevRoundData = participantData.dictatorTask[currentRound - 2]; // -2 because currentRound is already incremented
            if (!prevRoundData) return;

            prevRoundNumberDisplay.textContent = prevRoundData.round;
            const externalityLevel = participantData.treatment.externality;
            const feedbackType = (currentRound > BASELINE_ROUNDS) ? participantData.treatment.feedback : 'self'; // Feedback type applies only after baseline

            let html = `<p>In round ${prevRoundData.round}, you purchased <strong>${prevRoundData.purchase}</strong> units.</p>`;
            html += `<p>This resulted in a payoff of <strong>${prevRoundData.payoffECU} ECU</strong> and caused <strong>${prevRoundData.emissions.toFixed(1)} kg</strong> of CO2 emissions.</p>`;
            html += `<p>The carbon offsets donated were <strong>${prevRoundData.offsets.toFixed(1)} kg</strong>.</p>`;

            // --- Self Feedback Bar Chart (always shown) ---
             html += `<p class="mt-3 mb-1 font-medium">Your purchase:</p>`;
             html += createBarChart([ { value: prevRoundData.purchase, label: 'Your Purchase', type: 'self' } ]);


            // --- Social Comparison Feedback (Social & Tangible treatments, rounds > BASELINE_ROUNDS) ---
            if (feedbackType === 'social' || feedbackType === 'tangible') {
                // Simulate getting peer average for this round/externality
                const peerRoundIndex = prevRoundData.round - BASELINE_ROUNDS - 1; // Index for simulated data (0-4 for rounds 6-10)
                const peerAvg = simulatedPeerAverages[externalityLevel][peerRoundIndex] || 75; // Fallback
                prevRoundData.peerAvg = peerAvg; // Store it for record

                const difference = prevRoundData.purchase - peerAvg;
                let comparisonText = '';
                let emoji = '😐'; // Neutral
                let normClass = 'injunctive-norm-neutral';

                if (difference < 0) {
                    comparisonText = `You purchased ${Math.abs(difference).toFixed(0)} units less than the average (${peerAvg.toFixed(0)} units).`;
                    emoji = '😊'; // Positive
                    normClass = 'injunctive-norm-positive';
                } else if (difference > 0) {
                    comparisonText = `You purchased ${difference.toFixed(0)} units more than the average (${peerAvg.toFixed(0)} units).`;
                    emoji = '😟'; // Negative (using worried face as per paper's sad face)
                    normClass = 'injunctive-norm-negative';
                } else {
                    comparisonText = `You purchased the same amount as the average (${peerAvg.toFixed(0)} units).`;
                     normClass = 'injunctive-norm-neutral';
                }

                html += `<div class="p-3 mt-4 rounded-md ${normClass}">`;
                html += `<p class="font-semibold text-lg inline-block mr-2">${emoji}</p>`;
                html += `<p class="inline-block">${comparisonText}</p>`;
                html += `</div>`;

                // --- Bar Chart with Comparison ---
                html += `<p class="mt-3 mb-1 font-medium">Comparison:</p>`;
                html += createBarChart([
                    { value: prevRoundData.purchase, label: 'Your Purchase', type: 'self' },
                    { value: peerAvg, label: 'Avg. Others', type: 'peer' }
                 ]);

                // --- Tangible Emissions Feedback (Tangible treatment only) ---
                if (feedbackType === 'tangible') {
                    const drivingDist = prevRoundData.emissions * KM_PER_KG_CO2;
                    const treeMonths = prevRoundData.emissions * MONTHS_TREE_PER_KG_CO2;

                    html += `<div class="mt-4 pt-3 border-t border-gray-300">`;
                    html += `<p class="font-medium mb-2">The ${prevRoundData.emissions.toFixed(1)} kg CO2 emissions caused by your decision are equivalent to:</p>`;
                    html += `<div class="flex items-center space-x-4 text-center justify-around">`;
                    html += `<div>🚗 <br> ~<strong>${drivingDist.toFixed(0)} km</strong> of driving</div>`;
                    html += `<div>🌳 <br> ~<strong>${treeMonths.toFixed(0)} months</strong> for a tree to absorb</div>`;
                    html += `</div></div>`;
                }
            }

            feedbackContent.innerHTML = html;
        }

         /**
         * Creates HTML for a simple bar chart.
         * @param {Array<object>} data - Array of objects { value, label, type ('self' or 'peer') }
         * @returns {string} HTML string for the bar chart.
         */
        function createBarChart(data) {
            let barsHtml = '<div class="bar-container">';
            barsHtml += '<div class="bar-axis"></div>'; // X-axis line
            barsHtml += '<span class="bar-label-y">0</span>'; // Y-axis origin label

            const maxValue = 100; // Max possible purchase

            data.forEach(item => {
                const barHeight = Math.max(1, (item.value / maxValue) * 100); // % height, ensure min height 1px
                const barClass = item.type === 'peer' ? 'bar bar-peer' : 'bar';
                barsHtml += `
                    <div class="${barClass}" style="height: ${barHeight}%;">
                         <span class="bar-value">${item.value.toFixed(0)}</span>
                         <span class="bar-label-x">${item.label}</span>
                    </div>
                `;
            });
            barsHtml += '</div>';
            return barsHtml;
        }


        /**
         * Records the purchase decision for the current round.
         */
        function recordPurchase() {
            const purchaseAmount = parseInt(purchaseSlider.value);
            const emissionsRate = participantData.treatment.externality === 'high' ? 1 : 0.5;
            const payoff = INITIAL_ENDOWMENT + (purchaseAmount * (PAYOFF_PER_UNIT - COST_PER_UNIT));
            const emissions = purchaseAmount * emissionsRate;
            const offsets = Math.max(0, INITIAL_OFFSETS - emissions);

            participantData.dictatorTask.push({
                round: currentRound,
                purchase: purchaseAmount,
                payoffECU: payoff,
                emissions: emissions,
                offsets: offsets,
                peerAvg: null // Will be filled later if feedback shown
            });
            console.log(`Round ${currentRound} Data:`, participantData.dictatorTask[currentRound - 1]); // For debugging
        }

        /** Updates the display for the risk slider */
        function updateRiskSliderDisplay() {
            riskValueDisplay.textContent = surveyRisk.value;
        }

        /**
         * Records survey answers.
         */
        function recordSurvey() {
            participantData.survey.compete = surveyCompete.value ? parseInt(surveyCompete.value) : null;
            participantData.survey.climate = surveyClimate.value ? parseInt(surveyClimate.value) : null;
            participantData.survey.risk = surveyRisk.value ? parseInt(surveyRisk.value) : null;
            console.log("Survey Data:", participantData.survey); // For debugging
        }

        /**
         * Calculates final payoffs and displays the results screen.
         */
        function showResults() {
            // Randomly select one round from dictator game (rounds 1-10)
            const selectedRoundIndex = Math.floor(Math.random() * TOTAL_ROUNDS); // 0 to 9
            const selectedRoundData = participantData.dictatorTask[selectedRoundIndex];

            participantData.finalPayoff.selectedRound = selectedRoundData.round;
            participantData.finalPayoff.finalOffsetsDonated = selectedRoundData.offsets;

            const totalECU = participantData.normTask.payoffECU + selectedRoundData.payoffECU;
            const totalGBP = totalECU * ECU_TO_GBP_RATE;

            participantData.finalPayoff.totalECU = totalECU;
            participantData.finalPayoff.totalGBP = totalGBP;

            // Display results
            resultsCondition.textContent = participantData.treatment.label;
            resultsNormPayoff.textContent = participantData.normTask.payoffECU;
            resultsSelectedRound.textContent = selectedRoundData.round;
            resultsSelectedPurchase.textContent = selectedRoundData.purchase;
            resultsDictatorPayoff.textContent = selectedRoundData.payoffECU;
            resultsOffsetsDonated.textContent = selectedRoundData.offsets.toFixed(1);
            resultsTotalPayoffECU.textContent = totalECU;
            resultsTotalPayoffGBP.textContent = totalGBP.toFixed(2);

            console.log("Final Results:", participantData.finalPayoff); // For debugging
            showPhase('phase-results');
        }


        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', () => {
            showPhase('phase-welcome'); // Start at welcome screen
            assignTreatment(); // Assign treatment condition early

            // Welcome
            startButton.addEventListener('click', () => showPhase('phase-consent'));

            // Consent
            consentButton.addEventListener('click', () => {
                participantData.consent = true;
                showPhase('phase-norm-instructions');
            });

            // Norm Task Instructions
            startNormTaskButton.addEventListener('click', () => {
                updateNormSliderDisplay(); // Initialize display
                showPhase('phase-norm-task');
            });

            // Norm Task Slider
            normSlider.addEventListener('input', updateNormSliderDisplay);

            // Norm Task Submission
            submitNormTaskButton.addEventListener('click', () => {
                calculateNormPayoff();
                showPhase('phase-dictator-instructions');
            });

            // Dictator Game Instructions
            startDictatorGameButton.addEventListener('click', () => {
                 startRound(); // Start round 1
            });

            // Purchase Slider
            purchaseSlider.addEventListener('input', updatePurchaseSliderDisplay);

            // Purchase Submission
            submitPurchaseButton.addEventListener('click', () => {
                recordPurchase();
                startRound(); // Start next round (or move to survey)
            });

            // Survey Risk Slider
            surveyRisk.addEventListener('input', updateRiskSliderDisplay);


            // Survey Submission
            submitSurveyButton.addEventListener('click', () => {
                recordSurvey();
                showResults();
            });
        });

    </script>

</body>
</html>
